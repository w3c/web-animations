<!DOCTYPE html>
<!-- vim: set expandtab ts=2 sw=2 tw=80: -->
<html>
  <head>
    <title>Web Animations 1.0</title>
    <meta charset="utf-8">
    <script src="respec/respec.js" class="remove"></script>
    <script src="respec/js/sh_javascript.min.js" class="remove"></script>
    <script class="remove">
      var respecConfig = {
        // specification status (e.g. WD, LCWD, NOTE, etc.). If in doubt use
        // ED.
        specStatus: "ED",

        // the specification's short name, as in
        // http://www.w3.org/TR/short-name/
        // shortName:            "web-anim",

        // if your specification has a subtitle that goes below the main
        // formal title, define it here
        // subtitle   :  "an excellent document",

        // if you wish the publication date to be other than today, set this
        // publishDate:  "2009-08-06",

        // if the specification's copyright date is a range of years, specify
        // the start date here:
        // copyrightStart: "2012"

        // if there is a previously published draft, uncomment this and set
        // its YYYY-MM-DD date and its maturity status
        // previousPublishDate: "1977-03-15",
        // previousMaturity: "WD",

        // if there a publicly available Editor's Draft, this is the link
        edDraftURI:
        "https://dvcs.w3.org/hg/FXTF/raw-file/default/web-anim/index.html",

        // if this is a LCWD, uncomment and set the end of its review period
        // lcEnd: "2009-08-05",

        // if you want to have extra CSS, append them to this list
        // it is recommended that the respec.css stylesheet be kept
        extraCSS: ["respec/respec.css",
                   "web-animations.css"],

        // Turning off inlineCSS for now since if extraCSS points to
        // a relative URL your testing from a file URL the XHR will fail.
        // Probably should turn this back on once this is hosted on a server
        // somewhere.
        inlineCSS: false,

        // editors, add as many as you like
        // only "name" is required
        editors:  [
            { name: "Brian Birtles", mailto: "bbirtles@mozilla.com",
              company: "Mozilla Japan", companyURL: "http://mozilla.jp/" },
            { name: "Shane Stephens", mailto: "shans@google.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
            { name: "Alex Danilo", mailto: "adanilo@google.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
            { name: "Dmitry Baranovskiy", mailto: "baranovs@adobe.com",
              company: "Adobe Systems", companyURL: "http://www.adobe.com/" },
            { name: "Tab Atkins", mailto: "jackalmage@gmail.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
        ],

        // authors, add as many as you like.
        // This is optional, uncomment if you have authors as well as editors.
        // only "name" is required. Same format as editors.

        //authors:  [
        //    { name: "Your Name", url: "http://example.org/",
        //      company: "Your Company", companyURL: "http://example.com/" },
        //],

        // name of the WG(s)
        wg: [ "CSS Working Group",
              "SVG Working Group" ],

        // URI of the public WG page
        wgURI: [ "http://dev.w3.org/Style/CSS/members",
                 "http://www.w3.org/Graphics/SVG/WG" ],

        // Activity this WG is part of
        wgActivity: [ 
          [ "Style", "http://www.w3.org/Style/Activity" ],
          [ "Graphics", "http://www.w3.org/Graphics/Activity" ]
        ],

        // name (without the @w3c.org) of the public mailing to which comments
        // are due
        wgPublicList: "public-fx",

        // URI of the patent status for this WG, for Rec-track documents
        // !!!! IMPORTANT !!!!
        // This is important for Rec-track documents, do not copy a patent URI
        // from a random document unless you know what you're doing. If in
        // doubt ask your friendly neighbourhood Team Contact.
        wgPatentURI:  "",

        noIDLSorting: true,
        noIDLIn: true
      };
    </script>
    <!--
      ReSpec.js wishlist:

      Add here any issues you find with ReSpec including missing features. It
      will help us decide if we should continue using it and work out what we
      need to fix.

      * Allow making cross-references to specific methods and members.
    -->
  </head>
  <body>
    <section id='abstract'>
      This is the abstract for your specification.
    </section>

    <section class="informative">
      <h2>Introduction</h2>
      <p>
        Web Animations defines a model for supporting animation and
        synchronization on the Web platform.
        It is intended that other specifications will build on this model and
        expose its features through declarative means.
        In addition, this specification also defines a programming interface to
        the model that may be implemented by user agents that provide support
        for scripting.
      </p>
      <section>
        <h3>Use cases</h3>
        <p>
          The Web Animations model aims at three broad areas of application:
        </p>
        <dl>
          <dt>User interface effects</dt>
          <dd>
            <p>
              Animation can be used to give visual clues and feedback to make
              a user interface more readily comprehensible.
            </p>
            <p>
              For example, a user action results in a table row being
              removed to represent an item being removed from a shopping cart.
              In such a case, fading the row to transparent and then shifting
              the subsequent rows up to fill the space over a few hundred
              milliseconds provides the user with clear feedback as to the
              results of their action as opposed to instantly removing the row
              from the DOM.
            </p>
            <p>
              To support this scenario not only are the animated effects of
              fading and shifting required, but so is synchronization, both
              between the animations, and between animations and scripted
              actions (removing the table row from the DOM after the animations
              have completed).
            </p>
          </dd>
          <dt>Storytelling and visualisation</dt>
          <dd>
            <p>
              Another type of animation uses the animated effect to convey
              a story or represent some information.
              Unlike user interface effects which are largely a presentational
              adjunct to the content, these animations form an essential part of
              the content presented to the user.
            </p>
            <p>
              For example, in an animated cartoon two cats fly through space
              to another planet leaving a rainbow trail behind them.
              After arriving at the planet a change of scene occurs and the user
              should decide whether or not the cats enter a magic mountain by
              selecting one of two preset destinations in the scene.
            </p>
            <p>
              This scenario requires the following features:
            </p>
            <ul>
              <li>animated effects for moving characters along a path as well as
                  warping a path (the rainbow trail),</li>
              <li>synchronization that allows some actions to happen
                  simultaneously (the two cats moving) and others in sequence
                  (the change of scene),</li>
              <li>play control to allow rewinding the cartoon, or changing its
                  playback rate to accommodate particular learning or
                  accessibility needs (particularly if audio or textual captions
                  are included as described in the next use case category),</li>
              <li>the ability to trigger alternate animations at different
                  points in the overall story.</li>
            </ul>
            <p>
              Similar use cases in this category include visualising physical
              phenomena such as spring motion for educational purposes,
              or visualising data such as the prevalence of a disease over
              a geographical space over a year whereby animation is used to
              present the time-based component of the data.
            </p>
          </dd>
          <dt>Synchronizing media and animated effects</dt>
          <dd>
            <p>
              Finally, animation is often used in conjunction with other media
              such as video and audio.
            </p>
            <p>
              As an example, the subtitles shown on a karaoke video may indicate
              the current position in the lyrics through a ball bouncing from
              one syllable to the next.
              In this scenario it is necessary to maintain strict
              synchronization between the audio and animation even in the face
              of user interaction such as rewinding or pausing the audio or
              network events such as a delay due to media buffering.
            </p>
            <p>
              A more complicated example of this category is applying a series
              of independent sound effects to an animated cartoon or adding
              a video as the background of an animated scene such that is cued
              to start mid-way into the scene.
            </p>
          </dd>
        </dl>
        <p>
          The nature of these uses cases differs significantly and whilst Web
          Animations attempts to address each use case, technologies built on
          top of the Web Animations may expose features tailored towards more
          specific use cases rather catering to each scenario equally.
        </p>
      </section>
      <section>
        <h3>Relationship to other specifications</h3>
        <p>
          CSS Transitions [[CSS3-TRANSITIONS]], CSS Animations 
          [[CSS3-ANIMATIONS]], and SVG [[SVG112]] all provide mechanisms that
          generate animated content on a Web page.
          Although the three specifications provide many similar features,
          they are described in different terms.
          This specification proposes an abstract animation model that
          encompasses the common features of all three specifications.
          This model is backwards-compatible with the current behavior of these
          specifications such that they can be defined in terms of this model
          without any observable change.
        </p>
        <p>
          Defining CSS Transitions, CSS Animations and SVG's animation features
          in terms of a common model opens up possibilities of synchronizing
          animations, interchanging their definitions, and manipulating them
          using a common programming interface regardless of their markup.
          To facilitate this process of redefining these features in terms of
          a common model, this specification is accompanied by a CSS embedding
          specification, which describes how CSS features can be implemented in
          terms of Web Animations primitives, and an SVG embedding specification
          which does the same for SVG.
        </p>
        <p>
          The animation features in SVG 1.1 are defined in terms of SMIL
          Animation [[SMIL-ANIMATION]].
          It is intended that by defining SVG's animation features in terms of
          the Web Animations model, the dependency between SVG and SMIL
          Animation can be removed.
          To this end, features not present in Web Animations that are part of
          SVG are described in full in the SVG and Web Animations integration
          document.
        </p>
        <p>
          The programming interface component of this specification makes
          some additions to interfaces defined in HTML5 [[HTML5]].
        </p>
      </section>
      <section>
        <h3>Overview of this specification</h3>
        <p>
          This specification begins by defining an abstract model for animation.
          This is followed by a programming interface defined in terms of the
          abstract model.
          The programming interface is defined in terms of the abstract model
          and is only relevant to user agents that provide scripting support.
        </p>
      </section>
    </section>

    <section class="informative">
      <h2>Web Animations model overview</h2>
      <p>
        At a glance, the Web Animations model consists of two largely
        independent pieces, a <em>timing model</em> and an <em>animation
        model</em>.  The role of these pieces is as follows:
      </p>
      <dl>
        <dt>Timing model</dt>
        <dd>
          Takes a moment in time and converts it to a proportional distance
          within a single iteration of an animation called the <em>time
          fraction</em>.
        </dd>
        <dt>Animation model</dt>
        <dd>
          Takes the <em>time fractions</em> produced by the timing model and
          converts them into a series of values to apply to the target
          properties and attributes.
        </dd>
      </dl>
      <p>
        Graphically, this flow can be represented as follows:
      </p>
      <div class="figure">
        <img src="img/timing-and-animation-models.svg" width="600">
      </div>
      <p class="caption">
        Overview of the operation of the Web Animations model.<br>
        The current time is input to the timing model which produces a time
        fraction.<br>
        This distance is used as input to the animation model which produces
        the values to apply.
      </p>
      <p>
        For example, consider an animation that:
      </p>
      <ul>
        <li>starts after 3 seconds,</li>
        <li>runs twice,</li>
        <li>takes 2 seconds every time, and</li>
        <li>changes the width of a rectangle from 50 pixels to 100
            pixels.</li>
      </ul>
      <p>
        The first three points apply to the timing model.
        At a time of 6 seconds, it will calculate that the animation should be
        half-way through its second iteration and produces the result 0.5.
        The animation model then uses that information to calculate a width
        for the rectangle of 75.
      </p>
      <p>
        This specification begins with the timing model and then proceeds to
        the animation model.
      </p>
    </section>

    <section class="informative">
      <h2>The timing model at a glance</h2>
      <p>
        Two features characterise the Web Animations timing model: it is
        <em>stateless</em> and it is <em>hierarchical</em>.
      </p>
      <section>
        <h3>Stateless</h3>
        <p>
          The Web Animations timing model operates by taking an input time and
          producing an output time fraction.
          Since the output is based solely on the input time and is entirely
          independent of previous inputs, the model may be described as
          stateless.
          This gives the model the following properties:
        </p>
        <dl>
          <dt>Frame-rate independent</dt>
          <dd>
            Since the output is independent of previous inputs, the rate at
            which the model is sampled will not affect its progress.
            Provided the input times are proportional to the progress of
            real-world time, animations will progress at an identical rate
            regardless of the capabilities of the device running them.
          </dd>
          <dt>Direction agnostic</dt>
          <dd>
            Since the sequence of inputs is insignificant, the model is
            directionless.
            This means that the model can be sampled in reverse or even in
            a backwards and forwards pattern without requiring any specialized
            handling.
          </dd>
          <dt>Constant-time seeking</dt>
          <dd>
            Since each input is independent of the previous input, the
            processing required to perform a seek operation, even far into the
            future, is at least potentially constant.
          </dd>
        </dl>
        <p>
          There are two apparent exceptions to the stateless behavior of the
          timing model.
        </p>
        <p>
          Firstly, events are fired when, for example, one sample falls
          on the opposite side of an animation's interval boundary to the
          previous sample.
          This is certainly stative behavior.
          However, events should be considered as a layer added on top of the
          core timing model.
          In the case where no event listeners are registered, the model is
          stateless.
        </p>
        <p>
          The other exception to this stateless behavior is that a number of
          methods such as <code>pause</code> and <code>reverse</code> are
          defined in terms of the time at which they are called and are
          therefore stative.
          These methods are provided primarily for convenience and are not part
          of the core timing model but, like events, are layered on top.
        </p>
        <p>
          Finally, each time the model is sampled, it can be considered to
          establish a temporary state.
          While this temporary state affects the values returned from the API,
          it has no influence on the subsequent samples and hence does not
          conflict with the stateless qualities described above.
        </p>
      </section>
      <section>
        <h3>Hierarchical</h3>
        <p>
          The other characteristic feature of the Web Animations timing model is
          that time is inherited.
          Time begins with a monotonically increasing time source and cascades
          down a number of steps to each animation.
          At each step, time may be shifted backwards and forwards, scaled,
          reversed, paused, and repeated.
        </p>
        <div class="figure">
          <img src="img/time-hierarchy.svg" width="600">
        </div>
        <p class="caption">
          A hierarchy of time sources.
          Each node in the tree refers to a time source from which it derives
          its time.
          This parent time source is referred to here as the node's timeline.
        </p>
        <p>
          A consequence of this hierarchical arrangement is that complex
          animation arrangements can be reversed, scheduled, accelerated and so
          on, as a whole unit since the manipulations applied to the parent
          cascade down to its descendants.
          Furthermore, since time has a common source, it is easy to synchronize
          animations.
        </p>
      </section>
    </section>

    <section>
      <h2>Time sources</h2>
      <p>
        In Web Animations timing is based on a hierarchy of time relationships
        where the nodes are called time sources.
        Time sources provide a <dfn>time value</dfn> for the purpose of deriving
        further time sources and for eventual input into the animation model.
      </p>
      <p class="annotation">
        A future version or module may offer time sources based on UI gestures
        or other quantities that are less related to time.
      </p>
      <p>
        Some time sources further separate the <a>time value</a> into
        a <em>current time value</em> and a <em>result time value</em>.
      </p>
      <p>
        The <dfn>current time value</dfn> is a point of progress in the time
        source and is used for seeking the time source.
      </p>
      <p>
        The <dfn>output time value</dfn> is the <a>current time value</a> with
        an optional transformation applied
        and is used for synchronizing consumers of the time source.
      </p>
      <p class="feedbackWanted">
        Other options for naming:
        <em>result time value</em> (<code>resultTime</code>),
        <em>filtered time value</em> (<code>filteredTime</code>),
        <em>child time value</em> (<code>childTime</code>),
        <em>sync time value</em> (<code>syncTime</code>)
        &hellip;
      </p>
      <p>
        For simple time sources, and unless otherwise stated, the <a>current
        time value</a> and <a>output time value</a> are one and the same.
      </p>
      <div class="annotation">
        <p>
          This complexity arises from the fact that in other APIs
          <code>currentTime</code> is used both as the input for seeking (e.g.
          HTMLMediaController, HTMLMediaElement) and also as the output for
          syncing (e.g. HTMLMediaController).
        </p>
        <p>
          We want to be consistent in allowing <code>currentTime</code> to be
          used for seeking and we also want to allow such objects to be used as 
          time sources.
        </p>
        <p>
          As a result we allow <code>currentTime</code> to do double-duty in
          simple cases, and introduce <code>outputTime</code> for cases where
          it is necessary to distinguish between the two times.
        </p>
      </div>
      <p>
        Time sources are represented in the Web Animations <acronym
        title="Application Programming Interface">API</acronym> by the
        <a>TimeSource</a> interface.
      </p>
      <section>
        <h3>The <code>TimeSource</code> interface</h3>
        <dl title="interface TimeSource" class="idl">
          <dt>readonly attribute double? currentTime</dt>
          <dd>
            <p>
              The <a>current time value</a> of this time source in seconds.
              This value is updated each time the model is sampled (see <a
              href="#interaction-with-script" class="sectionRef"></a>).
            </p>
            <p>
              Note that this will be <code>null</code> if the time source cannot
              currently produce a time value.
              For example, a time source that derives its time from another time
              source will return <code>null</code> if the parent time source is
              not provided, is unavailable, or if the parent time source reports
              <code>null</code> as its <a>output time value</a>.
            </p>
            <p class="note">
              Note that while <code>currentTime</code> is read-only in this
              interface, it is writeable in the derived interface
              <a>TimedItem</a>.
            </p>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>The document timeline</h2>
      <p>
        Towards the root of the time hierarchy is the document time source.
        A <dfn>document time source</dfn> is associated with a <a
        href="http://www.w3.org/TR/html51/dom.html#the-document-object">Document</a>
        [[HTML5]]
        object and provides a monotonically increasing time value that begins at
        zero when the Document <a>begins to play</a>.
      </p>
      <p>
        A document time source <dfn>begins to play</dfn> at the earliest of the
        following possible moments:
      </p>
      <ol>
        <li>When a call is made to <code>play</code> on the
            <a>DocumentTimeSource</a>.</li>
        <li>The moment immediately prior to dispatching the "load" event of the
            document with which it is associated if the <code>autoplay</code>
            attribute on the <a>DocumentTimeSource</a> is <code>true</code> at
            that moment.
            <p>
              For HTML documents, this is the moment after the <a
              href="http://www.w3.org/TR/html51/dom.html#current-document-readiness
              ">current document readiness</a> has changed to "complete" but
              before dispatching the load event.
              In terms of the timings defined in [[NAVIGATION-TIMING]], this
              occurs between the <em>domComplete</em> and
              <em>loadEventStart</em> timings.
            </p>
        <li>When the <code>autoplay</code> attribute is made newly
            <code>true</code> at a moment after opportunity 2.</li>
      </ol>
      <p>
        Before a document time source <a>begins to play</a>, its <a>current time
        value</a> is <code>null</code>.
        Once a document time source has <a title="begins to play">begun to
        play</a> its immediate time value is zero and from that point onwards it
        reports the number of seconds since it <a title="begins to play">began
        to play</a> subject to the constraints on updating the time value in <a
        href="#interaction-with-script" class="sectionRef"></a>.
      </p>
      <p>
        Once a document time source has begun to play it cannot be restarted or
        paused and continues to be non-<code>null</code> for the remainder of
        its lifetime.
      </p>
      <section>
        <h3>The <a>DocumentTimeSource</a> interface</h3>
        <dl title="interface DocumentTimeSource : TimeSource" class="idl">
          <dt>attribute boolean autoplay</dt>
          <dd>
            <p>
              Indicates if the document time source should <a title="begins to
              play">begin to play</a> automatically at the moment immediately
              before the "load" event is fired.
              Initially <code>true</code>.
            </p>
          </dd>
          <dt>void play ()</dt>
          <dd>
            If the document time source has not already <a title="begins to
            play">begun to play</a> causes it to begin immediately.
          </dd>
          <dt>double? toDocumentTime (double documentTime,
                                      DocumentTimeSource other)</dt>
          <dd>
            <p>
              Returns the time value from another <a>DocumentTimeSource</a>,
              <em>other</em>, converted to a time value relative to the when
              this document time source began.
            </p>
            <p>
              Returns <code>null</code> if <em>documentTime</em> time represents
              a time earlier than when this document time source <a
              title="begins to play">began to play</a> or if this document time
              source has not yet begun to play.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <em>documentTime</em> is less than zero.
              </dd>
            </dl>
          </dd>
          <dt>double? toDocumentTime (Event event)</dt>
          <dd>
            <p>
              Returns the number of seconds between when <em>event</em> was
              fired and when this document time source began.
            </p>
            <p>
              Since the <code>timeStamp</code> attribute of the
              <code>Event</code> interface specified in [[DOM-LEVEL-3-EVENTS]]
              is not guaranteed to be monotonically increasing implementations
              SHOULD record alongside each event a suitable monotonically
              increasing timestamp that can be used to convert to an appropriate
              time value here.
            </p>
            <p>
              Returns <code>null</code> if the time of the event precedes when
              this document time source <a title="begins to play">began to
              play</a> or if this document time source has not yet begun to
              play.
            </p>
            <p class="issue">
              This might be deferred to a later version.
            </p>
          </dd>
          <dt>double? fromDocumentTime (double documentTime,
                                        TimeSource other)</dt>
          <dd>
            <p>
              Returns the corresponding time value for a given time source,
              <em>other</em>, for a time value relative to this document time
              source using the following procedure.
            </p>
            <ol>
              <li>Define the <dfn>parent time source</dfn> of time source A as
                  being the value of a <code>timeline</code> property on A if
                  such a property exists and refers to a <a>TimeSource</a>
                  object.</li>
              <li>Define an <dfn>ancestor time source</dfn> of time source A as
                  any time source that appears in the chain of parent time
                  sources constructed starting with the <a>parent time
                  source</a> of A and continuing with each subsequent parent
                  up to and including a document time source or until there are
                  no further parent time sources.</li>
              <li>Define a time source A as being <dfn>derived from another time
                  source</dfn> B if B is an <a>ancestor time source</a> of
                  A.</li>
              <li>Determine <var>local document time</var> as follows:
                <dl class="switch">
                  <dt>If <em>other</em> is not <a title="derived from another
                  time source">derived from</a> this document time source,</dt>
                  <dd>
                    <ol>
                      <li>
                        Let <var>remote document</var> be the document time
                        source that is an <a>ancestor time source</a> of
                        <em>other</em> if such a document time source exists.
                      </li>
                      <li>
                        If there is no such <var>remote document</var> raise
                        a <code>DOMException</code> of type
                        <code>HierarchyRequestError</code>.
                      </li>
                      <li>
                        Let <var>local document time</var> be the result of
                        calling <code>toDocumentTime(<em>documentTime</em>,
                        <var>remote document</var>)</code> on this object.
                      </li>
                    </ol>
                  </dd>
                  <dt>Otherwise,</dt>
                  <dd>
                    Let <var>local document time</var> be <em>documentTime</em>.
                  </dd>
                </dl>
              </li>
              <li>
                Calculate the <code>currentTime</code> of <em>other</em> by
                following the steps described <span
                class="todo">somewhere...</span>
              </li>
            </ol>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>HierarchyRequestError</code></dt>
              <dd>
                Raised if <em>other</em> does not have an <a>ancestor time
                source</a> that is a document time source object.
              </dd>
            </dl>
            <p class="issue">
              Is this needed? And is the automatic cross-document time source
              negotation required?
            </p>
          </dd>
        </dl>
        <p>
          As document time sources are associated with a Document object, the
          following extension is required to the Document interface defined in
          [[HTML5]].
        </p>
        <dl title="partial interface Document" class="idl">
          <dt>readonly attribute DocumentTimeSource timeline</dt>
          <dd>
            The <a>DocumentTimeSource</a> associated with the document.
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Timed items</h2>
      <p>
        In addition to time sources, the other actor in the Web Animations
        timing model is timed items.
      </p>
      <section class="informative">
        <h3>Relationship to time sources</h3>
        <p>
          The complement of time sources&mdash;which produce time
          values&mdash;is timed items, which consume time values.
          The time source from which a timed item receives time values is called
          its <em>timeline</em>.
        </p>
        <p>
          In the context of its timeline, each timed item is defined by an
          interval during which it is scheduled to be active.
        </p>
        <div class="figure">
          <img src="img/timeline.svg" width="600">
        </div>
        <p class="caption">
          At time <em>t</em> timed items A and B are active.
          Timed item C is no longer active.
          Timed item D has yet to begin and is not active.
        </p>
        <p>
          As well as being consumer of time values, timed items are also
          themselves time sources.
          After consuming a time value most timed values apply a transformation
          to the value and then pass it on as an <a>output time value</a>.
        </p>
      </section>
      <section class="informative">
        <h3>The active interval</h3>
        <p>
          The period that a timed item is scheduled to run is called the
          <dfn>active interval</dfn>.
          Each timed item has only one such interval.
        </p>
        <p>
          The lower bound of the active interval is determined by the
          <dfn>start time</dfn> of the timed item but may be shifted by
          a <dfn>start delay</dfn> on the timed item.
        </p>
        <p>
          The upper bound of the interval is determined by the <a>active
          duration</a>.
        </p>
        <p>
          The relationship between the <a>start time</a>, <a>start delay</a>,
          and <a href="#calculating-the-active-duration">active duration</a> is
          illustrated below.
        </p>
        <div class="figure">
          <img src="img/active-interval-examples.svg" width="600">
        </div>
        <p class="caption">
          Examples of the effect of the <a>start delay</a> on the endpoints of
          the <a>active interval</a>.<br>
          (a) A timed item with no delay; the start time and start of
          item are coincident.<br>
          (b) A timed item with a positive delay; the start of the
          item is deferred by the delay.<br>
          (c) A timed item with a negative delay; the start of the
          item is brought forward by the delay.
        </p>
      </section>
      <section>
        <h3>Local time and inherited time</h3>
        <div class="informative">
          <p>
            In Web Animations all times are relative to some point of reference.
            These different points of reference produce different <em>time
            spaces</em>.
          </p>
          <p>
            This can be compared to coordinate spaces as used in computer
            graphics.
            The zero time of a time space is analogous to the origin of
            a coordinate space.
          </p>
          <p>
            For example, since a timed item can specify its own start time, the
            time values produced by a timed item will be offset from those
            received from its time source.
            As a result we say that the timed item establishes a new time space
            which we call <em>local time</em> as illustrated below.
          </p>
          <div class="figure">
            <img src="img/local-time.svg" width="600">
          </div>
          <p class="caption">
            Inherited time and local time.<br>
            At time <var>t</var>, the inherited time is 2.5.<br>
            For timed item (a), the local time is 1.5.<br>
            For timed item (b), the local time is also 1.5 since local time is
            based on a timed item's start time only, and not on its start delay.
          </p>
          <p>
            From the point of a view of a given timed item we can talk about the
            following time spaces:
          </p>
          <dl>
            <dt><dfn>Inherited time space</dfn></dt>
            <dd>
              A time space that corresponds to the <a title="output time
              value">output time values</a> of the timed item's time source.
            </dd>
            <dt><dfn>Local time space</dfn></dt>
            <dd>
              A time space whose zero time is the start time of the timed item
              (plus any accumulated <a>time drift</a>&mdash;see <a
              href="#seeking-a-timed-item" class="sectionRef"></a>).
            </dd>
          </dl>
          <p>
            In addition to these time spaces we can also refer to the
            <dfn>document time space</dfn> which is equivalent to the
            <a>inherited time space</a> of the <a>DocumentTimeSource</a> of the
            <a
            href="http://www.w3.org/TR/html5/browsers.html#active-document">active
            document</a>.
          </p>
          <p>
            Furthermore, timed items that allow repeating introduce a further
            time space, <a>iteration time space</a> (see <a
            href="#repeating" class="sectionRef"></a>).
          </p>
        </div>
        <p>
          For a given timed item, the <dfn>inherited time</dfn> at a given
          moment is the value of the <dfn>output time value</dfn> of the time
          source. If no time source is associated with the timed item, the
          inherited time is <code>null</code>.
        </p>
        <p>
          From the point of view of the API, the <a>inherited time</a> is
          based on the first matching condition of the following:
        </p>
        <dl class="switch">
          <dt>If <code>timeline</code> is <code>null</code>,</dt>
          <dd>return <code>null</code>.</dd>
          <dt>If <code>timeline</code> has an attribute
              <code>outputTime</code>,</dt>
          <dd>return that value.</dd>
          <dt>Otherwise,</dt>
          <dd>Return <code>timeline.currentTime</code>.</dd>
        </dl>
        <p>
          For some calculations it is useful to be able to use zero when the
          <a>inherited time</a> is <code>null</code>. For this purpose we define
          the <dfn>effective inherited time</dfn> as the <a>inherited time</a>
          unless that value is <code>null</code> in which case the effective
          inherited time is zero.
        </p>
        <p>
          The normative definition of <a>local time</a> follows the definition
          of <a>time drift</a> and is found in <a
          href="#calculating-the-local-time" class="sectionRef"></a>.
        </p>
      </section>
      <section>
        <h3>Timed item states</h3>
        <div class="informative">
          <p>
            At given moment, a timed item may be described as being in one of
            several overlapping states.
            These states are only established for the duration of a single
            sample and are primarily a convenience for defining the behavior of
            events and various API methods.
          </p>
          <p>
            The different states are illustrated below.
          </p>
          <div class="figure">
            <img src="img/timed-item-states.svg" width="700">
          </div>
          <p class="caption">
            An example of the different states used for describing a timed item
            at a given time.
            Note that a timed item is considered to be in effect for all times
            inside the <a>active interval</a> as well as times outside the
            active interval where a <a>fill mode</a> is applied.
          </p>
          <p>
            These states and their useage within the model are summarised as
            follows:
          </p>
          <dl>
            <dt>scheduled</dt>
            <dd>
              The current time falls before the item's <a>active interval</a>.
              This state is only used in conjunction with the <em>active</em>
              state to define <em>current</em> timed items.
            </dd>
            <dt>active</dt>
            <dd>
              The current time falls inside the item's <a>active interval</a>.
              Transitions to and from the active state trigger timing events as
              defined in <a href="#timing-events" class="sectionRef"></a>.
            </dd>
            <dt>current</dt>
            <dd>
              The current time falls either before or inside the item's
              <a>active interval</a>.
              This state is used to determine which animations are returned from
              the <code>getCurrentAnimations</code> method defined on the
              <code>Document</code> and <code>Element</code> interfaces.
            </dd>
            <dt>in effect</dt>
            <dd>
              The current time falls either inside the item's <a>active
              interval</a> or outside the interval but at a time where the
              item's <a>fill mode</a> (see <a href="#fill-behavior"
              class="sectionRef"></a>) causes it to affect its target.
              Timed items only pass on an output time value to descendent timed
              items or animation effects when the item is in effect.
              At all other times, the output time of a timed item is
              <code>null</code>.
            </dd>
          </dl>
          <p>
            The normative definition of each of these states follows.
          </p>
        </div>
        <p>
          A timed item is <dfn>scheduled</dfn> if <em>either</em> of the
          following conditions is true:
        </p>
        <ol>
          <li>the timed item's <a>local time</a> is not <code>null</code> and is
              less than the item's <code>startDelay</code>, or</li>
          <li>the timed item has a parent time source (represented in the API by
              a non-null <code>timeline</code> attribute) which is
              a <a>scheduled</a> timed item.</li>
        </ol>
        <p>
          A timed item is <dfn>active</dfn> if <em>all</em> of the following
          conditions are met:
        </p>
        <ol>
          <li>the timed item's <a>local time</a> is not <code>null</code>,
              and</li>
          <li><a>local time</a> &ge; <code>startDelay</code>, and</li>
          <li><a>local time</a> &lt; <code>activeDuration</code>.</li>
        </ol>
        <p>
          A timed item is <dfn>current</dfn> if it is either <a>scheduled</a> or
          <a>active</a>.
        </p>
        <p>
          A timed item is <dfn>in effect</dfn> if its <a>active time</a> as
          calculated according to the procedure in <a
          href="#calculating-the-active-time" class="sectionRef"></a> is not
          <code>null</code>.
        </p>
      </section>
      <section>
        <h3>The <a>TimedItem</a> interface</h3>
        <p>
          Timed items are represented in the Web Animations API by the
          <a>TimedItem</a> interface.
        </p>
        <dl title="interface TimedItem : TimeSource" class="idl">
          <dt>attribute double startTime</dt>
          <dd>
            <p>
              The time which, when combined with the <code>startDelay</code>,
              defines the lower bound of the <a>active interval</a>.
              It is expressed in seconds in the <a>inherited time space</a>.
            </p>
            <p>
              When this item is the child of a sequence timing group, any
              previously set value for <code>startTime</code> is ignored and
              instead the value of this property is determined by the procedure
              defined in <a
              href="#the-start-time-of-children-of-a-sequence-timing-group"
              class="sectionRef"></a>.
              Furthermore, attempts to set this property will raise a
              <code>DOMException</code> of type <code>InvalidStateError</code>.
              If this item is later removed from the sequence timing group,
              any previously set value will be restored.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>InvalidStateError</code></dt>
              <dd>
                Raised on setting if this item is the child of a sequence
                timing group (see <a
                href="#the-start-time-of-children-of-a-sequence-timing-group"
                class="sectionRef"></a>).
              </dd>
            </dl>
          </dd>
          <dt>attribute double startDelay</dt>
          <dd>
            <p>
              The number of seconds which, when added to the timed item's
              <code>startTime</code>, defines the lower bound of the timed
              item's <a>active interval</a>.
            </p>
            <p>
              A non-normative description of the effect of this property on
              timing is given in <a href="#the-active-interval"
              class="sectionRef"></a>.
            </p>
          </dd>
          <dt>attribute unrestricted double activeDuration</dt>
          <dd>
            <p>
              The length in seconds of the <a>active interval</a>.
            </p>
            <p>
              Initially, this attribute will reflect the <a>intrinsic run-time
              active duration</a>.
              Changes to the model that cause the <a>intrinsic run-time active
              duration</a> to change are reflected in the value returned here.
            </p>
            <p>
              The <a>intrinsic run-time active duration</a> may be overridden by
              setting this attribute to any real number (see <a
              href="#calculating-the-active-duration" class="sectionRef"></a>).
            </p>
            <p>
              If the <a>zero run-time playback rate flag</a> is set, returns
              <code>Infinity</code>.
            </p>
            <p class="issue">
              How can you restore the active duration to reflecting the
              <a>intrinsic run-time active duration</a>?
              <code>resetActiveDuration</code>?
            </p>
            <p class="issue">
              Call this simply <code>duration</code>?
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised on setting if the value to set is a real number that is
                less than zero.
              </dd>
            </dl>
            <p class="issue">
              It might be simpler and more consistent to split out
              <code>defaultActiveDuration</code> and <code>activeDuration</code>
              here?<br>
              However, in this case <code>defaultActiveDuration</code> would not
              be overridable? i.e. readonly?
            </p>
          </dd>
          <dt>readonly attribute unrestricted double endTime</dt>
          <dd>
            <p>
              The upper bound of the <a>active interval</a> expressed in
              seconds relative to the <a>inherited time space</a> of
              <code>timeline</code>.
            </p>
            <div class="issue">
              <p>
                Should this reflect the run-time active interval or the default
                active interval? i.e. if you set <code>playbackRate</code> to
                2 should this change?
              </p>
              <p>
                It might be more useful to have to reflect the default active
                interval since <code>activeDuration</code> already reflects the
                run-time interval.
              </p>
              <p>
                If this reflects the default it should probably ignore the
                <code>timeDrift</code> and then we could remove the definition
                of the <a>default end time</a> defined in <a
                href="#the-intrinsic-duration-of-a-parallel-timing-group"
                class="sectionRef"></a>.
              </p>
            </div>
            <p>
              <code>endTime</code> is calculated as follows:
            </p>
            <dl class="switch">
              <dt>If <code>locallyPaused</code> is <code>true</code>,</dt>
              <dd>
                <code>endTime</code> is positive infinity.
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                <code>endTime</code> is the result of evaluating
                <code>startTime + startDelay +
                      activeDuration + timeDrift</code>.
              </dd>
            </dl>
            <p class="note">
              Note that while the <code>endTime</code> is read-only, it can be
              set indirectly by overriding the <code>activeDuration</code>
              property.
              For example, to set <code>endTime</code> to time <var>t</var> in
              <a>inherited time space</a>, set <code>activeDuration</code> to
              <code><var>t</var> - startTime - startDelay - timeDrift</code>.
            </p>
            <div class="issue">
              <p>
                Make this writeable?
                We could make it just do the above calculation and set
                <code>activeDuration</code>, the caveat being that setting
                <code>endTime</code> &lt; <code>startTime</code> would fail
                (even if the next line of code fixed <code>startTime</code> to
                make it valid).
              </p>
              <p>
                Alternatively we could allow <code>endTime</code> to be less
                than <code>startTime</code> and add logic to ignore such
                intervals elsewhere.
              </p>
            </div>
          </dd>
          <dt>readonly attribute TimeSource? timeline</dt>
          <dd>
            <p>
              The time source upon which this timed item's timing is based.
              The <a title="output time value">output time values</a> of
              this time source provide the <a>inherited time space</a> for this
              timed item.
            </p>
            <p>
              May be <code>null</code> if this timed item is not associated with
              a time source.
              Animations without a time source do not affect their target.
            </p>
            <p class="issue">
              Is this right? It's probably useful to be able to put animations
              in a state where they have no effect on their target such as when
              calling <code>cancel</code>.
              Should we just set <code>target</code> to <code>null</code>
              in that case?
            </p>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Playback control: seeking, pausing and cancelling</h2>
      <div class="informative">
        <p>
          As well as scheduling timed items to run for a given interval, it is
          possible to make adjustments to their playback as they run by seeking
          their current position, pausing and resuming, and disabling the
          animation outright.
        </p>
      </div>
      <section>
        <h3>Seeking a timed item</h3>
        <div class="informative">
          <p>
            Changing the current playback position of a timed item can be used
            to rewind a timed item to its start point, fast-forward to a point
            in the future, or to provide ad-hoc synchronization between items.
          </p>
          <p>
            Seeking a timed item effectively creates an additional offset
            between the item and its time source.
            This offset is called the <em>time drift</em> and is illustrated
            below.
          </p>
          <div class="figure">
            <img src="img/seeking.svg" width="600">
          </div>
          <p class="caption">
            A time <var>t</var> a seek is performed on animation A changing its
            local time from 1.5s to 2s.
            As a result animation A&prime; has a <em>time drift</em> of
            -0.5s.<br>
            Note that the start time indicated by a red star does not change
            since it is expressed in <a>inherited time space</a>.
          </p>
          <p>
            Timed items that do not have a time source may still be seeked.
            If they are later attached to a time source they will resume
            playback from the seeked time.
          </p>
          <p>
            The normative description for seeking must account for pausing (see
            <a href="#pausing-a-timed-item" class="sectionRef"></a>) as well as
            follows. 
          </p>
        </div>
        <p>
          In order to supporting seeking and pausing, timed items track the
          following three values:
        </p>
        <dl>
          <dt><dfn>time drift</dfn></dt>
          <dd>The offset between a timed item's scheduled time and actual local
              time caused by seeking and pausing.
              Initially zero.
              Exposed in the API as <code>timeDrift</code>.
          </dd>
          <dt><dfn>pause start time</dfn></dt>
          <dd>The local time when the item was paused.
              Initially zero.
              Not exposed in the API.
          </dd>
          <dt><dfn>local pause state</dfn></dt>
          <dd>A boolean flag for indicated if this item has been directly paused
              as opposed to being <em>effectively</em> paused due to an ancestor
              time source being paused.
              Initially false.
              Exposed in the API as <code>locallyPaused</code>.
          </dd>
        </dl>
        <p>
          Seeking is performed in response to a change to a timed item's
          <code>currentTime</code> attribute and is realised by adjusting the
          <em>time drift</em> or the <em>pause start time</em> of the item as
          follows:
        </p>
        <ol>
          <li>Let <var>seek time</var> be the new value to which
              <code>currentTime</code> should be set.</li>
          <li>The steps for adjusting the local time depend on the state of the
              <a>local pause state</a> as follows:
            <dl class="switch">
              <dt>If the <a>local pause state</a> is true,</dt>
              <dd>
                Set <a>pause start time</a> to <var>seek time</var>.
              </dd>
              <dt>If the <a>local pause state</a> is false,</dt>
              <dd>
                Set the stored value for the <a>time drift</a> to
                the result of evaluating
                <code><a>effective inherited time</a> - startTime -
                      <var>seek time</var></code>.
              </dd>
            </dl>
          </li>
        </ol>
        <p>
          The animation events dispatched when a seek is performed are described
          in <a href="#event-dispatch-during-seeking" class="sectionRef"></a>.
        </p>
      </section>
      <section>
        <h3>Pausing a timed item</h3>
        <div class="informative">
          <p>
            Pausing can be used to temporarily suspend a timed item.
            Like seeking, pausing effectively causes the local time of a timed
            item to be offset from its time source and hence causes the <em>time
            drift</em> to be updated.
          </p>
          <p>
            Pausing before a timed item begins will cause the item to begin
            in a paused state but does not delay its start as illustrated below.
          </p>
          <div class="figure">
            <img src="img/pausing.svg" width="600">
          </div>
          <p class="caption">
            The effect on pausing a timed item at different moments.<br>
            Timed item A is paused and unpaused before it would otherwise begin.
            The pause has no effect.<br><br>
            Timed item B is paused before it would begin and remains paused.
            At the schedule start time item B begins playing in a paused state.
            When it is unpaused it continues playing.
            The resulting timed item has a time drift equivalent to the interval
            from the start time to when the item was unpaused.<br><br>
            Timed item C is paused and unpaused during its active interval.
            After unpausing timed item has a time drift equivalent to the
            duration of the pause interval.
          </p>
        </div>
        <section>
          <h4>Updating the local pause state</h4>
          <p>
            The procedure for updating the <a>local pause state</a> is as
            follows:
          </p>
          <ol>
            <li>
              Let <var>new value</var> be the new local pause state to set.
            </li>
            <li>
              If <var>new value</var> equals <a>local pause state</a>,
              return.
            </li>
            <li>
              The next step depends on the current <a>local pause state</a> as
              follows,
              <dl class="switch">
                <dt>If <a>local pause state</code> is true,</dt>
                <dd>
                  Set the <em>stored</em> value of <a>time drift</a> to the
                  <em>current calculated</em> value of <a>time drift</a> as
                  defined in <a href="#calculating-the-time-drift"
                  class="sectionRef"></a>.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  Record the current value of <code>currentTime</code> as
                  <a>pause start time</a>.
                </dd>
              </dl>
            </li>
            <li>
              Update <a>local pause state</a> to <var>new value</var>.
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the time drift</h4>
          <p>
            The <a>time drift</a> value is both a stored and a
            calculated value.
            When a timed item is paused, the value is calculated from the
            <a>pause start time</a>.
            When a timed item is not paused, the stored value is used.
            The stored value is initially zero, and is updated when the item
            is unpaused or seeked.
          </p>
          <p>
            Since pausing does not take effect prior to when a timed item
            begins, we first define the beginning of a timed item for the
            purposes of pausing as a timed item's <em>earliest moment</em>.
            The calculation is as follows:
          </p>
          <blockquote>
            <dfn>earliest moment</dfn> = <code>min(0, startDelay)</code>
          </blockquote>
          <p>
            Using this definition we can define the value of <a>time drift</a>
            at a given moment as follows:
          </p>
          <dl class="switch">
            <dt>If the <a>local pause state</a> is true or
                the <a>zero run-time playback rate flag</a> is true,</dt>
            <dd>
              Return the result of 
              <code><a>effective inherited time</a> - startTime -
              max(<a>pause start time</a>, <a>earliest moment</a>)</code>.
            </dd>
            <dt>Otherwise,</dt>
            <dd>
              Return the stored value for this property.
            </dd>
          </dl>
        </section>
        <section>
          <h4>Calculating the local time</h4>
          <p>
            Having defined the <a>time drift</a> we can now define <a>local
            time</a> as described in <a href="#local-time-and-inherited-time"
            class="sectionRef"></a>.
          </p>
          <blockquote>
            <dfn>local time</dfn> =
              <code><a>inherited time</a> - startTime - <a>time drift</a></code>
          </blockquote>
          <p>
            If either <a>inherited time</a> is <code>null</code>, the local time
            is <code>null</code>.
          </p>
        </section>
      </section>
      <section>
        <h3>Cancelling a timed item</h3>
        <div class="informative">
          <p>
            During playback it is sometimes useful to completely disable a timed
            item such that it has no effect.
            This is achieved by disassociating the timed item from its time
            source.
          </p>
        </div>
        <p>
          The procedure for cancelling a timed item is as follows:
        </p>
        <ol>
          <li>If the timed item's <code>timeline</code> attribute is
              <code>null</code>, return immediately.</li>
          <li>Record the current <a>inherited time</a> as <var>local
              time</var>.</li>
          <li>Record the current <a>document time</a> as <var>document
              time</var>.</li>
          <li>Record the <a>current iteration</a> as <var>iteration
              index</var>.</li>
          <li>If <code>timeline</code> is a timing group,
              remove this timed item from the group and set
              <code>timeline</code> to <code>null</code>.
              Otherwise simply set <code>timeline</code> to <code>null</code>.
              In either case, do not dispatch a <em>timingend</em> event on this
              timed item or any of its descendents.
          <li>Dispatch a <em>timingcancel</em> event at this timed item and
              its descendents using the stored values for
              <var>local time</var>, <var>document time</var>, and
              <var>iteration index</var>.</li>
        </ol>
      </section>
      <section>
        <h3>Playback control interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Playback control members</dt><dd></dd>
          <dt>inherit attribute double? currentTime</dt>
          <dd>
            <p>
              Returns the <a>effective local time</a> of the timed item.
            </p>
            <p>
              This differs from the definition of <a>local time</a> used
              elsewhere in the model in that when the <a>inherited time</a> time
              is <code>null</code> (e.g. because <code>timeline</code> is
              <code>null</code>, or because the timeline has a <code>null</code>
              time value) an inherited time of zero is used.
              This allows the item to be seeked prior to being attached to
              a time source.
            </p>
            <p>
              The value returned is calculated as follows:
            </p>
            <blockquote>
              <code>currentTime =
                    <a>effective inherited time</a> - startTime
                    - timeDrift</code>
            </blockquote>
            <p>
              Note that unlike the <code>currentTime</code> attribute on
              the <a>TimeSource</a> interface, this attribute can be set.
              Setting this property performs a seek operation according to the
              steps described in described in <a href="#seeking-a-timed-item"
              class="sectionRef"></a>.
            </p>
            <p>
              Furthermore, as a result of the definition above, for
              <a>TimedItem</a> objects this property will never be
              <code>null</code>.
              Attempts to set this property to <code>null</code> will result in
              a <code>DOMException</code> of type
              <code>InvalidModificationError</code> being thrown.
            </p>
            <p class="note">
              Note that the <code>currentTime</code> property is not actually
              set directly but is updated to the seek time as a result of the
              performing the calculation above using the updated
              <code>timeDrift</code> established using the procedure described
              in <a href="#seeking-a-timed-item" class="sectionRef"></a>.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type
                  <code>InvalidModificationError</code></dt>
              <dd>
                Raised when attempting to set this attribute to
                <code>null</code>.
              </dd>
            </dl>
          </dd>
          <dt>readonly attribute double timeDrift</dt>
          <dd>
            <p>
              The number of seconds that the actual <a>local time</a> of this
              item lags behind its scheduled time as a result of pausing and
              seeking this item.
            </p>
            <p>
              The calculation of the <a>time drift</a> is described in <a
              href="#calculating-the-time-drift" class="sectionRef"></a>.
            </p>
            <div class="issue">
              This should either be writeable or at least reset-able (e.g.
              <code>resetDrift()</code>).
            </div>
          </dd>
          <dt>attribute boolean locallyPaused</dt>
          <dd>
            <p>
              The <a>local pause state</a> of this timed item.
            </p>
            <p>
              The behavior when setting this value is described in <a
              href="#updating-the-local-pause-state" class="sectionRef"></a>.
            </p>
            <p class="issue">
              Should this be writeable?
              Once we integrate with media controllers we might want to make
              this writeable only when not associated with a media controller
              much like things currently work in HTML5.
            </p>
            <p class="issue">
              This attribute is at-risk.
              It remains to be seen if really needs to be exposed, or if
              <code>pause()</code>, <code>play()</code>, and
              <code>unpause()</code> are sufficient for most use cases.
            </p>
          </dd>
          <dt>readonly attribute boolean paused</dt>
          <dd>
            Indicates if this element or one of its ancestors is paused.
            This will be <code>true</code> if and only if the
            <a>local pause state</a> of at least one of this item <em>or one of
            its ancestor timed items</em> is true.
            <p class="issue">
              We really want to say <em>ancestor time sources</em> here but time
              sources don't have pause state.
            </p>
          </dd>
          <dt>void pause ()</dt>
          <dd>
            Sets the <a>local pause state</a> to <code>true</code> by
            following the procedure described in <a
            href="#updating-the-local-pause-state" class="sectionRef"></a>.
            <p class="annotation">
              This method is intended to behave in a comparable manner to
              <a
              href="http://dev.w3.org/html5/spec/media-elements.html#media-elements">HTMLMediaElement</a>'s <a
              href="http://dev.w3.org/html5/spec/media-elements.html#dom-media-pause">pause
              method</a>.
            </p>
          </dd>
          <dt>void play ()</dt>
          <dd>
            <p>
              Unpauses this item and, if the local time of the item is not
              within the <a>active interval</a>, seeks to the beginning of the
              <a>active interval</a> by taking the following steps.
            </p>
            <ol>
              <li>If <code>currentTime &gt; startDelay
                  + activeDuration</code> and
                  <code>playbackRate &ge; 0</code>, seek to
                  <code>startDelay</code> following the procedure described in
                  <a href="#seeking-a-timed-item" class="sectionRef"></a>.</li>
              <li>Set the <a>local pause state</a> to <code>false</code> using
                  the procedure described in <a
                  href="#updating-the-local-pause-state"
                  class="sectionRef"></a>.</li>
            </ol>
            <p>
              To unpause the item without seeking, set
              <code>locallyPaused</code> to <code>false</code>.
            </p>
            <p class="annotation">
              This method is intended to behave in a comparable manner to
              <a
              href="http://dev.w3.org/html5/spec/media-elements.html#media-elements">HTMLMediaElement</a>'s <a
              href="http://dev.w3.org/html5/spec/media-elements.html#dom-media-play">play
              method</a>.
            </p>
          </dd>
          <dt>void cancel ()</dt>
          <dd>
            <p>
              Disassociates this timed item from its <a>TimeSource</a>
              (represented by <code>timeline</code>).
              As a result, if the timed item or its children are
              <a>Animation</a> objects, they will no longer affect their target
              elements.
            </p>
            <p>
              The procedure for cancelling a timed item is defined in <a
              href="#cancelling-a-timed-item" class="sectionRef"></a>.
            </p>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Fill behavior</h2>
      <div class="informative">
        <p>
          Outside of the <a>active interval</a>, a timed item may still have an
          effect depending on its <dfn>fill mode</dfn>.
        </p>
      </div>
      <section class="informative">
        <h3>Fill modes</h3>
        <p>
          The different fill modes are as follows:
        </p>
        <dl>
          <dt>none</dt>
          <dd>
            The timed item has no effect outside of the <a>active interval</a>.
          </dd>
          <dt>forwards</dt>
          <dd>
            For times that occur later than the <a>active interval</a>, the
            timed item will continue to produce the same <a>output time
            value</a> that was used at the end of the <a>active interval</a>.

            For times that occur before the <a>active interval</a>, the
            timed item will have no effect.
          </dd>
          <dt>backwards</dt>
          <dd>
            For times that occur before the <a>active interval</a>, the
            timed item will produce the same <a>output time value</a> that
            will be used at the start of the <a>active interval</a>.

            For times that occur later than the <a>active interval</a>, the
            timed item will have no effect.
          </dd>
          <dt>both</dt>
          <dd>
            For times that occur before the <a>active interval</a>, the
            backwards fill behavior is used.

            For times that occur after the <a>active interval</a>, the
            forwards fill behavior is used.
          </dd>
        </dl>
        <p>
          Some examples of the these fill modes are illustrated below.
        </p>
        <div class="figure">
          <img src="img/animation-state-and-fill-behavior.svg" width="600">
        </div>
        <p class="caption">
          Examples of various fill modes and the states produced.<br>
          (a) fill mode &lsquo;none&rsquo;. The timed item has no effect outside
              its active interval.<br>
          (b) fill mode &lsquo;forwards&rsquo;. After the active interval has
              finished, the timed value continues to maintain a fill value.<br>
          (c) fill mode &lsquo;backwards&rsquo;. The timed item produces a fill
              value until the start of the active interval.<br>
          (d) fill mode &lsquo;both&rsquo;. Both before and after the active
              interval the timed item produces a fill value.
        </p> 
        <p>
          The normative definition of fill behavior is incorporated in the
          calculation of the <a>active time</a> in <a
          href="#calculating-the-active-time" class="sectionRef"></a>.
        </p>
        <p class="note">
          Note that setting a fill mode has no bearing on the endpoints of the
          <a>active interval</a>.
          However, the fill mode <em>does</em> have an effect on various other
          properties of the timing model since the <a>active time</a> of a timed
          item is only defined (that is, not <code>null</code>) inside the
          <a>active interval</a> <em>or</em> when a fill is applied.
        </p>
      </section>
      <section>
        <h3>The <code>FillMode</code> enumeration</h3>
        <dl title="enum FillMode" class="idl">
          <dt>none</dt>
          <dd>
            No fill.
          </dd>
          <dt>forwards</dt>
          <dd>
            Fill forwards.
          </dd>
          <dt>backwards</dt>
          <dd>
            Fill backwards.
          </dd>
          <dt>both</dt>
          <dd>
            Fill backwards and forwards.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Fill control interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Fill control members</dt><dd></dd>
          <dt>attribute FillMode fillMode</dt>
          <dd>
            <p>
              The <a>fill mode</a> as specified by one of the <a>FillMode</a>
              enumeration values.
            </p>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Repeating</h2>
      <section class="informative">
        <h3>Iteration intervals</h3>
        <p>
          It is possible to specify that a timed item should repeat
          a fixed number of times or even indefinitely.
          This repetition occurs <em>within</em> the <a>active interval</a>.
          The span of time during which a single repetition takes place is
          called an <dfn>iteration interval</dfn>.
        </p>
        <p>
          Unlike the <a>active interval</a>, a timed item can have multiple
          <a>iteration interval</a>s although typically only the interval
          corresponding to the <a>current iteration</a> is of interest.
        </p>
        <p>
          The length of a single iteration is called the <a>iteration
          duration</a>. Comparing the <a>iteration duration</a> and the
          <a href="#calculating-the-active-duration">active duration</a> we
          have:
        </p>
        <dl>
          <dt>Iteration duration</dt>
          <dd>
            The time taken for a single iteration of the timed item to complete.
          </dd>
          <dt>Active duration</dt>
          <dd>
            The time taken for the entire timed item to complete, including
            repetitions.
            This may be longer or shorter than the <a>iteration duration</a>.
          </dd>
        </dl>
        <p>
          The relationship between the <a>iteration duration</a> and
          <a href="#calculating-the-active-duration">active duration</a> is
          illustrated below.
        </p>
        <div class="figure">
          <img src="img/iteration-intervals.svg" width="600">
        </div>
        <p class="caption">
          A comparison of the iteration and active durations for a timed item
          with an iteration count of 2.5.
          Note that the iteration duration for the final iteration does not
          change, it is simply cut-off by the active duration.
        </p>
      </section>
      <section class="informative">
        <h3>Iteration time space</h3>
        <p>
          We have already encountered different time spaces in describing
          <a>local time and inherited time</a>.
          Repetition introduces yet another time space: the iteration time
          space.
        </p>
        <p>
          <dfn>Iteration time space</dfn> is a time space whose zero time is the
          beginning of a timed item's current iteration.
        </p>
        <p>
          Within the Web Animations model we also refer to <dfn>active
          time</dfn> which is a time relative to the beginning of the active
          interval.
          This time space, however, is not used in the API.
        </p>
        <p>
          These time spaces are illustrated below.
        </p>
        <div class="figure">
          <img src="img/time-spaces.svg" width="600">
        </div>
        <p class="caption">
          A comparison of item time, active time, and iteration time for an
          animation with a iteration duration of 1s and an iteration count of
          2.5.
        </p>
        <p class="note">
          Note that while the time spaces themselves are not bounded, Web
          Animations defines <a>active time</a> and <a>iteration
          time</a> such that they are clamped to a set range as shown in the
          diagram.
          For example, whilst a time of -1 second is a valid time in
          <a>active time space</a>, the procedure for calculating the
          <a>active time</a> defined in <a
          href="#calculating-the-active-time" class="sectionRef"></a> will
          never return a negative value.
        </p>
        <p>
          In addition to these time spaces we can also refer to the
          <dfn>document time space</dfn> which is equivalent to the <a>local
          time</a> of the <a>DocumentTimeSource</a> of the <a
          href="http://www.w3.org/TR/html5/browsers.html#active-document">active
          document</a>.
        </p>
      </section>
      <section class="informative">
        <h3>Interval timing</h3>
        <p>
          When a timed item repeats we must define the behavior at the iteration
          boundaries.
          For this and indeed for all interval-timing, Web Animations uses an
          endpoint-exclusive timing model.
          This means that whilst the begin time of an interval
          is included in the interval, the end time time is not.
          In interval notation this can written <code>[begin,end)</code>.
          This model provides sensible behavior when intervals are repeated and
          sequenced since there is no overlap between the intervals.
        </p>
        <p>
          In the examples below, for the repeated item, at local time 1s,
          the iteration time is 0.
          For the sequenced items, at inherited time 1s, only item B will be
          <a>active</a>; there is no overlap.
        </p>
        <div class="figure">
          <img src="img/endpoint-exclusive-timing.svg" width="600">
        </div>
        <p class="caption">
          Illustration of end-point exclusive timing. For both repeated and
          sequenced timed items there is no overlap at the boundaries between
          intervals.
        </p>
        <p>
          An exception to this behavior is that when performing a <a
          href="#fill-behavior">fill</a>, if the fill begins at an
          interval endpoint, the endpoint is used.
          This behavior falls out of the algorithm given in <a
          href="#calculating-the-iteration-time"
          class="sectionRef"></a> and is illustrated below.
        </p>
        <div class="figure">
          <img src="img/endpoint-exclusive-timing-and-fill.svg" width="600">
        </div>
        <p class="caption">
          After one iteration, the iteration time is 0, but after two iterations
          (and thereonwards), the iteration time is equal to the iteration
          duration due to the special behavior defined when a timed item fills.
        </p>
      </section>
      <section>
        <h3>Iteration control interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Iteration control members</dt><dd></dd>
          <dt>attribute double iterationStart</dt>
          <dd>
            <p>
              A finite real number greater than or equal to zero representing
              the number of iterations into the timed item at which to begin.
              For example, a value of 0.5 would cause the timed item to begin
              half-way through the first iteration.
            </p>
            <p>
              The <code>iterationCount</code> is effectively <em>added</em> to
              the <code>iterationStart</code> such that a timed item with an
              <code>iterationStart</code> of &lsquo;0.5&rsquo; and
              <code>iterationCode</code> of &lsquo;2&rsquo; would still
              repeat twice however it would begin and end half-way through
              the timed item's <a>iteration interval</a>.
            </p>
            <p>
              Setting the <code>iterationStart</code> to a value greater than
              or equal to one is typically only useful in combination with an
              animation effect that has an <code>accumulateOperation</code>
              other than &lsquo;replace&rsquo;.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised on setting if the value to set is a real number less
                than zero.
              </dd>
            </dl>
          </dd>
          <dt>attribute unrestricted double iterationCount</dt>
          <dd>
            <p>
              A real number greater than or equal to zero (including positive
              infinity) representing the number of times to repeat the
              timed item.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised on setting if the value to set is a real number less
                than zero.
              </dd>
            </dl>
          </dd>
          <dt>attribute unrestricted double iterationDuration</dt>
          <dd>
            <p>
              The duration in seconds of a single iteration.
              Unless set, this will reflect the <a>intrinsic iteration
              duration</a> of the timed item.
              If set, it must be greater than or equal to zero (including
              positive infinity).
            </p>
            <p>
              After setting, this attribute can be restored to reflecting the
              <a>intrinsic iteration duration</a> of the timed item by calling
              <code>resetIterationDuration</code>.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised on setting if the value to set is a real number less
                than zero.
              </dd>
            </dl>
            <p class="issue">
              This used to be called <code>duration</code> for consistency with
              CSS and SVG.
              Which is better?
            </p>
          </dd>
          <dt>readonly attribute unsigned long? currentIteration</dt>
          <dd>
            The current iteration index beginning with zero for the first
            iteration as described in <a
              href="#calculating-the-current-iteration" class="sectionRef"></a>.
          </dd>
          <dt>unrestricted double resetIterationDuration()</dt>
          <dd>
            <p>
              Causes the <code>iterationDuration</code> attribute to reflect the
              <a>intrinsic iteration duration</a> of the timed item, discarding
              any previously set value for the attribute.
            </p>
            <p>
              Returns the <a>intrinsic iteration duration</a> of the timed item.
            </p>
          </dd>
        </dl>
        <p class="annotation">
          In future we may introduce <code>iterationTime</code> which
          corresponds to the <code>outputTime</code> prior to applying time
          transformations.
          The advantage of exposing this is that it could be writeable since the
          transformation from iteration time to local time should be invertible.
          It is also probably the time we will use for <a>TimingEvent</a> times.
        </p>
      </section>
    </section>

    <section>
      <h2>Speed control</h2>
      <section>
        <h3>Speed control parameters</h3>
        <div class="informative">
          <p>
            The rate of play of a timed item can be controlled by setting its
            <em>playback rate</em>.
            For example, setting a playback rate of 2 will cause the item to run
            twice as fast.
            Likewise, a playback rate of -1 will cause the item to run
            backwards.
          </p>
          <p>
            The playback rate is applied only to the <a>active interval</a> of
            a timed item and not to the time while it is delayed or filling.
          </p>
          <p>
            Setting a negative playback rate also has the effect of inverting
            the <a>fill mode</a>.
          </p>
          <p>
            There are two side of effects of changing the playback rate of
            a timed item that may be unexpected.
          </p>
          <ul>
            <li>Changing the playback rate of an item in play can cause it to
                jump in position.
                For example, doubling the playback rate of an item that is
                a quarter of the way through its <a>active interval</a> will
                cause it to jump to the half-way point.</li>
            <li>Changing the playback rate of an item can change its
                <a>default active duration</a>.
                For example, doubling the playback rate of an item with an
                active interval that usually takes 3 seconds will make the
                active interval 1.5 seconds.
                This can cause knock-on effects if other timed items depend on
                this timed item's duration such as other children of a sequence
                timing group.</li>
          </ul>
          <p>
            Since sometimes these side effects are undesirable Web Animations
            provides two means for controlling a timed item's playback rate.
          </p>
          <dl>
            <dt>Default playback rate</dt>
            <dd>
              A static parameter to the model that exhibits the side effects
              described above.
              This is the parameter used to calculate a timed item's
              <a>default active duration</a> and for scheduling the children
              of a timing group.
              It is also the most suitable parameter for serializing and is the
              only parameter copied when cloning.
            </dd>
            <dt>Run-time playback rate</dt>
            <dd>
              An override parameter used to adjust the playback rate without
              affecting the <a>default active duration</a>.
            </dd>
          </dl>
          <p class="annotation">
            These parameters and the corresponding API attributes are intended
            to parallel (somewhat imprecisely) the attributes on the
            <code>HTMLMediaElement</code> interface.
          </p>
        </div>
        <p>
          In order to support speed control, timed items track the following
          three values:
        </p>
        <dl>
          <dt><dfn>default playback rate</dfn></dt>
          <dd>
            A real number that acts as a multiplier on the item's rate of
            play.
            Initially 1.
            Exposed in the API as <code>defaultPlaybackRate</code>.
          </dd>
          <dt><dfn>run-time playback rate</dfn></dt>
          <dd>
            An additional rate of play that, when defined, overrides the default
            playback rate for the purposes of calculating the <a>iteration
            time</a>.
            Initially undefined.
            Not exposed in the API.
          </dd>
          <dt><dfn>zero run-time playback rate flag</dfn></dt>
          <dd>
            A flag to indicate special pause-like behavior is to be employed due
            to setting <code>playbackRate</code> to zero.
            Initially false.
            Not exposed in the API.
          </dd>
        </dl>
        <p>
          In addition, we define the <a>effective run-time playback rate</a> as
          follows:
        </p>
        <blockquote>
          The value of the <dfn>effective run-time playback rate</dfn> is the
          <a>run-time playback rate</a> if it is defined.
          If the <a>run-time playback rate</a> the value of the effective
          run-time playback rate is that of the <a>default playback rate</a>.
        </blockquote>
        <p>
          Setting a negative playback rate has the effect of inverting a timed
          item's <a>fill mode</a> and hence we define the <dfn>effective fill
          mode</dfn> as follows:
        </p>
        <dl class="switch">
          <dt>If the <a>effective run-time playback rate</a> is &ge; 0,</dt>
          <dd>
            return the value of <code>fillMode</code>.
          </dd>
          <dt>Otherwise,
          <dd>
            the result depends on the value of <code>fillMode</code> as follows,
            <dl class="switch">
              <dt>If <code>fillMode</code> is <code>forwards</code>,</dt>
              <dd>
                return <code>backwards</code>.
              </dd>
              <dt>If <code>fillMode</code> is <code>backwards</code>,</dt>
              <dd>
                return <code>forwards</code>.
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                return <code>fillMode</code>.
              </dd>
            </dl>
          </dd>
        </dl>
      </section>
      <section>
        <h3>Performing run-time speed control</h3>
        <p>
          The following procedure adjusts the <a>run-time playback rate</a>
          to <var>new rate</var> whilst maintaining the current <a>scaled
          active time</a>.  If the current <a>local time</a> is outside the
          active interval the distance from the interval is scaled according to
          the change in speed.
        </p>
        <div class="annotation">
          <p>
            Special handling is required for when the run-time playback rate is
            zero.
            Intuitively, this should pause the timed item at its current
            position however the way the model is designed that will not
            happen.
            Instead, the active duration will become infinite and the item will
            effectively jump back to the start position.
          </p>
          <p>
            We work around that by providing special handling for when the
            run-time playback rate is zero.
            This handling consists of the following strategy:
          </p>
          <ul>
            <li>When setting the <code>playbackRate</code> to zero, record the
                time as the pause time and basically employ pause behavior.
                Don't actually update the playback rate in this case.</li>
            <li>Set a flag <em>zero run-time playback rate</em>.</li>
            <li>When reporting the <code>activeDuration</code> report
                <code>Infinity</code> when <em>zero run-time playback rate</em>
                is set.</li>
            <li>When reporting the <code>playbackRate</code> report
                <code>0</code> when <em>zero run-time playback rate</em>
                is set.</li>
          </ul>
        </div>
        <ol>
          <li>Let <var>previous rate</var> be the value of
              <a>effective run-time playback rate</a> prior to making any
              changes.</li>
          <li>Perform the steps corresponding to the first matching condition of
              the following.
              <dl class="switch">
                <dt>If <var>new rate</var> is zero,</dt>
                <dd>
                  Set the <a>zero run-time playback rate flag</a> to true.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  <ol>
                    <li>Update <a>run-time playback rate</a> to <var>new
                        rate</var>.</li>
                    <li>Set the <a>zero run-time playback rate flag</a> to
                        false.</li>
                  </ol>
                </dd>
              </dl></li>
          <li>Perform the steps corresponding to the first matching condition
              of the following.
            <dl class="switch">
              <dt>If <var>previous rate</var> is zero,</dt>
              <dd>
                Perform a seek to <a>pause start time</a> using the procedure
                described in <a href="#seeking-a-timed-item"
                class="sectionRef"></a>.
              </dd>
              <dt>If <var>new rate</var> is zero,</dt>
              <dd>
                Set <a>pause start time</a> to the current value of
                <code>currentTime</code>.
              </dd>
              <dt>If <a>local time</a> is <code>null</code>,</dt>
              <dd>
                Return immediately.
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                <ol>
                  <li>Re-calculate the value of the <a>run-time active
                      duration</a>.</li>
                  <li>Calculate the <var>seek adjustment</var> according to the
                      following formula:
                      <code><var>seek adjustment</var> =
                      (<a>local time</a> - <code>startDelay</code>) *
                      (1 - <var>previous rate</var> / <var>new
                      rate</var>)</code>.  </li>
                  <li>If the sign of <var>new rate</var> and <var>previous
                      rate</var> differs, subtract from <span
                      class="todo"><var>seek adjustment</var> (is that right?
                      a word seemed to be missing from this sentence)</span> the
                      updated value of the <a>run-time active duration</a>.</li>
                  <li>Let <var>seek time</var> be the result of the following
                      formula:
                      <code><a>item time</a>
                        - <var>seek adjustment</var></code>.</li>
                  <li>Seek to <var>seek time</var> using the procedure defined
                      in <a href="#seeking-a-timed-item"
                      class="sectionRef"></a>.</li>
                </ol>
              </dd>
            </dl>
          </li>
        </ol>
      </section>
      <section>
        <h3>Speed control interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Speed control members</dt><dd></dd>
          <dt>attribute double defaultPlaybackRate</dt>
          <dd>
            <p>
              A real number that acts as a multiplier on the item's rate of
              play.
              This attribute reflects the <a>default playback rate</a> value
              described in <a href="#speed-control-parameters"
              class="sectionRef"></a>. 
            </p>
            <p>
              The <code>playbackRate</code> attribute, when set, explicitly
              overrides this attribute for the purpose of calculating the
              <a>iteration time</a>.
            </p>
          </dd>
          <dt>attribute double playbackRate</dt>
          <dd>
            <p>
              Run-time playback control.
              Setting this attribute allows overriding the playback rate in such
              a way that the <a>default active duration</a> does not change and
              performs a compensatory seek so that the position of the timed
              item does not jump.
            </p>
            <p>
              The attribute returns the <a>effective run-time playback rate</a>
              and as such will initially equal <code>defaultPlaybackRate</code>.
            </p>
            <p>
              If the <a>zero run-time playback rate flag</a> is set, returns 0.
            </p>
            <p>
              Setting this value updates the <a>run-time playback rate</a> which
              in turn will be used as input when calculating the <a>iteration
              time</a>.
            </p>
            <p>
              Setting this attribute also performs a compensatory seek on the
              timed item using the procedure defined in <a
              href="#performing-run-time-speed-control" class="sectionRef"></a>.
            </p>
            <p>
              After setting, this attribute can be restored to reflecting
              <code>defaultPlaybackRate</code> by calling
              <code>resetPlaybackRate</code>.
            </p>
          </dd>
          <dt>void reverse ()</dt>
          <dd>
            <p>
              Reverses this timed item such that it begins reversing from its
              current point.
              Note that this means that for a timed item that has yet to begin,
              calling <code>reverse</code> will mean that it never starts.
            </p>
            <ol>
              <li>
                Calculate <var>seek time</var> as follows:
              </li>
                <dl class="switch">
                  <dt>If <code>currentTime &lt; startDelay</code>,</dt>
                  <dd>
                    Let <var>seek time</var> be
                    <code>startDelay + activeDuration</code>.
                  </dd>
                  <dt>If <code>currentTime &gt;
                      startDelay + activeDuration</code>,</dt>
                  <dd>
                    Let <var>seek time</var> be <code>startDelay</code>.
                  </dd>
                  <dt>Otherwise,</dt>
                  <dd>
                    Let <var>seek time</var> be
                    <code>activeDuration - currentTime - startDelay</code>.
                  </dd>
                </dl>
              </li>
              <li>
                Set <code>playbackRate</code> to <code>-playbackRate</code>.
              </li>
              <li>
                Set <code>currentTime</code> to <var>seek time</var>.
              </li>
            </ol>
          </dd>
          <dt>double resetPlaybackRate ()</dt>
          <dd>
            <p>
              Makes the <a>run-time playback rate</a> undefined.
              As a result the <code>playbackRate</code> will reflect
              <code>defaultPlaybackRate</code>.
            </p>
            <p>
              This also has the effect of setting the <a>zero run-time playback
              rate flag</a> to false.
            </p>
            <p>
              Returns the <a>default playback rate</a>.
            </p>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Core timed item calculations</h2>
      <section class="informative">
        <h3>Overview</h3>
        <p>
          At the core of the Web Animations timing model is the process that
          takes an inherited time value and converts it to an <a>iteration
          time</a>.
        </p>
        <p>
          Following this further transformations are applied before resulting at
          a final <a>output time</a>.
        </p>
        <p>
          The first step in this process is to calculate the boundary when the
          item is active, that is, the <a>active duration</a>.
        </p>
        <p>
          This process is illustrated below.
        </p>
        <div class="figure">
          <img src="img/active-duration-calculation.svg" width="650">
        </div>
        <p class="caption">
          Calculation of the <a>active duration</a> is based on
          multiplying the <a>iteration duration</a> by the <a>iteration
          count</a> and then dividing by the <a>playback rate</a>.
        </p>
        <p>
          The process for calculating the <a>active duration</a> is normatively
          defined in <a href="#calculating-the-active-duration"
          class="sectionRef"></a>.
        </p>
        <p>
          Having established the <a>active duration</a>, the process for
          transforming a timed item's <a>inherited time</a> into its
          <a>transformed time</a> is illustrated below.
        </p>
        <div class="figure">
          <img src="img/time-calculations.svg" width="650">
        </div>
        <p class="caption">
          An overview of timing model calculations.<br>
          (1) The <a>inherited time</a> is converted into a <a>local time</a> by
          incorporating the <a>start time</a> and <a>time drift</a>.<br>
          (2) The <a>local time</a> is converted into an <a>active time</a> by
          incorporating the <a>start delay</a>.<br>
          (3) The <a>playback rate</a> and <a>iteration start</a> properties are
          applied to the <a>active time</a> to produce the <a>scaled active
          time</a>.<br>
          (4) The <a>scaled active time</a> is then converted to an offset
          within a single iteration: the <a>iteration time</a>.<br>
          (5) The <a>iteration time</a> is converted into a <a>directed time</a>
          by incorporating the <a>playback direction</a>.<br>
          (6) Finally any timing functions are applied to the <a>directed
          time</a> to produce the <a>transformed time</a>.
        </p>
        <p>
          Steps 2 to 4 in the diagram are described following.
          The first step, calculating the <a>local time</a> is described in <a
          href="#calculating-the-local-time" class="sectionRef"></a>.
          Steps 5 and 6 are described in
          <a href="#calculating-the-directed-time" class="sectionRef"></a>
          and
          <a href="#calculating-the-transformed-time" class="sectionRef"></a>
          respectively.
        </p>
      </section>
      <section>
        <h3>Calculating the duration</h3>
        <section>
          <h4>Calculating the iteration duration</h4>
          <p>
            The <dfn>iteration duration</dfn>, unless overridden (see below), is
            simply its <em>intrinsic iteration duration</em>.
          </p>
          <p>
            The <dfn>intrinsic iteration duration</dfn> of a timed item is zero,
            however some specific types of timed item such as timing groups
            override this behavior and provide an alternative intrinsic duration
            (see <a href="#the-intrinsic-duration-of-a-parallel-timing-group"
            class="sectionRef"></a> and <a
            href="#the-intrinsic-duration-of-a-sequence-timing-group"
            class="sectionRef"></a>).
          </p>
          <p>
            The Web Animations API also provides a means to
            override the <a>intrinsic iteration duration</a> and provide another
            value for the <a>iteration duration</a> via that
            <code>iterationDuration</code> attribute.
          </p>
          <div class="informative">
            <p>
              Since the <a>intrinsic iteration duration</a> of an animation is
              zero, and the default <code>fillMode</code> when constructing an
              <a>Animation</a> is <em>forwards</em>, it is possible to
              create animations that simply set a property without any
              interpolation as follows,
            </p>
            <pre class='example sh_javascript'>
new Animation(elem, { display: 'none' });
            </pre>
            <p>
              This is particularly useful in combination with other animations
              or timed items.
              For example, fading an element before switching
              &lsquo;display&rsquo; to &lsquo;none&rsquo; can be achieved as
              follows,
            </p>
            <pre class='example sh_javascript'>
new SeqGroup(
  [
    new Animation(elem, { opacity: '0%' }, 1),
    new Animation(elem, { display: 'none' })
  ]
);
            </pre>
          </div>
        </section>
        <section>
          <h4>Calculating the active duration</h4>
          <p>
            The active duration is based on the timed item's playback rate of
            which we have both the <a>default playback rate</a> and <a>run-time
            playback rate</a>.
            As a result, we can define both the <a>default active duration</a>
            and <a>run-time active duration</a>.
            As with the playback rate, the <a>default active duration</a> is
            used by timing groups to schedule children whilst the <a>run-time
            active duration</a> is used to control playback.
          </p>
          <p>
            In order to calculate the <a>default active duration</a> we
            first define the <a>repeated duration</a> as follows:
          </p>
          <blockquote>
            <dfn>repeated duration</dfn> =
              <code><a>iteration duration</a> *
                    <a>iterationCount</a></code>
          </blockquote>
          <p>
            The <dfn>default active duration</dfn> is calculated according
            to the following steps:
          </p>
          <ol>
            <li>
              If the <a>default playback rate</a> is zero, return
              <code>Infinity</code>.
            </li>
            <li>
              Otherwise, return <code><a>repeated duration</a>
              / abs(<a>default playback rate</a>)</code>.
            </li>
          </ol>
          <p>
            For the <a>run-time active duration</a>, we first define
            the <dfn>intrinsic run-time active duration</dfn> as the result of
            following the same steps for calculating the <a>default active
            duration</a> but substituting the <a>effective run-time playback
            rate</a> for the <a>default playback rate</a>.
          </p>
          <p>
            Next we define the <dfn>run-time active duration</dfn> as simply the
            <a>intrinsic run-time active duration</a> unless overridden by
            providing another value for the run-time active duration via the
            <code>activeDuration</code> attribute.
          </p>
        </section>
      </section>
      <section>
        <h3>Transforming the local time</h3>
        <section>
          <h4>Calculating the active time</h4>
          <p>
            The <dfn>active time</dfn> is based on the <a>local time</a>
            and <code>startDelay</code>.
            It is defined only when the timed item is <a>in effect</a> and is
            calculated according to the following steps:
          </p>
          <ol>
            <li>
              If <a>local time</a> is <code>null</code>, return
              <code>null</code>.
            </li>
            <li>
              If <code><a>local time</a> &lt; startDelay</code>
              the result depends on the <code>fillMode</code> as follows,
              <dl class="switch">
                <dt>
                  If the <a>effective fill mode</a> is <em>backwards</em> or
                  <em>both</em>,
                </dt>
                <dd>
                  return zero.
                <dd>
                <dt>
                  Otherwise,
                </dt>
                <dd>
                  return <code>null</code>.
                </dd>
              </dl>
            </li>
            <li>
              If <code><a>local time</a> &lt; startTime + <a>run-time active
              duration</a></code>, return <code><a>local time</a>
              - startDelay</code>.
            </li>
            <li>
              Otherwise, the result depends on the <a>effective fill mode</a> as
              follows,
              <dl class="switch">
                <dt>
                  If the <a>effective fill mode</a> is <em>forwards</em> or
                  <em>both</em>,
                </dt>
                <dd>
                  return the <a>run-time active duration</a>.
                <dd>
                <dt>
                  Otherwise,
                </dt>
                <dd>
                  return <code>null</code>.
                </dd>
              </dl>
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the scaled active time</h4>
          <p>
            Before the <a>active time</a> can be converted to an <a>iteration
            time</a> we must factor in the timed item's <a>effective run-time
            playback rate</a> and <code>iterationStart</code>.
            This is called the <a>scaled active time</a>.
          </p>
          <p>
            In order to calculate the <a>scaled active time</a> we first
            define the <a>start offset</a> as follows:
          </p>
          <blockquote>
            <dfn>start offset</dfn> =
              <code>iterationStart * <a>iteration duration</a></code>
          </blockquote>
          <p>
            The <dfn>scaled active time</dfn> is calculated according to
            the following steps:
          </p>
          <ol>
            <li>
              If the <a>active time</a> is <code>null</code>, return
              <code>null</code>.
            </li>
            <li>
              Return the scaled active time based on the
              <a>effective run-time playback rate</a> as follows,
              <dl class="switch">
                <dt>If <a>effective run-time playback rate</a> is negative,</dt>
                <dd>
                Return <code>(<a>active time</a> -
                              <a>run-time active duration</a>)
                        * <a>effective run-time playback rate</a>
                        + <a>start offset</a></code>.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  Return <code><a>active time</a>
                  * <a>effective run-time playback rate</a>
                  + <a>start offset</a></code>.
                </dd>
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the iteration time</h4>
          <p>
            The <dfn>iteration time</dfn> is calculated according to the
            following steps:
          </p>
          <ol>
            <li>
              If the <a>local time</a> is <code>null</code>,
              return <code>null</code>.
            </li>
            <li>
              If the <a>iteration duration</a> is zero, return zero.
            </li>
            <li>
              If <code><a>scaled active time</a> - <a>start
              offset</a></code> is equal to the <a>repeated duration</a>,
              and <code>iterationCount</code> is not zero,
              and <code>(iterationCount + iterationStart) % 1</code> is zero,
              return the <a>iteration duration</a>.
            </li>
            <li>
              Otherwise, return <code><a>scaled active time</a>
              % <var>iteration duration</var></code>.
            </li>
          </ol>
        </section>
      </section>
      <section>
        <h3>Calculating the current iteration</h3>
        <p>
          The <dfn>current iteration</dfn> can be calculated using the
          following steps:
        </p>
        <ol>
          <li>
            If the <a>item time</a> is <code>null</code>, return
            <code>null</code>.
          </li>
          <li>
            If the <a>scaled active time</a> is zero, return zero.
          </li>
          <li>
            If the <a>iteration duration</a> is zero, return
            <code>floor(timing.iterationStart + timing.iterationCount)</code>.
          </li>
          <li>
            If the <a>unscaled iteration time</a> equals the <a>iteration
            duration</a>, return <code>timing.iterationStart
            + timing.iterationCount - 1</code>.
          </li>
          <li>
            Return <code>floor(<a>scaled active time</a> /
            <a>iteration duration</a>)</code>.
            <p class="note">
              If the <a>iteration duration</a> is infinite, the
              result of <code>floor(<a>scaled active time</a> /
              <a>iteration duration</a>)</code> will be zero as defined by
              IEEE 754-2008.
            </p>
          </li>
        </ol>
      </section>
    </section>

    <section>
      <h2>Direction control</h2>
      <div class="informative">
        <p>
          Timed items may also be configured to run iterations in alternative
          directions using direction control.
          Unlike speed control, setting a reverse direction does not invert the
          <a>effective fill mode</a> of the timed item.
        </p>
      </div>
      <section>
        <h3>The <code>PlaybackDirection</code> enumeration</h3>
        <dl title="enum PlaybackDirection" class="idl">
          <dt>normal</dt>
          <dd>
            All iterations are played as specified.
          </dd>
          <dt>reverse</dt>
          <dd>
            All iterations are played in the reverse direction from the way
            they are specified.
          </dd>
          <dt>alternate</dt>
          <dd>
            Even iterations are played as specified, odd iterations are played
            in the reverse direction from the way they are specified.
          </dd>
          <dt>alternate-reverse</dt>
          <dd>
            Even iterations are played in the reverse direction from the way
            they are specified, odd iterations are played as specified.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Calculating the directed time</h3>
        <p>
          The <dfn>directed time</dfn> is based on the <a>iteration time</a>
          using the following steps:
        </p>
        <ol>
          <li>
            Calculate the <var>current direction</var> using the first
            matching condition from the following list:
            <dl class="switch">
              <dt>
                If <code>direction</code> is <code>normal</code>,
              </dt>
              <dd>Let the <var>current direction</var> be forwards.</dd>
              <dt>
                If <code>direction</code> is <code>reverse</code>,
              </dt>
              <dd>Let the <var>current direction</var> be reverse.</dd>
              <dt>
                Otherwise,
              </dt>
              <dd>
                <ol>
                  <li>
                    Let <var>d</var> be the <a>current iteration</a>.
                  </li>
                  <li>
                    If <code>direction</code> is
                    <code>alternate-reverse</code> increment
                    <var>d</var> by 1.
                  </li>
                  <li>
                    <p class="issue">
                      There used to be a step here which seemed to be adding
                      special handling for filling when the item ends on
                      a repeat boundary but it seems like that is taken care
                      of by the calcuation of <a>iteration time</a> and
                      <a>current iteration</a>.
                      Is anything actually needed here?
                    </p>
                  </li>
                  <li>
                    If <code><var>d</var> % 2 == 0</code>, let the
                    <var>current direction</var> be forwards, otherwise let
                    the <var>current direction</var> be reverse.
                  </li>
                </ol>
              </dd>
            </dl>
          </li>
          <li>
            If the <var>current direction</var> is forwards then return
            the <a>iteration time</a>.
            <p>
              Otherwise, return the <a>iteration duration</a>
              - <a>iteration time</a>.
            </p>
          </li>
        </ol>
      </section>
      <section>
        <h3>Direction control interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Direction control members</dt><dd></dd>
          <dt>attribute PlaybackDirection direction</dt>
          <dd>
            <p>
              Direction behavior as specified by one of the
              <a>PlaybackDirection</a> enumeration values.
            </p>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Time transformations</h2>
      <section class="informative">
        <h3>Scaling the time</h3>
        <p>
          It is often desirable to control the rate at which a timed item
          progresses.
          For example, easing the rate of animation can create a sense of
          momentum and produce a more natural effect.
          Conversely, in other situations such as when modelling a discrete
          change, a smooth transition is undesirable and instead it is necessary
          for the timed item to progress in a series of distinct steps.
        </p>
        <p>
          For such situations Web Animations provides a variety of timing
          functions that scale the progress of a timed item.
        </p>
        <p>
          Timing functions take an input time fraction in the range [0, 1] and
          produce a scaled output time fraction whose range is unbounded.
        </p>
        <div class="figure">
          <img src="img/timing-function-example.svg" width="350">
        </div>
        <p class="caption">
          Example of a timing function that produces a ease-in effect.
          Given a input timing fraction of 0.7, the timing function scales the
          value to produce an output time fraction of 0.52.<br>
          By applying this timing function, time will appear to progress more
          slowly at first but then gradually progress more quickly.
        </p>
        <p>
          Such timing functions can be applied to an iteration of a timed item
          as a whole via the <a>TimedItem</a> interface or to a segment of
          a keyframe animation via the <a>KeyframeAnimationEffect</a>
          interface.
        </p>
      </section>
      <section>
        <h3>The <a>TimingFunction</a> interface</h3>
        <p>
          The timing functions provided by Web Animations share a common
          <a>TimingFunction</a> interface as defined below.
        </p>
        <dl title="interface TimingFunction" class="idl">
          <dt>double scaleTime()</dt>
          <dd>
            <p>
              Takes an input time fraction in the range [0, 1] and applies some
              transformation on the value to produce an output time fraction
              (typically, but not necessarily, also in the range [0, 1]).
            </p>
            <dl class="parameters">
              <dt>double time</dt> <!-- Oh yeah! -->
              <dd>
                The input time fraction.
              </dd>
              <dt>TimedItem? item</dt>
              <dd>
                <p>
                  The <a>TimedItem</a> for which the time scaling operation is
                  being performed.
                </p>
                <p>
                  Some timing functions, for example, may produce different
                  results depending on the animation values involved to produce
                  an even rate of change.
                </p>
                <p>
                  This may be <code>null</code>, for example, when invoked
                  directly by user code for the purpose of testing or re-using
                  the scaling operation in another context.
                </p>
                <p>
                  Implementations of this interface for which there is no
                  meaningful result in the absence of a <a>TimedItem</a> will
                  simply return <code>time</code> unchanged when
                  <code>item</code> is <code>null</code>.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>TimingFunction clone()</dt>
          <dd>
            <p>
              For implementations of this interface that have local state,
              produces an identical but independent copy of this object.
              For implementations without local state, returns the same object.
            </p>
          </dd>
          <dt>static TimingFunction? createFromString(DOMString spec)</dt>
          <dd>
            <p>
              Creates a new <a>TimingFunction</a> object based on a string-based
              specification (e.g. "ease-in").
            </p>
            <p>
              The acceptable values and their meanings are those defined for the
              <a
              href="http://www.w3.org/TR/css3-transitions/#transition-timing-function-property">transition-timing-function</a>
              property in CSS Transitions [[!CSS3-TRANSITIONS]].
            </p>
            <p>
              In addition to the values defined in CSS Transitions, this method
              extends the <code>steps()</code> function notation to allow
              &lsquo;middle&rsquo; as a transition point keyword (e.g.
              <code>steps(3, middle)</code>) corresponding to the
              &lsquo;middle&rsquo; <a>StepPosition</a> value.
              Similarly, the keyword &lsquo;steps-middle&rsquo; is recognized by
              and given the meaning <code>steps(1, middle)</code>.
            </p>
            <p>
              Strings that specify a cubic-bezier timing function result in
              a new <a>SplineTimingFunction</a> being returned.
              Strings that specify a stepping function produce a new
              <a>StepTimingFunction</a>.
            </p>
            <p>
              If <code>spec</code> is unrecognized, <code>null</code> is
              returned.
              User agents that provide debugging feedback SHOULD report the
              unrecognized value.
            </p>
            <p class="issue">
              So the string <code>cubic-bezier(...)</code> produces
              a <a>SplineTimingFunction</a>.
              That's a bit confusing.
              But <code>CubicBezierTimingFunction</code> is a lot to type and
              not very user-friendly.
            </p>
            <p class="issue">
              Should we make the &lsquo;linear&rsquo; keyword return
              <code>null</code> or <code>new SplineTimingFunction([0, 0, 1,
              1])</code>?
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>Scaling using a cubic Bzier curve</h3>
        <p>
          A common method of producing easing effects is to use a cubic Bzier
          curve to scale the time.
          The endpoints of the curve are fixed at (0,0) and (1,1) while two
          control points <var>P1</var> and <var>P2</var> define the shape of the
          curve.
          Provided the <var>x</var> values of <var>P1</var> and <var>P2</var>
          lie within the range [0,1] such a curve produces a function that is
          used to map input times (the <var>x</var> values) onto output times
          (the <var>y</var> values).
          This arrangement is illustrated below.
        </p>
        <div class="figure">
          <img src="img/cubic-bezier-timing-curve.svg" width="500">
        </div>
        <p class="caption">
          A cubic Bzier curve used as a timing function.<br>
          The shape of the curve is determined by the location of the control
          points <var>P1</var> and <var>P2</var>.<br>
          Input time fractions serve as <var>x</var> values of the curve, whilst
          the <var>y</var> values are the output time fractions.
        </p>
        <p>
          The curves produced by the keywords accepted by the
          <a href="#widl-TimingFunction-createFromString-TimingFunction-DOMString-spec"
          class="idlType"><code>Timing.createFromString</code></a>
          method are illustrated below.
        </p>
        <div class="figure">
          <img src="img/curve-keywords.svg" width="500">
        </div>
        <p class="caption">
          The timing functions produced by each of the keyword values.
        </p>
        <section>
          <h4>The <code>SplineTimingFunction</code> interface</h4>
          <p>
            Cubic bzier curve based timing functions are represented using
            the <code>SplineTimingFunction</code> interface defined below.
          </p>
          <dl title="interface SplineTimingFunction : TimingFunction"
            class="idl">
            <dt>Constructor (sequence&lt;double&gt; points)</dt>
            <dd>
              <p>
                Creates a new <a>SplineTimingFunction</a> object and initializes
                the <code>points</code> member to the passed in list of
                <code>points</code>.
              </p>
              <p class="annotation">
                It would be more convenient for authors if the passed in list of
                points could be longer than four items and we simply read the
                first four items and ignored the rest.
                However, applications may begin to depend on that behavior and
                we could not easily allow this object to take longer lists (to
                represent more complex curves) in the future without adding
                a separate constructor for that purpose.
              </p>
              <p>
                Exceptions:
              </p>
              <dl class="exceptions">
                <dt>DOMException of type <code>IndexSizeError</code></dt>
                <dd>
                  Raised if any of the <var>x</var> values in
                  <code>points</code> is outside the range [0, 1]
                  or if the length of <code>points</code> is not 4 items.
                </dd>
              </dl>
            </dd>
            <dt>attribute sequence&lt;double&gt; points</dt>
            <dd>
              <p>
                A sequence of four real numbers representing the coordinates of
                the two control points in the following sequence
                <var>&lt;p1-x&gt;</var> <var>&lt;p1-y&gt;</var>
                <var>&lt;p2-x&gt;</var> <var>&lt;p2-y&gt;</var>.
              </p>
              <p>
                Each of the <var>x</var> values (i.e. <var>p1-x</var> and
                <var>p2-x</var>) must be in the range [0, 1].
              </p>
              <p>
                Exceptions:
              </p>
              <dl class="exceptions">
                <dt>DOMException of type <code>IndexSizeError</code></dt>
                <dd>
                  Raised on setting if an <var>x</var> value is outside the
                  range [0, 1].
                </dd>
                <dt>DOMException of type
                    <code>InvalidModificationError</code></dt>
                <dd>
                  Raised on attempting to alter the length of
                  <code>points</code>.
                </dd>
              </dl>
            </dd>
            <dt>double scaleTime(double time, TimedItem? item)</dt>
            <dd>
              Applies the timing function produced by the cubic Bzier curve
              with points (0,0), (<code>points[0], points[1]</code>),
              (<code>points[2]</code>, <code>points[3]</code>), (1, 1).
              Returns the resulting <var>y</var> value when the <var>x</var>
              value is <code>max(0, min(1, time))</code>.
            </dd>
            <dt>TimingFunction clone()</dt>
            <dd>
              Returns a copy of this object.
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>Timing in discrete steps</h3>
        <p>
          It is possible to scale a timed item's timing so that the timed item
          occurs in a series of discrete steps using a stepping function.
        </p>
        <p>
          A stepping function divides the input time into a specified number of
          intervals that are equal in duration.
          The output time, starting at zero, rises by an amount equal to the
          interval duration once during each interval at the transition point
          which may be either the start, midpoint, or end of the interval.
        </p>
        <p>
          In keeping with Web Animation's model for endpoint exclusive interval
          timing (see <a href="#interval-timing" class="sectionRef"></a>), the
          output time at the transition point is the time <em>after</em>
          applying the increase (i.e. the top of the step).
        </p>
        <p>
          Some example step timing functions are illustrated below.
        </p>
        <div class="figure">
          <img src="img/step-timing-func-examples.svg" width="700">
        </div>
        <p class="caption">
          Example step timing functions.
          In each case the domain is the input time fraction whilst the range
          represents the output time fraction produced by the step function.<br>
          The first row shows the function for each transition point when only
          one step is specified whilst the second row shows the same for three
          steps.
        </p>
        <section>
          <h4>The <code>StepPosition</code> enumeration</h4>
          <p>
            The point within a step interval at which the change in value occurs
            is specified using one of the <a>StepPosition</a> enumeration
            values.
          </p>
          <dl title="enum StepPosition" class="idl">
            <dt>start</dt>
            <dd>
              The change in value occurs at the beginning of the interval.
            </dd>
            <dt>middle</dt>
            <dd>
              The change in value occurs at the midpoint of the interval.
            </dd>
            <dt>end</dt>
            <dd>
              The change in value occurs at the end of the interval.
            </dd>
          </dl>
        </section>
        <section>
          <h4>The <code>StepTimingFunction</code> interface</h4>
          <p>
            Step timing functions are represented by the
            <a>StepTimingFunction</a> interface.
          </p>
          <dl title="interface StepTimingFunction : TimingFunction" class="idl">
            <dt>Constructor (unsigned integer numSteps,
                             optional StepPosition position = 'end')</dt>
            <dd>
              <p>
                Creates a new <a>StepTimingFunction</a> with the specified
                number of steps and transition point.
              </p>
              <p>
                Exceptions:
              </p>
              <dl class="exceptions">
                <dt>DOMException of type <code>IndexSizeError</code></dt>
                <dd>
                  Raised if <code>numSteps</code> is zero.
                </dd>
              </dl>
            </dd>
            <dt>attribute unsigned integer numSteps</dt>
            <dd>
              <p>
                A number greater than or equal to one representing the number of
                steps in the function.
              </p>
              <p>
                Exceptions:
              </p>
              <dl class="exceptions">
                <dt>DOMException of type <code>IndexSizeError</code></dt>
                <dd>
                  Raised on setting if the number of steps is zero.
                </dd>
              </dl>
            </dd>
            <dt>attribute StepPosition position</dt>
            <dd>
              The point within each interval at which the change in value
              occurs.
            </dd>
            <dt>double scaleTime(double time, TimedItem? item)</dt>
            <dd>
              Returns the value of applying the step function defined by
              <a>numSteps</a> and <a>position</a> with input <var>time</var>.
              The behavior of the step function is described in <a
              href="#timing-in-discrete-steps" class="sectionRef"></a>.
            </dd>
            <dt>TimingFunction clone()</dt>
            <dd>
              Returns a copy of this object.
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3><a>TimedItem</a> time transformation interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Time transformation members</dt><dd></dd>
          <dt>attribute TimingFunction? timingFunction</dt>
          <dd>
            An optional timing function used to scale input time to produce
            timing effects such as easing behavior.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Calculating the transformed time</h3>
        <p>
          The <dfn>transformed time</dfn> is calculated from the
          <a>directed time</a> using the following steps:
        </p>
        <ol>
          <li>
            If the <a>directed time</a> is <code>null</code>,
            return <code>null</code>.
          </li>
          <li>
            Scale the time as follows:
            <dl class="switch">
              <dt>If <code>timingFunction</code> is
                  a <a>TimingFunction</a> object,</dt>
              <dd>
                <ol>
                  <li>Let <var>iteration fraction</var> be the result of
                      evaluating <code><a>directed time</a> / <a>iteration
                      duration</a></code> unless <a>iteration duration</a> is
                      zero, in which case let <var>iteration fraction</var> be
                      zero.</li>
                  <li>Return the result of evaluating
                <code><a>directed time</a> *
                timingFunction.scaleTime(<var>iteration fraction</var>))</code>.
                  </li>
                </ol>
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                Return the <a>directed time</a>.
              </dd>
            </dl>
          </li>
        </ol>
      </section>
    </section>

    <section>
      <h2>The output time of a timed item</h2>
      <p>
        The <dfn>output time</dfn> of a timed item is simply the
        <a>transformed time</a>.
      </p>
      <section>
        <h3>Output time interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Output time members</dt><dd></dd>
          <dt>readonly attribute double? outputTime</dt>
          <dd>
            <p>
              The <a>output time</a> in seconds of this timed item.
              As a result of the steps for calculating this value in <a
              href="#core-timed-item-calculations" class="sectionRef"></a> and
              elsewhere, this attribute will be
              non-<code>null</code> if and only if the timed item is in
              <a>in effect</a>.
            </p>
            <p class="annotation">
              This attribute is not writeable since doing so would require
              being able to do a reverse conversion from the value to set into
              to local time space and then updating the <code>currentTime</code>
              accordingly.
              However, that's not possible since timing functions may be applied
              and some of them are not invertible.
            </p>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Animations</h2>
      <p>
        Animations are a kind of timed item that apply an animation effect to
        a target element.
        The are represented in the Web Animations API by the
        <code>Animation</code> objects.
      </p>
      <section>
        <h3>The <code>Animation</code> interface</h3>
        <dl title="interface Animation : TimedItem" class="idl">
          <dt>Constructor ()</dt>
          <dd>
            <p>
              Creates a new <a>Animation</a> object using the following
              procedure:
            </p>
            <ol>
              <li>Create a new <a>Animation</a> object,
                  <var>animation</var>.</li>
              <li>Establish a temporary timing dictionary, <var>timing
                 dictionary</var>, based on the type of <var>timing</var> as
                 follows,
                <dl class="switch">
                  <dt>If <var>timing</var> is a <a>TimingDictionary</a>
                  object,</dt>
                  <dd>
                    Let <var>timing dictionary</var> refer to <var>timing</var>.
                  </dd>
                  <dt>If <var>timing</var> is a <code>double</code>,</dt>
                  <dd>
                    Let <var>timing dictionary</var> be a new <var>timing
                    dictionary</var> object with all properties set to their
                    default values and <code>iterationDuration</code> set to
                    <var>timing</var>.
                  </dd>
                  <dt>Otherwise (<var>timing</var> is <code>null</code> or
                      undefined),</dt>
                  <dd>
                    Let <var>timing dictionary</var> be a new <var>timing
                    dictionary</var> object with all properties set to their
                    default values.
                  </dd>
                </dl>
              </li>
              <li>For each member of <var>timing dictionary</var>,
                <ol>
                  <li>Assign the value of the member to the
                      correspondingly-named property on
                      <var>animation</var>.</li>
                  <li>If member <code>timingFunction</code> is of type
                      <code>DOMString</code> create a new <a>TimingFunction</a>
                      object by calling
                      <a href="#widl-TimingFunction-createFromString-TimingFunction-DOMString-spec"
                      class="idlType"><code>Timing.createFromString</code></a><code>(<var>timing
                      dictionary</var>.timingFunction)</code> and assign the
                      result to
                      <code><var>animation</var>.timingFunction</code>.</li>
                </ol>
              </li>
              <li>Assign the animation effect based on the type of
                <var>effect</var> as follows,
                <dl class="switch">
                  <dt>If <var>effect</var> is an <a>AnimationEffect</a>
                      object or a <a>CustomAnimationEffect</a> object,</dt>
                  <dd>
                    Assign <code><var>animation</var>.effect</code> to
                    <var>effect</var>.
                  </dd>
                  <dt>If <var>effect</var> is <code>null</code>,</dt>
                  <dd>
                    Set <code><var>animation</var>.effect</code> to
                    <code>null</code>.
                  </dd>
                  <dt>Otherwise,</dt>
                  <dd>
                    Set <code><var>animation</var>.effect</code> to the return
                    value of calling <a
                  href="#widl-AnimationEffect-createFromProperties-AnimationEffect-object-properties"
                  class="idlType"><code>AnimationEffect.createFromProperties</code></a><code>(<var>effect</var>)</code>.
                  </dd>
                </dl>
              </li>
              <li>Set <code>timeline</code> to the <a>DocumentTimeSource</a> for
                the <a
                href="http://www.w3.org/TR/html5/browsers.html#active-document">active
                document</a>.</li>
            </ol>
            <div class="todo">
              <p>
                Still need to work out the autoplay behaviour here.
              </p>
              <p>
                I think we want it to work like this:
              </p>
              <pre class='example sh_javascript'>
var anim = new Animation(elem, { left: '100px' }, 3);
// anim is paused until you call play
// anim.startTime = ???
anim.play();
// anim.startTime = anim.timeline.outputTime
              </pre>
            </div>
            <p>
              Examples of the usage of this constructor are given in <a
              href="#creating-a-new-animation-object" class="sectionRef"></a>.
            </p>
            <dl class="parameters">
              <dt>AnimationTarget? element</dt>
              <dd>
                The target element or pseudo-element.
                This may be <code>null</code> for animations that do not target
                a specific element.
              </dd>
              <dt>object? effect</dt>
              <dd>
                The animation effect used to set the <code>effect</code>
                property of the newly created <a>Animation</a> object.
                <p>
                  If this parameter is an <a>AnimationEffect</a> object or
                  <a>CustomAnimationEffect</a> object, it will shared with any
                  other <a>Animation</a> objects referring to the same
                  <a>AnimationEffect</a> or <a>CustomAnimationEffect</a>
                  object.
                  It will <em>not</em> be copied.
                </p>
                <p>
                  If this parameter is <code>null</code>, the newly created
                  <a>Animation</a> will also have a <code>null</code> animation
                  effect.
                </p>
                <p>
                  Otherwise, if this parameter is any other type of object, it
                  will be passed to <a
                  href="#widl-AnimationEffect-createFromProperties-AnimationEffect-object-properties"
                  class="idlType"><code>AnimationEffect.createFromProperties</code></a>
                  and the resulting <a>AnimationEffect</a> object used as the
                  animation effect.
                </p>
              </dd>
              <dt>optional (double or TimingDictionary)? timing</dt>
              <dd>
                <p>
                  The timing properties of the new animation.
                </p>
                <p>
                  If this parameter is a <code>double</code>, then it
                  specifies the duration of a single iteration of the animation,
                  that is, the <a>iteration duration</a>, in seconds.
                </p>
                <p>
                  If this parameter is <code>null</code> the default value for
                  <a>iteration duration</a> specified in the
                  <a>TimingDictionary</a> definition will be used, that is,
                  zero.
                </p>
                <p>
                  If this parameter is of type <a>TimingDictionary</a>, then
                  the values of the passed-in dictionary will be used.
                </p>
                <p>
                  Finally, if this parameter is not specified, it is as if
                  a value of <code>null</code> were specified.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>attribute (AnimationEffect or CustomAnimationEffect)? effect</dt>
          <dd>
            <p>
              The animation effect to apply (see <a
              href="#animation-values" class="sectionRef"></a>).
              May be <code>null</code> in which case the animation will produce
              no noticeable effect other than dispatching events (see <a
              href="#timing-events" class="sectionRef"></a>).
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type
                  <code>NoModificationAllowedError</code></dt>
              <dd>
                Raised on setting if this object is linked to a template (i.e.
                <code>template</code> is not <code>null</code>).
              </dd>
            </dl>
          </dd>
          <dt>readonly attribute AnimationTarget? target</dt>
          <dd>
            <p>
              The element or pseudo-element being animated by this object.
              This may be <code>null</code> for animations that do not target
              a specific element such as an animation that produces a sound
              using an audio API.
            </p>
            <p class="note">
              Note that in a future version <a>AnimationTarget</a> may be
              extended to allow targetting, for example, a sequence of elements.
              Therefore, code that is intended to be used with arbitrary
              <a>Animation</a> objects should test the concrete type of
              <code>target</code> before using it and not assume that it refers
              to an Element.
            </p>
            <p class="issue">
              Allowing <code>target</code> to refer to multiple elements may
              suggest cancelling works differently so that it is possible to
              cancel the animation as-applied to a single element.
              Likewise, it may influence how SVG is mapped to this API if SVG is
              extended to support multiple targets.
            </p>
          </dd>
        </dl>
        <section class="informative">
          <h4>Creating a new <code>Animation</code> object</h4>
          <p>
            The <a>Animation</a> constructor offers a number of approaches to
            creating a new <a>Animation</a> object.
            At its simplest, an <a>Animation</a> object that changes the
            &lsquo;left&rsquo; property of <var>elem</var> to 100 over three
            seconds can be achieved as follows:
          </p>
          <pre class='example sh_javascript'>
var anim = new Animation(elem, { left: '100px' }, 3);
          </pre>
          <p>
            To specify further timing properties such as the playback rate,
            a <a>TimingDictionary</a> can be used as follows:
          </p>
          <pre class='example sh_javascript'>
var anim = new Animation(elem, { left: '100px' }, { duration: 3, playbackRate: 2 });
          </pre>
          <p>
            The animation effect parameter may specify multiple properties,
            an <a>AnimationEffect</a> object, or even a callback object.
          </p>
          <pre class='example sh_javascript'>
// Specify multiple properties at once
var animA = new Animation(elem, { left: '100px', top: '300px' }, 5);

// Share the animation effect of another animation
var animB = new Animation(elem, animA.effect, 3);

// Supply a specialized animation effect
var animC = new Animation(elem, new PathAnimationEffect( ... ), 3);

// Supply a custom script-based animation effect
var animC = new Animation(elem,
  { 
    sample: function(time) { 
      if (time !== null) {
        document.documentElement.currentScale = 1.0 + time * 2.0;
      } else {
        document.documentElement.currentScale = 1.0;
      }
    },
    clone: function { return this; }
  }, 3);
          </pre>
          <p class="todo">
            Fill in the parameters for <a>PathAnimationEffect</a> above once
            we have decided on them.
          </p>
        </section>
      </section>
      <section>
        <h3>The <code>TimingDictionary</code> dictionary</h3>
        <p>
          To simplify creation of <a>Timing</a> objects
          a <code>TimingDictionary</code> can be used.
        </p>
        <p>
          Except where otherwise noted, the acceptable values for each
          member and their meanings are defined in the <a>Timing</a>
          interface.
        </p>
        <dl title="dictionary TimingDictionary" class="idl">
          <dt>double? startTime = null</dt>
          <dd>
            <p class="todo">
              TBD. See notes on autoplay behavior in the <a>Animation</a>
              constructor definition.
            </p>
          </dd>
          <dt>double startDelay = 0</dt>
          <dd>
            <p>
              The number of seconds from a timed item's <code>startTime</code>
              to the start of the <a>animation interval</a>.
              See <a href="#widl-TimedItem-startDelay"
              class="idlType"><code>startDelay</code></a> on the
              <a>TimedItem</a> interface.
            </p>
          </dd>
          <dt>FillMode fillMode = "forwards"</dt>
          <dd>
            <p>
              The <a>fill mode</a> of the animation.
              See <a href="#widl-TimedItem-fillMode"
              class="idlType"><code>fillMode</code></a> on the <a>TimedItem</a>
              interface.
            </p>
            <p class="note">
              Note that in both CSS Animations [[CSS3-ANIMATIONS]] and SVG
              [[SVG112]] the default fill mode is "none".
              Web Animations differs in this regard since it was determined
              that when generating animations from script forwards filling is
              the more commonly-desired behavior.
            </p>
            <p class="issue">
              Some feedback suggests the default here should be "both".
            </p>
          </dd>
          <dt>double iterationStart = 0.0</dt>
          <dd>
            <p>
              The number of iterations into the item at which to begin.
              See <a href="#widl-TimedItem-iterationStart"
              class="idlType"><code>iterationStart</code></a> on the
              <a>TimedItem</a> interface.
            </p>
          </dd>
          <dt>unrestricted double iterationCount = 1.0</dt>
          <dd>
            <p>
              The number of times to repeat the item.
              See <a href="#widl-TimedItem-iterationCount"
              class="idlType"><code>iterationCount</code></a> on the
              <a>TimedItem</a> interface.
            </p>
          </dd>
          <dt>unrestricted double? iterationDuration = null</dt>
          <dd>
            <p>
              The duration in seconds of a single iteration, that is, the
              <a>iteration duration</a>.
              See <a href="#widl-TimedItem-duration"
              class="idlType"><code>duration</code></a> on the <a>TimedItem</a>
              interface.
            </p>
          </dd>
          <dt>double defaultPlaybackRate = 1.0</dt>
          <dd>
            <p>
              A multiplier applied to the inherited time potentially causing
              the item to run at a different rate to its natural speed.
              See <a href="#widl-TimedItem-defaultPlaybackRate"
              class="idlType"><code>defaultPlaybackRate</code></a> on the
              <a>TimedItem</a> interface.
            </p>
          </dd>
          <dt>PlaybackDirection direction = "normal"</dt>
          <dd>
            <p>
              The direction in which animation proceeds, e.g. "reverse".
              See <a href="#widl-TimedItem-direction"
              class="idlType"><code>direction</code></a> on the <a>TimedItem</a>
              interface.
            </p>
          </dd>
          <dt>(DOMString or TimingFunction)? timingFunction = null</dt>
          <dd>
            <p>
              An optional timing function used to scale the time to produce
              easing effects and the like.
            </p>
            <p>
              Unlike the <a>TimedItem</a> interface, the member here may be set
              to either a <a>TimingFunction</a> object or
              a <code>DOMString</code> corresponding to one of the values
              recognized by <a
              href="#widl-TimingFunction-createFromString-TimingFunction-DOMString-spec"
              class="idlType"><code>Timing.createFromString</code></a>.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>Animation targets and pseudo-elements</h3>
        <p>
          Animations may target not only regular elements but also
          pseudo-elements such as <code>::before</code> and
          <code>::first-line</code> [[!SELECT]].
        </p>
        <p>
          To represent pseudo-elements, we introduce the <a>PseudoElement</a>
          interface.
        </p>
        <dl title="interface PseudoElement" class="idl">
          <dt>Constructor (Element element, DOMString pseudoElement)</dt>
          <dd>
            Creates a new pseudo-element using <var>element</var> as the <a
            href="http://www.w3.org/TR/css3-selectors/#subject">subject</a>
            and <var>pseudoElement</var> as the pseudo-element to match (e.g.
            &lsquo;<code>::first-line</code>&rsquo;).
          </dd>
          <dt>attribute Element element</dt>
          <dd>
            The element used as the <a
            href="http://www.w3.org/TR/css3-selectors/#subject">subject</a> for
            matching a pseudo-element.
            <p>Exceptions:</p>
            <dl class="exceptions">
              <dt>DOMException of type
                  <code>NoModificationAllowedError</code></dt>
              <dd>
                Raised on setting if this object is a readonly object.
              </dd>
            </dl>
          </dd>
          <dt>attribute DOMString pseudoElement</dt>
          <dd>
            The pseudo-element including the initial colon(s). For example,
            &lsquo;<code>::after</code>&rsquo;.
            <p>Exceptions:</p>
            <dl class="exceptions">
              <dt>DOMException of type
                  <code>NoModificationAllowedError</code></dt>
              <dd>
                Raised on setting if this object is a readonly object.
              </dd>
            </dl>
          </dd>
        </dl>
        <div class="feedbackWanted">
          <p>
            This is an interface that may be useful in other specifications and
            so there are a few considerations to bear in mind:
          </p>
          <ul>
            <li>
              <p>
                Currently no validation is performed at all.
                You can set <code>pseudoElement</code> to
                &lsquo;<code>::batman</code>&rsquo; and we'll just ignore it
                when compositing (still need to define this).
              </p>
              <p>
                This is in order to provide better fallback.
                For example, if a UA doesn't support a particular pseudo-element
                it will still run the animation in terms of occupying time and
                firing events.
                There simply won't be any visual effect.
              </p>
              <p>
                Also, we have a general pattern in this specification that
                constructors don't throw.
              </p>
              <p>
                So while this works for this API, is this behavior useful in
                other specifications?
              </p>
            </li>
            <li>
              <p>
                The other issue is that we could just make <a>PseudoElement</a>
                have an optional <code>pseudoElement</code> attribute and use
                that everywhere instead of a union of <a>Element</a> or
                <a>PseudoElement</a> (see <a>AnimationTarget</a>).
              </p>
              <p>
                The reason we don't is that it complicates the 99% case where
                you're not using pseudo-elements. For example, you have to type
                <code>anim.target.element</code> which is what so many people
                don't like about SVG.
              </p>
              <p>
                So, again, this works for this specification, but is it ok for
                others?
              </p>
            </li>
            <li>
              While we're at it, should we enforce using double-colons somehow?
            </li>
          </ul>
        </div>
        <section>
          <h4>The <a>AnimationTarget</a> typedef</h4>
          <div class="idl"
            title="typedef (Element or PseudoElement) AnimationTarget">
            For simplicity, throughout this specification <a>AnimationTarget</a>
            is used wherever either an <a>Element</a> or a <a>PseudoElement</a>
            can be used.
          </div>
        </section>
      </section>
      <section>
        <h3>Extensions to the <code>Element</code> interface</h3>
        <p>
          To simplify the creation of <a>Animation</a> objects for a given
          Element, the <a class="externalDFN"
          href="http://www.w3.org/TR/dom/#interface-element">Element</a>
          interface [[!DOM4]] is extended as follows:
        </p>
        <dl class="idl" title="partial interface Element">
          <dt>Animation animate()</dt>
          <dd>
            <p>
              Creates a new <a>Animation</a> object whose target element is the
              Element object on which the method is called, and calls
              <code>play()</code> on the newly created animation.
            </p>
            <p>
              The following code fragment:
            </p>
            <pre class="example sh_javascript">
              var anim = elem.animate({ 'opacity': 0 }, 2);
            </pre>
            <p>
              is equivalent to:
            </p>
            <pre class="example sh_javascript">
              var anim = new Animation(elem, { 'opacity': 0 }, 2);
              anim.play();
            </pre>
            <p>
              Returns the newly created <a>Animation</a> object.
            </p>
            <dl class="parameters">
              <dt>object? effect</dt>
              <dd>
                The animation effect to apply.
                This value is passed to the <a
                href="#widl-ctor-Animation--AnimationTarget-element-object-effect--double-or-TimingDictionary--timing">Animation
                constructor</a> as the <var>effect</var> parameter and has the
                same interpretation as defined for that constructor.
              </dd>
              <dt>optional (double or TimingDictionary)? timing</dt>
              <dd>
                The timing parameters of the animation.
                This value is passed to the <a
                href="#widl-ctor-Animation--AnimationTarget-element-object-effect--double-or-TimingDictionary--timing">Animation
                constructor</a> as the <var>timing</var> parameter and has the
                same interpretation as defined for that constructor.
              </dd>
            </dl>
          </dd>
        </dl>
      </section>
      <section>
        <h3>Re-using animations</h3>
        <p>
          It is possible to duplicate an <a>Animation</a> using the
          <code>clone</code> method.
          Doing so duplicates only the scheduled state of the <a>Animation</a>
          and not its run-time state.
        </p>
        <ol>
          <li>Let <var>source</var> be a the <a>Animation</a> object to
              clone.</li>
          <li>Create a new <a>TimingDictionary</a>,
              <var>cloned timing</var> with all members set to their default
              values (see <a href="#the-timingdictionary-dictionary"
              class="sectionRef"></a>).</li>
          <li>Set <code><var>cloned timing</var>.timingFunction</code> to
              the result of calling
              <code><var>source</var>.timingFunction.clone()</code>
              or <code>null</code> if
              <code><var>source</var>.timingFunction</code> is
              <code>null</code>.</li>
          <li>Set the remainder of the members of <var>cloned timing</var> to
              the properties of the same name on <var>source</var>.</li>
          <li>
            The <a>AnimationEffect</a> is cloned depending on the type of
            <code><var>source</var>.effect</code> as follows,
            <dl class="switch">
              <dt>If <code><var>source</var>.effect</code> is an
                  <a>Animation</a> object,</dt>
              <dd>
                Let <var>cloned effect</var> be the result of calling
                <code><var>source</var>.effect.clone()</code>.
              </dd>
              <dt>If <code><var>source</var>.effect</code> is a
                  <a>CustomAnimationEffect</a> object,</dt>
              <dd>
                If <code><var>source</var>.effect</code> has a method called
                <code>clone</code> let <var>cloned effect</var> be the result of
                calling that method, otherwise let <var>cloned effect</var> be
                <code><var>source</var>.effect</code>.
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                Let <var>cloned effect</var> be <code>null</code>.
              </dd>
            </dl>
          </li>
          <li>Return a new <a>Animation</a> object created by
              calling the <a
              href="#widl-ctor-Animation--AnimationTarget-element-object-effect--double-or-TimingDictionary--timing">Animation
              constructor</a> with parameters
              <code>Animation(<var>source</var>.target, <var>cloned
              effect</var>, <var>cloned timing</var>)</code>.</li>
        </ol>
        <p class="annotation">
          This does not attach the cloned animation to
          <code><var>source</var>.timeline</code>.
          I think that's the more useful and expected behavior (especially when
          dealing with children of a sequence group or repeating parallel
          groups) but we may wish to add a facility in future for simplifying
          this.
        </p>
        <section>
          <h4>Animation re-use related interface members</h4>
          <dl title="partial interface Animation" class="idl">
            <dt>Animation clone ()</dt>
            <dd>
              Creates a copy of this <a>Animation</a> object minus its run-time
              state using the procedure defined in <a
              href="#re-using-animations" class="sectionRef"></a>.
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>Calculating the time fraction</h3>
        <p>
          Before passing the <a>output time</a> of an <a>Animation</a> to the
          animation effect we must convert it to a <em>time fraction</em>.
          The <dfn>time fraction</dfn> is calculated according to the
          following steps:
        </p>
        <dl class="switch">
          <dt>
            If the <a>iteration duration</a> is zero,
          </dt>
          <dd>
            <p>
              the <a>time fraction</a> is as follows,
            </p>
            <dl class="switch">
              <dt>
                If <a>local time</a> &lt; <code>startDelay</code>,
              </dt>
              <dd>
                Return the result of recalculating the <a>output time</a>
                using a <a>local time</a> of zero and an <a>iteration
                duration</a> of 1.
              </dd>
              <dt>
                Otherwise,
              </dt>
              <dd>
                Return the result of recalculating the <a>output time</a>
                using a <a>local time</a> of <code>iterationCount</code> and an
                <a>iteration duration</a> of 1.
              </dd>
            </dl>
          </dd>
          <dt>
            Otherwise,
          </dt>
          <dd>
            Return <a>output time</a> / <a>iteration duration</a>.
          </dd>
        </dl>
        <p class="note">
          Since <a href="#time-transformations">timing functions</a> are
          allowed to produce output times outside the range [0,1] it is
          possible that the value calculated for a <a>time fraction</a> also
          lies outside this range.
        </p>
      </section>
    </section>

    <section>
      <h2>Grouping and synchronization</h2>
      <div class="informative">
      <p>
        While it is possible to set the timing properties of animations
        individually, it is often useful to bundle animations together and
        control their timing as a group.
      </p>
      <p>
        This can be used to share common timing properties as illustrated below:
      </p>
      <div class="figure">
        <img src="img/grouping-delay.svg" width="800">
      </div>
      <p class="caption">
        Using groups to share common timing properties.<br>
        (a) Shows setting a delay of 5 seconds on individual animations.<br>
        (b) Produces the same effect by setting the delay on the group.
      </p>
      <p>
        As well as sharing timing information, by grouping animations together
        they can be seeked, paused, and stopped as a unit.
      </p>
      </div>
      <section class="informative">
        <h3>Relationship of group time to child time</h3>
        <p>
          The timing of the children of a group is based on the timing of the
          group. Specifically, times for the children are based on the parent's
          <em>iteration time</em>. That is, the children animate <em>inside</em>
          an iteration of the parent.
        </p>
        <p>
          As an example, consider repetition. If a group has an iteration count
          of 2, then the children of of the group will all play twice since they
          effectively play <em>inside</em> the group's iterations.
        </p>
        <div class="figure">
          <img src="img/grouping-repetition.svg" width="600">
        </div>
        <p class="caption">
          Since children of an timing group base their timing on the group's
          <var>iteration time</var>, when the group repeats, the children play
          again.
        </p>
        <p>
          If an iteration count is specified for the children of a group as well
          as for the group the effect is as if the iteration count of the group
          was multiplied with the iteration count of the children.
        </p>
        <div class="figure">
          <img src="img/grouping-repetition-and-animation-repetition.svg"
            width="600">
        </div>
        <p class="caption">
          Specifying an iteration count of 2 on an timing group and an
          iteration count of 3 on one of its children results in that child
          playing 6 times.
        </p>
        <p>
          A further result of the children of a group basing their timing on the
          group's <var>iteration time</var> is that they cannot animate outside
          of the group's <a>animation interval</a>.
          This is because the <var>iteration time</var> of a group will not
          change outside its animation interval.
          This allows groups to clip the playback of their children.
        </p>
        <div class="figure">
          <img src="img/grouping-clipping.svg" width="600">
        </div>
        <p class="caption">
          In the first instance, an animation has a negative delay and an
          infinite iteration count.<br>
          However, when a similar animation is placed inside a group with
          a specified duration it has the effect of clipping the animation's
          duration.
        </p>
        <p>
          Some further consequences of group children basing their timing on
          their parent group's <var>iteration time</var> are:
        </p>
        <ul>
          <li>
            Setting the playback rate of an timing group will speed up or
            slow down all children.
          </li>
          <li>
            Changing the playback direction of an timing group will change
            the direction of all children.
          </li>
          <li>
            Applying a timing function to an timing group will affect the
            playback rate of all children.
          </li>
        </p>
      </section>
      <section class="informative">
        <h3>Types of groups</h3>
        <p>
          Groups can be used to provide synchronization behavior for its
          children.
          For example, one type of group runs its children in parallel, whilst
          another type runs the children in sequence.
        </p>
        <p>
          Compare the two arrangements illustrated below:
        </p>
        <div class="figure">
          <img src="img/grouping-types.svg" width="600">
        </div>
        <p class="caption">
          Two types of timing groups.<br>
          (a) is a parallel group where all the children run simultaneously.<br>
          (b) is a sequence group where the children run in turn.
        </p>
        <p>
          Groups can also contain other groups which allows for more
          sophisticated synchronization.
        </p>
        <div class="figure">
          <img src="img/grouping-nesting.svg" width="600">
        </div>
        <p class="caption">
          A sequence timing group that contains a parallel timing group as
          a child.<br>
          The parallel group waits for the previous child of the sequence
          group to finish, and then the children of the parallel group play
          simultaneously.
          After they have finished the next child of the sequence group plays.
        </p>
        <p>
          Web Animations defines two types of timing groups.
        </p>
        <dl>
          <dt>Parallel groups</dt>
          <dd>
            Children of the group play simultaneously.
            The start time of children is taken as relative to the start of the
            current iteration of the group, that is, it is in the group's
            <em>iteration time space</em>.
          </dd>
          <dt>Sequence groups</dt>
          <dd>
            Children of the group play in turn beginning with the first child
            and proceeding to the last.
            Any start time specified on children is ignored and replaced with
            the time calculated using the procedure in <a
            href="#the-start-time-of-children-of-a-sequence-timing-group"
            class="sectionRef"></a>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>TimingGroup</code> interface</h3>
        <p>
          Represents a list of timed items grouped together for the purposes of
          synchronization.
        </p>
        <p>
          The <code>TimingGroup</code> interface supports indexed
          properties with indices in the range 0 &le; <var>index</var> &lt;
          <code>group.size</code>. 
        </p>
        <dl title="interface TimingGroup : TimedItem"
          class="idl">
          <dt>readonly attribute unsigned long length</dt>
          <dd>
            The number of timed items in the group.
          </dd>
          <dt>void clear ()</dt>
          <dd>
            <p>
              Removes all child timed items from the group.
            </p>
          </dd>
          <dt>getter TimedItem? (unsigned long index)</dt>
          <dd>
            <p>
              Returns the item at <code>index</code>.
              If <code>index</code> is greater than or equal to
              <code>length</code> returns <code>null</code>.
            </p>
          </dd>
          <dt>setter TimedItem (unsigned long index, TimedItem newItem)</dt>
          <dd>
            <p>
              Replaces the item at <code>index</code> with <code>newItem</code>
              by calling <code>splice(index, 1, newItem)</code>.
            </p>
            <p>
              No attempt is made to check if the item at <code>index</code> is
              already <code>newItem</code>. In such a case, <code>newItem</code>
              will be removed from this group and re-added as per the usual
              operation of <code>slice</code>.
            </p>
            <p>
              Returns <code>newItem</code>.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>HierarchyRequestError</code></dt>
              <dd>
                Raised if <code>newItem</code> is the timeline for a document
                (see <a href="#the-document-timeline" class="sectionRef"></a>).
              </dd>
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <code>index</code> is outside of the range 0 &le;
                <var>index</var> &lt; <code>group.length</code>.
              </dd>
            </dl>
            <div class="note">
              <p>
                Whilst <code>splice</code> allows negative indices,
                WebIDL requires index property setters to take an index of type
                <code>unsigned long</code> and hence <code>index</code> is
                restricted to the range 0 &le; <var>index</var> &lt;
                <code>group.length</code>.
              </p>
            </div>
          </dd>
          <dt>sequence&lt;TimedItem&gt; add (TimedItem newItem,
                                             TimedItem... otherItems)</dt>
          <dd>
            <p>
              Add <code>newItem</code> and each <code>otherItems</code> as the
              last item(s) in the group by calling <code>splice(group.length, 0,
              newItem, otherItem1, ... otherItemN)</code>.
            </p>
            <p>
              Returns a sequence containing the added items:
              <code>[newItem, otherItem1, ... otherItemN]</code>.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>HierarchyRequestError</code></dt>
              <dd>
                Raised if any of the items to add is the timeline for a document
                (see <a href="#the-document-timeline" class="sectionRef"></a>).
                If this exception is thrown none of the <code>newItem</code>
                objects will be added to the group.
              </dd>
            </dl>
          </dd>
          <dt>sequence&lt;TimedItem&gt; remove (
                long index, optional unsigned long count = 1)</dt>
          <dd>
            <p>
              Removes the item(s) at <code>index</code> by calling
              <code>splice(index, count)</code>.
            </p>
            <p>
              Returns the removed items.
            </p>
          </dd>
          <dt>
            sequence&lt;TimedItem&gt; splice ()
          </dt>
          <dd>
            <p>
              Modifies the list of children of this group by first removing
              <code>deleteCount</code> items from <code>start</code> followed by
              adding <code>newItems</code> at the same point.
            </p>
            <p>
              The operation of slice is based on <a
                href="http://www.ecma-international.org/publications/files/ECMA-ST-ARCH/ECMA-262%205th%20edition%20December%202009.pdf#page=140">ECMAScript 5's
                Array.prototype.splice</a>.
            </p>
            <p>
              Returns a sequence of the items removed from group during the
              removal step (regardless of whether these items were re-added
              during the addition step).
            </p>
            <dl class="parameters">
              <dt>long start</dt>
              <dd>
                The index at which items should be removed and inserted.
                Negative indices represent an offset from the end of the list of
                items.
                This value is clamped to the range [-<code>length</code>,
                <code>length</code>].
              </dd>
              <dt>unsigned long deleteCount</dt>
              <dd>
                The number of items to remove from the group beginning at
                <code>start</code>.
                Negative values are clamped to zero, and all other values are
                clamped such that
                0 &lt; <code>start</code> + <code>deleteCount</code> &le;
                length.
              </dd>
              <dt>sequence&lt;TimedItem&gt; newItems</dt>
              <dd>
                The items to be added at <code>start</code>.
                Each item, if it already has a parent group (including this
                group), is first removed from its parent group before being
                added to this group.
              </dd>
            </dl>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>HierarchyRequestError</code></dt>
              <dd>
                Raised if any of the items in <code>newItem</code> is the
                timeline for a document (see <a href="#the-document-timeline"
                class="sectionRef"></a>).
              </dd>
            </dl>
          </dd>
          <dt>
            sequence&lt;TimedItem&gt; splice (long start,
              unsigned long deleteCount, TimedItem... newItem)
          </dt>
          <dd>
            An overload of <code>splice</code> to take a variadic list of items
            rather than requiring a sequence.
            The operation is identical to <code>splice(unsigned long start,
            unsigned long deleteCount, sequence&lt;TimedItem&gt;
            newItems)</code>.
          </dd>
          <dt>long indexOf (TimedItem item)</dt>
          <dd>
            Returns the index of <code>item</code> within the group.
            If <code>item</code> is not in the group, returns <code>-1</code>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Parallel timing groups</h3>
        <p>
          Parallel timing groups run their children such they potentially play
          simultaneously.
          The start time of each child depends on its own <code>startTime</code>
          property.
        </p>
        <section>
          <h4>The intrinsic duration of a parallel timing group</h4>
          <p>
            The intrinsic duration of a parallel timing group is the maximum of
            <a>default end time</a> of each child <a>TimedItem</a>.
          </p>
          <p>
            If the group has no children then the intrinsic duration is zero.
          </p>
          <p>
            The <a>default end time</a> of a <a>TimedItem</a> is defined as
            follows:
          </p>
          <blockquote>
            <dfn>default end time</dfn> =
            <code>startTime + startDelay + <a>default active duration</a></code>
          </blockquote>
        </section>
        <section>
          <h4>The <code>ParGroup</code> interface</h4>
          <p>
            Parallel timing groups are represented by <code>ParGroup</code>
            objects.
          </p>
          <dl title="interface ParGroup : TimingGroup" class="idl">
            <dt>Constructor ()</dt>
            <dd>
              <p>
                Creates a new <a>ParGroup</a> object using the following
                procedure:
              </p>
              <ol>
                <li>Create a new <a>ParGroup</a> object, <var>group</var>.</li>
                <li>Establish a temporary timing dictionary, <var>timing
                   dictionary</var>, based on the type of <var>timing</var> as
                   follows,
                  <dl class="switch">
                    <dt>If <var>timing</var> is a <a>TimingDictionary</a>
                    object,</dt>
                    <dd>
                      Let <var>timing dictionary</var> refer to
                      <var>timing</var>.
                    </dd>
                    <dt>If <var>timing</var> is a <code>double</code>,</dt>
                    <dd>
                      Let <var>timing dictionary</var> be a new <var>timing
                      dictionary</var> object with all properties set to their
                      default values and <code>iterationDuration</code> set to
                      <var>timing</var>.
                    </dd>
                    <dt>Otherwise (<var>timing</var> is <code>null</code> or
                        undefined),</dt>
                    <dd>
                      Let <var>timing dictionary</var> be a new <var>timing
                      dictionary</var> object with all properties set to their
                      default values.
                    </dd>
                  </dl>
                </li>
                <li>For each member of <var>timing dictionary</var>,
                  <ol>
                    <li>Assign the value of the member to the
                        correspondingly-named property on
                        <var>group</var>.</li>
                    <li>If member <code>timingFunction</code> is of type
                        <code>DOMString</code> create a new <a>TimingFunction</a>
                        object by calling
                        <a href="#widl-TimingFunction-createFromString-TimingFunction-DOMString-spec"
                        class="idlType"><code>Timing.createFromString</code></a><code>(<var>timing
                        dictionary</var>.timingFunction)</code> and assign the
                        result to
                        <code><var>group</var>.timingFunction</code>.</li>
                  </ol>
                </li>
                <li>
                  Add <var>children</var> to the group by calling
                  <code><var>group</var>.splice(0, 0,
                  <var>children</var>)</code>.
                </li>
                <li>Set <code>timeline</code> to the <a>DocumentTimeSource</a> for
                  the <a
                  href="http://www.w3.org/TR/html5/browsers.html#active-document">active
                  document</a>.</li>
              </ol>
              <dl class="parameters">
                <dt>sequence&lt;TimedItem&gt;? children</dt>
                <dd>
                  <p>
                    A sequence of timed items to add as children of this group.
                  </p>
                  <p>
                    These children are appended in sequence using the same
                    semantics as the <code><a>TimingGroup</a>.add</code> method.
                  </p>
                </dd>
                <dt>optional (double or TimingDictionary)? timing</dt>
                <dd>
                  <p>
                    The timing properties of the new timing group.
                  </p>
                  <p>
                    If this parameter is a <code>double</code>, then it
                    specifies the duration of a single iteration of the
                    animation, that is, the <a>iteration duration</a>, in
                    seconds.
                  </p>
                  <p>
                    If this parameter is <code>null</code> the default value for
                    <a>iteration duration</a> specified in the
                    <a>TimingDictionary</a> definition will be used, that is,
                    zero.
                  </p>
                  <p>
                    If this parameter is of type <a>TimingDictionary</a>, then
                    the values of the passed-in dictionary will be used.
                  </p>
                  <p>
                    Finally, if this parameter is not specified, it is as if
                    a value of <code>null</code> were specified.
                  </p>
                </dd>
              </dl>
            </dd>
            <dt>ParGroup clone ()</dt>
            <dd>
              <p>
                Creates a deep copy of this <a>ParGroup</a> object minus its
                run-time state using the following procedure.
              </p>
              <ol>
                <li>Let <var>source</var> be this <a>ParGroup</a> object, the
                    object to be cloned.</li>
                <li>Create a new <a>TimingDictionary</a>,
                    <var>cloned timing</var> with all members set to their
                    default values (see <a
                    href="#the-timingdictionary-dictionary"
                    class="sectionRef"></a>).</li>
                <li>Set <code><var>cloned timing</var>.timingFunction</code> to
                    the result of calling
                    <code><var>source</var>.timingFunction.clone()</code>
                    or <code>null</code> if
                    <code><var>source</var>.timingFunction</code> is
                    <code>null</code>.</li>
                <li>Set the remainder of the members of <var>cloned timing</var>
                    to the properties of the same name on
                    <var>source</var>.</li>
                <li>Let <var>cloned children</var> be an empty sequence of
                    <a>TimedItem</a> objects.</li>
                <li>For each <var>child</var> in
                    <code><var>source</var>.children</code>, append the result
                    of calling <code><var>child</var>.clone()</code>
                    to <var>cloned children</var>.
                <li>Return a new <a>ParGroup</a> object created by
                    calling the <a>ParGroup</a> constructor with parameters
                    <code>ParGroup(<var>cloned children</var>,
                    <var>cloned timing</var>)</code>.</li>
              </ol>
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>Sequence timing groups</h3>
        <p>
          Sequence timing groups run their children in turn
          following their order in the group.
          This ordering is achieved by adjusting the <var>start time</var> of
          each child in the group.
        </p>
        <div class="informative">
          <p>
            Since the <var>start delay</var> is added to the <var>start
            time</var>, it can be used to adjust the timing of the <a>animation
            interval</a> relative to calculated <var>start time</var> as shown
            in the following diagram.
          </p>
          <div class="figure">
            <img src="img/sequence-groups-and-start-delays.svg" width="600">
          </div>
          <p>
            A negative <var>start delay</var> can be used to cause the
            <a>animation interval</a> of two children to overlap.
            Note that the <var>start delay</var> affects the <var>start
            time</var> of subsequent children in the group.
          </p>
        </div>
        <section>
          <h4>The start time of children of a sequence timing group</h4>
          <p>
            The start time for the children of a sequence timing group
            is calculated according to the following procedure:
          </p>
          <ol>
            <li>Let the <var>accumulated start time</var> be zero.
            <li>
              Iterate over each child in the group beginning with the first item
              in the group and proceeding to the last.
              For each child perform the following steps:
              <ol>
                <li>
                  Let <var>child</var> be the current child.
                </li>
                <li>
                  Let <code><var>child</var>.startTime</code> be
                  <var>accumulated start time</var>.
                </li>
                <li>
                  Let <var>accumulated start time</var> be
                  the <a>default end time</a> of <var>child</var> after updating
                  its <code>startTime</code>.
                </li>
              </ol>
            </li>
          </ol>
          <p class="note">
            When <code>activeDuration</code> is positive infinity the
            behavior is defined by IEEE 754-2008.
            As a result, if any of the children of a sequence timing group
            has an infinite <a>default active duration</a>, any children that
            occur later in the sequence will not play.
          </p>
        </section>
        <section>
          <h4>The intrinsic duration of a sequence timing group</h4>
          <p>
            The instrinsic duration of a sequence timing group is
            equivalent to the <var>start time</var> of a hypothetical child
            appended to the group's children using the procedure described in <a
            href="#the-start-time-of-children-of-a-sequence-timing-group"
            class="sectionRef"></a>.
          </p>
        </section>
        <section>
          <h4>The <code>SeqGroup</code> interface</h4>
          <p>
            Sequence timing groups are represented by <code>SeqGroup</code>
            objects.
          </p>
          <dl title="interface SeqGroup : TimingGroup"
            class="idl">
            <dt>
            Constructor (sequence&lt;TimedItem&gt;? children,
                optional (double or TimingDictionary)? timing)
            </dt>
            <dd>
              The meaning and handling of each of the parameters in this
              constructor is identical to the constructor for
              <a>ParGroup</a>.
            </dd>
            <dt>SeqGroup clone ()</dt>
            <dd>
              <p>
                Creates a deep copy of this <a>SeqGroup</a> object minus its
                run-time state using the same procedure as defined for <a
                href="#widl-ParGroup-clone-ParGroup">ParGroup.clone</a> except
                that a new <a>SeqGroup</a> object is created instead of
                a <a>ParGroup</a>.
              </p>
            </dd>
          </dl>
        </section>
      </section>
    </section>

    <section>
      <h2>Animation values</h2>
      <div class="informative">
        <p>
          The Web Animations <em>animation model</em> takes the <a
          title="time fraction">time fractions</a> produced by the <em>timing
          model</em> for a given <a>Animation</a> and applies it as the input to
          the <em>animation effect</em> defined for the <a>Animation</a> object.
          The output of each <em>animation effect</em> is then combined using
          a global animation stack before being applied to the target property
          (see <a href="#combining-animations" class="sectionRef"></a>).
        </p>
        <p>
          The entry-point to the <em>animation model</em> is the
          <a>AnimationEffect</a> or <a>CustomAnimationEffect</a> object
          associated with each <a>Animation</a>.
          These objects describe how animation values should be calculated for
          the <a>Animation</a> for any given time.
          <a>AnimationEffect</a> serves as an abstract interface of which
          several concrete subclasses are provided.
        </p>
      </div>
      <section>
        <h3>The <code>AnimationEffect</code> interface</h3>
        <dl title="interface AnimationEffect" class="idl">
          <dt>attribute CompositeOperation operation</dt>
          <dd>
            <p>
              The operation used to composite this animation with the stack, as 
              specified by one of the <a>CompositeOperation</a> enumeration
              values.
            </p>
            <p>
              This value defaults to <code>"replace"</code>
            </p>
          </dd>
          <dt>attribute CompositeOperation accumulateOperation</dt>
          <dd>
            <p>
              The operation used to composite each iteration of this animation
              with the result of compositing the previous animation, as
              specified by one of the <a>CompositeOperation</a> constants
              defined in this interface.
            </p>
            <p>
              This value defaults to <code>"replace"</code>.
            </p>
          </dd>
          <dt>AnimationEffect clone ()</dt>
          <dd>
            <p>
              Creates and returns a new object of the same type as this object's
              most-derived interface such that it will produce the same output
              as this object.
            </p>
            <p class="todo">
              We either need a more rigorous definition here or (probably
              better) a sets of steps on a per-subclass basis.
            </p>
          </dd>
          <dt>static AnimationEffect? createFromProperties ()</dt>
          <dd>
            <p>
              Creates an <a>AnimationEffect</a> representing the passed-in
              collection of properties.
            </p>
            <div class="note">
              <p>
                Note that this method requires handling the passed in parameter
                in a manner not yet supported by Web IDL and hence this method
                is ECMAScript-specific.
              </p>
              <p>
                Since accessing the properties of an ECMAScript user object can
                have side effects, the manner in which these properties is
                accessed is important.
                In light of this consideration the following procedure has the
                following properties:
              </p>
              <ul>
                <li>Every property is read only once.</li>
                <li>Properties are read in a well-defined order.</li>
                <li>Properties corresponding to unsupported target properties or
                    attributes are not read.</li>
              </ul>
            </div>
            <p>
              The interpretation of the passed-in <code>properties</code> object
              can be described in three parts.
            </p>
            <p><strong>Part 1 &ndash; Determine the set of
               animation properties</strong></p>
            <ol>
              <li>Create a list, <var>supported properties</var>, of property
                  names and attribute names that can be animated by the
                  implementation.</li>
              <li>Let <var>animation properties</var> be an empty sequence.</li>
              <li>Iterate through the properties of <code>properties</code>. For
                  each <var>property</var> in <code>properties</code>, if
                  <var>property</var> also exists in <var>supported
                  properties</var> based on a case-sensitive comparison, append
                  <var>property</var> to <var>animation properties</var>.
                  <p class="note">
                    Whilst the iteration order for properties of an ECMAScript
                    object is implementation-dependent, the order here is not
                    significant to the outcome as <var>animation
                    properties</var> will be sorted before being iterated over.
                  </p>
                  <p class="issue">
                    How do we handle <code>operation</code> and
                    <code>compositeOperation</code>? We'd like to be able to
                    list them in the same property bag but that would mean we
                    could never animate properties of the same name.
                  </p>
              </li>
            </ol>
            <p><strong>Part 2 &ndash; Create the <a>AnimationEffect</a>
               objects</strong></p>
            <p>
              The <a>AnimationEffect</a> object produced depends on the length
              of <var>animation properties</var> as follows:
            </p>
            <dl class="switch">
              <dt>If <var>animation properties</var> is of zero length,</dt>
              <dd>
                return <code>null</code>.
                <div class="note">
                  <p>
                    This behavior of returning <code>null</code> allows
                    alternative animation effects to be provided based on the
                    capabilities of the user agent as follows:
                  </p>
                  <pre class="example sh_javascript">
elem.animate(
  AnimationEffect.createFromProperties({ transform: 'translate(-100px)' }) ||
  AnimationEffect.createFromProperties({ top: '-100px' }),
  3);
                  </pre>
                </div>
              </dd>
              <dt>If <var>animation properties</var> has only one element,</dt>
              <dd>
                <ol>
                  <li>Let <var>name</var> be the value of the element
                      in <var>animation properties</var>.</li>
                  <li>Let <var>value</var> be the value of
                      <code>properties.<var>name</var></code>.</li>
                  <li>Return a new <a>KeyframeAnimationEffect</a> object
                      according to the steps in part 3 below based on
                      <var>name</var> and <var>value</var>.</li>
                </ol>
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                <ol>
                  <li>Let <var>group</var> be a newly constructed
                      <a>GroupedAnimationEffect</a>.</li>
                  <li>Sort <var>animation properties</var> lexicographically by
                      the Unicode codepoints that define each property
                      name.</li>
                  <li>For user agents that support both a prefixed and an
                      unprefixed version of some CSS properties, remove all
                      prefixed properties from <var>animation properties</var>
                      where the corresponding unprefixed version is also
                      present.</li>
                  <li>Iterate through <var>animation properties</var>. For each
                      <var>name</var> in <var>animation properties</var>:
                    <ol>
                      <li>Let <var>value</var> be the value of
                          <code>properties.<var>name</var></code>.</li>
                      <li>Create a new <a>KeyframeAnimationEffect</a>,
                          <var>effect</var> object according to the steps in
                          part 3 below based on <var>name</var> and
                          <var>value</var>.</li>
                      <li>Append <var>effect</var> to <var>group</var>.
                    </ol>
                  </li>
                  <li>Return <var>group</var>.
                </ol>
              </dd>
            </dl>
            <p><strong>Part 3 &ndash; Create each
               <a>KeyframeAnimationEffect</a> object</strong></p>
            <p>
              Based on a given <var>name</var> and <var>value</var>, a new
              <a>KeyframeAnimationEffect</a> is created as follows:
            </p>
            <dl class="switch">
              <dt>If <var>value</var> is not of type <code>(DOMString or
              sequence&lt;(<a>KeyframeDictionary</a> or
              DOMString)&gt;)</code>,</dt>
              <dd>
                Throw a <code>TypeError</code> as defined by [[!ECMA-262]].
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                Construct a new <a>KeyframeAnimationEffect</a> by calling
                <code>KeyframeAnimationEffect(<var>name</var>,
                <var>value</var>)</code>.
              </dd>
            </dl>
            <dl class="parameters">
              <dt>object properties</dt>
              <dd>
                An object whose object properties represent the CSS properties
                or element attributes to be animated.
                The values corresponding to these properties are the animation
                values to be applied as described above.
              </dd>
            </dl>
          </dd>
        </dl>
        <div class="annotation">
          In future, we may expose <code>any sample (double?  timeFraction,
          double currentIteration, AnimationTarget? target, any
          underlyingValue)</code> so that the animation effects can be driven
          apart from the timing model.
          Also, doing so would allow us to do real native custom animation
          effects if we decide to go in that direction
          (see annotation in <a href="#custom-animation-effects"
          class="sectionRef"></a>).
        </div>
      </section>
      <section>
        <h3>The <code>CompositeOperation</code> enumeration</h3>
        <dl title="enum CompositeOperation" class="idl">
          <dt>replace</dt>
          <dd>
            The animation should replace the value it is composited with.
          </dd>
          <dt>accumulate</dt>
          <dd>
            The animation should add to the value it is composited with.
            The meaning of addition is dependent on the type of animation.
          </dd>
          <dt>merge</dt>
          <dd>
            The animation should merge with the value it is composited with.
            The meaning of merge is dependent on the type of animation.
            The duration of the merge is the calculated animation duration
            of the <code>AnimationTemplate</code> containing this
            <code>AnimationEffect</code>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>KeyframeAnimationEffect</code> interface</h3>
        <dl title="interface KeyframeAnimationEffect : AnimationEffect"
          class="idl">
          <dt>Constructor (DOMString property,
      (DOMString or sequence&lt;(KeyframeDictionary or DOMString)&gt;) frames,
      optional CompositeOperation operation = "replace",
      optional CompositeOperation compositeOperation = "replace")</dt>
          <dd>
            <p>
              Creates a new <a>KeyframeAnimationEffect</a> object for the
              specified property from the given list of keyframes.
            </p>
            <p>
              The list of keyframes may be a sequence of
              <a>KeyframeDictionary</a> dictionaries, a sequence of
              <code>DOMString</code>s, a combination of both, or
              a single <code>DOMString</code>.
            </p>
            <p>
              <code>DOMString</code>s are used to create keyframes with an
              offset of 1.
              When the list of keyframes is a sequence consisting entirely of
              <code>DOMString</code>s the offsets of the newly created
              <a>Keyframe</a>s are distributed evenly from 0 to 1.
            </p>
            <p>
              The <var>property</var>, <var>operation</var> and
              <var>compositeOperation</var> arguments are assigned to the
              attributes of the same names.
            </p>
            <p>
              The <var>frames</var> argument is processed as follows:
            </p>
            <ol>
              <li>Let <var>effect</var> be the
                  <a>KeyframeAnimationEffect</a> currently under construction.
              </li>
              <li>
                <p>
                  The processing of <var>frames</var> depends on its type as
                  follows:
                </p>
                <dl class="switch">
                  <dt>If <var>frames</var> is a <code>DOMString</code>,</dt>
                  <dd>
                    <ol>
                      <li>
                        Let <var>frame</var> be a new <a>Keyframe</a>
                        constructed from a <a>KeyframeDictionary</a> whose
                        <code>value</code> member is set to
                        <var>frames</var> and whose other members are set
                        to their default values.
                      </li>
                      <li>
                        Call
                <code><var>effect</var>.frames.add(<var>frame</var>)</code>.
                      </li>
                    </ol>
                  </dd>
                  <dt>If <var>frames</var> is a sequence of <code>(DOMString
                      or <a>KeyframeDictionary</a>)</code>,</dt>
                  <dd>
                    <ol>
                      <li>Set a flag <var>all strings</var> to
                          <code>true</code>.</li>
                      <li>
                        For each <var>item</var> in <var>frames</var>:
                        <ol>
                          <li>
                            <dl class="switch">
                              <dt>If <var>item</var> is
                                  a <code>DOMString</code>,</dt>
                              <dd>
                                Let <var>frame</var> be a new <a>Keyframe</a>
                                constructed from a <a>KeyframeDictionary</a>
                                whose <code>value</code> member is set to
                                <var>item</var> and whose other members are
                                set to their default values.
                              </dd>
                              <dt>Otherwise (<var>item</var> is
                                  a <a>KeyframeDictionary</a>),</dt>
                              <dd>
                                <ol>
                                  <li>
                                    Let <var>frame</var> be a new
                                    <a>Keyframe</a> constructed by calling
                                    <code>Keyframe(<var>item</var>)</code>.
                                  </li>
                                  <li>
                                    Set <var>all strings</var> to
                                    <code>false</code>.
                                  </li>
                                </ol>
                              </dd>
                            </dl>
                          </li>
                          <li>
                            Call
                <code><var>effect</var>.frames.add(<var>frame</var>)</code>.
                          </li>
                        </ol>
                      </li>
                      <li>If flag <var>all strings</var> is
                          <code>true</code> call
                        <code><var>effect</var>.frames.distribute()</code>.
                      </li>
                    </ol>
                  </dd>
                </dl>
              </li>
            </ol>
          </dd>
          <dt>attribute DOMString property</dt>
          <dd>
            The name of the target property or attribute.
          </dd>
          <dt>readonly attribute KeyframeList frames</dt>
          <dd>
            The series of values that make up this effect sorted by their
            offset within the iteration duration of the animation.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>KeyframeList</code> interface</h3>
        <p>
          The <a>KeyframeList</a> object is a collection of <a>Keyframe</a>
          objects sorted by the offset of each <a>Keyframe</a>.
        </p>
        <dl title="interface KeyframeList" class="idl">
          <dt>readonly attribute unsigned long length</dt>
          <dd>
            The number of frames in the list.
          </dd>
          <dt>void clear ()</dt>
          <dd>
            Removes all frames from this list.
          </dd>
          <dt>getter Keyframe? (unsigned long index)</dt>
          <dd>
            Returns the frame at <code>index</code> if it exists or
            <code>null</code> otherwise.
          </dd>
          <dt>Keyframe add((Keyframe or KeyframeDictionary) frame)</dt>
          <dd>
            <p>
              Adds <var>frame</var> to the list such that the list remains
              sorted by the offset of the frames.
            </p>
            <p>
              If <var>frame</var> is of type <a>KeyframeDictionary</a> then
              a <a>Keyframe</a> object is first constructed by calling
              <code>Keyframe(<var>frame</var>)</code> before adding the
              newly constructed <a>Keyframe</a> to the list.
            </p>
            <p>
              If there already exists a frame in this list with offset
              <code><var>frame</var>.offset</code>, the newly added
              <var>frame</var> will appear in the list <em>after</em> the
              already existing frames in the list with the same offset.
            </p>
            <p>
              If <var>frame</var> is already part of another <a>KeyframeList</a>
              it is first removed from that list before being added to this
              list.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <var>frame</var> is a <a>KeyframeDictionary</a> whose
                offset is outside the range [0,1] or missing.
              </dd>
            </dl>
          </dd>
          <dt>Keyframe? remove(unsigned long index)</dt>
          <dd>
            Removes the frame at position <var>index</var> and returns it.
            If index is outside the range [0, length), then <code>null</code> is
            returned.
          </dd>
          <dt>long indexOf(Keyframe frame)</dt>
          <dd>
            Returns the index of <var>frame</var> within the list. If
            <var>frame</var> is not a member of the list, returns
            <code>-1</code>.
          </dd>
          <dt>KeyframeList distribute()</dt>
          <dd>
            <p>
              Adjusts the offsets of the frames in the list such that the
              offsets are spaced equidistantly whilst maintaining their current
              order and such that the first frame (when there are multiple
              frames) has offset 0 and the last frame (if any) has offset 1.
            </p>
            <p>
              For <var>frame</var> at position <var>i</var> in the list where
              0 &le; <var>i</var> &lt; <code>length</code>, an offset will be
                assigned equal to <code>i / (length - 1)</code> unless
                <code>length</code> is 1 in which case it will be given offset
                1.
            </p>
            <p>
              After applying the changes, this list is returned.
            </p>
          </dd>
        </dl>
        <div class="annotation">
          <p>
            The following changes for making keyframes easier to work with in
            future have been proposed:
          </p>
          <pre class="example sh_javascript">
// Currently you have to do this
effect.frames.add({ property: 'left', offset: 0.3, value: '100px' }); 

// It would be nice if you could also do this
effect.frames.add(0.3, 'left', '100px');

// Also, fetching by offset would be good

// Returns the last frame with offset 0.3 if there is one.
// If there is none, does the interpolation and returns a new frame? 
var frame = effect.frames['0.3']; 
          </pre>
        </div>
      </section>
      <section>
        <h3>The <code>Keyframe</code> interface</h3>
        <p>
          A <a>Keyframe</a> represents a moment within an animation that has
          a specified value to be applied to the target property or attribute.
          In between such moments values may be interpolated or filled based on
          the <a>TimingFunction</a> specified on the <a>TimedItem</a> where the
          <a>Keyframe</a> is used, or on the previous <a>Keyframe</a>.
        </p>
        <div class="issue">
          <p>
            Currently a <a>Keyframe</a> can only target a single property which
            is defined on the <a>KeyframeAnimationEffect</a>.
            This is different to CSS.
            Is this something we want to change?
            It would complicate the API, of course, but is it worth it?
          </p>
        </div>
        <p>
          <dl title="interface Keyframe" class="idl">
            <dt>Constructor (KeyframeDictionary dictionary)</dt>
            <dd>
              <p>
                Creates a new <a>Keyframe</a> object using the parameters
                specified in <var>dictionary</var>.
              </p>
              <p>
                <code><var>dictionary</var>.offset</code> is clamped to the
                range [0, 1] before setting.
              </p>
            </dd>
            <dt>attribute DOMString value</dt>
            <dd>
              The value to assign to the target attribute or property at the
              given offset.
            </dd>
            <dt>attribute double offset</dt>
            <dd>
              <p>
                A value between 0 and 1 inclusive representing the offset
                within the iteration duration of the animation where this value
                should appear.
              </p>
              <p>
                If this keyframe belongs to a <a>KeyframeList</a>, changes to
                this value cause the <a>KeyframeList</a> to be immediately
                re-sorted using a stable sort such that all children are ordered
                by their offset but children with identical offsets retain their
                relative position in the list.
              </p>
              <p>
                Exceptions:
              </p>
              <dl class="exceptions">
                <dt>DOMException of type <code>IndexSizeError</code></dt>
                <dd>
                  Raised on setting a value outside the range [0,1].
                </dd>
              </dl>
            </dd>
            <dt>attribute TimingFunction? timingFunction</dt>
            <dd>
              <p>
                The timing function to apply between this keyframe and the
                next keyframe in any <a>KeyframeList</a> in which this object
                appears.
              </p>
              <p>
                May be <code>null</code> in which case linear interpolation will
                be used.
              </p>
            </dd>
          </dl>
        </p>
      </section>
      <section>
        <h3>The <code>KeyframeDictionary</code> dictionary</h3>
        <p>
          To simplify creation of <a>Keyframe</a> objects
          a <code>KeyframeDictionary</code> can be used.
        </p>
        <p>
          The members of the dictionary correspond to attributes in the
          <a>Keyframe</a> interface which provides a more complete description
          of their meaning and usage.
        </p>
        <dl title="dictionary KeyframeDictionary" class="idl">
          <dt>DOMString value = ""</dt>
          <dd>
            The value to assign to the target attribute or property at the given
            offset.
          </dd>
          <dt>double offset = 1</dt>
          <dd>
            A value between 0 and 1 (inclusive) representing the offset within
            the iteration duration of the animation where this value should
            appear.
          </dd>
          <dt>TimingFunction? timingFunction = null</dt>
          <dd>
            The timing function to apply between this keyframe and the
            next keyframe in any <a>KeyframeList</a> in which this object
            appears.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>PathAnimationEffect</code> interface</h3>
        <dl title="[Constructor] interface PathAnimationEffect
          : AnimationEffect" class="idl">
          <dt>attribute SVGPathSegList segments</dt>
          <dd>
            The list of segments that make up this path.
          </dd>
          <dt>attribute boolean rotate</dt>
          <dd>
            True if objects animating along this path should be rotated
            such that their positive x axis is aligned with the direction of
            movement along the path.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>GroupedAnimationEffect</code> interface</h3>
        <p>
          The <code>GroupedAnimationEffect</code> interface represents a
          set of animation effects that share the same
          <code>AnimationTemplate</code> parent.
        </p>
        <p class="todo">
          If the group contains multiple effects that target the same property
          does order in the group matter? If so, we need to add a means for
          re-ordering the group other than popping and pushing. For example,
          <code>insertBefore</code>.
        </p>
        <dl title="interface GroupedAnimationEffect : AnimationEffect"
          class="idl">
          <dt>Constructor (object properties)</dt>
          <dd>
            <p class="todo">
              TBD whilst we decide whether we need this interface or whether we
              can merge it with <a>KeyframeAnimationEffect</a> somehow.
            </p>
          </dd>
          <dt>readonly attribute unsigned long length</dt>
          <dd>
            The number of animation effects in the group.
          </dd>
          <dt>void clear()</dt>
          <dd>
            Removes all effects from this group.
          </dd>
          <dt>getter AnimationEffect? (unsigned long index)</dt>
          <dd>
            Returns the effect at <var>index</var> if it exists, or
            <code>null</code> otherwise.
          </dd>
          <dt>AnimationEffect add(AnimationEffect effect)</dt>
          <dd>
            <p>
              Appends <code>effect</code> to the end of the group such that
              <code>group.indexOf(<var>effect</var>)</code> equals
              <code>group.length - 1</code>.
            </p>
            <p class="todo">
              I'm assuming that <a>AnimationEffect</a>s can be shared amongst
              animations and groups.
              Or does <var>effect</var> need to be removed from any previous
              <a>AnimationEffect</a>s or <a>Animation</a>s first?
            </p>
          </dd>
          <dt>AnimationEffect? remove(unsigned long index)</dt>
          <dd>
            Removes the effect at <code>index</code> and returns it. If
            <var>index</var> is outside the range [0, <code>length</code>), then
            <code>null</code> is returned.
          </dd>
          <dt>long indexOf(AnimationEffect effect)</dt>
          <dd>
            Returns the index of <var>effect</var> within the group.
            If <var>effect</var> is not a member of the group, returns
            <code>-1</code>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Calculating animation values</h3>
        <div class="todo">
          This section needs more detail on when sampling is done.
          It also needs to be specified that an <a>Animation</a> with
          a <code>null</code> <a>AnimationEffect</a> still fires events.
        </div>
        <section>
          <h4>Calculating the animation value from an iteration value</h4>
          <p>
            If the <a>current iteration</a> is zero, or the 
            <var>accumulateOperation</var> is
            <code>"replace"</code>, then the 
            <var>animation value</var> is simply the iteration value, as
            defined below.
          </p>
          <p>
            When the animation time equals the iteration duration for the 
            first time for an animation, the current 
            <var>animation value</var> should be retained as the
            <var>end value</var> for the animation.
          </p>
          <p class="todo">
            Need to revise this definition since we can't assume the time at
            the end of the first iteration will be visited (we might be
            playing backwards, or have a <var>iteration start</var> greater
            than 1).
          </p>
          <p>
            If the <a>current iteration</a> is not zero and the
            <var>accumulateOperation</var> is
            <code>"accumulate"</code> then the 
            <var>animation value</var> is the <var>end value</var> accumulated
            <a>current iteration</a> times, with the 
            <var>iteration value</var> accumulated on top.
          </p>
          <p>
            If the <a>current iteration</a> is not zero and the
            <var>accumulateOperation</var> is
            <code>"merge"</code> then the
            <var>animation balue</var> is the <var>end value</var> merged
            with the <var>iteration value</var>, with an interpolation
            parameter equal to the current <var>time fraction</var>
          </p>
          <p class="todo">
            Need to review the following algorithms to check they still make
            sense now that the iteration fraction is not necessarily in the
            range [0, 1].
          </p>
        </section>
        <section>              
          <h4>Calculating the iteration value for a 
            <code>KeyframeAnimationEffect</code></h4>
          <p>
            When an <code>AnimationTemplate</code> contains a pointer to a
            <code>KeyframeAnimationEffect</code> <var>keyframes</var>, the
            <var>animation value</var> for that animation at given current time
            <var>t</var> is calculated according to the following steps:
          </p>
          <ol>
            <li>
              Convert <var>t</var> to the <var>time fraction</var> 
              (see <a href="#calculating-the-time-fraction"
              class="sectionRef"></a>).
            </li>
            <li>
              Generate a <var>sorted frame list</var> by sorting the list of
              <code>Keyframe</code> objects contained within the
              <code>KeyframeList</code> object stored in <var>keyframes.frames</var> 
              by their <var>offset</var>.
              If there are no frames in the <var>sorted frame list</var>
              then no animation occurs and the <var>iteration value</var> is
              just the <var>base value</var> of the property being animated.
            </li>
            <li>
              Otherwise, find the <var>after frame</var> by iterating through
              the <var>sorted frame list</var> until the last
              <code>Keyframe</code> with an <var>offset</var>
              larger than the <var>time fraction</var> is
              encountered.
            </li>
            <li>
              If the <var>after frame</var> is the first frame in the
              <var>sorted frame list</var>, then construct a 
              <var>before frame</var> with an <var>offset</var> of 0 and a
              value equal to the <var>base value</var> of the property being
              animated.
            </li>
            <li>
              If the <var>after frame</var> does not exist (i.e. all frames
              have an <var>offset</var> less than the <var>time 
              fraction</var>) then construct an <var>after frame</var> with
              an <var>offset</var> of 1 and a value equal to the
              <var>base value</var> of the property being animated, and
              Set the <var>before frame</var> to the last frame in the 
              <var>sorted frame list</var>.
            </li> 
            <li>
              Otherwise (the <var>after frame</var> exists and is not the
              first frame in the <var>sorted frame list</var>) set the 
              <var>before frame</var> to the frame immediately prior to the
              <var>after frame</var> in the <var>sorted frame list</var>.
            </li>
            <li>
              The <var>local time function</var> is the
              <var>timingFunction</var> of the <var>before frame</var>, if 
              it exists; otherwise the <var>timingFunction</var> of the
              <code>Animation</code> interface's <var>timing</var> attribute.
            </li>
            <li>
              Find the <var>local time fraction</var> by subtracting
              the <var>offset</var> of the <var>before frame</var> from
              the <var>time fraction</var>, then dividing the result
              by the difference between the <var>offset</var> of the
              <var>after frame</var> and the <var>offset</var> of the
              <var>before frame</var>.
            <li>
              Calculate the <var>effective time fraction</var> by applying
              the <var>local time function</var> to the <var>local time
              fraction</var>.
            <li>
              Calculate the <var>animation value</var> by linearly 
              interpolating the values of the <var>before frame</var> and
              <var>after frame</var>, using the 
              <var>effective time fraction</var> as interpolation parameter (see <a href="#linear-interpolation" class="sectionRef"></a>).
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the iteration value for a 
            <code>PathAnimationEffect</code></h4>
          <p>
            When an <code>AnimationTemplate</code> contains a pointer to a
            <code>PathAnimationEffect</code> and <var>rotate</var> is set
            to false, the <var>animation value</var> for that animation at
            given current time <var>t</var> is the transform defined by a
            translation equal to the location on the path at <var>t</var>.
          </p>
          <p>
            When <var>rotate</var> is set to true, the
            <var>animation value</var> is the transform defined by the above
            translation followed by a rotation defined by the following
            process:
          </p>
          <ol>
            <li>
              Calculate the <var>normal</var> to the path at <var>t</var> (see <a href="#calculating-the-normal-to-a-path" class="sectionRef"></a>).
            </li>
            <li>
              Determine the <var>normal rotation</var>, which is given by 
              <code>atan2(normal.y, normal.x)</code>.
            </li>
            <li>
              The <var>rotation</var> is the transform that rotates by
              the <var>normal rotation</var>.
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the iteration value for a 
            <code>GroupedAnimationEffect</code></h4>
          <p>
            When an <code>AnimationTemplate</code> contains a pointer to a
            <code>GroupedAnimationEffect</code>, the <var>animation
            value</var> for that animation at given current time <var>t</var> 
            is calculated by following the procedure outlined in
            <a href="#resolving-animation-stacks" class="sectionRef"></a>, 
            treating the list of <code>AnimationEffect</code> objects 
            contained within the <code>GroupedAnimationEffect</code> as 
            the animation stack and using an initial animation value 
            of 0 for all simple properties and id for transform.
          </p>
        </section>
      </section>
      <section>
        <h3>Custom animation effects</h3>
        <div class="informative">
          <p>
            In some situations the animation effects provided by Web Animations
            may be insufficient.
            For example, the animation effects defined here are only able to
            target certain CSS properties and DOM attributes.
            They are unable, therefore, to modify the <a
            href="#http://www.w3.org/TR/SVG11/struct.html#__svg__SVGSVGElement__currentScale"><code>currentScale</code></a>
            property of an SVG element to smoothly zoom the viewport without
            affecting the document content.
          </p>
          <p>
            In such cases where the provided animation effects do not provide
            needed functionality, an animation effect defined by script may be
            used.
            Such animation effects receive a time fraction from the timing
            model and are responsible for producing the animation effect
            corresponding to the specified time.
          </p>
          <p>
            Using an animation effect defined in script it is possible to
            animate not only previously un-animatable attributes and properties,
            but potentially anything that is accessible via script, including
            even producing audio or creating vibrations.
          </p>
          <p>
            For example, using an animation effect that draws to a <a
            href="http://www.w3.org/TR/html5/the-canvas-element.html#the-canvas-element"><code>canvas</code></a>
            element it is possible to produce a complex animated effect
            featuring patterns that may be difficult to create using CSS or
            SVG.
            Compared to using the <a
            href="http://www.w3.org/TR/animation-timing/">WindowAnimationTiming</a>
            interface, this approach ensures the animation is frame-rate
            independent and can be paused, reversed, eased with timing effects,
            accelerated, synchronized with other animations, and be controlled
            in the same manner as any other Web Animations animation without any
            additional programming.
          </p>
        </div> <!-- informative -->
        <div class="annotation">
          <p>
            I think we want two types of custom animation effects.
            Following is the general-purpose animate-anything kind of effect.
            The other type, which is not defined here, is the one that can
            participate in the animation sandwich just like any other.
          </p>
          <p>
            This, second, native-like animation effect, would have the
            following features:
          </p>
          <ul>
            <li>Shares the same function signature as
                <code><a>AnimationEffect</a>.sample</code></li>
            <li>Gets passed the underlying value and passes out the animated
                value.</li>
            <li>Has a target property and is sorted against other
                <a>AnimationEffect</a> objects (including platform
                objects)</li>
            <li>Can be added as a child of
                a <a>GroupedAnimationEffect</a>.</li>
          </ul>
          <p>
            That's a bit more difficult since you have to be careful that the
            custom effect doesn't do anything naughty while you're in the
            middle of compositing the animation sandwich.
            I think we should postpone this until Web Animations 2.
          </p>
        </div>
        <section>
          <h4>Execution order of custom animation effects</h4>
          <p>
            Custom animation effects allow authors to define animation effects
            using script.
            Such animation effects are not limited to a single CSS property or
            DOM attribute and therefore the steps for assessing their order of
            execution differs from regular animation effects.
          </p>
          <p>
            Custom animation effects are executed after all other
            <a>AnimationEffect</a> objects have completed and applied their
            effects to their targets.
          </p>
          <p class="issue">
            Need to define this more precisely.
            Are styles flushed?
            Presumably they are.
            Can we suspend reflow for the duration of executing the script-based
            animation effects and just do it once afterwards?
          </p>
          <p>
            Within the set of custom animation effects, the order of execution
            is mostly the same as that for other animation effects and is
            defined in <a href="#the-global-animation-stack"
            class="sectionRef"></a>.
            However, custom animation effects may also override this
            ordering through the <code>priority</code> attribute, which, if
            defined, specifies the priority of the effects with lower numbers
            are executed sooner.
          </p>
          <p>
            In deciding which of two <a>CustomAnimationEffect</a> objects,
            <var>A</var> and <var>B</var>, should be executed the following
            rules are applied.
          </p>
          <ol>
            <li>Sort <var>A</var> and <var>B</var> based on their
                <code>priority</code> such that lower priorities are sorted
                first.
                If either does not have a defined <code>priority</code>,
                then treat the priority as being positive infinity for the
                purposes of sorting.</li>
            <li>If <var>A</var> and <var>B</var> have the same priority,
                sort according to the <code>startTime</code>s of the
                <a>TimedItem</a>s with which <var>A</var> and <var>B</var> are
                associated such that earlier start times are sorted first.
            <li>If <var>A</var> and <var>B</var> have the same priority and
                start time, sort by the position of the corresponding
                <a>Animation</a> objects occur within the animation tree (see
                issue below).</li>
          </ol>
          <p>
            Items sorted earlier, are executed first.
          </p>
          <p class="issue">
            That last point is quite wrong. I don't think we've specified
            exactly what script order is in <a
            href="#the-global-animation-stack" class="sectionRef"></a>.
            But I wonder if it makes more sense to effectively enumerate all the
            script-based nodes in the animation tree using some well-defined
            order and use that index.
            Can that be done efficiently?
          </p>
        </section>
        <section>
          <h4>The <code>CustomAnimationEffect</code> callback interface</h4>
          <p>
            Custom animation effects can be defined in script using the
            <a>CustomAnimationEffect</a> interface.
          </p>
          <p class="issue">
            Should this be a dictionary?
            I'd like to make <code>clone</code> optional.
          </p>
          <div title="callback interface CustomAnimationEffect" class="idl">
            <dt>attribute unsigned integer priority</dt>
            <dd>
              The order in which this animation effect will be executed in
              relation to other custom animation effects such that items with
              a lower priority are executed earlier as defined in <a
              href="#execution-order-of-custom-animation-effects"
              class="sectionRef"></a>.
            </dd>
            <dt>void sample ()</dt>
            <dd>
              The callback used to produce the animation effect corresponding to
              the sample time determined by the timing model.
              <dl class="parameters">
                <dt>double? timeFraction</dt>
                <dd>
                  The distance within a single iteration of the animation effect
                  of the current sample.
                  When this is <code>null</code>, the callback object SHOULD
                  remove the animation effect.
                </dd>
                <dt>double currentIteration</dt>
                <dd>
                  The current iteration index beginning with zero for the first
                  iteration.
                </dd>
                <dt>AnimationTarget? target</dt>
                <dd>
                  The element to which the effect should be applied, if any.
                  When this method is called as a result of this object being
                  associated with an <a>Animation</a> object, it will be
                  <code><a>Animation</a>.target</code>
                </dd>
              </dl>
            </dd>
            <dt>CustomAnimationEffect clone ()</dt>
            <dd>
              Creates an independent copy of this object.
            </dd>
          </div>
          <p class="issue">
            Do we need to pass in the <a>TimedItem</a> as well?
            If possible I'd prefer not to but it may necessary for some types of
            effect.
            Might be an additional parameter to add later if it proves
            necessary?
          </p>
          <p class="issue">
            I think we will also need to pass the previous time fraction.
            Animations will often use this to check if they are paused, playing
            in reverse etc.
            They can track this themselves but then you need a separate object
            everywhere you use it.
          </p>
        </section>
      </section>
    </section>

    <section>
      <h2>Primitive animation operations</h2>
      <section>
        <h3>Linear interpolation</h3>
        <section>
          <h4>Linear interpolation of paths</h4>
          <p class="todo">Write me</p>
        </section>
        <section>
          <h4>Linear interpolation of transforms</h4>
          <p class="todo">Write me</p>        
        </section>
        <section>
          <h4>Linear interpolation of primitive values</h4>
          <p class="todo">Write me</p>
        </section>
      </section>
      <section>
        <h3>Calculating the normal to a path</h3>
        <p class="todo">Write me</p>
      </section>
    </section>
    <section>
      <h2>Combining animations</h2>
      <section>
        <h3>The Global Animation Stack</h3>
        <p>
          When multiple <a>in effect</a> animations target the same element, the
          animations are ordered into a stack which resolves how those 
          animations combine.
          This stack is sorted by animation <var>start time</var>.
          Where multiple animations have the same start time, those animations
          are sorted in document order (for animations from the DOM) and script
          order (for animations from the API). Script animations are always
          sorted after DOM animations.
        </p>
        <p>
          Other operations also generate animation stacks - for example, 
          grouping multiple animations using a 
          <code>GroupedAnimationEffect</code>.
        </p>
        <p>
          An animation stack may be thought of as a single stack with all
          animations sorted into it, or a stack per animating element, as
          animations on one element cannot effect the course of animations on 
          another element.
        </p>
        <p class="note">
          The start time of an animation refers to the time when the animation
          is specified to begin as recorded in the
          <code>TimedItem.startTime</code> property, that is, before applying
          any <var>start delay</var>.
        </p>
        <p class="note">
          The stacking order of animations is independent of the
          current play direction of individual animations and animation
          groups.
        </p>
      </section>
      <section>
        <h3>Resolving Animation Stacks</h3>
        <p>
          In order to resolve an animation stack, an initial animation
          value is required for each element and property animated by the
          stack.
          To calculate a current animation value for elements and properties
          from an animation stack, an animation value is generated for each
          animation in the stack 
          (see <a href="#calculating-animation-values" class="sectionRef"></a>).
          The cumulative animation result for each element and property is first
          initialised to the relevant initial animation value.
          Starting at the bottom of the stack (i.e. earliest start time) and
          working up, as animation results are encountered for an element
          and property, these are merged into the cumulative animation result
          using the animation combinator stored in the 
          <code>AnimationEffect</code> that generated the result.
          Once all animation results in the stack are processed, the resulting
          cumulative animation values are the current animation values for
          each property of each element that is animated.
        </p>
      </section>
      <section>
        <h3>Animation combinators</h3>
        <p>
          When an animation applies to a target and property that animations
          earlier in the animation stack have already applied to, the
          cumulative animation result from the stack is composited with the new
          animation to produce a new cumulative animation result.
          The possible combinators are defined by the <a>CompositeOperation</a>
          enumeration.
        </p>
        <section>
          <h4>The REPLACE combinator</h4>
          <p>
            When an animation <code>a</code> is composited over a cumulative
            animation result <code>c</code> using the REPLACE combinator, the
            new cumulative animation result is always <code>a</code>.
          </p>
        </section>
        <section>
          <h4>The ACCUMULATE combinator</h4>
          <p>
            When a path animation <code>a</code> is composited over a
            cumulative animation result <code>c</code> using the ACCUMULATE
            combinator, the effective transform of <code>a</code> is calculated.
            This transform is then post-multiplied to the cumulative animation
            result to generate a new cumulative animation result.
          </p>
          <p>
            When a transform animation <code>a</code> is composited over a
            cumulative animation result <code>c</code> using the ACCUMULATE
            combinator, <code>a</code> is post-multiplied to the cumulative
            animation result to generate a new cumulative animation result.
          </p>
          <p>
            When a simple animation (i.e. an animation which is not a path
            animation nor a transform animation) <code>a</code> is composited
            over a cumulative animation result <code>c</code> using the
            ACCUMULATE combinator, the new cumulative animation result is the
            sum of <code>a</code> and <code>c</code>, clipped if necessary to
            the appropriate domain.
          </p>
        </section>
        <section>
          <h4>The MERGE combinator</h4>
          <p>
            All MERGE operators are governed by an interpolation parameter
            <code>p</code> that is calculated as the ratio of
            <code>(currentTime - parent.startTime)
            / parent.animationDuration</code>, where <code>parent</code> is the
            <code>AnimationTemplate</code> which references the
            <code>AnimationEffect</code> that is being composited.
          </p>
          <p>
            When a path animation <code>a</code> is composited over a
            cumulative animation result <code>c</code> using the MERGE
            combinator, the effective transform of <code>a</code> is
            calculated.
            This transform is then interpolated with <code>c</code> using the
            rules provided in [[!CSS3-2D-TRANSFORMS]] to provide the new
            cumulative animation result.
          </p>
          <p>
            When a transform animation <code>a</code> is composited over a
            cumulative animation result <code>c</code> using the MERGE
            combinator, <code>a</code> is interpolated with <code>c</code>
            using the rules provide in [[!CSS3-2D-TRANSFORMS]] to provide the 
            new cumulative animation result.
          </p>
          <p>
            When a simple animation <code>a</code> is composited over a
            cumulative animation result <code>c</code> using the MERGE
            combinator, the new cumulative animation result is calculated as
            the weighted sum of <code>a</code> and <code>c</code>, with weights
            of <code>(1-p)</code> and <code>p</code> respectively.
          </p>
        </section>
      </section>
      <section>
        <h3>Current values, animation values, and the override stylesheet</h3>
        <section>
          <h4>Current values</h4>
          <p>
            The <var>current value</var> of a given property and object is the
            value generated for that property by computing a current style for
            that object without taking the override stylesheet into account.
          </p>
        </section>
        <section>
          <h4>The override stylesheet</h4>
          <p>
            The override stylesheet contains output animation values and
            acts with a higher priority than all other stylesheets. However,
            !important rules from all other stylesheets act with a higher priority
            than the override stylesheet.

            The override stylesheet is regenerated for each timepoint in a
            document using the process described below.
          </p>
        </section>
        <section>
          <h4>Animation values</h4>
          <p class="todo">
            We already have a section with the heading "animation values".
            Ideally they should be unique so they're easy to target by named
            anchor.
          </p>
          <p>
            Animation values for all animated properties are generated at
            each time point according to the following process, then inserted
            into the override stylesheet.
          </p>
          <ol>
            <li>
              A global animation stack is generated as described in 
              <a href="#the-global-animation-stack" class="sectionRef"></a>.
            </li>
            <li>
              An initial animation value is generated by taking the current
              style for each object (ignoring the override stylesheet) and
              extracting a value for each animated property.
            </li>
            <li>
              The global animation stack is resolved using the initial animation
              value and the process in 
              <a class="sectionRef" href="#resolving-animation-stacks"></a>.
            </li>
            <li>
              The current animation values generated by this process are inserted
              into the override stylesheet.
            </li>
            <p class="todo">
              Do we need to work out how to use the override stylesheet for
              elements that don't have an id but are targetted for animations?
            </p>
          </ol>
        </section>
      </section>
    </section>

    <section>
      <h2>Synchronizing with media</h2>
      <div class="todo">
        Currently investigating integration with HTML5's MediaController object.
      </div>
      <section>
        <h3>The <code>MediaItem</code> interface</h3>
        <dl title="interface MediaItem : TimedItem" class="idl">
          <dt>attribute HTMLMediaElement element</dt>
          <dd>
            A pointer to the element?
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Script interface</h2>
      <p>
        In addition to the abstract model described above, Web Animations also
        defines a programming interface to the model.
        This interface can be used to inspect and extend animations produced by
        declarative means or for directly producing animations when a procedural
        approach is more suitable.
      </p>
    </section>

    <section>
      <h2>Timing events</h2>
      <p>
        As timed items play they report changes to their status through
        <a>TimingEvent</a>s.
      </p>
      <div class="annotation">
        <p><strong>Relationship to CSS and SVG events</strong></p>
        <p>
          CSS defines <code>AnimationEvent</code>s and
          <code>TransitionEvent</code>s and SVG defines <code>TimeEvent</code>s.
          The proposal here is to dispatch <a>TimingEvent</a>s in parallel to
          these events.
          This has the following properties:
        </p>
        <ul>
          <li>It is possible to register for <em>just</em> CSS animation events,
          or <em>just</em> CSS transition events, or <em>just</em> SVG time
          events, or <em>all</em> animation-related events
          (by registering for the timing events defined here).</li>
          <li>Backwards compatibility&mdash;existing content continues to work
          as is.</li>
        </ul>
        <p>
          An alternative is to make CSS and SVG events subclass
          <a>TimingEvent</a> and just fire the one event.
          Two issues arrive with this.
          Firstly, the event type would change on the subclasses so it wouldn't
          be possible to catch all "start" events, for example.
          Secondly, the propagation path for SVG events is different since they
          are fired at the animation template element rather than the animation
          target element.
        </p>
        <p>
          Nevertheless, there may be alternative approaches here such as
          augmenting CSS Animation events only and firing them from the API
          (although that may cause compatibility issues when SVG animations
          start reporting events to content expecting only CSS animations).
        </p>
      </div>
      <section>
        <h3>The <code>TimingEvent</code> interface</h3>
        <dl title="interface TimingEvent : Event" class="idl">
          <dt>Constructor
              (DOMString type, optional TimingEventInit eventInitDict)</dt>
          <dd>
            Constructs a new <a>TimingEvent</a> object as described in <a
            href="http://www.w3.org/TR/dom/#constructing-events">Constructing
            events</a> in [[!DOM4]].
          </dd>
          <dt>attribute double documentTime</dt>
          <dd>
            <p>
              The <code>currentTime</code> of the <a>DocumentTimeSource</a> with
              which the <a>TimedItem</a> is associated when the event was
              dispatched.
            </p>
            <div class="annotation">
              <p>
                I think document time will be much more useful than global time.
                For the rarer case that you want to synchronise animations
                between documents using events, I anticipate
                <a>DocumentTimeSource</a> will have a method to convert
                a document to global time and vice-versa and/or convert times
                from one <a>DocumentTimeSource</a> to another
                <a>DocumentTimeSource</a>.
              </p>
              <p>
                When we come to define animations that aren't necessarily linked
                to a document time source we'll need to make this nullable or
                redefine it to mean "root time source".
              </p>
            </div>
          </dd>
          <dt>attribute double localTime</dt>
          <dd>
            <p>
              The <a>output time value</a> of the <a>TimeSource</a> with which
              the <a>TimedItem</a> is associated when the event was dispatched.
              For animations that do not belong to an <a>TimingGroup</a> this
              will be equal to <code>documentTime</code>.
            </p>
            <p class="annotation">
              If we allow animations to be associated with, for example,
              MediaControllers, we'll need to revise the above description to
              cover more than just <a>TimingGroup</a>s.
            </p>
            <p class="annotation">
              If we rename <a>item time</a> to local time we'll need to rename
              this.
              Note that the time given here is in <em>parent iteration
              time</em>.
              This is the same time space used for <code>startTime</code> and
              <code>endTime</code>.
              This is the most useful time space if, for example, you receive
              a timing event and want to add a new animation that synchronises
              with the item that dispatched the event by adding it to the same
              time source (e.g. group).
            </p>
          </dd>
          <dt>attribute unsigned long? iterationIndex</dt>
          <dd>
            The value of <code>currentIteration</code> on the target
            <a>TimedItem</a> when the event was dispatched.
          </dd>
        </dl>
        <p class="issue">
          Suggestions for naming? CSS has taken <code>AnimationEvent</code> and
          <code>TransitionEvent</code> and SVG has <code>TimeEvent</code>.
          Call it <code>SyncEvent</code>?
          Or we could just augment <code>AnimationEvent</code> since it has
          a similar propagation path.
        </p>
        <dl title="dictionary TimingEventInit" class="idl">
          <dt>double documentTime = 0</dt>
          <dd></dd>
          <dt>double localTime = 0</dt>
          <dd></dd>
          <dt>double iterationIndex = 0</dt>
          <dd></dd>
        </dl>
      </section>
      <section>
        <h3>Types of <a>TimingEvent</a></h3>
          <dt>timingstart</dl>
          <dd>
            Occurs at the moment when an item enters an <a>animation
            interval</a> (from either direction).
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
            </ul>
          </dd>
          <dt>timingiteration</dl>
          <dd>
            Occurs at the moment when a repeating item's
            <code>currentIteration</code> changes excluding changes to and from
            <code>null</code>.
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
            </ul>
          </dd>
          <dt>timingend</dl>
          <dd>
            Occurs at the moment when an item leaves an <a>animation
            interval</a> (from either direction).
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
            </ul>
          </dd>
          <dt>timingcancel</dl>
          <dd>
            Occurs when <code>TimedItem.cancel</code> is called.
            In this case, a <em>timingend</em> event is not fired
            (see the description of
             <a href="#widl-TimedItem-cancel-void">TimedItem.cancel</a>).
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
            </ul>
          </dd>
        </dl>
        <p class="annotation">
          The naming here is not great.
          Would <code>syncstart</code> be any better?
          If we augment <code>AnimationEvent</code> then at least we could use
          <code>animationstart</code> etc.
        </p>
        <div class="annotation">
          <p>
            Other potential event types for a later version:
          </p>
          <ul>
            <li><em>pause</em> &mdash;
              fires whenever <code>paused</code> is newly true.<br>
              Use case: show a graphic overlay to mark a cartoon as paused.<br>
              Likewise <em>unpause</em>.</li>
            <li><em>seek</em> &mdash;
              fires whenever <code>currentTime</code> is set on the item or an
              ancestor.<br>
              Use case: Acts as a signal that intermediate events may have been
              dropped (see <a href="#event-dispatch-during-seeking"
              class="sectionRef"></a>).
              For example, if you have an iteration event handler that assumes
              it will get one call per iteration, then a seek event would be
              a cue that you need to check <code>iterationIndex</code> and
              adjust.
              Also, if you were implementing something like SVG's syncbase
              timing with script you often need to do some bookkeeping on
              a seek.
            </li>
            <li><em>directionchange</em> &mdash;
              fires whenever the effective direction of the item changes (due to
              the direction attribute, changes to playbackRate, calling reverse
              etc. on either the item or an ancestor)<br>
              Use case: update UI to represent rewinding;
              stop audio when playing backwards to prevent secretly encoded
              messages being revealed.
            </li>
            <li><em>newanimation</em> &mdash;
              fires whenever a new <a>Animation</a> object is created.
              Use case: a timeline debugger. You want to show all animations
              that are playing or yet-to-play.
              Using this event (and <code>document.getCurrentAnimations</code>?)
              you could build up a timegraph.
              <p>
                I think this sort of event and this sort of use case would fit
                the MutationObserver pattern well.
                We could introduce a whole class of mutation records targetted
                at debugging (e.g. <em>timewindowchange</em>)
              </p>
          </ul>
          <p>
            Also, although this is a bit different to a regular event (since
            it's qualified by a parameter), it seems like it might be nice to be
            able to do something like:
          </p>
          <pre class='example sh_javascript'>
            anim.onprogress(0.8,
             function() {
              // Issue a request to prefetch the next episode
             });
          </pre>
          <p>
            It would be called whenever you got a sample where
            <code>iterationTime</code> &ge; <var>progress</var> was newly true.
          </p>
        </div>
      </section>
      <section>
        <h4>Event dispatch</h4>
        <p>
          The <a
          href="http://www.w3.org/TR/DOM-Level-3-Events/#glossary-propagation-path">propagation
          path</a> for all events depends on the <a>TimedItem</a> where the
          status change took place.
          If the item is an <a>Animation</a> with a <code>target</code> that is
          not <code>null</code>, the propagation path follows the usual <a
          href="http://www.w3.org/TR/DOM-Level-3-Events/#event-flow">DOM event
          flow</a> from <code>DefaultView</code> down the parent chain to
          <code>target</code> and finally to the
          <a>TimedItem</a> where the status change took place.
          Otherwise, the propagation path is simply the <code>TimedItem</code>
          object itself.
        </p>
        <p class="note">
          Note that unlike <code>AnimationEvent</code>s and
          <code>TransitionEvent</code>s in CSS, and <code>TimeEvent</code>s in
          SVG which target an Element, the target of a <a>TimingEvent</a> is
          a <a>TimedItem</a>.
        </p>
        <p>
          Since Web Animations makes no guarantees about the time between
          successive frames of animation, it is possible that the time when
          a change in state that should produce an event is scheduled to occur
          does not line up with a frame.
        </p>
        <p>
          As such, the events that should be dispatched when sampling the model
          is based on the interval between samples as follows.
        </p>
        <ul>
          <li>
            Let <var>previous sample</var> be the moment when the timing model
            was last sampled, recorded in document time.
            If there was no previous sample, then let <var>previous sample</var>
            be -1.
          </li>
          <li>
            Let <var>current sample</var> be the current document time.
          </li>
          <li>
            Let <var>progress interval</var> be the interval (<var>previous
            sample</var>, <var>current sample</var>].
          </li>
        </ul>
        <p>
          The events to be dispatched are therefore those whose document time
          lies within <var>progress interval</var>.
        </p>
        <div class="issue">
          <p>
            This description fails to account for newly-added animations,
            removed animations, and other tree surgery.
            For example, if I have a sample at t=3s, I add an animation whose
            animation interval starts at t=2s, and then conduct another sample
            at t=4s, the <em>timingstart</em> event should fire even though the
            event's document time lies outside the progress interval.
          </p>
          <p>
            We could possibly fix this by making the previous sample times and
            current sample times per-<a>TimedItem</a> but that won't work for
            repeating groups.
            Needs work.
          </p>
        </div>
        <div class="issue">
          <p>
            This last part here requires calculating document times (both for
            testing against the progress interval and also for filling in the
            <code>documentTime</code> property of the event) and that's hard to
            calculate since our current model allows non-invertible timing
            functions on groups.
            That means you can't easily just traverse the descendants (by child
            and iteration) and generate a list of interval and iteration
            boundaries then filter out the ones that don't fit in the interval
            because you can't easily convert from local time to document time.
          </p>
          <p>
            You can, of course, convert from document time to local time
            and while that's probably enough to tell if there was an interval or
            iteration edge or not, it's not enough to determine the exact time
            at which it occurred (to fill in the event parameters).
          </p>
          <p>
            A complex example is where you have an group whose iteration time
            goes from 0 to 1.5 to 0.7 back to 1.
            Suppose you have a child animation that finishes its animation
            interval at 80% of the way through the parent's iteration interval.
            It would then finish, do nothing, then start reversing part-way,
            then finish again.
            In that case I think you expect to get: start, finish, start,
            finish.
          </p>
          <p>
            It's probably not impossible, so long as we allow for the fact that
            the inverse may have several (even equal) roots but it sounds tricky
            and possibly expensive to calculate on each iteration.
          </p>
          <p>
            I think we might need to re-consider allowing non-invertible timing
            functions on groups.
            Alternatively we could say that the children of a group with
            a non-interval timing function don't generate events.
            Or, alternatively again, that they occur on the non-transformed
            times.
          </p>
          <p>
            This final options of making event times untransformed times is not
            such a bad option, especially if we split time transformations into
            a separate step and perhaps even a separate interface.
            It's similar to some vector graphics editing programs that provide
            bitmap filter effects&mdash;often the bounding box of the filtered
            shape reflects the dimensions of the vector shape and not that of
            the bitmapped result.
          </p>
          <p>
            Also, in the case of an animation that bounces back and forth before
            resting at its final value, it's probably more useful to get just
            one end event when it finally rests than lots of little end/start
            events each time it crosses the 1.0 iteration time boundary.
          </p>
        </div>
        <div class="issue">
          <p>
            One implementation issue with events is that sometimes you find you
            suddenly have a large backlog of events to dispatch and this may
            have an adverse impact on performance.
            Some such situations include:
          </p>
          <ul>
            <li>
              You have a short iteration duration, e.g. 50ms, then you get put
              in a background tab and throttled really low.
              On the next sample, you might have hundreds of iteration events to
              dispatch.
            </li>
            <li>
              You have an arrangement of animations such that they keep spawning
              new ones for ever.
              You can easily get this in SVG using syncbase timing or in the
              model here by using repeating groups.
              In this case, you can have a lot of events to dispatch if you get
              throttled low.
              Once you have a global clock, you also encounter this situation
              when the computer goes to sleep since when it wakes up it will
              have a lot of start/end/iteration events to catch up on.
            </li>
          </ul>
          <p>
            It seems like the Mutation Observer pattern might help here except,
            firstly, that might prevent simple usage such as:
          </p>
          <pre class='example sh_javascript'>
elem.animate({ opacity: '0%' }, 1).onend =
   function() { elem.parentNode.removeChild(elem); };
          </pre>
          <p>
            Secondly, even using the observer pattern doesn't relieve the
            implementation of having to walk through the model and determine
            all the mutations that have occured and their corresponding times
            and this could be expensive if the computer has been asleep for
            a few days.
          </p>
          <p>
            Another option might be to set some implementation requirements that
            allow dropping events or automatic pausing when the time between
            samples is protracted (such as the device going to sleep).
          </p>
        </div>
      </section>
      <section>
        <h3>Event dispatch during seeking</h3>
        <p>
          The previous description of event dispatch applies when the timing
          model is sampled during normal playback (whether forwards or
          backwards).
          However, when a seek is performed by setting the
          <code>currentTime</code> of a <a>TimedItem</a>,
          a different behavior is employed.
          In effect, event dispatch is supressed until the seek is completed.
          After the seek has completed, events are dispatched based on comparing
          the before and after state of each <a>TimedItem</a> affected by the
          seek.
          Iteration events are not dispatched.
        </p>
        <p class="annotation">
          Supressing events during seeking is necessary to provide performant
          seeking.
          It is also arguably the more intuitive behavior as, for example,
          when rewinding a cartoon one probably does not expect a bucketload of
          events to arrive as a result of traversing backwards over each
          <a>TimedItem</a>.
        </p>
        <p class="issue">
          Should iteration events be dispatched?
        </p>
        <p>
          The procedure is as follows:
        </p>
        <ol>
          <li>Prior to performing the seek on <var>item</var>,
              record whether it is <a>active</a> or not.</li>
          <li>If <var>item</var> is an <a>TimingGroup</a> record whether each
              descendent <a>TimedItem</a> is <a>active</a> or not.</li>
          <li>Perform the seek as described in <a href="#seeking-a-timed-item"
            class="sectionRef"></a>.</li>
          <li>For each <a>TimedItem</a> considered in steps 2 and 3, compare
              whether the item was <a>active</a> before the seek and
              whether it is <a>active</a> now and dispatch events as follows:
              <dl class="switch">
                <dt>If the item was previously <a>active</a> but, after seeking,
                    is no longer <a>active</a>,</dt>
                <dd>Dispatch a new <code>timingend</code> event with
                  <a>localTime</a> set to <code>endTime</code> and
                  <a>documentTime</a> set to the corresponding document
                  time.
                  <span class="todo">(Obviously this depends on being able
                    to convert from a local time to a document time as
                    discussed in the previous section.)
                </dd>
                <dt>If the item was previously not <a>active</a> but, after
                    seeking, is now <a>active</a>,</dt>
                <dd>Dispatch a new <code>timingstart</code> event with
                  <a>localTime</a> set to <code>startTime
                  + timing.startDelay + timeDrift</code> and
                  <a>documentTime</a> set to the corresponding document
                  time.
                </dd>
              </dl>
          </li>
        </ol>
        <p>
          The sequence of dispatched events is identical to that of events
          dispatched during regular sampling (see <a href="#sequence-of-events"
            class="sectionRef"></a>).
        </p>
      </section>
      <section>
        <h3>Sequence of events</h3>
        <p>
          <a>TimingEvent</a>s are categories as <a
          href="http://www.w3.org/TR/DOM-Level-3-Events/#sync-async">synchronous
          events</a> whose sequence is as follows:
        </p>
        <ol>
          <li>Events are ordered by <code>documentTime</code></li>
          <li>For events with the same <code>documentTime</code>,
              sort by event type from first to last as follows:
              <em>timingcancel</em>, <em>timingend</em>,
              <em>timingiteration</em>, <em>timingstart</em>.
              <p class="note">
                Note that sorting end events before start events is consistent
                with the end-point exclusive nature of timing in Web
                Animations (see <a href="#interval-timing"
                class="sectionRef"></a>).
                When animation A ends at the same time as animation B begins,
                we can imagine that animation A ends an incredibly short amount
                of time before animation B begins such that there is no overlap.
              </p>
          </li>
          <li>
            For events with the same <code>documentTime</code> and type,
            if the target <a>TimedItem</a>s participate in a tree made up of
            <a>TimingGroup</a>s then the events are dispatched as if the tree
            was sampled breadth-first such that events attached to ancestor
            <a>TimedItem</a>s are dispatched first.
          </li>
        </ol>
        <p class="issue">
          What if the order is still unresolved, is it okay to leave it
          undefined?
          Can we use document order or script order here?
          It's tempting to use the same order as we use for compositing but
          remember that not everything that is timed is composited (e.g.
          groups).
        </p>
      </section>
      <section>
        <h3><a>TimedItem</a> events interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Event callbacks</dt><dd></dd>
          <dt>attribute EventHandler onstart</dt>
          <dd>
            The event handler for the <em>timingstart</em> event
            (see <a href="#timing-events" class="sectionRef"></a>).
          </dd>
          <dt>attribute EventHandler oniteration</dt>
          <dd>
            The event handler for the <em>timingiteration</em> event
            (see <a href="#timing-events" class="sectionRef"></a>).
          </dd>
          <dt>attribute EventHandler onend</dt>
          <dd>
            The event handler for the <em>timingend</em> event
            (see <a href="#timing-events" class="sectionRef"></a>).
          </dd>
          <dt>attribute EventHandler oncancel</dt>
          <dd>
            The event handler for the <em>timingcancel</em> event
            (see <a href="#timing-events" class="sectionRef"></a>).
          </dd>
        </dl>
        <p class="note">
          Note that the <a
          href="http://www.w3.org/TR/html5/webappapis.html#eventhandler">EventHandler</a>
          callback interface type is defined in [[!HTML5]].
        </p>
        <div class="idl" title="TimedItem implements EventTarget">
          <a>TimedItem</a> also implements the <a class="externalDFN"
          href="http://www.w3.org/TR/dom/#eventtarget">EventTarget</a>
          interface defined in [[!DOM4]].
        </div>
      </section>
    </section>

    <section>
      <h2>Querying current animations</h2>
      <p>
        It is often useful to be able to access the animations currently in play
        or scheduled to play, that is <a>current</a> animations, including those
        which may have been defined declaratively rather than by using the API.
        To that end the following extensions are defined for
        the <a class="externalDFN"
        href="http://www.w3.org/TR/dom/#interface-document">Document</a>
        and <a class="externalDFN"
        href="http://www.w3.org/TR/dom/#interface-element">Element</a>
        interfaces defined in [[!DOM4]].
      </p>
      <p class="note">
        Note that animations for which the current time falls <em>after</em> the
        <a>active interval</a> but which are still <a>in effect</a> due to
        a <a>fill mode</a> are <em>not</em> returned by this method.
        This is because in order to return such animations, user agents would be
        required to maintain all animations with a forwards fill indefinitely.
        As a result the resources consumed by an animated document would
        steadily accumulate over time.
      </p>
      <dl class="idl" title="partial interface Document">
        <dt>sequence&lt;Animation&gt; getCurrentAnimations()</dt>
        <dd>
          <p>
            Returns all <a>Animation</a> objects that meet <em>both</em> of the
            following conditions:
          </p>
          <ol>
            <li>
              has a <code>target</code> property that is an Element whose
              <code>ownerDocument</code> is the Document on which this method
              was called, <em>or</em> has a <code>target</code> property that is
              a <a>PseudoElement</a> whose <code>element.ownerDocument</code> is
              the Document on which this method was called, and
            </li>
            <li>
              is <a>current</a>.
            </li>
          </ol>
          <p>
            The returned sequence is a snapshot (i.e. not live) representing the
            state of animations that corresponds at the time when the method was
            called.
          </p>
          <div class="issue">
            <p>
              There are at least three ways to define which elements this
              covers in terms of their association with the Document object on
              which the method is called, <var>document</var>:
            </p>
            <ol>
              <li>All <a>Animation</a>s created using
              <a><var>document</var>.createAnimation</a>&mdash;means even
              Animations that don't target an element (e.g. they do some audio,
              or target a scrollbar) get included. Not sure if this is good or
              bad.</li>
              <li>All <a>Animation</a>s which, if you trace their chain of time
              sources you eventually arrive at
              <code><var>document</var>.timeline</code>&mdash;means if you
              associate an Animation with a custom time source like a scrollbar
              (in a future version) it wouldn't be included. Again, not sure if
              this is good or bad.</li>
              <li>All <a>Animation</a>s whose <code>target</code> or
              <code>target.element</code> (for <a>PseudoElement</a>s) has an
              <code>ownerDocument</code> which is
              <var>document</var>&mdash;means only stuff which is affecting this
              document's DOM in the usual way is included (but including, if
              it's even possible, animations from another document).</li>
            </ol>
            <p>
              I suspect option 2 is the best approach but I've specified 3 for
              now simply because it was easiest.
            </p>
            <p>
              I'll probably specify 2 once we've cleared up some of the issues
              surrounding time sources.
            </p>
          </div>
        </dd>
      </dl>
      <dl class="idl" title="partial interface Element">
        <dt>sequence&lt;Animation&gt; getCurrentAnimations()</dt>
        <dd>
          <p>
            Returns all <a>Animation</a> objects whose <code>target</code>
            property is the Element on which this method was called and which
            are <a>current</a>.
            Note that this does <em>not</em> include <a>PseudoElement</a>s whose
            <code>element</code> attribute refers to this Element.
          </p>
          <p>
            The returned sequence is a snapshot (i.e. not live) representing the
            state of animations that corresponds at the time when the method was
            called.
          </p>
        </dd>
      </dl>
    </section>

    <section>
      <h2>Interaction with script</h2>
      <p>
        The Web Animations model may be modified using the API defined in this
        specification.
        This iteraction between script execution and the regular operation of
        the model is defined as follows:
      </p>
      <ul>
        <li>
          <p>
            Changes made to the timing model are reflected immediately in the
            values returned by timing model interfaces.
            <span
            class="todo">(Need to be more specific here. Once the section
            numbers have stabilized we could put section numbers here.)</span>
            Similarly, timing model methods that operate on the current state
            of the model such as pausing or reversing are applied to
            a fully-updated timing model, that is, after all previous
            modifications have been incorporated.
          </p>
          <div class="informative">
            <p>
              For example, if an <a>Animation</a>'s <code>startTime</code> is
              changed via the API, the value returned when querying the
              animation's <code>endTime</code> will reflect updated state of the
              timing model immediately.
            </p>
            <pre class="example sh_javascript">
              // Initially startTime is 3 and endTime is 5
              anim.startTime = 4;
              alert(anim.endTime); // Displays '6'
            </pre>
            <p>
              The same concept applies to more complex modifications of the
              timing model such as adding and removing children from
              a <a>TimingGroup</a>.
            </p>
          </div>
        </li>
        <li>
          <p>
            Changes to the timing model other than <a
            href="#seeking-a-timed-item">seek operations</a> do not cause
            <a href="#timing-events">timing events</a> to be dispatched
            immediately.
            Instead, such events are dispatched upon the next sample as defined
            in <a href="#event-dispatch" class="sectionRef"></a>.
          </p>
          <p>
            The behavior of events with relation to seek operations is defined
            in <a href="#event-dispatch-during-seeking" class="sectionRef"></a>.
          </p>
          <div class="informative">
            <p>
              For example, if a series of modifications to the timing model in
              a single script block causes a <a>TimedItem</a>'s <a>item time</a>
              to jump from being outside the active interval, to inside the
              interval, and then outside again no events are fired as in the
              following example.
            </p>
            <pre class="example sh_javascript">
              // document.timeline.currentTime is 3
              var anim = new Animation(null, null, 2);
              anim.onstart = function() { alert("started"); };
              anim.play(); // startTime = 3
              anim.startTime = Infinity;
              // No alert is shown
            </pre>
          </div>
        </li>
        <li>
          <p>
            Modifications to any part of the API (whether the timing model or
            animation model) are not reflected in the target element and nor is
            any <a>CustomAnimationEffect</a> called until the next sample has
            been performed at some time after the current script block completes
            execution.
          </p>
          <div class="informative">
            <p>
              For example, if a series of modifications to the timing model in
              a single script block causes a <a>TimedItem</a>'s <a>item time</a>
              to jump from being outside the active interval, to inside the
              interval, and then outside again no events are fired as in the
              following example.
            </p>
            <pre class="example sh_javascript">
              // Set opacity to 0 immediately
              var anim = new Animation(elem, { "opacity": 0 });
              anim.play();
              alert(window.getComputedStyle(elem).opacity);
              // Displays '1'
            </pre>
          </div>
          <p class="issue">
            I'm unsure if this is the desired behavior.
            Gecko, for example, forces a synchronous sample when a seek is
            performed.
            This certainly makes testing simpler but I'm not sure if this is
            a good idea or not.
          </p>
          <p class="issue">
            Do we need to put some minimum requirement on when samples are
            performed?
            By the time the next script block executes can I assume the model is
            up to date?
          </p>
        </li>
        <li>
          <p>
            The value returned by
            <code><a>DocumentTimeSource</a>.currentTime</code> will not change
            within a script block unless explicitly set through the API.
          </p>
          <div class="informative">
            <p>
              For example, if a series of modifications to the timing model in
              a single script block causes a <a>TimedItem</a>'s <a>item time</a>
              to jump from being outside the active interval, to inside the
              interval, and then outside again no events are fired as in the
              following example.
            </p>
            <pre class="example sh_javascript">
              var a = document.timeline.currentTime;
              // ... many lines of code ...
              var b = document.timeline.currentTime;
              alert(b - a); // Displays 0
            </pre>
          </div>
          <p class="issue">
            What about when <code>play</code> is called and the
            <a>DocumentTimeSource</a> is not already playing?
            We said elsewhere that <code>currentTime</code> <em>immediately</em>
            becomes zero.
            If we want that to be true we should probably force a synchronous
            sample at that point.
          </p>
        </li>
      </ul>
    </section>

    <section>
      <h2>Integration with Media Fragments</h2>
      <p>
        The Media Fragments specification [[!MEDIA-FRAGMENTS]] defines a means
        for addressing a temporal range of a media resource.
        The application of media fragments depends on the MIME type of the
        resource on which they are specified.
        For resources with the <a
        href="http://www.w3.org/TR/SVG/intro.html#MIMEType">SVG MIME type</a>
        [[!SVG11]], the application of temporal parameters is defined in the <a
        href="svg-integration.html">Web Animations and SVG Integration</a>
        specification.
      </p>
      <p class="note">
        Note that media fragments are defined to operate on resources based on
        their MIME type.
        As a result, temporal addressing may not be supported in all situations
        where Web Animations content is used.
      </p>
    </section>

    <section>
      <h2>Interaction with page display</h2>
      <p class="todo">
        What should be the behavior here? Should we pause on unload/pagehide?
        What does video do?
      </p>
    </section>

    <section>
      <h2>Making animation accessible</h2>
      <p class="todo">
        TBD. If we have triggers represented in the API, need a way to make
        these available to accessibility agents.
      </p>
      <p class="todo">
        TBD. Need a way to expose speed control etc.?
      </p>
      <p class="todo">
        TBD. Describe how to integrate with the <a
          href="http://www.whatwg.org/specs/web-apps/current-work/#timed-text-tracks">Timed
          Text API</a> and give examples of how to author content so it is
        accessible.
      </p>
    </section>

    <section>
      <h2>Implementation requirements</h2>
      <section>
        <h3>Discarding past animations</h3>
        <p>
          If implementations are required to preserve all state associated with
          animations then the resources required by an animation could continue
          to increase without limit over time. For long-running animations, and
          particularly those where animations are added dynamically, this could
          lead to degraded performance and eventual failure.
        </p>
        <div class="issue">
          <p>
            I'm not sure how to define this. We could say all animations with
            <code><var>end time converted to document time</var> &lt;
            <var>current document time</var> - 5min</code> can be discarded.
          </p>
          <p>
            That's fine, but what about crazy documents that put 1 million
            animations in a 5min span? Just leave that up to the browser.
            Also, what about mobile clients, is 5 min too long? Is this too
            prescriptive?
          </p>
          <p>
            Maybe, just make some suggestions (e.g. 1 min for mobile clients,
            5 min for desktop?) and then define an exception to throw if there
            is a seek to some time outside that window.
          </p>
          <p>
            Also, note that defining this in terms of past intervals is
            direction-specific but that's probably ok since most long-running
            animations will run forwards.
          </p>
        </div>
      </section>
      <section>
        <h3>Conformance criteria</h3>
        <p class="todo">
          Basically, for non-scripted user agents, there are none,
          For scripted user agents, do the API.
        </p>
      </section>
    </section>

    <section class='appendix' id="webidl-ref">
      <h2>Interface summary</h2>
    </section>

    <section class='appendix'>
      <h2>Acknowledgements</h2>
      <p>
        Thank you to Michiel &ldquo;Pomax&rdquo; Kamermans for help with the
        equations for a proposed smooth timing function although this feature
        has been deferred to a subsequent specification.
      </p>
    </section>
  </body>
</html>
