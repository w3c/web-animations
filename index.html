<!DOCTYPE html>
<!-- vim: set expandtab ts=2 sw=2 tw=80: -->
<html>
  <head>
    <title>Web Animations 1.0</title>
    <meta charset='utf-8'>
    <script src="respec/respec.js" class="remove"></script>
    <script src="respec/js/sh_javascript.min.js" class="remove"></script>
    <script class="remove">
      var respecConfig = {
        // specification status (e.g. WD, LCWD, NOTE, etc.). If in doubt use
        // ED.
        specStatus: "ED",

        // the specification's short name, as in
        // http://www.w3.org/TR/short-name/
        shortName:            "web-animations",

        // if your specification has a subtitle that goes below the main
        // formal title, define it here
        // subtitle   :  "an excellent document",

        // if you wish the publication date to be other than today, set this
        publishDate:  "2013-06-25",

        // if the specification's copyright date is a range of years, specify
        // the start date here:
        // copyrightStart: "2012"

        // if there is a previously published draft, uncomment this and set
        // its YYYY-MM-DD date and its maturity status
        // previousPublishDate: "1977-03-15",
        // previousMaturity: "WD",

        // if there a publicly available Editor's Draft, this is the link
        edDraftURI: "http://dev.w3.org/FXTF/web-anim/web-animations.html",

        // if this is a LCWD, uncomment and set the end of its review period
        // lcEnd: "2009-08-05",

        // if you want to have extra CSS, append them to this list
        // it is recommended that the respec.css stylesheet be kept
        extraCSS: ["respec/respec.css",
                   "web-animations.css"],

        // Turning off inlineCSS for now since if extraCSS points to
        // a relative URL your testing from a file URL the XHR will fail.
        // Probably should turn this back on once this is hosted on a server
        // somewhere.
        inlineCSS: false,

        // editors, add as many as you like
        // only "name" is required
        editors:  [
            { name: "Brian Birtles", mailto: "bbirtles@mozilla.com",
              company: "Mozilla Japan", companyURL: "http://mozilla.jp/" },
            { name: "Shane Stephens", mailto: "shans@google.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
            { name: "Alex Danilo", mailto: "adanilo@google.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
            { name: "Dmitry Baranovskiy", mailto: "baranovs@adobe.com",
              company: "Adobe Systems", companyURL: "http://www.adobe.com/" },
            { name: "Tab Atkins", mailto: "jackalmage@gmail.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
        ],

        // authors, add as many as you like.
        // This is optional, uncomment if you have authors as well as editors.
        // only "name" is required. Same format as editors.

        //authors:  [
        //    { name: "Your Name", url: "http://example.org/",
        //      company: "Your Company", companyURL: "http://example.com/" },
        //],

        // name of the WG(s)
        wg: [ "CSS Working Group",
              "SVG Working Group" ],

        // URI of the public WG page
        wgURI: [ "http://www.w3.org/Style/CSS/members",
                 "http://www.w3.org/Graphics/SVG/WG" ],

        // Activity this WG is part of
        wgActivity: [ 
          [ "Style", "http://www.w3.org/Style/Activity" ],
          [ "Graphics", "http://www.w3.org/Graphics/Activity" ]
        ],

        // name (without the @w3c.org) of the public mailing to which comments
        // are due
        wgPublicList: "public-fx",

        // URI of the patent status for this WG, for Rec-track documents
        // !!!! IMPORTANT !!!!
        // This is important for Rec-track documents, do not copy a patent URI
        // from a random document unless you know what you're doing. If in
        // doubt ask your friendly neighbourhood Team Contact.
        wgPatentURI:  "",

        noIDLSorting: true,
        noIDLIn: true
      };
    </script>
    <!--
      ReSpec.js wishlist:

      Add here any issues you find with ReSpec including missing features. It
      will help us decide if we should continue using it and work out what we
      need to fix.

      * Allow making cross-references to specific methods and members.
    -->
  </head>
  <body>
    <section id="abstract">
      This specification defines a model for synchronization and timing of
      changes to the presentation of a Web page.
      This specification also defines an application programming interface for
      interacting with this model and it is expected that further specifications
      will define declarative means for exposing these features.
    </section>

    <section class="informative">
      <h2>Introduction</h2>
      <p>
        Web Animations defines a model for supporting animation and
        synchronization on the Web platform.
        It is intended that other specifications will build on this model and
        expose its features through declarative means.
        In addition, this specification also defines a programming interface to
        the model that may be implemented by user agents that provide support
        for scripting.
      </p>
      <section>
        <h3>Use cases</h3>
        <p>
          The Web Animations model aims at two broad areas of application:
        </p>
        <dl>
          <dt>User interface effects</dt>
          <dd>
            <p>
              Animation can be used to give visual clues and feedback to make
              a user interface more readily comprehensible.
            </p>
            <p>
              For example, a user action results in a table row being
              removed to represent an item being removed from a shopping cart.
              In such a case, fading the row to transparent and then shifting
              the subsequent rows up to fill the space over a few hundred
              milliseconds provides the user with clear feedback as to the
              results of their action as opposed to instantly removing the row
              from the DOM.
            </p>
            <p>
              To support this scenario not only are the animated effects of
              fading and shifting required, but so is synchronization, both
              between the animations, and between animations and scripted
              actions (removing the table row from the DOM after the animations
              have completed).
            </p>
          </dd>
          <dt>Storytelling and visualisation</dt>
          <dd>
            <p>
              Another type of animation uses the animated effect to convey
              a story or represent some information.
              Unlike user interface effects which are largely a presentational
              adjunct to the content, these animations form an essential part of
              the content presented to the user.
            </p>
            <p>
              For example, in an animated cartoon two cats fly through space
              to another planet leaving a rainbow trail behind them.
              After arriving at the planet a change of scene occurs and the user
              should decide whether or not the cats enter a magic mountain by
              selecting one of two preset destinations in the scene.
            </p>
            <p>
              This scenario requires the following features:
            </p>
            <ul>
              <li>animated effects for moving characters along a path as well as
                  warping a path (the rainbow trail),
              <li>synchronization that allows some actions to happen
                  simultaneously (the two cats moving) and others in sequence
                  (the change of scene),
              <li>play control to allow rewinding the cartoon, or changing its
                  playback rate to accommodate particular learning or
                  accessibility needs,
              <li>the ability to trigger animations in response to user input
            </ul>
            <p>
              Similar use cases in this category include visualising physical
              phenomena such as spring motion for educational purposes,
              or visualising data such as the prevalence of a disease over
              a geographical space over a year whereby animation is used to
              present the time-based component of the data.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>Relationship to other specifications</h3>
        <p>
          CSS Transitions [[CSS3-TRANSITIONS]], CSS Animations 
          [[CSS3-ANIMATIONS]], and SVG [[SVG112]] all provide mechanisms that
          generate animated content on a Web page.
          Although the three specifications provide many similar features,
          they are described in different terms.
          This specification proposes an abstract animation model that
          encompasses the common features of all three specifications.
          This model is backwards-compatible with the current behavior of these
          specifications such that they can be defined in terms of this model
          without any observable change.
        </p>
        <p>
          The animation features in SVG 1.1 are defined in terms of SMIL
          Animation [[SMIL-ANIMATION]].
          It is intended that by defining SVG's animation features in terms of
          the Web Animations model, the dependency between SVG and SMIL
          Animation can be removed.
        </p>
        <p>
          The programming interface component of this specification makes
          some additions to interfaces defined in HTML5 [[HTML5]].
        </p>
      </section>
      <section>
        <h3>Overview of this specification</h3>
        <p>
          This specification begins by defining an abstract model for animation.
          This is followed by a programming interface defined in terms of the
          abstract model.
          The programming interface is defined in terms of the abstract model
          and is only relevant to user agents that provide scripting support.
        </p>
      </section>
    </section>

    <section class="informative">
      <h2>Web Animations model overview</h2>
      <p>
        At a glance, the Web Animations model consists of two largely
        independent pieces, a <em>timing model</em> and an <em>animation
        model</em>.  The role of these pieces is as follows:
      </p>
      <dl>
        <dt>Timing model</dt>
        <dd>
          Takes a moment in time and converts it to a proportional distance
          within a single iteration of an animation called the <em>time
          fraction</em>.
          An <em>iteration index</em> is also generated for animations
          that vary as they repeat.
        </dd>
        <dt>Animation model</dt>
        <dd>
          Takes the <em>time fractions</em> and <em>iteration indices</em>
          produced by the timing model and converts them into a series of values
          to apply to the target properties and attributes.
        </dd>
      </dl>
      <p>
        Graphically, this flow can be represented as follows:
      </p>
      <div class="figure">
        <img src="img/timing-and-animation-models.svg" width="600"
            alt='Overview of the operation of the Web Animations model.'>
      </div>
      <p class="caption">
        Overview of the operation of the Web Animations model.<br>
        The current time is input to the timing model which produces a time
        fraction and an iteration index.<br>
        These parameters are used as input to the animation model which produces
        the values to apply.<br>
      </p>
      <p>
        For example, consider an animation that:
      </p>
      <ul>
        <li>starts after 3 seconds,</li>
        <li>runs twice,</li>
        <li>takes 2 seconds every time, and</li>
        <li>changes the width of a rectangle from 50 pixels to 100
            pixels.</li>
      </ul>
      <p>
        The first three points apply to the timing model.
        At a time of 6 seconds, it will calculate that the animation should be
        half-way through its second iteration and produces the result 0.5.
        The animation model then uses that information to calculate a width
        for the rectangle of 75.
      </p>
      <p>
        This specification begins with the timing model and then proceeds to
        the animation model.
      </p>
    </section>

    <section>
      <h2>Timing model</h2>
      <p>
        This section describes and defines the behavior of the Web Animations
        timing model.
        <a>Timing events</a>, however, which are also a feature of the timing
        model, are described separately in <a href="#timing-events"
        class="sectionRef"></a>.
      </p>
    <section class="informative">
      <h2>The timing model at a glance</h2>
      <p>
        Two features characterise the Web Animations timing model: it is
        <em>stateless</em> and it is <em>hierarchical</em>.
      </p>
      <section>
        <h3>Stateless</h3>
        <p>
          The Web Animations timing model operates by taking an input time and
          producing an output time fraction.
          Since the output is based solely on the input time and is independent
          of previous inputs, the model may be described as stateless.
          This gives the model the following properties:
        </p>
        <dl>
          <dt>Frame-rate independent</dt>
          <dd>
            Since the output is independent of previous inputs, the rate at
            which the model is sampled will not affect its progress.
            Provided the input times are proportional to the progress of
            real-world time, animations will progress at an identical rate
            regardless of the capabilities of the device running them.
          </dd>
          <dt>Direction-agnostic</dt>
          <dd>
            Since the sequence of inputs is insignificant, the model is
            directionless.
            This means that the model can be sampled in reverse or even in
            a backwards and forwards pattern without requiring any specialized
            handling.
          </dd>
          <dt>Constant-time seeking</dt>
          <dd>
            Since each input is independent of the previous input, the
            processing required to perform a seek operation, even far into the
            future, is at least potentially constant.
          </dd>
        </dl>
        <p>
          There are a few apparent exceptions to the stateless behavior of the
          timing model.
        </p>
        <p>
          Firstly, <a>timing events</a> are fired when, for example, one sample
          falls on the opposite side of an animation's interval boundary to the
          previous sample.
          This is certainly stative behavior.
          However, events should be considered as a layer added on top of the
          core timing model.
          When no event listeners are registered, the model is stateless.
        </p>
        <p>
          The other exception to this stateless behavior is that a number of
          methods defined in the <a href="#script-interface">programming
          interface</a> to the model provide play control such as pausing
          an item.
          These methods are defined in terms of the time at which they are
          called and are therefore stative.
          These methods are provided primarily for convenience and are not part
          of the core timing model but, like events, are layered on top.
        </p>
        <p>
          Finally, each time the model is sampled, it can be considered to
          establish a temporary state.
          While this temporary state affects the values returned from the <a
          href="#script-interface">programming interface</a>, it has no
          influence on the subsequent samples and hence does not conflict with
          the stateless qualities described above.
        </p>
      </section>
      <section>
        <h3>Hierarchical</h3>
        <p>
          The other characteristic feature of the Web Animations timing model is
          that time is inherited.
          Time begins with a monotonically increasing time source and cascades
          down a number of steps to each animation.
          At each step, time may be shifted backwards and forwards, scaled,
          reversed, paused, and repeated.
        </p>
        <div class="figure">
          <img src="img/time-hierarchy.svg" width="600"
            alt="A hierarchy of timing nodes">
        </div>
        <p class="caption">
          A hierarchy of timing nodes.
          Each node in the tree derives its time from its parent node.
          At the root of the tree is the global clock.
        </p>
        <p>
          A consequence of this hierarchical arrangement is that complex
          animation arrangements can be reversed, scheduled, accelerated and so
          on as a whole unit since the manipulations applied to the parent
          cascade down to its <a>descendants</a>.
          Furthermore, since time has a common source, it is easy to synchronize
          animations.
        </p>
      </section>
    </section>

    <section>
      <h2>Timing model concepts</h2>
      <p>
        In Web Animations timing is based on a hierarchy of time relationships
        between timing nodes.
        Parent nodes provide timing information to their child nodes in the form
        of <a>time values</a>.
        A <dfn>time value</dfn> is a real number which nominally represents
        a number of seconds from some moment.
        The connection between <a>time values</a> and wall-clock seconds may be
        obscured by any number of transformations applied to the value as it
        passes through the time hierarchy.
      </p>
      <p class="annotation">
        In the future we may have timelines that are based on UI gestures in
        which case the connection between time values and seconds will be
        weakened even further.
      </p>
      <p>
        Periodically, the user agent will trigger an update to the timing model
        in a process called <dfn>sampling</dfn>.
        On each <dfn>sample</dfn> the <a>time values</a> of each timing node are
        updated.
      </p>
      <p class="note">
        A more precise definition of when the model is updated when scripting is
        involved is provided in <a
        href="#script-execution-and-live-updates-to-the-model"
        class="sectionRef"></a>.
      </p>
    </section>

    <section>
      <h2>The global clock</h2>
      <p>
        At the root of the Web Animations timing hierarchy is the <a>global
        clock</a>.
      </p>
      <p>
        The <dfn>global clock</dfn> is a source of monotonically increasing
        <a>time values</a> unaffected by adjustments to the system clock.
        The <a>time values</a> produced by the <a>global clock</a> represent
        wall-clock seconds from an unspecified historical moment.
        The absolute value of the <a>time values</a> produced by the <a>global
        clock</a> are insignificant, only their rate of change.
      </p>
      <p class="note">
        Note that the <a>global clock</a> is not exposed in the <a
        href="#script-interface">programming interface</a> and nor is it
        expected to be exposed by markup.
        As a result the moment from which <a>global clock</a> <a>time values</a>
        are measured, that is, the zero time of the clock, is allowed to be
        implementation-dependent.
        One user agent may measure the number of seconds since the the user
        agent was loaded whilst another may use the time when the device was
        started.
        Both approaches are acceptable and produce no observable difference
        in the output of the model.
      </p>
    </section>

    <section>
      <h2>Timelines</h2>
      <p>
        A <dfn>timeline</dfn> provides a source of <a>time values</a> for the
        purpose of synchronization.
      </p>
      <p>
        Typically, a <a>timeline</a> is tied to the <a>global clock</a> such
        that its absolute time is calculated as a fixed offset from the time of
        the <a>global clock</a>.
        This offset is established by designating some moment as the timeline's
        <dfn>zero time</dfn> and recording the <a>time value</a> of the
        <a>global clock</a> at that moment.
        At subsequent moments, the <a>time value</a> of the timeline is
        calculated as the difference between the current <a>time value</a> of
        the <a>global clock</a> and the value recorded at the <a>zero time</a>.
      </p>
      <p class="annotation">
        Note that we anticipate that other types of timelines may be introduced
        in the future that are not tied to the global clock.
        For example, a timeline whose time values correspond to UI gestures.
      </p>
      <p>
        Since a <a>timeline</a> may be defined to relative a moment that has yet
        to occur, it may not always be able to return a meaningful <a>time
        value</a>.
        A <a>timeline</a> is considered to be <dfn>not started</dfn> when it is
        in such a state that it cannot produce a <a>time value</a>.
      </p>
      <section>
        <h3>The document timeline</h3>
        <p>
          Each document has a <a>timeline</a> called the <dfn>document
          timeline</dfn> whose <a>time value</a> at a given moment is calculated
          as a fixed offset from the <a>global clock</a> such that its <a>zero
          time</a> corresponds to the moment immediately prior to dispatching
          the load event of the document.
          Prior to this moment, the <a>document timeline</a> is <a>not
          started</a>.
        </p>
        <p>
          For documents that support the concept of <a
          href="http://www.w3.org/TR/html51/dom.html#current-document-readiness
          ">current document readiness</a>, this is the moment after the <a
          href="http://www.w3.org/TR/html51/dom.html#current-document-readiness
          ">current document readiness</a> has changed to "complete" but
          before dispatching the load event.
          For user agents that support Navigation Timing [[NAVIGATION-TIMING]],
          this occurs between the <em>domComplete</em> and
          <em>loadEventStart</em> timings.
        </p>
        <div class="issue">
          This is not correct.
          We need a means to start animations prior to document load.
        </div>
        <p>
          Since the <a>document timeline</a> is tied to the <a>global clock</a>
          by a fixed offset, <a>time values</a> reported by the <a>document
          timeline</a> increase monotonically.
          Furthermore, since no scaling is applied, these <a>time values</a>
          are proportional to wall-clock seconds.
        </p>
      </section>
    </section>

    <section>
      <h2>Players</h2>
      <div class="informative">
        <p>
          The children of a <a>timeline</a> are called <em>players</em>.
          A player takes a <a>timed item</a> which is a static description of
          some timed behavior and binds it to a <a>timeline</a> so that it runs.
          A player also allows run-time control of the connection between the
          <a>timed item</a> and its <a>timeline</a> by providing pausing,
          seeking, and speed control.
          The relationship between a player and a <a>timed item</a> is analogous
          to that of a DVD player and a DVD.
        </p>
      </div>
      <p>
        A <dfn>player</dfn> connects a single <a>timed item</a>, called its
        <dfn>source content</dfn>, to a <a>timeline</a> and provides playback
        control.
      </p>
      <p>
        A <a>player</a> records the <a>time value</a> of its <a>timeline</a>
        at which its <a>source content</a> is scheduled to begin
        as the <dfn title="player start time">start time</dfn>.
      </p>
      <p>
        When a <a>player</a> is created, it is assigned a globally unique
        sequence number called the <dfn>player sequence number</dfn>.
        This number is used to resolve the sort order of players that have the
        same <a title="player start time">start time</a> for a variety of
        situations such as combining animations, queuing events, and returning
        the list of players.
      </p>
      <p class="annotation">
        If we later allow restarting a <a>player</a> (e.g. by adding
        a <code>play()</code> method), we might update the sequence number at
        this point and rename it to something more appropriate.
      </p>
      <section>
        <h3>The current time of a player</h3>
        <p>
          <a>Players</a> provide a <a>time value</a> to their <a>source
          content</a> called the player's <dfn>current time</dfn>.
          The calculation of the <a>current time</a> is as follows:
        </p>
        <blockquote>
          <code><a>current time</a> =
          (<var>timeline time</var> - <a title="player start time">start
          time</a>) * <a title="player playback rate">playback rate</a>
          - <a>time drift</a></code>
        </blockquote>
        <p>
          Where:
        </p>
        <ul>
          <li><var>timeline time</var> is the current <a>time value</a> of the
          <a>timeline</a> with which this <a>player</a> is associated.</li>
          <li><var>start time</var> is the player's <a
          title="player start time">start time</a>.</li>
          <li><var>playback rate</var> is the player's <a
          title="player playback rate">playback rate</a> value described in <a
          href="#speed-control" class="sectionRef"></a>.</li>
          <li><var>time drift</var> is the <a>time drift</a> value described in
          <a href="#seeking-and-pausing" class="sectionRef"></a>.</li>
        </ul>
        <p>
          If the <a>timeline</a> with which is <a>player</a> is associated is
          <a>not started</a> then the <a>current time</a> is <code>null</code>.
        </p>
        <p>
          It is often useful to treat the <a>current time</a> as zero when it
          would otherwise be <code>null</code>.
          We define the <dfn>effective current time</dfn> as being equal
          to <a>current time</a> unless the <a>current time</a> is
          <code>null</code>,
          in which case the <var>effective current time</var> is zero.</li>
        </p>
        <p>
          The procedure for performing manual updates to the <a>current time</a>
          is defined in <a href="#performing-a-seek" class="sectionRef"></a>.
        </p>
      </section>
      <section>
        <h3>Seeking and pausing</h3>
        <p>
          Seeking and pausing a player are closely related and are described
          here together.
        </p>
        <section class="informative">
          <h4>Introduction to seeking</h4>
          <p>
            Changing the current playback position of a player can be used to
            rewind its <a>source content</a> to its start point, fast-forward
            to a point in the future, or to provide ad-hoc synchronization
            between timed items.
          </p>
          <p>
            However, in Web Animations, the <a title="player start time">start
            time</a> of a <a>player</a> has special significance in determining
            the priority of animations (see <a href="#combining-animations"
            class="sectionRef"></a>) and so we cannot simply adjust the <a
            title="player start time">start time</a>.
            Instead, an additional offset is introduced called the <a>time
            drift</a> that further offsets a player's <a>current time</a> from
            its timeline.
            The effect of the <a>time drift</a> when seeking is illustrated
            below.
          </p>
          <div class="figure">
            <img src="img/seeking.svg" width="600"
                alt="The effect of seeking a player.">
          </div>
          <p class="caption">
            At time <var>t</var>, a seek is performed on the player changing its
            <a>current time</a> from 1.5s to 2s.<br>
            As a result, the <a>time drift</a> is set to -0.5s.<br>
            Note that the <a title="player start time">start time</a> indicated
            by a red star does not change.
          </p>
          <p>
            It is possible to seek a player even if its <a>timeline</a> is
            <a>not started</a>.
            Once the timeline begins, the player will begin playback from the
            seeked time.
          </p>
        </section>
        <section class="informative">
          <h4>Introduction to pausing</h4>
          <p>
            Pausing can be used to temporarily suspend a <a>player</a>.
            Like seeking, pausing effectively causes the <a>current time</a> of
            a player to be offset from its <a>timeline</a> by means of
            setting the <a>time drift</a>.
          </p>
          <p>
            The effect of pausing on a <a>player</a>'s <a>time drift</a> is
            illustrated below.
          </p>
          <div class="figure">
            <img src="img/pausing.svg" width="600"
                alt="The effect of pausing a player.">
          </div>
          <p class="caption">
            The effect of pausing a <a>player</a>.<br>
            Whether pausing before or after a <a>player</a>'s <a
            title="player start time">start time</a>
            the duration of the interval during which the <a>player</a> was
            paused is added to the <a>player</a>'s <a>time drift</a> whilst the
            <a title="player start time">start time</a> remains unaffected.
          </p>
        </section>
        <section>
          <h4>Seeking and pausing properties</h4>
          <p>
            <a>Players</a> track three properties related to seeking and
            pausing.
          </p>
          <dl>
            <dt><dfn>time drift</dfn></dt>
            <dd>
              The offset from a player's scheduled current time as defined by
              its <a title="player start time">start time</a>, and its actual
              current time after accounting for the effects of seeking and
              pausing.
              The <a>time drift</a> is initially zero and is updated as per the
              definition in <a href="#calculating-the-time-drift"
              class="sectionRef"></a>.
            </dd>
            <dt><dfn>paused state</dfn></dt>
            <dd>
              A boolean value that is true if the player is currently paused.
              The <a>paused state</a> is initially false.
            </dd>
            <dt><dfn>pause start time</dfn></dt>
            <dd>
              The player's <a>effective current time</a> at the time when the
              <a>paused state</a> was last newly true.
              The <a>pause start time</a> is initially zero.
            </dd>
          </dl>
          <p>
            A number of calculations for performing seeking and pausing are
            defined to operate even when the associated <a>timeline</a> is
            <a>not started</a>.
            For such situations we define the <dfn>effective timeline time</dfn>
            as the current <a>time value</a> of the <a>timeline</a> associated
            with a <a>player</a>;
            if the timeline is <a>not started</a>, then the <var>effective
            timeline time</var> is zero.
          </p>
        </section>
        <section>
          <h4>Calculating the time drift</h4>
          <p>
            The <a>time drift</a> value is both a stored and a calculated value.
            When a player is paused, the value is calculated from the <a>pause
            start time</a>.
            When a player is not paused, the stored value is used.
            The stored value is initially zero, and is updated when the player
            is unpaused or seeked.
          </p>
          <p>
            The value of <a>time drift</a> at a given moment is calculated as
            follows:
          </p>
          <dl class="switch">
            <dt>If the <a>paused state</a> is true,</dt>
            <dd>
              Return the result of 
              <code>(<a>effective timeline time</a> - <a
              title="player start time">start time</a>) * <a
              title="player playback rate">playback rate</a> -
              <a>pause start time</a></code>.
            </dd>
            <dt>Otherwise,</dt>
            <dd>
              Return the stored value for this property.
            </dd>
          </dl>
          <p class="todo">
            These formulae need to be verified since removing the special
            behavior regarding pausing before the start time.
          </p>
        </section>
        <section>
          <h4>Updating the <a>paused state</a></h4>
          <p>
            The procedure for updating the <a>paused state</a> is as
            follows:
          </p>
          <ol>
            <li>
              Let <var>new value</var> be the new paused state to set.
            </li>
            <li>
              If <var>new value</var> equals the current <a>paused state</a>,
              return.
            </li>
            <li>
              The next step depends on the current <a>paused state</a> as
              follows,
              <dl class="switch">
                <dt>If <a>paused state</a> is true,</dt>
                <dd>
                  Set the <em>stored</em> value of <a>time drift</a> to the
                  <em>current calculated</em> value of <a>time drift</a> as
                  defined in <a href="#calculating-the-time-drift"
                  class="sectionRef"></a>.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  Record the current value of the <a>effective current time</a>
                  as <a>pause start time</a>.
                </dd>
              </dl>
            </li>
            <li>
              Update <a>paused state</a> to <var>new value</var>.
            </li>
          </ol>
        </section>
        <section>
          <h4>Performing a seek</h4>
          <p>
            <dfn>Seeking</dfn> is the process of updating a player's <a>current
            time</a> to a desired value.
            It is achieved using the following procedure:
          </p>
          <ol>
            <li>Let <var>seek time</var> be the desired <a>time value</a> for
                the player's <a>current time</a>.</li>
            <li>The steps for adjusting the <a>current time</a> depend on the
                <a>paused state</a> as follows:
              <dl class="switch">
                <dt>If the <a>paused state</a> is true,</dt>
                <dd>
                  Set <a>pause start time</a> to <var>seek time</var>.
                </dd>
                <dt>If the <a>paused state</a> is false,</dt>
                <dd>
                  Set the stored value for the <a>time drift</a> to
                  the result of evaluating
                  <code>(<a>effective timeline time</a> - <a
                     title="player start time">start time</a>)
                     * <a title="player playback rate">playback rate</a> -
                     <var>seek time</var></code>.
                </dd>
              </dl>
            </li>
          </ol>
          <p>
            The <a>timing events</a> queued when a seek is performed are
            described in <a href="#event-dispatch-and-seeking-a-player"
            class="sectionRef"></a>.
          </p>
        </section>
      </section>
      <section>
        <h3>Speed control</h3>
        <div class="informative">
          <p>
            The rate of play of a player can be controlled by setting its
            <em>playback rate</em>.
            For example, setting a playback rate of 2 will cause the player's
            <a>current time</a> to increase at twice the rate of its
            <a>timeline</a>.
            Similarly, a playback rate of -1 will cause the player's <a>current
            time</a> to decrease at the same rate as the <a>time values</a> from
            its <a>timeline</a> increase.
          </p>
          <p>
            Note that <a>timed items</a> also have a <a
            title="timed item playback rate">playback rate</a> associated with
            them that behaves differently to that defined here.
          </p>
        </div>
        <p>
          <a>Players</a> have a <dfn title="player playback
          rate">playback rate</dfn> that provides a scaling factor from the rate
          of change of the associated <a>timeline</a>'s <a>time values</a> to
          the player's <a>current time</a>.
          The <a title="player playback rate">playback rate</a> is initially 1.
        </p>
        <p>
          Setting a player's <a title="player playback rate">playback rate</a>
          to zero effectively pauses the player but without affecting the
          player's <a>paused state</a>.
        </p>
        <section>
          <h4>Updating the playback rate</h4>
          <p>
            Changes to the <a title="player playback rate">playback rate</a>
            also trigger a compensatory seek so that that the player's
            <a>current time</a> is unaffected by the change to the playback
            rate.
          </p>
          <p>
            The procedure is as follows:
          </p>
          <ol>
            <li>Let <var>previous time</var> be the value of the <a>effective
                current time</a> before updating the <a
                title="player playback rate">playback rate</a>.</li>
            <li>Update the <a title="player playback rate">playback rate</a> to
                the new value.</li>
            <li>Seek to <var>previous time</var> using the procedure defined in
                <a href="#performing-a-seek" class="sectionRef"></a>.</li>
          </ol>
        </section>
      </section>
    </section>

    <section>
      <h2>Timed items</h2>
      <p>
        The <a>source content</a> of a <a>player</a>, if set, is a type of
        <dfn>timed item</dfn>.
        There are two types of <a>timed item</a>:
      </p>
      <ul>
        <li><a>animations</a>, and</li>
        <li><a>timing groups</a>.</li>
      </ul>
      <p>
        At a given moment, a <a>timed item</a> can be associated with at most
        one <a>player</a>.
      </p>
      <p>
        <a>Timed items</a> can be chained together into a hierarchy using
        <a>timings groups</a>.
        Only the <a>root</a> <a>timed item</a> of such a hierarchy can be <dfn
        title="directly associated with a player">directly associated</dfn> with
        a <a>player</a>.
        Attempting to associate a <a>timed item</a> that has a <a>parent timing
        group</a> with a <a>player</a> results in the <a>timed item</a> being
        removed from the <a>parent timing group</a> first.
        A <a>timed item</a> with an <a>ancestor</a> <a>timing group</a> that is
        <a>directly associated with a player</a> is <dfn
        title="indirectly associated with a player">indirectly associated</dfn>
        with that <a>player</a>.
      </p>
      <p>
        A <a>timed item</a>, <var>item</var>, is <dfn>associated with
        a timeline</dfn>, <var>timeline</var>, if <var>item</var> is
        <a title="directly associated with a player">directly</a> or
        <a title="indirectly associated with a player">indirectly</a> associated
        with a <a>player</a> which, in turn, is associated with
        <var>timeline</var>.
      </p>
      <p>
        All types of <a>timed item</a> define a number of common properties
        which are described in the following sections.
      </p>
      <section>
        <h3>The active interval</h3>
        <div class="informative">
          <p>
            The period that a <a>timed item</a> is scheduled to run is called
            its <a>active interval</a>.
            Each <a>timed item</a> has only one such interval.
          </p>
          <p>
            The lower bound of the <a>active interval</a> is determined by the
            <a title="timed item start time">start time</a> of the <a>timed
            item</a> but may be shifted by a <a>start delay</a> on the <a>timed
            item</a>.
          </p>
          <p>
            The upper bound of the interval is determined by the <a>active
            duration</a>.
          </p>
          <p>
            The relationship between the <a title="timed item start time">start
            time</a>, <a>start delay</a>, and <a>active duration</a> is
            illustrated below.
          </p>
          <div class="figure">
            <img src="img/active-interval-examples.svg" width="600"
                alt="Examples of the effect of the start delay on the endpoints
                    of the active interval">
          </div>
          <p class="caption">
            Examples of the effect of the <a>start delay</a> on the endpoints of
            the <a>active interval</a>.<br>
            (a) A timed item with no delay; the <a
            title="timed item start time">start time</a> and beginning of the
            <a>active interval</a> are coincident.<br>
            (b) A timed item with a positive delay; the beginning of the
            <a>active interval</a> is deferred by the delay.<br>
            (c) A timed item with a negative delay; the beginning of the
            <a>active interval</a> is brought forward by the delay.
          </p>
        </div>
        <p>
          <a>Timed items</a> define an <dfn>active interval</dfn> which is the
          period of time during which the item is scheduled to produce its
          effect with the exception of <a>fill modes</a> which apply outside
          the <a>active interval</a>.
        </p>
        <p>
          The lower bound of the <a>active interval</a> is defined by the
          combination of the timed item's <a title="timed item start time">start
          time</a> and <a>start delay</a>
        </p>
        <p>
          A <a>timed item</a>'s <dfn title="timed item start time">start
          time</dfn> is the moment at which the <a>parent timing group</a>, if
          any, has scheduled the <a>timed item</a> to begin.
          It is expressed in <a>inherited time</a>.
          In most cases, including the case when the <a>timed item</a> has no
          <a>parent timing group</a>, the <a title="timed item start time">start
          time</a> is zero.
          The singular exception is <a>sequence timing groups</a> which set the
          <a title="timed item start time">start times</a> of their children as
          described in <a
          href="#the-start-time-of-children-of-a-sequence-timing-group"
          class="sectionRef"></a>.
        </p>
        <p>
          In addition to the <a title="timed item start time">start time</a>,
          a <a>timed item</a> also has a <dfn>start delay</dfn> which is an
          offset from the <a title="timed item start time">start time</a>.
          Unlike the <a title="timed item start time">start time</a> which is
          determined by the <a>parent timing group</a>, the <a>start delay</a>
          is a property of the <a>timed item</a> itself.
        </p>
        <p>
          The lower bound of the <a>active interval<a> of a <a>timed item</a>,
          expressed in <a title="inherited time">inherited time space</a>, is
          the sum of the <a title="timed item start time">start time</a> and the
          <a>start delay</a>.
        </p>
        <p>
          These definitions are incorporated in the calculation of the <a>local
          time</a> (see <a href="#local-time-and-inherited-time"
          class="sectionRef"></a>) and <a>active time</a>.
        </p>
        <p>
          The length of the <a>active interval</a> is called the <dfn>active
          duration</dfn>, the calculation of which is defined in <a
          href="#calculating-the-active-duration" class="sectionRef"></a>.
        </p>
      </section>
      <section>
        <h3>Local time and inherited time</h3>
        <div class="informative">
          <p>
            In Web Animations all times are relative to some point of reference.
            These different points of reference produce different <em>time
            spaces</em>.
          </p>
          <p>
            This can be compared to coordinate spaces as used in computer
            graphics.
            The zero time of a time space is analogous to the origin of
            a coordinate space.
          </p>
          <p>
            Just as with coordinate spaces, time spaces can also be nested.
            <a>Timing groups</a> typically perform some
            transformations on the <a>time values</a> they
            receive from their <a title="parent timing group">parent</a> or
            <a>player</a> before passing on the transformed <a>time values</a>
            to their children.
            Child <a>timed items</a> then operate <em>within</em> that
            transformed time space.
          </p>
          <p>
            Children take the transformed time values from their
            parent&mdash;called the <a>inherited time</a>&mdash; and add their
            <a title="timed item start time">start time</a> to establish their
            own <a title="local time">local time space</a> as illustrated below.
          </p>
          <div class="figure">
            <img src="img/local-time.svg" width="600"
                alt="Inherited time and local time.">
          </div>
          <p class="caption">
            Inherited time and local time.<br>
            At time <var>t</var>, the <a>inherited time</a> is 2.5.<br>
            For <a>timed item</a> (a) which has a <a
              title="timed item start time">start time</a> of 1, the <a>local
              time</a> is 1.5.<br>
            For <a>timed item</a> (b) which has a <a
              title="timed item start time">start time</a> of 1
              and a <a>start delay</a> of 1,
              the <a>local time</a> is also 1.5
              since <a>local time</a> is based on a <a>timed item</a>'s
              <a title="timed item start time">start time</a> only,
              and not on its <a>start delay</a>.
          </p>
        </div>
        <p>
          For a <a>timed item</a>, the <dfn>inherited time</dfn> at
          a given moment is based on the first matching condition from the
          following:
        </p>
        <dl class="switch">
          <dt>If the <a>timed item</a> has a <a>parent timing group</a>,</dt>
          <dd>
            the inherited time is the <a>parent timing group</a>'s current
            <a title="transformed time">transformed time value</a>.
          </dd>
          <dt>If the <a>timed item</a> is directly associated with
              a <a>player</a>,</dt>
          <dd>
            the inherited time is the <a>current time</a> of the
            <a>player</a>.
          </dd>
          <dt>Otherwise,</dt>
          <dd>
            the inherited time is <code>null</code>.
          </dd>
        </dl>
        <p>
          The <dfn>local time</dfn> of a <a>timed item</a> is the <a>timed
          item</a>'s <a>inherited time</a> minus its <a
          title="timed item start time">start time</a>.
          If the <a>inherited time</a> is <code>null</code> then the local time
          is also <code>null</code>.
        </p>
      </section>
      <section>
        <h3>Timed item states</h3>
        <div class="informative">
          <p>
            At given moment, a <a>timed item</a> may be described as being in
            one of several overlapping states.
            These states are only established for the duration of a single
            sample and are primarily a convenience for describing stative parts
            of the model such as event dispatch.
          </p>
          <p>
            The different states are illustrated below.
          </p>
          <div class="figure">
            <img src="img/timed-item-states.svg" width="700"
                alt="An example of the different states used for describing a
                    timed item.">
          </div>
          <p class="caption">
            An example of the different states used for describing a <a>timed
            item</a> at a given time.
            Note that a <a>timed item</a> is considered to be <a>in effect</a>
            for all times inside the <a>active interval</a> as well as times
            outside the <a>active interval</a> where a <a>fill mode</a> is
            applied.
          </p>
          <p>
            These states and their useage within the model are summarised as
            follows:
          </p>
          <dl>
            <dt><a>scheduled</a></dt>
            <dd>
              The <a>timed item</a>'s <a>local time</a> falls before the item's
              <a>active interval</a>.
              This state is only used in conjunction with the
              <a><em>active</em></a> state to define the <a><em>current</em></a>
              state.
            </dd>
            <dt><a>active</a></dt>
            <dd>
              The <a>timed item</a>'s <a>local time</a> falls inside the item's
              <a>active interval</a>.
              Transitions to and from the <a><em>active</em></a> state trigger
              timing events as defined in <a href="#timing-events"
              class="sectionRef"></a>.
            </dd>
            <dt><a>current</a></dt>
            <dd>
              <p>
                The <a>timed item</a>'s <a>local time</a> falls either before or
                inside the item's <a>active interval</a>, <em>or</em> the
                <a>local time</a> of an <a>ancestor</a> <a>timing group</a>
                falls before or inside its <a>active interval</a> thereby
                opening up the possibility that this <a>timed item</a> might
                play again (e.g. due to repeating).
              </p>
              <p>
                This state is used in the <a
                href="#script-interface">programming interface</a> to identify
                all <a>animations</a> and <a>players</a> that are likely to be
                of interest.
              </p>
              <p>
                Furthermore, the <a>current</a> state provides an important
                definition for managing the amount of memory required by
                implementations.
                Assuming a monotonically increasing <a>timeline</a>, in the
                absence of dynamic changes to the model, an implementation can
                safely discard all <a>timed items</a> that are <em>not</em>
                <a>current</a> and not referenced elsewhere provided they take
                care to preserve any <a>fill values</a> since they will not have
                any dynamic effect.
              </p>
            </dd>
            <dt><a>in effect</a></dt>
            <dd>
              The <a>timed item</a>'s <a>local time</a> falls either inside the
              item's <a>active interval</a> or outside the interval but at
              a time where the item's <a>fill mode</a> (see <a
              href="#fill-behavior" class="sectionRef"></a>) causes it to affect
              its target.
              <a>Timed items</a> only produce a <a>transformed time</a> when the
              item is <a>in effect</a>.
              At all other times, the <a>transformed time</a> of a <a>timed
              item</a> is <code>null</code>.
            </dd>
          </dl>
          <p>
            The normative definition of each of these states follows.
          </p>
        </div>
        <p>
          A <a>timed item</a> is <dfn>scheduled</dfn> if <em>either</em> of the
          following conditions is true:
        </p>
        <ol>
          <li>the timed item's <a>local time</a> is not <code>null</code> and is
              less than the item's <code>startDelay</code>, or</li>
          <li>the timed item has a <a>parent timing group</a> which is
              a <a>scheduled</a> timed item.</li>
        </ol>
        <p>
          A <a>timed item</a> is <dfn>active</dfn> if <em>all</em> of the
          following conditions are met:
        </p>
        <ol>
          <li>the <a>timed item</a>'s <a>local time</a> is not
              <code>null</code>, and</li>
          <li>the <a>timed item</a>'s <a>local time</a> is <em>greater than or
              equal</em> to its <a>start delay</a>, and</li>
          <li>the <a>timed item</a>'s <a>local time</a> is <em>less than</em>
              the sum of its <a>start delay</a> and <a>active duration</a>.</li>
        </ol>
        <p>
          A timed item is <dfn>current</dfn> if it is either <a>scheduled</a> or
          <a>active</a> or it has a <a>parent timing group</a> and the
          <a>parent timing group</a> is <a>current</a>.
        </p>
        <p>
          A timed item is <dfn>in effect</dfn> if its <a>active time</a> as
          calculated according to the procedure in <a
          href="#calculating-the-active-time" class="sectionRef"></a> is not
          <code>null</code>.
        </p>
      </section>
    </section>

    <section>
      <h2>Fill behavior</h2>
      <p>
        The effect of a <a>timed item</a> outside its <a>active interval</a> is
        determined by its <dfn>fill mode</dfn>.
      </p>
      <p>
        The possible <a>fill modes</a> are:
      </p>
      <ul>
        <li>none,</li>
        <li>forwards,</li>
        <li>backwards, and</li>
        <li>both.</li>
      </ul>
      <p>
        The normative definition of these modes is incorporated in the
        calculation of the <a>active time</a> in <a
        href="#calculating-the-active-time" class="sectionRef"></a>.
      </p>
      <section class="informative">
        <h3>Fill modes</h3>
        <p>
          The effect of each <a>fill mode</a> is as follows:
        </p>
        <dl>
          <dt>none</dt>
          <dd>
            The timed item has no effect outside of the <a>active interval</a>.
          </dd>
          <dt>forwards</dt>
          <dd>
            For times that occur later than the <a>active interval</a>, the
            timed item will continue to produce the same <a
            title="transformed time">transformed time value</a> that was used at
            the end of the <a>active interval</a>.

            For times that occur before the <a>active interval</a>, the
            timed item will have no effect.
          </dd>
          <dt>backwards</dt>
          <dd>
            For times that occur before the <a>active interval</a>, the timed
            item will produce the same <a title="transformed time">transformed
            time value</a> that will be used at the start of the <a>active
            interval</a>.

            For times that occur later than the <a>active interval</a>, the
            timed item will have no effect.
          </dd>
          <dt>both</dt>
          <dd>
            For times that occur before the <a>active interval</a>, the
            <span class="prop-value">backwards</span> fill behavior is used.

            For times that occur after the <a>active interval</a>, the
            <span class="prop-value">forwards</span> fill behavior is used.
          </dd>
        </dl>
        <p>
          Some examples of the these fill modes are illustrated below.
        </p>
        <div class="figure">
          <img src="img/animation-state-and-fill-behavior.svg" width="600"
            alt="Examples of various fill modes and the states produced.">
        </div>
        <p class="caption">
          Examples of various fill modes and the states produced.<br>
          (a) fill mode &lsquo;none&rsquo;. The timed item has no effect outside
              its active interval.<br>
          (b) fill mode &lsquo;forwards&rsquo;. After the active interval has
              finished, the timed value continues to maintain a fill value.<br>
          (c) fill mode &lsquo;backwards&rsquo;. The timed item produces a fill
              value until the start of the active interval.<br>
          (d) fill mode &lsquo;both&rsquo;. Both before and after the active
              interval the timed item produces a fill value.
        </p> 
        <p class="note">
          Note that setting a fill mode has no bearing on the endpoints of the
          <a>active interval</a>.
          However, the fill mode <em>does</em> have an effect on various other
          properties of the timing model since the <a>active time</a> of a timed
          item is only defined (that is, not <code>null</code>) inside the
          <a>active interval</a> <em>or</em> when a fill is applied.
        </p>
        <div class="issue">
          <p>
            As currently defined, when filling, a <a>timed item</a> uses an
            <a>active time</a> equal to either zero or its <a>active
            duration</a>, and this is used as the basis for the time which is
            inherited by its children.
          </p>
          <p>
            This has the effect of &lsquo;snapshotting&rsquo; the children for
            the duration of the parent's fill.
            As a result, if a child is active at the boundary of an ancestor's
            <a>active interval</a> and that ancestor is configured to fill at
            the point, the child will remain active through the ancestor's fill
            even if the child is <em>not</em> configured to fill in the given
            direction.
          </p>
          <p>
            This behavior may be surprising in some circumstances..
            It is particularly noticeable in the case of an ancestor with
            backwards fill, as for the common case where children are aligned at
            the start of the parent's active interval, they will also fill
            backwards regardless of their fill mode.
          </p>
          <p>
            In order to provide control of this behavior we
            are considering modifying the definition of fill to depend on the
            parent's fill state.
            In particular, when a parent is filling, a child will only be active
            (and its descendants thus have an effect) if it too is configured to
            fill in that direction.
          </p>
          <p>
            In order to provide the currently-defined behavior (which we expect
            is useful for many situations), we would likely introduce a new
            'auto' fill mode, which means that a <a>timed item</a>'s fill mode
            should match that of its parent, if present, or use forward fill
            otherwise.
          </p>
          <p>
            See <a
            href='http://lists.w3.org/Archives/Public/public-fx/2013AprJun/0184.html'>section
            2 (Fill modes on descendants) of minuted discussion from Tokyo 2013
              F2F</a>.
          </p>
        </div>
        <div class="issue">
          <p>
            Currently <a>timing functions</a> that generate results outside the
            range [0, 1] will behave unexpectedly when applied to animation
            groups, as children will increase iterations or enter into fill mode
            rather than continuing to extrapolate along their defined behaviours
            (which is what they would do if the timing function applied to them
            directly).
          </p>
          <p>
            To fix this it is possible we will wish to introduce 'overflow' fill
            modes that respond to time values larger than or smaller than the
            active time range by extrapolating rather than filling.
          </p>
          <p>
            See <a
            href='http://lists.w3.org/Archives/Public/public-fx/2013AprJun/0184.html'>section
            15 (Overflowing fill) of minuted discussion from Tokyo 2013 F2F</a>.
          </p>
        </div>
      </section>
    </section>

    <section>
      <h2>Repeating</h2>
      <section>
        <h3>Iteration intervals</h3>
        <p>
          It is possible to specify that a timed item should repeat
          a fixed number of times or indefinitely.
          This repetition occurs <em>within</em> the <a>active interval</a>.
          The span of time during which a single repetition takes place is
          called an <dfn>iteration interval</dfn>.
        </p>
        <p>
          Unlike the <a>active interval</a>, a timed item can have multiple
          <a>iteration intervals</a> although typically only the interval
          corresponding to the <a>current iteration</a> is of interest.
        </p>
        <p>
          The length of a single iteration is called the <dfn>iteration
          duration</dfn>.
          The initial <a>iteration duration</a> of a timed item is simply its
          <a>intrinsic iteration duration</a>.
        </p>
        <p>
          The <dfn>intrinsic iteration duration</dfn> of a timed item is zero,
          however some specific types of timed item such as timing groups
          override this behavior and provide an alternative intrinsic duration
          (see <a
          href="#the-intrinsic-iteration-duration-of-a-parallel-timing-group"
          class="sectionRef"></a> and <a
          href="#the-intrinsic-iteration-duration-of-a-sequence-timing-group"
          class="sectionRef"></a>).
        </p>
        <p>
          The <a>iteration duration</a> of a <a>timed item</a> may be set by the
          author to represent a value other than the <a>intrinsic iteration
          duration</a>.
        </p>
        <div class="informative">
          <p>
            Comparing the <a>iteration duration</a> and the <a>active
            duration</a> we have:
          </p>
          <dl>
            <dt>Iteration duration</dt>
            <dd>
              The time taken for a single iteration of the timed item to
              complete.
            </dd>
            <dt>Active duration</dt>
            <dd>
              The time taken for the entire timed item to complete, including
              repetitions.
              This may be longer or shorter than the <a>iteration duration</a>.
            </dd>
          </dl>
          <p>
            The relationship between the <a>iteration duration</a> and <a>active
            duration</a> is illustrated below.
          </p>
          <div class="figure">
            <img src="img/iteration-intervals.svg" width="600"
                alt="Comparison of the iteration duration and active time.">
          </div>
          <p class="caption">
            A comparison of the <a>iteration duration</a> and <a>active
            duration</a> of a timed item with an <a>iteration count</a> of 2.5.
            Note that the <a>iteration duration</a> for the final iteration does
            not change, it is simply cut-off by the <a>active duration</a>.
          </p>
        </div>
      </section>
      <section>
        <h3>Controlling iteration</h3>
        <p>
          The number of times a <a>timed item</a> repeats is called its
          <dfn>iteration count</dfn>.
          The <a>iteration count</a> is a real number greater than or equal to
          zero.
          The <a>iteration count</a> may also be positive infinity to represent
          that the <a>timed item</a> repeats indefinitely.
        </p>
        <p>
          In addition to the <a>iteration count</a>, <a>timed items</a> also
          have an <dfn>iteration start</dfn> property which specifies an offset
          into the series of iterations at which the <a>timed item</a> should
          begin.
          The <a>iteration start</a> is a finite real number greater than or
          equal to zero.
        </p>
        <p>
          The behavior of these parameters is defined in the calculations in <a
          href="#core-timed-item-calculations" class="sectionRef"></a>.
        </p>
        <div class="informative">
          <p>
            The effect of the <a>iteration count</a> and <a>iteration start</a>
            parameters is illustrated below.
          </p>
          <div class="figure">
            <img src="img/iteration-count-and-start.svg" width="600"
                alt="The effect of the iteration count and iteration start
                    parameters">
          </div>
          <p class="caption">
            The effect of the <a>iteration count</a> and <a>iteration start</a>
            parameters.<br>
            In the first case the <a>iteration count</a> is 2.5 resulting in the
            third iteration being cut-off half way through its <a>iteration
            interval</a>.<br>
            The second case is the same but with an <a>iteration start</a> of
            0.5.
            This causes the <a>timed item</a> to begin half way through the
            first iteration.
          </p>
          <p>
            Unlike the <a>iteration count</a> parameter, the <a>iteration
            start</a> parameter does not effect the length of the <a>active
            duration</a>.
          </p>
          <p>
            Note that values of <a>iteration start</a> greater than or equal to
            one are generally not useful unless used in combination with an
            <a>animation effect</a> that has an <a>accumulation operation</a>
            property of <a title="accumulation operation sum">sum</a>.
          </p>
        </div>
      </section>
      <section class="informative">
        <h3>Iteration time space</h3>
        <p>
          We have already encountered different time spaces in describing
          <a>local time and inherited time</a> (see <a
          href="#local-time-and-inherited-time" class="sectionRef"></a>).
          Repetition introduces yet another time space: the iteration time
          space.
        </p>
        <p>
          <em>Iteration time space</em> is a time space whose zero time is the
          beginning of a timed item's current iteration.
        </p>
        <p>
          Within the Web Animations model we also refer to <a>active
          time</a> which is a time relative to the beginning of the active
          interval.
          This time space, however, is internal to the model and not exposed in
          the script interface or in markup.
        </p>
        <p>
          These time spaces are illustrated below.
        </p>
        <div class="figure">
          <img src="img/time-spaces.svg" width="600"
            alt="A comparison of item time, active time, and iteration time.">
        </div>
        <p class="caption">
          A comparison of item time, active time, and iteration time for an
          animation with a iteration duration of 1s and an iteration count of
          2.5.
        </p>
        <p class="note">
          Note that while the time spaces themselves are not bounded, Web
          Animations defines <a>active time</a> and <a>iteration
          time</a> such that they are clamped to a set range as shown in the
          diagram.
          For example, whilst a time of -1 second is a valid time in
          <em>active time space</em>, the procedure for calculating the
          <a>active time</a> defined in <a
          href="#calculating-the-active-time" class="sectionRef"></a> will
          never return a negative value.
        </p>
        <p>
          In addition to these time spaces we can also refer to the
          <em>document time space</em> which is time space of the <a>time
          values</a> of the <a>document timeline</a> of the <a
          href="http://www.w3.org/TR/html5/browsers.html#active-document">active
          document</a>.
        </p>
      </section>
      <section class="informative">
        <h3>Interval timing</h3>
        <p>
          When a timed item repeats we must define the behavior at the iteration
          boundaries.
          For this and indeed for all interval-timing, Web Animations uses an
          endpoint-exclusive timing model.
          This means that whilst the begin time of an interval
          is included in the interval, the end time time is not.
          In interval notation this can written <code>[begin,end)</code>.
          This model provides sensible behavior when intervals are repeated and
          sequenced since there is no overlap between the intervals.
        </p>
        <p>
          In the examples below, for the repeated item, at local time 1s,
          the iteration time is 0.
          For the sequenced items, at inherited time 1s, only item B will be
          <a>active</a>; there is no overlap.
        </p>
        <div class="figure">
          <img src="img/endpoint-exclusive-timing.svg" width="600"
            alt="Illustration of end-point exclusive timing.">
        </div>
        <p class="caption">
          Illustration of end-point exclusive timing. For both repeated and
          sequenced timed items there is no overlap at the boundaries between
          intervals.
        </p>
        <p>
          An exception to this behavior is that when performing a <a
          href="#fill-behavior">fill</a>, if the fill begins at an
          interval endpoint, the endpoint is used.
          This behavior falls out of the algorithm given in <a
          href="#calculating-the-iteration-time"
          class="sectionRef"></a> and is illustrated below.
        </p>
        <div class="figure">
          <img src="img/endpoint-exclusive-timing-and-fill.svg" width="600"
            alt="Effect of iterations and fill on iteration time.">
        </div>
        <p class="caption">
          After one iteration, the iteration time is 0, but after two iterations
          (and thereonwards), the iteration time is equal to the iteration
          duration due to the special behavior defined when a timed item fills.
        </p>
      </section>
    </section>

    <section>
      <h2>Timed item speed control</h2>
      <p>
        Like <a>players</a>, <a>timed items</a> also have a <dfn
        title="timed item playback rate">playback rate</dfn> parameter.
        The <a title="timed item playback rate">playback rate</a> of a <a>timed
        item</a> is a finite real number that acts as a multiplier when
        calculating the <a>timed item</a>'s <a>transformed time</a> from its
        <a>local time</a>.
      </p>
      <p>
        The effect of setting the <a title="timed item playback rate">playback
        rate</a> of a <a>timed item</a> differs from the setting the <a
        title="player playback rate">playback rate</a> on a player.
        Its behavior is defined in the timing calculations given in <a
        href="#core-timed-item-calculations" class="sectionRef"></a>.
      </p>
      <div class="informative">
        <p>
          In summary, the behavior of the <a title="timed item playback
          rate">playback rate</a> of a <a>timed item</a> is as follows:
        </p>
        <ul>
          <li>
            The <a title="timed item playback rate">playback rate</a> is applied
            only to the <a>active interval</a> of a <a>timed item</a> and not to
            the time while it is <a title="start delay">delayed</a> or <a
            title="fill mode">filling</a>.
          </li>
          <li>
            Setting a negative <a title="timed item playback rate">playback
            rate</a> on a <a>timed item</a> causes the <a>timed item</a> to
            begin at the end of its <a>active interval</a>.
            This differs from the <a title="player playback rate">playback
            rate</a> on a <a>player</a>.
            Setting a <a title="player playback rate">playback rate</a> on
            a <a>player</a> to a negative value at a moment before the
            <a>player</a>'s </a>source content</a> has begun, will result in the
            <a>source content</a> never playing.
          </li>
          <li>
            Setting the <a title="timed item playback rate">playback rate</a> of
            a <a>timed item</a> affects the calculated value of the <a>active
            duration</a> (see <a href="#calculating-the-active-duration"
            class="sectionRef"></a>).
          </li>
          <li>
            <p>
              Changing the <a title="timed item playback rate">playback rate</a>
              of a <a>timed item</a> whose <a>local time</a> is within its
              <a>active interval</a> will cause it to jump.
              This is because the <a>active duration</a> will be updated but the
              <a>local time</a> will not.
            </p>
            <p>
              Furthermore, if other <a>timed items</a> depend on the <a>timed
              item</a>'s <a>active duration</a>, such as sibling <a>timed
              items</a> in a <a>sequence timing group</a>, they too may jump as
              a result of setting the <a>timed item</a>'s <a
              title="timed item playback rate">playback rate</a>.
            </p>
            <p>
              For runtime speed control the <a
              title="player playback rate">playback rate</a> of the
              <a>player</a> should be used.
            </p>
          </li>
        </ul>
      </div>
    </section>

    <section>
      <h2>Core timed item calculations</h2>
      <section class="informative">
        <h3>Overview</h3>
        <p>
          At the core of the Web Animations timing model is the process that
          takes an <a>inherited time</a> value and converts it to an
          <a>iteration time</a>.
        </p>
        <p>
          Following this further transformations are applied before resulting at
          a final <a>transformed time</a>.
        </p>
        <p>
          The first step in this process is to calculate the boundary when the
          <a>timed item</a> is <a>active</a>, that is, the <a>active
          duration</a>.
        </p>
        <p>
          This process is illustrated below.
        </p>
        <div class="figure">
          <img src="img/active-duration-calculation.svg" width="650"
            alt="Calculation of the active duration.">
        </div>
        <p class="caption">
          Calculation of the <a>active duration</a> is based on
          multiplying the <a>iteration duration</a> by the <a>iteration
          count</a> and then dividing by the <a
          title="timed item playback rate">playback rate</a>.
        </p>
        <p>
          The process for calculating the <a>active duration</a> is normatively
          defined in <a href="#calculating-the-active-duration"
          class="sectionRef"></a>.
        </p>
        <p>
          Having established the <a>active duration</a>, the process for
          transforming a <a>timed item</a>'s <a>inherited time</a> into its
          <a>transformed time</a> is illustrated below.
        </p>
        <div class="figure">
          <img src="img/time-calculations.svg" width="650"
            alt="An overview of timing model calculations.">
        </div>
        <p class="caption">
          An overview of timing model calculations.<br>
          (1) The <a>inherited time</a> is converted into a <a>local time</a> by
          incorporating the <a title="timed item start time">start time</a>.<br>
          (2) The <a>local time</a> is converted into an <a>active time</a> by
          incorporating the <a>start delay</a>.<br>
          (3) The <a>playback rate</a> and <a>iteration start</a> properties are
          applied to the <a>active time</a> to produce the <a>scaled active
          time</a>.<br>
          (4) The <a>scaled active time</a> is then converted to an offset
          within a single iteration: the <a>iteration time</a>.<br>
          (5) The <a>iteration time</a> is converted into a <a>directed time</a>
          by incorporating the <a>playback direction</a>.<br>
          (6) Finally, a timing function is applied to the <a>directed
          time</a> to produce the <a>transformed time</a>.
        </p>
        <p>
          The first step, calculating the <a>local time</a> is described in <a
          href="#local-time-and-inherited-time" class="sectionRef"></a>.
          Steps 2 to 4 in the diagram are described in the following sections.
          Steps 5 and 6 are described in
          <a href="#calculating-the-directed-time" class="sectionRef"></a>
          and
          <a href="#calculating-the-transformed-time" class="sectionRef"></a>
          respectively.
        </p>
      </section>
      <section>
        <h3>Calculating the active duration</h3>
        <p>
          In order to calculate the <a>active duration</a> we first define the
          <a>repeated duration</a> as follows:
        </p>
        <blockquote>
          <dfn>repeated duration</dfn> =
            <code><a>iteration duration</a> *
                  <a>iteration count</a></code>
        </blockquote>
        <p>
          The <a>active duration</a> is calculated according to the following
          steps:
        </p>
        <ol>
          <li>
            If the <a title="timed item playback rate">playback rate</a> is
            zero, return <code>Infinity</code>.
          </li>
          <li>
            Otherwise, return <code><a>repeated duration</a>
            / abs(<a title="timed item playback rate">playback rate</a>)</code>.
          </li>
        </ol>
      </section>
      <section>
        <h3>Transforming the local time</h3>
        <section>
          <h4>Calculating the active time</h4>
          <p>
            The <dfn>active time</dfn> is based on the <a>local time</a>
            and <a>start delay</a>.
            It is defined only when the <a>timed item</a> is <a>in effect</a>
            and is calculated according to the following steps:
          </p>
          <ol>
            <li>
              If <a>local time</a> is <code>null</code>, return
              <code>null</code>.
            </li>
            <li>
              If <code><a>local time</a> &lt; <a>start delay</a></code>
              the result depends on the <a>fill mode</a> as follows,
              <dl class="switch">
                <dt>
                  If the <a>fill mode</a> is <span
                  class="prop-value">backwards</span> or <span
                  class="prop-value">both</span>,
                </dt>
                <dd>
                  return zero.
                <dd>
                <dt>
                  Otherwise,
                </dt>
                <dd>
                  return <code>null</code>.
                </dd>
              </dl>
            </li>
            <li>
              If <code><a>local time</a> &lt; <a
              title="timed item start time">start time</a> + <a>active
              duration</a></code>, return <code><a>local time</a> - <a>start
              delay</a></code>.
            </li>
            <li>
              Otherwise, the result depends on the <a>fill mode</a> as follows,
              <dl class="switch">
                <dt>
                  If the <a>fill mode</a> is <span
                  class="prop-value">forwards</span> or <span
                  class="prop-value">both</span>,
                </dt>
                <dd>
                  return the <a>active duration</a>.
                <dd>
                <dt>
                  Otherwise,
                </dt>
                <dd>
                  return <code>null</code>.
                </dd>
              </dl>
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the scaled active time</h4>
          <p>
            Before the <a>active time</a> can be converted to an <a>iteration
            time</a> we must factor in the <a>timed item</a>'s <a
            title="timed item playback rate">playback rate</a> and <a>iteration
            start</a>.
            The result is called the <a>scaled active time</a>.
          </p>
          <p>
            In order to calculate the <a>scaled active time</a> we first
            define the <a>start offset</a> as follows:
          </p>
          <blockquote>
            <dfn>start offset</dfn> =
              <code><a>iteration start</a> * <a>iteration duration</a></code>
          </blockquote>
          <p>
            The <dfn>scaled active time</dfn> is calculated according to
            the following steps:
          </p>
          <ol>
            <li>
              If the <a>active time</a> is <code>null</code>, return
              <code>null</code>.
            </li>
            <li>
              Return the scaled active time based on the
              <a title="timed item playback rate">playback rate</a> as follows,
              <dl class="switch">
                <dt>If the <a title="timed item playback rate">playback rate</a>
                    is negative,</dt>
                <dd>
                Return <code>(<a>active time</a> -
                              <a>active duration</a>)
                        * <a title="timed item playback rate">playback rate</a>
                        + <a>start offset</a></code>.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  Return <code><a>active time</a>
                  * <a title="timed item playback rate">playback rate</a>
                  + <a>start offset</a></code>.
                </dd>
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the iteration time</h4>
          <p>
            The <dfn>iteration time</dfn> is calculated according to the
            following steps:
          </p>
          <ol>
            <li>
              If the <a>scaled active time</a> is <code>null</code>,
              return <code>null</code>.
            </li>
            <li>
              If the <a>iteration duration</a> is zero, return zero.
            </li>
            <li>
              If <code><a>scaled active time</a> - <a>start
              offset</a></code> is equal to the <a>repeated duration</a>,
              and <a>iteration count</a> is not zero,
              and <code>(<a>iteration count</a> + <a>iteration start</a>)
              % 1</code> is zero,
              return the <a>iteration duration</a>.
            </li>
            <li>
              Otherwise, return <code><a>scaled active time</a>
              % <a>iteration duration</a></code>.
            </li>
          </ol>
        </section>
      </section>
      <section>
        <h3>Calculating the current iteration</h3>
        <p>
          The <dfn>current iteration</dfn> can be calculated using the
          following steps:
        </p>
        <ol>
          <li>
            If the <a>scaled active time</a> is <code>null</code>, return
            <code>null</code>.
          </li>
          <li>
            If the <a>scaled active time</a> is zero, return zero.
          </li>
          <li>
            If the <a>iteration duration</a> is zero, return
            <code>floor(<a>iteration start</a> + <a>iteration count</a>)</code>.
          </li>
          <li>
            If the <a>iteration time</a> equals the <a>iteration
            duration</a>, return <code><a>iteration start</a>
            + <a>iteration count</a> - 1</code>.
          </li>
          <li>
            Return <code>floor(<a>scaled active time</a> /
            <a>iteration duration</a>)</code>.
            <p class="note">
              If the <a>iteration duration</a> is infinite, the
              result of <code>floor(<a>scaled active time</a> /
              <a>iteration duration</a>)</code> will be zero as defined by
              IEEE 754-2008.
            </p>
          </li>
        </ol>
      </section>
    </section>

    <section>
      <h2>Direction control</h2>
      <p>
        <a>Timed items</a> may also be configured to run iterations in
        alternative directions using direction control.
        For this purpose, <a>timed items</a> have a <dfn>playback
        direction</dfn> parameter which takes one of the following values:
      </p>
      <ul>
        <li>normal,</li>
        <li>reverse,</li>
        <li>alternate, or</li>
        <li>alternate-reverse.</li>
      </ul>
      <p>
        The semantics of these values are incorporated into the calculation of
        the <a>directed time</a> which follows.
      </p>
      <div class="informative">
        <p>
          A non-normative definition of these values is as follows:
        </p>
        <dl>
          <dt>normal</dt>
          <dd>
            All iterations are played as specified.
          </dd>
          <dt>reverse</dt>
          <dd>
            All iterations are played in the reverse direction from the way
            they are specified.
          </dd>
          <dt>alternate</dt>
          <dd>
            Even iterations are played as specified, odd iterations are played
            in the reverse direction from the way they are specified.
          </dd>
          <dt>alternate-reverse</dt>
          <dd>
            Even iterations are played in the reverse direction from the way
            they are specified, odd iterations are played as specified.
          </dd>
        </dl>
      </div>
      <section>
        <h3>Calculating the directed time</h3>
        <p>
          The <dfn>directed time</dfn> is calculated from the <a>iteration
          time</a> using the following steps:
        </p>
        <ol>
          <li>If the <a>iteration time</a> is <code>null</code>, return
              <code>null</code>.
          <li>
            Calculate the <var>current direction</var> using the first
            matching condition from the following list:
            <dl class="switch">
              <dt>
                If <a>playback direction</a> is <code>normal</code>,
              </dt>
              <dd>Let the <var>current direction</var> be forwards.</dd>
              <dt>
                If <a>playback direction</a> is <code>reverse</code>,
              </dt>
              <dd>Let the <var>current direction</var> be reverse.</dd>
              <dt>
                Otherwise,
              </dt>
              <dd>
                <ol>
                  <li>
                    Let <var>d</var> be the <a>current iteration</a>.
                  </li>
                  <li>
                    If <a>playback direction</a> is
                    <code>alternate-reverse</code> increment
                    <var>d</var> by 1.
                  </li>
                  <li>
                    <p class="issue">
                      There used to be a step here which seemed to be adding
                      special handling for filling when the item ends on
                      a repeat boundary but it seems like that is taken care
                      of by the calcuation of <a>iteration time</a> and
                      <a>current iteration</a>.
                      Is anything actually needed here?
                    </p>
                  </li>
                  <li>
                    If <code><var>d</var> % 2 == 0</code>, let the
                    <var>current direction</var> be forwards, otherwise let
                    the <var>current direction</var> be reverse.
                  </li>
                </ol>
              </dd>
            </dl>
          </li>
          <li>
            If the <var>current direction</var> is forwards then return
            the <a>iteration time</a>.
            <p>
              Otherwise, return the <a>iteration duration</a>
              - <a>iteration time</a>.
            </p>
          </li>
        </ol>
      </section>
    </section>

    <section>
      <h2>Time transformations</h2>
      <section class="informative">
        <h3>Scaling the time</h3>
        <p>
          It is often desirable to control the rate at which a <a>timed item</a>
          progresses.
          For example, easing the rate of animation can create a sense of
          momentum and produce a more natural effect.
          Conversely, in other situations such as when modelling a discrete
          change, a smooth transition is undesirable and instead it is necessary
          for the <a>timed item</a> to progress in a series of distinct steps.
        </p>
        <p>
          For such situations Web Animations provides <a>timing functions</a>
          that scale the progress of a <a>timed item</a>.
        </p>
        <p>
          <a>Timing functions</a> take an input time fraction and produce
          a scaled output time fraction.
        </p>
        <div class="figure">
          <img src="img/timing-function-example.svg" width="350"
            alt="Example of a timing function that produces an ease-in effect.">
        </div>
        <p class="caption">
          Example of a timing function that produces a ease-in effect.
          Given a input timing fraction of 0.7, the timing function scales the
          value to produce an output time fraction of 0.52.<br>
          By applying this timing function, time will appear to progress more
          slowly at first but then gradually progress more quickly.
        </p>
        <p>
          Such <a>timing functions</a> can be applied to an iteration of
          a <a>timed item</a>.
        </p>
      </section>
      <section>
        <h3>Timing functions</h3>
        <p>
          A <dfn>timing function</dfn> takes an input time fraction in the range
          [0, 1] and produces an output time fraction whose range is unbounded
          (i.e. positive and negative infinity are permitted).
        </p>
        <p>
          <a>Timed items</a> have one <a>timing function</a> associated with
          them.
          The default <a>timing function</a> is the <dfn>linear timing
          function</dfn> whose output is identical to its input.
        </p>
        <div class="issue">
          <p>
            We are considering introducing the concept of chained timing
            functions.
          </p>
          <p>
            A chained timing function is composed of a set of primitive timing
            functions, where each primitive timing function maps a limited
            portion of the input range to a portion of the output range.
            Available primitive timing functions include
            <a>cubic Bézier timing functions</a>, <a>step timing functions</a>
            and the <a>linear timing function</a>.
          </p>
          <p>
            A chained timing function can be configured to explicitly specify
            the input and output ranges of each primitive timing function, or to
            align the input ranges of the primitive timing functions with the
            offsets of the corresponding animation effect's keyframes or path
            segments.
          </p>
          <p>
            See <a
            href='http://lists.w3.org/Archives/Public/public-fx/2013AprJun/0184.html'>section
            5 (Chained timing functions) of minuted discussion from Tokyo
              2013 F2F</a>.
          </p>
        </div>
      </section>
      <section>
        <h3>Scaling using a cubic Bézier curve</h3>
        <div class="informative">
          <p>
            A common method of producing easing effects is to use a cubic Bézier
            curve to scale the time.
            The endpoints of the curve are fixed at (0, 0) and (1, 1) while two
            control points <var>P1</var> and <var>P2</var> define the shape of
            the curve.
            Provided the <var>x</var> values of <var>P1</var> and <var>P2</var>
            lie within the range [0, 1] such a curve produces a function that is
            used to map input times (the <var>x</var> values) onto output times
            (the <var>y</var> values).
            This arrangement is illustrated below.
          </p>
          <div class="figure">
            <img src="img/cubic-bezier-timing-curve.svg" width="500"
                alt="A cubic Bezier curve used as a timing function.">
          </div>
          <p class="caption">
            A cubic Bézier curve used as a timing function.<br>
            The shape of the curve is determined by the location of the control
            points <var>P1</var> and <var>P2</var>.<br>
            Input time fractions serve as <var>x</var> values of the curve,
            whilst the <var>y</var> values are the output time fractions.
          </p>
          <p>
            Some example cubic Bézier timing functions are illustrated below.
          </p>
          <div class="figure">
            <img src="img/curve-keywords.svg" width="500"
                alt="The timing functions produced by keyword values.">
          </div>
          <p class="caption">
            The timing functions produced by each of the keyword values
            associated with cubic Bézier timing functions accepted by the
            <a href="#widl-Timing-timingFunction"
            class="idlType"><code>Timing.timingFunction</code></a>
            member from the <a href="#script-interface">script interface</a>.
          </p>
        </div>
        <p>
          A <dfn>cubic Bézier timing function</dfn> is a type of <a>timing
          function</a> defined by four real numbers that specify the two control
          points, <var>P1</var> and <var>P2</var>, of a cubic Bézier curve whose
          end points are fixed at (0, 0) and (1, 1).
          The x coordinates of <var>P1</var> and <var>P2</var> are
          restricted to the range [0, 1].
        </p>
        <p>
          The evaluation of this curve is covered in many sources such as
          [[FUND-COMP-GRAPHICS]].
        </p>
        <div class="issue">
          <p>
            It has been proposed to extend <code>cubic-bezier</code> to allow
            multiple segments, using syntax such as the following:
          </p>
          <pre>
            <code>cubic-bezier( [ &lt;number&gt;{6} ; ]* &lt;number&gt;{4} )</code>
          </pre>
          <p>
            (i.e. the curve starts at (0, 0); each segment is defined by six
            numbers where the start point is the end of the previous segment and
            the numbers define the two control points and the end point. The
            last segment is defined by four numbers since the end point is fixed
            at (1, 1).)
          </p>
          <p>
            This would provide a simpler and more compact syntax for tools
            trying to map arbitrary curves (e.g. bounce functions) to timing
            functions than trying to construct the corresponding chained timing
            function.
          </p>
        </div>
      </section>
      <section>
        <h3>Timing in discrete steps</h3>
        <div class="informative">
          <p>
            It is possible to scale a timed item's timing so that the timed item
            occurs in a series of discrete steps using a stepping function.
          </p>
          <p>
            Some example step timing functions are illustrated below.
          </p>
          <div class="figure">
            <img src="img/step-timing-func-examples.svg" width="700"
                alt="Example step timing functions.">
          </div>
          <p class="caption">
            Example step timing functions.
            In each case the domain is the input time fraction whilst the range
            represents the output time fraction produced by the step
            function.<br>
            The first row shows the function for each transition point when only
            one step is specified whilst the second row shows the same for three
            steps.
          </p>
        </div>
        <p>
          A <dfn>step timing function</dfn> is a type of <a>timing function</a>
          that divides the input time into a specified number of intervals that
          are equal in duration.
          The output time, starting at zero, rises by an amount equal to the
          interval duration once during each interval at the transition point
          which may be either the start, midpoint, or end of the interval.
        </p>
        <p>
          In keeping with Web Animation's model for endpoint exclusive
          interval timing (see <a href="#interval-timing"
          class="sectionRef"></a>), the output time at the transition point is
          the time <em>after</em> applying the increase (i.e. the top of the
          step).
        </p>
      </section>
      <section>
        <h3>Paced timing</h3>
        <div class='todo'>
          <p>Insert a nice diagram showing how this works</p>
        </div>
        <p>
          A <dfn>paced timing function</dfn> scales the input time such that the
          resulting time values cause a <dfn>referenced property</dfn> that is
          animated by a specified <a>animation effect</a>, referred to as the
          <dfn>paced effect</dfn>,
          to change at a constant rate over the period of time for which the
          paced timing function applies.
        </p>
        <p>
          The syntax for specifying a paced timing function is:
          <code>paced(<a
          href="http://www.w3.org/TR/css3-syntax/#property">&lt;property&gt;</a>)</code>.
          The <code>&lt;property&gt;</code> argument is the <a>referenced
          property</a> of the <a>paced timing function</a>.
        </p>
        <div class='informative'>
          <p>
            For example, <code>paced(transform)</code> would indicate that the
            time should be scaled such that changes to the <span
            class="prop-name">transform</span> property occur at a constant
            rate.
          </p>
        </div>
        <p>
          The <a>paced effect</a> is the <a>animation effect</a> specified on
          the same <a>timed item</a> where the <a>paced timing function</a> is
          applied.
          As a result, <a>paced timing functions</a> can only be used on
          <a>animations</a> and not other types of <a>timed items</a>.
        </p>
        <p>
          If <em>any</em> of the following conditions is true, the
          <a>linear timing function</a> is used for the purpose of timing model
          calculations:
        </p>
        <ul>
          <li>there is no <a>paced effect</a> (because the <a>timed item</a> is
              not an <a>animation</a> or does not specify an <a>animation
              effect</a>), or
          <li>the <a>referenced property</a> is not one of the <a>target
              properties</a> of the <a>paced effect</a>, or
          <li>the <a>referenced property</a> is not <a>interpolable</a>, or
          <li>the <a>referenced property</a> is not a valid property.
        </ul>
        <section>
          <h2>Evaluating a paced timing function</h2>
          <p>
            The result of evaluating a <a>paced timing function</a> at
            <var>input time</var> is calculated as follows:
          </p>
          <ol>
            <li>
              Let <var>length list</var> be a sequence of length values
              calculated using the rules defined in <a
              href="#calculating-the-length-between-two-property-values"
              class="sectionRef"></a>
              for the <a>referenced property</a> between each pair of keyframes
              that refers to the <a>referenced property</a> in a <a>keyframe
              animation effect</a>,
              or between each path segment in a <a>path animation effect</a>.
              <p class="issue">
                Need to confirm this approach is actually backwards-compatible
                with SVG with regards to motion-path behavior.
              </p>
            <li>
              If the number of items in <var>length list</var> is 1 or less let
              the output of the timing function be <var>input time</var> and
              terminate these steps.
            <li>
              Let <var>total length</var> be the sum of values in
              <var>length list</var>.
            <li>
              If <var>total length</var> is zero let
              the output of the timing function be <var>input time</var> and
              terminate these steps.
            <li>
              Let <var>distance</var> be
              <code><var>input time</var> &#215; <var>total length</var></code>.
            <li>
              Let <var>current position</var> be 0.
            <li>
              Let <var>current distance</var> be 0.
            <li>
              Let <var>current length</var> be the first value in <var>length
              list</var>.
            <li>While <var>distance</var> &gt; <code><var>current distance</var>
              + <var>current length</var></code>, perform the following steps:
              <ol>
                <li>Increment <var>current position</var> by 1.
                <li>Increase <var>current distance</var> by <var>current
                    length</var>.
                <li>Let <var>current length</var> be the value at
                    position <var>current position</var> in <var>length
                    list</var>.
              </ol>
            <li>
              The output of the paced timing function is the result of
              evaluating:
              <code><var>current distance</var> / <var>total length</var> + 
                (<var>distance</var> - <var>current distance</var>) / 
                <var>current length</var></code>
          </ol>
          <p class="issue">
            Is this algorithm necessary? Would a prose description suffice?
          </p>
        </section>
        <section>
          <h2>Calculating the length between two property values</h2>
          <p>
            The length between any two property values depends on the type of
            values as follows:
          </p>
          <dl>
            <dt>For numeric values,</dt>
            <dd>
              length is defined as the absolute value of the
              difference between two values.
              <p class="todo">
                Need to explain how this applies to length values.
              </p>
            </dd>
            <dt>For colors,</dt>
            <dd>
              length is defined as the result of evaluating the following
              expression
              <div role="math" aria-describedby="math-color-length">
              <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
              <mrow>
                <msqrt>
                  <msup>
                    <mrow>
                      <mfenced open="(" close=")" separators=",">
                        <mrow><mi>ra</mi><mo>-</mo><mi>rb</mi></mrow></mfenced>
                    </mrow><mn>2</mn>
                  </msup>
                  <mo>+</mo>
                  <msup>
                    <mrow>
                      <mfenced open="(" close=")" separators=",">
                        <mrow><mi>ga</mi><mo>-</mo><mi>gb</mi></mrow></mfenced>
                    </mrow><mn>2</mn>
                  </msup>
                  <mo>+</mo>
                  <msup>
                    <mrow>
                      <mfenced open="(" close=")" separators=",">
                        <mrow><mi>ba</mi><mo>-</mo><mi>bb</mi></mrow></mfenced>
                    </mrow><mn>2</mn>
                  </msup>
                  <mo>+</mo>
                  <mn>255</mn><mo>&times;</mo><mn>255</mn><mo>&times;</mo>
                  <msup>
                    <mrow>
                      <mfenced open="(" close=")" separators=",">
                        <mrow><mi>aa</mi><mo>-</mo><mi>ab</mi></mrow>
                      </mfenced>
                    </mrow><mn>2</mn>
                  </msup>
                </msqrt>
              </mrow>
              </math>
              <pre id="math-color-length">sqrt((ra - rb)^2 + (ga - gb)^2 + (ba - bb)^2 + 255*255*(aa - ab)^2)</pre>
              </div>
              <p>
                where the colors between which the length is to be measured are
                <code>rgba(ra, ga, ba, aa)</code> and
                <code>rgba(rb, gb, bb, ab)</code> respectively.
              </p>
            </dd>
            <dt>For transform values,</dt>
            <dd>
              <p>
                The definition of length for transform values depends on whether
                adjacent keyframe values of the transform property have matching
                first components.
                If the components are translate functions, then euclidean
                distance between the two translation vectors is used. 
                If the components are scale functions, then the absolute
                difference between the average scale values is used.
                If the components are rotate functions, then the absolute
                difference between rotation angles is used.
              </p>
              <p>
                If the components match but are not scale, rotate or translate
                functions, then the <a>linear timing function</a> is used
                for the purpose of timing model calculations.
              </p>
              <p>
                If the components do not match, then interpolation between the 
                components will require matrix decomposition.
                In this case the length is calculated using the euclidean
                distance between the translate components of the decomposed
                matrices.
              </p>
              <p class="todo">
                Need a reference for euclidean distance.
              </p>
              <p class="todo">
                This only refers to keyframe values.
                Need to explain what to do for paths.
              </p>
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>Calculating the transformed time</h3>
        <p>
          The <dfn>transformed time</dfn> is calculated from the
          <a>directed time</a> using the following steps:
        </p>
        <ol>
          <li>
            If the <a>directed time</a> is <code>null</code>,
            return <code>null</code>.
          </li>
          <li>Let <var>iteration fraction</var> be the result of
              evaluating <code><a>directed time</a> / <a>iteration
              duration</a></code> unless <a>iteration duration</a> is
              zero, in which case let <var>iteration fraction</var> be
              zero.</li>
          <li>Let <var>scaled fraction</var> be the result of
              evaluating the <a>timed item</a>'s <a>timing function</a>
              with <var>iteration fraction</var> as the input time
              fraction.
          <li>Return the result of evaluating <code><var>scaled
              fraction</var> * <a>iteration duration</a></code>.
        </ol>
      </section>
    </section>

    <section>
      <h2>Grouping and synchronization</h2>
      <div class="informative">
        <p>
          While it is possible to set the timing properties of <a>timed
          items</a> individually, it is often useful to synchronize <a>timed
          items</a> so that they share common timing properties and maintain
          their temporal relationship.  This is achieved using a <a>timing
          group</a>.
        </p>
        <p>
          A simple example is illustrated below.
        </p>
        <div class="figure">
          <img src="img/grouping-delay.svg" width="800"
                alt="Using groups to share common timing properties.">
        </div>
        <p class="caption">
          Using groups to share common timing properties.<br>
          (a) Shows setting a delay of 5 seconds on individual animations.<br>
          (b) Produces the same effect by setting the delay on the group.
        </p>
        <p>
          When a <a>timing group</a> is directly associated with
          a <a>player</a>, the <a>timed items</a> associated with the <a>timing
          group</a> can be seeked, paused, and stopped as a unit.
        </p>
      </div>
      <p>
        A <dfn>timing group</dfn> is a type of <a>timed item</a> that contains
        an ordered sequence of zero or more <a>timed items</a> known as <dfn
        title="child timed item">child timed items</dfn>.
      </p>
      <p>
        At a given moment, a <a>timed item</a> may be a <a>child timed item</a>
        of at most one <a>timing group</a> known as the <dfn>parent timing
        group</dfn>.
        The <a>parent timing group</a> cannot be the same <a>timed
        item</a> as the <a>child timed item</a> itself.
      </p>
      <p>
        By nesting <a>timing groups</a> it is possible to create hierarchical
        tree structures.
        The following terms are used to describe the parts and properties of
        such structures and are defined in [[!DOM4]]:
      </p>
      <ul>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-order">tree order</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-root">root</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-ancestor">ancestor</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-descendant">descendant</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-inclusive-ancestor">inclusive ancestor</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-inclusive-descendant">inclusive descendant</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-next-sibling">next
        sibling</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-previous-sibling">previous
        sibling</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-first-child">first child</a></dfn>
        <li><dfn><a
        href="http://www.w3.org/TR/dom/#concept-tree-last-child">last child</a></dfn>
      </ul>
      <p class="note">
        Note that in applying these definitions to <a>timed items</a>, the term
        <em>parent</em> refers exclusively to a <a>parent timing group</a> and
        does not include the <a>player</a> which with a <a>timed item</a> may be
        <a title="directly associated with a player">directly associated</a>
        despite the fact that conceptually the <a>player</a> acts as a parent
        time source.
      </p>
      <p>
        The temporal relationship between a <a>child timed item</a> and its
        <a>parent timing group</a> is incorporated in the definition of
        <a>inherited time</a> (see <a href="#local-time-and-inherited-time"
        class="sectionRef"></a>).
      </p>
      <section class="informative">
        <h3>Relationship of group time to child time</h3>
        <p>
          The timing of the children of a <a>timing group</a> is based on the
          timing of the group.
          Specifically, times for the children are based on the parent's
          <a>transformed time</a>.
          With regards to repetition, this means the children operate
          <em>inside</em> an iteration of the parent.
        </p>
        <p>
          For example, if a <a>timing group</a> has an <a>iteration count</a> of
          2, then the children of of the group will all play twice since they
          effectively play <em>inside</em> the group's iterations.
        </p>
        <div class="figure">
          <img src="img/grouping-repetition.svg" width="600"
                alt="The effect of multiple iterations on the children of a
                    group.">
        </div>
        <p class="caption">
          Since children of an <a>timing group</a> base their timing on the
          group's <a>transformed time</a>, when the group repeats, the
          children play again.
        </p>
        <p>
          Note that even in this case, the child <a>timed items</a> still have
          only <em>one</em> <a>active interval</a>.
          However, as a result of the parent's timing, the <a>active
          interval</a> is played twice.
        </p>
        <p>
          If an <a>iteration count</a> is specified for the children of a group
          as well as for the group itself, the effect is as if the <a>iteration
          count</a> of the group was multiplied with the <a>iteration count</a>
          of the children.
        </p>
        <div class="figure">
          <img src="img/grouping-repetition-and-animation-repetition.svg"
            width="600" alt="Iteration counts are multiplicative.">
        </div>
        <p class="caption">
          Specifying an <a>iteration count</a> of 2 on an <a>timing group</a>
          and an <a>iteration count</a> of 3 on one of its children results in
          that child playing 6 times.
        </p>
        <p>
          A further result of the children of a <a>timing group</a> basing their
          timing on the group's <a>transformed time</a> is that they cannot
          animate outside of the group's <a>active interval</a>.
          This is because the <a>transformed time</a> of a group will not
          change outside its <a>active interval</a>.
          This allows groups to <em>clip</em> the playback of their children.
        </p>
        <div class="figure">
          <img src="img/grouping-clipping.svg" width="600"
            alt="Groups clip the active interval of contained children.">
        </div>
        <p class="caption">
          In the first instance, a <a>timed item</a> has a negative delay and an
          infinite <a>iteration count</a>.<br>
          However, when a similar <a>timed item</a> is placed inside a <a>timing
          group</a> with a specified <a>iteration duration</a> it has the effect
          of clipping the child <a>timed item</a>'s <a>active interval</a>.
        </p>
        <p>
          Some further consequences of <a>timing group</a> children basing their
          timing on their parent group's <a>transformed time</a> are:
        </p>
        <ul>
          <li>
            Setting the <a title="timed item playback rate">playback rate</a> of
            a <a>timing group</a> will speed up or slow down all children.
          </li>
          <li>
            Changing the <a>playback direction</a> of a <a>timing group</a> will
            change the direction of all children.
          </li>
          <li>
            Applying a <a>timing function</a> to a <a>timing group</a> will
            affect the progress of all children.
          </li>
        </ul>
      </section>
      <section class="informative">
        <h3>Types of timing groups</h3>
        <p>
          <a>Timing groups</a> can be used to provide different kinds of
          synchronization behavior for their children.
          For example, one type of <a>timing group</a> runs its children in
          parallel, whilst another type runs the children in sequence.
        </p>
        <p>
          Compare the two arrangements illustrated below:
        </p>
        <div class="figure">
          <img src="img/grouping-types.svg" width="600"
            alt="Two types of timing groups.">
        </div>
        <p class="caption">
          Two types of <a>timing groups</a>.<br>
          (a) is a <a>parallel timing group</a> where all the children run
              simultaneously.<br>
          (b) is a <a>sequence timing group</a> where the children run in turn.
        </p>
        <p>
          <a>Timing groups</a> can also contain other <a>timing groups</a> which
          allows for more sophisticated synchronization.
          An example is illustrated below.
        </p>
        <div class="figure">
          <img src="img/grouping-nesting.svg" width="600"
            alt="Nesting of timing groups.">
        </div>
        <p class="caption">
          A <a>sequence timing group</a> that contains a <a>parallel timing
          group</a> as a child.<br>
          The <a>parallel timing group</a> waits for the previous child of the
          <a>sequence timing group</a> to finish, and then the children of the
          <a>parallel timing group</a> play simultaneously.
          After they have finished the next child of the <a>sequence timing
          group</a> plays.
        </p>
        <p>
          Web Animations defines two types of <a>timing groups</a>.
        </p>
        <dl>
          <dt><a>Parallel timing groups</a></dt>
          <dd>
            Children of the group play simultaneously.
            The <a title="timed item start time">start time</a> of each child
            coincides with the beginning of the group's <a>iteration
            interval</a>.
          </dd>
          <dt><a>Sequence timing groups</a></dt>
          <dd>
            Children of the group play in turn beginning with the first child
            and proceeding to the last.
            The <a title="timed item start time">start time</a> of each child is
            set to the end of the <a>active interval</a> of the previous
            sibling.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Parallel timing groups</h3>
        <p>
          A <dfn>parallel timing group</dfn> is a type of <a>timing group</a>
          that schedules its <a>child timed items</a> such that they play
          simultaneously.
        </p>
        <section>
          <h4>The start time of children of a parallel timing group</h4>
          <p>
            The <a title="timed item start time">start time</a> of a <a>child
            timed item</a> of a <a>parallel timing group</a> is zero.
          </p>
        </section>
        <section>
          <h4>The intrinsic iteration duration of a parallel timing group</h4>
          <p>
            The <a>intrinsic iteration duration</a> of a <a>parallel timing
            group</a> is based on the time when the last <a>child timed item</a>
            completes its <a>active interval</a> and is calculated using the
            following procedure.
          </p>
          <ol>
            <li>
              <p>Define the <a>end time</a> of a <a>timed item</a> as
              :</p>
              <blockquote>
                <dfn>end time</dfn> =
                <code><a title="timed item start time">start time</a> + <a>start
                delay</a> + <a>active duration</a></code>
              </blockquote>
            </li>
            <li>
              <p>
                The <a>intrinsic iteration duration</a> depends on the number of
                <a>child timed items</a> as follows,
              </p>
              <dl class="switch">
                <dt>If the group has no <a>child timed items</a>,</dt>
                <dd>
                  the <a>intrinsic iteration duration</a> is zero.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  <ol>
                    <li>Let <var>maximum end time</var> be the maximum value
                        after calculating the <a>end time</a> of each <a>child
                        timed item</a> in the group.</li>
                    <li>The <a>intrinsic iteration duration</a> is the result of
                        evaluating <code>max(0, <var>maximum end
                        time</var>)</code>.</li>
                  </ol>
                </dd>
              </dl>
            </li>
          </ol>
          <p class="note">
            Note that for children of a <a>parallel timing group</a>, the <a
            title="timed item start time">start time</a> will always be zero but
            it is included in the definition of <a>end time</a> here since the
            <a>end time</a> is also used to define the <a>intrinsic iteration
            duration</a> of a <a>sequence timing group</a>
            (see <a
            href="#the-intrinsic-iteration-duration-of-a-sequence-timing-group"
            class="sectionRef"></a>).
          </p>
        </section>
      </section>
      <section>
        <h3>Sequence timing groups</h3>
        <p>
          A <dfn>sequence timing group</dfn> is a type of <a>timing group</a>
          that schedules its <a>child timed items</a> such that they play in
          turn following their order in the group.
          This ordering is achieved by adjusting the <a
          title="timed item start time">start time</a> of each <a>child timed
          item</a> in the group.
        </p>
        <section>
          <h4>The start time of children of a sequence timing group</h4>
          <p>
            The <a title="timed item start time">start time</a> of a <a>child
            timed item</a> of a <a>sequence timing group</a> is the <a>end
            time</a> of the child's <a>previous sibling</a>.
            If the child has no <a>previous sibling</a> the start time is zero.
          </p>
          <div class="note">
            <p>
              When the <a>active duration</a> is positive infinity the behavior
              for calculating the <a>end time</a> of an <a>timed item</a> and
              the <a title="timed item start time">start time</a> of subsequent
              children follows the usual behavior defined by IEEE 754-2008.
              As a result, if any of the children of a <a>sequence timing
              group</a> has an infinite <a>active duration</a>, any children
              that occur later in the sequence will not play.
            </p>
            <p>
              Similarly, the above definition does not restrict
              <a title="timed item start time">start times</a> to positive
              values and hence some children may not play due to a negative
              <a>start delay</a> on children that occur earlier in the group
              since their <a>active interval</a> may end before the group's <a
              title="timed item start time">start time</a>.
            </p>
            <p class="todo">
              Need to define if events fire in this case.
            </p>
          </div>
          <div class="informative">
            <p>
              Because the start of the <a>active interval</a> is based on the
              sum of a <a>timed item</a>'s <a
              title="timed item start time">start time</a> <em>and</em> <a>start
              delay</a>, the <a>active intervals</a> of
              children of a <a>sequence timing group</a> need not run in strict
              sequence but can be shifted back and forth by using the <a>start
              delay</a> as shown in the following diagram.
            </p>
            <div class="figure">
              <img src="img/sequence-groups-and-start-delays.svg" width="600"
                alt="Using negative start delays to overlap children of seq
                    groups">
            </div>
            <p>
              A negative <a>start delay</a> can be used to cause the <a>active
              interval</a> of two children to overlap.  Note that the <a>start
              delay</a> affects the <a title="timed item start time">start
              time</a> of subsequent children in the group.
            </p>
          </div>
        </section>
        <section>
          <h4>The intrinsic iteration duration of a sequence timing group</h4>
          <p>
            The <a>intrinsic iteration duration</a> of a <a>sequence timing
            group</a> is equivalent to the <a
            title="timed item start time">start time</a> of a hypothetical
            <a>child timed item</a> appended to the group's children calculated
            according to the definition in <a
            href="#the-start-time-of-children-of-a-sequence-timing-group"
            class="sectionRef"></a> unless that produces a negative value, in
            which case the <a>intrinsic iteration duration</a> is zero.
          </p>
          <p>
            As a result, if the <a>sequence timing group</a> has no <a>child
            timed items</a> the <a>intrinsic iteration duration</a> will be
            zero.
          </p>
        </section>
      </section>
    </section>

    <section>
      <h2>Animations</h2>
      <p>
        <dfn title="animation">Animations</dfn> are a kind of <a>timed item</a>
        that apply an <a>animation effect</a> to an element or pseudo-element
        such as <code>::before</code> and <code>::first-line</code> [[!SELECT]]
        referred to as the <dfn>target element</dfn>.
      </p>
      <section>
        <h3>Calculating the time fraction</h3>
        <p>
          Before passing the <a>transformed time</a> of an <a>animation</a> to
          its <a>animation effect</a> it is converted to a <em>time
          fraction</em>.
          The <dfn>time fraction</dfn> of a <a>timed item</a> is calculated
          according to the following steps:
        </p>
        <dl class="switch">
          <dt>
            If the <a>iteration duration</a> is zero,
          </dt>
          <dd>
            <p>
              the <a>time fraction</a> is as follows,
            </p>
            <dl class="switch">
              <dt>
                If <a>local time</a> &lt; <a>start delay</a>,
              </dt>
              <dd>
                Return the result of recalculating the <a>transformed time</a>
                using a <a>local time</a> less than <a>start delay</a> (e.g.
                <code><a>start delay</a> - 1</code>) and an <a>iteration
                duration</a> of 1.
              </dd>
              <dt>
                Otherwise,
              </dt>
              <dd>
                <ol>
                  <li>Let <var>normalized active duration</var> be the result of
                      recalculating the <a>active duration</a> using an
                      <a>iteration duration</a> of 1.
                  <li>Return the result of recalculating the <a>transformed
                      time</a> using a <a>local time</a> of <var>normalized
                      active duration</var> and an <a>iteration duration</a> of
                      1.
                </ol>
              </dd>
            </dl>
          </dd>
          <dt>
            Otherwise,
          </dt>
          <dd>
            Return <a>transformed time</a> / <a>iteration duration</a> unless
            <a>transformed time</a> is <code>null</code>, in which case return
            <code>null</code>.
          </dd>
        </dl>
        <p class="note">
          Since <a>timing functions</a> are allowed to produce output times
          outside the range [0, 1] it is possible that the value calculated for
          a <a>time fraction</a> also lies outside this range.
        </p>
      </section>
    </section>
    </section> <!-- End of timing model -->

    <section>
      <h2>Animation model</h2>
      <div class="informative">
        <p>
          The Web Animations <em>animation model</em> takes the <a>time
          fractions</a> and <a>current iteration</a> values produced by the
          <em>timing model</em> for a given <a>animation</a> and applies it as
          the input to the <a>animation</a>'s <a>animation effect</a>.
        </p>
        <p>
          The output of each <a>animation effect</a> is then combined with other
          <a>animation effects</a> using an <a>animation stack</a> before being
          applied to the target properties (see <a href="#combining-animations"
          class="sectionRef"></a>).
        </p>
      </div>

    <section>
      <h2>Animation effects</h2>
      <p>
        An <dfn>animation effect</dfn> takes a <a>time fraction</a> and
        a <a>current iteration</a> value and uses them to calculate an
        <a>intermediate animation value</a> for its <a>target properties</a>.
        Each <a>animation</a> may have at most one <a>animation effect</a>
        associated with it.
      </p>
      <p>
        Since the result of an <a>animation effect</a> is based on the
        <a>time fraction</a> and <a>current iteration</a> value, it is updated
        whenever the timing model is <a title="sampling">sampled</a>.
        Note that changes to the timing model caused by using the <a
        href="#script-interface">programming interface</a> do <em>not</em> cause
        the animation model (and hence <a>animation effects</a>) to be updated
        as described in <a
        href="#script-execution-and-live-updates-to-the-model"
        class="sectionRef"></a>.
      </p>
      <section>
        <h3>Target properties</h3>
        <p>
          Each <a>animation effect</a> can have zero or more associated
          <dfn>target properties</dfn>.
          Not all properties may be animated by an <a>animation effect</a>.
          Properties that may be animated by an <a>animation effect</a> are 
          defined as <dfn>animatable</dfn>.
          The set of <a>animatable</a> properties is is defined in <a
          href="#animatable-properties" class="sectionRef"></a>.
        </p>
        <p>
          An <a>animation effect</a> that targets a property that is not
          <a>animatable</a> will have no effect on the property.
          However, an <a>animation</a> that applies such an <a>animation
          effect</a> will still exhibit the usual behavior for a <a>timed
          item</a> such as firing <a>timing events</a> and occupying time in
          a <a>sequence timing group</a>.
        </p>
      </section>
      <section>
        <h3>Target property types</h3>
        <p>
          The specific operations involved in animating a <a
          title="target properties">target property</a> differ based on the
          <dfn>property type</dfn>.
          For example, the specific procedure for animating a property that
          specifies a color will differ from a property that specifies a length.
          Each <a>animatable</a> property defines one or more <a>property
          types</a> to use when animating.
        </p>
        <p>
          In order to produce a smooth change between property values,
          a procedure for <dfn>interpolation</dfn> is required.
          A given <a>property type</a> is <dfn>interpolable</dfn> if there is
          a procedure defined to interpolate between two values of that type.
        </p>
        <p>
          In order to support <a>accumulation</a> and <a
          title="composition operation add">additive composition</a>,
          a procedure for <dfn>addition</dfn> is required.
          A given <a>property type</a> is <dfn>additive</dfn> if there is
          a procedure defined to add two values of that type.
        </p>
        <p>
          An initial list of <a>property types</a> and their procedures for
          <a>interpolation</a> and <a>addition</a> is given in <a
          href="#animation-of-property-types" class="sectionRef"></a>.
          In addition to this initial list, specifications that define CSS
          properties may provide additional property types to define the
          procedures for interpolation and addition of the values of those
          properties.
        </p>
      </section>
      <section>
        <h3>Intermediate animation values</h3>
        <p>
          Given a <a>time fraction</a>, a <a>current iteration</a>, and an
          <a>underlying value</a>, an <a>animation effect</a> produces
          an <dfn>intermediate animation value</dfn> for each <a>animatable</a>
          <a title="target properties">target property</a>.
          Before being applied to the <a>target properties</a>,
          these <a>intermediate animation values</a> are composed together using
          the process defined in <a href="#combining-animations"
          class="sectionRef"></a>.
        </p>
        <div class="issue">
          <p>
            The use of the term 'value' here is misleading, as the output of
            the effect stage can not be resolved to a concrete value until it
            is composited with an underlying value. This takes place in the
            compositing stage, when the animation stack is resolved. It is
            therfore more accurate to describe the output of the effect stage
            as a set of values and corresponding composition operations, which
            are used to modify an underlying value. The same is true of the
            unaccumulated animation value.
          </p>
          <p>
            Use of this more precise terminology will also allow the algorithm
            for accumulation to be specified more precisely.
          </p>
        </div>
        <p>
          An <a>intermediate animation value</a> is established by first
          calculating an <a>unaccumulated animation value</a> and then applying
          <a>accumulation</a> behavior.
        </p>
        <section>
          <h3>Unaccumulated animation values</h3>
          <p>
            The <dfn>unaccumulated animation value</dfn> is the result of
            evaluating an <a>animation effect</a> for a given <a>target
            property</a>, <a>time fraction</a> and <a>underlying value</a>
            <em>independent</em> of the <a>current iteration</a>.
            The procedure for calculating this value depends on the specific
            type of <a>animation effect</a> and is defined subsequently (see <a
            href="#the-unaccumulated-animation-value-of-a-keyframe-animation-effect"
            class="sectionRef"></a> and <a
            href="#the-unaccumulated-animation-value-of-a-path-animation-effect"
            class="sectionRef"></a>).
          </p>
        </section>
        <section>
          <h3>Accumulating animation values</h3>
          <p>
            <a>Animation effects</a> may be defined such that as the
            <a>animation</a> that is applying them is <a
            href="#repeating">repeated</a>, the <a>intermediate animation
            value</a> builds on the value produced by previous iterations.
            This behavior is called <dfn>accumulation</dfn>.
          </p>
          <p>
            The <a>accumulation</a> behavior of an <a>animation effect</a> is
            specified by the <a>animation effect</a>'s <dfn>accumulation
            operation</dfn> property.
            The <a>accumulation operation</a> property takes one of the
            following two values.
          </p>
          <dl>
            <dt><dfn title="accumulation operation sum">sum</dfn></dt>
            <dd>
              <p>
                The <a>intermediate animation value</a> produced by the
                <a>animation effect</a> for a given property is the sum of the
                <a>unaccumulated animation value</a> for the given <a>time
                fraction</a> and the final <a>intermediate animation value</a>
                of the previous iteration (i.e. the result of evaluating the
                <a>intermediate animation value</a> with a <a>time fraction</a>
                of 1, and a <a>current iteration</a> of <code><a>current
                iteration</a> - 1</code>).
              </p>
              <p>
                If the <a>current iteration</a> is zero, the <a>intermediate
                animation value</a> is just the <a>unaccumulated animation
                value</a>.
              </p>
            </dd>
            <dt><dfn
              title="accumulation operation none">none</dfn></dt>
            <dd>
              The <a>intermediate animation value</a> for the <a>animation
              effect</a> is just the <a>unaccumulated animation value</a>.
            </dd>
          </dl>
          <p>
            <a>Accumulation</a> behavior is only applied for <a>target
            properties</a> that are <a>additive</a>.
            For <a>target properties</a> whose values are not <a>additive</a>,
            an <a>accumulation operation</a> of
            <a title="accumulation operation none">none</a> is used.
          </p>
          <p>
            <a>Accumulation</a> behavior is only applied for <a
            title="keyframe animation effect">keyframe animation effects</a>
            when the <a>composition operation</a> is uniform across all
            <a>keyframes</a>.
            For <a title="keyframe animation effect">keyframe
            animation effects</a> where the <a>composition operation</a>
            varies, an <a>accumulation operation</a> of <a
            title="accumulation operation none">none</a> is used.
          </p>
          <div class="issue">
            The definition of accumulation here needs review.
            The intention is to provide compatible behavior with SVG but also
            needs to account for the possibility of <a>timing functions</a>
            whose final output value is not 1 (if we allow that), and possible
            differences in the way <a
            title="composition operation">composition</a> is defined.
          </div>
        </section>
      </section>
    </section>

    <section>
      <h2>Combining animations</h2>
      <div class="informative">
        <p>
          After calculating the <a>intermediate animation values</a> for an
          <a>animation effect</a> they are applied to the <a>animation
          effect</a>'s <a>target properties</a>.
        </p>
        <p>
          Since it is possible for multiple <a>in effect</a> <a
          title="animation">animations</a> to target the same property it is
          often necessary to combine the results of several <a>animation
          effects</a> together.
          This process is called <em>compositing</em> and is based on
          establishing an <a>animation stack</a> for each property targetted by
          an <a>in effect</a> <a>animation effect</a>.
        </p>
        <p>
          After compositing the results of <a>animation
          effects</a> together, the composited result is combined with other
          styles applied to the <a title="target properties">target
          property</a>.
        </p>
        <p>
          An overview of this arrangement is illustrated below:
        </p>
        <div class="figure">
          <img src="img/animation-cascade.svg" width="450"
            alt="Overview of the application of intermediate animation values
                to their target properties">
        </div>
        <p class="caption">
          Overview of the application of <a>intermediate animation values</a> to
          their <a>target properties</a>.<br>
          The results of <a>animation effects</a> targetting the same property
          are composited together using an <a>animation stack</a>.<br>
          The result of this composition is written to an override stylesheet
          that is more important than other stylesheets but less than any
          <code>!important</code> rules.
        </p>
        <p>
          For the first part of this operation&mdash;combining <a>intermediate
          animation values</a> that target the same <a
          title="target property">property</a>&mdash; it is necessary to
          determine both
          <em>how</em> the <a>animation effects</a>
          associated with the <a>animations</a> are combined
          with one another,
          as well as the <em>order</em> in which they are applied, that is,
          their relative <em>priority</em>.
        </p>
        <p>
          The matter of <em>how</em> <a>intermediate animation values</a> are
          combined is governed by any <a>composition operations</a> associated
          with the corresponding <a>animation effects</a>.
        </p>
        <p>
          The relative <em>priority</em> of <a>intermediate animation values</a>
          is determined by an <a>animation stack</a> established for each
          animated property.
        </p>
      </div>
      <section>
        <h3>The animation stack</h3>
        <p>
          Associated with each property <a title="target property">targetted</a>
          by one or more <a>animation effects</a> is an <dfn>animation
          stack</dfn> that establishes the relative priority of the <a>animation
          effects</a>.
        </p>
        <p>
          The relative priority of any two <a>animation
          effects</a>, <var>A</var> and <var>B</var>, within an <a>animation
          stack</a> is established by comparing the properties of the
          <a>animations</a> applying <var>A</var> and <var>B</var> as follows:
        </p>
        <ol>
          <li>Let the <var>associated player</var> of an <a>animation effect</a>
              be the <a>player</a> <a
              title="associated with a player">associated</a> with the
              <a>animation</a> that is applying the <a>animation effect</a> to
              the property with which this <a>animation stack</a> is
              associated.
          <li>Sort <var>A</var> and <var>B</var> by applying the following
              conditions in turn until the order is resolved,
            <ol>
              <li>Sort <var>A</var> and <var>B</var> using any <a>custom
                  animation priority</a> specified for <var>A</var> and
                  <var>B</var> so that lower priorities sort first.
              <li>Sort <var>A</var> and <var>B</var> by the <a>player start
                  time</a> of the <var>associated player</var> of each
                  of <var>A</var> and <var>B</var> so that earlier times sort
                  first.
              <li>Sort by the <a>player sequence number</a> so that lower
                  sequence numbers sort first.
              <li>Sort <var>A</var> and <var>B</var> in <a>tree order</a>.
           </ol>
        </ol>
        <p>
          <a>Animation effects</a> that sort earlier have <em>lower</em>
          priority.
        </p>
        <section>
          <h3>The custom animation priority</h3>
          <p>
            Each <a>animation effect</a> has an associated numeric
            <dfn>custom animation priority</dfn> that is used to provide
            high-level control of animation priority for specifications layered
            on top of Web Animations.
            The initial value of the <a>custom animation priority</a> is zero.
          </p>
          <div class="note">
            <p>
              Note that the <a>custom animation priority</a> is primarily
              intended to be used to prioritize animation effects at
              a high-level, such as to prioritize animations <em>by type</em>.
              For example, it can be used to ensure that CSS Animations always
              override CSS Transitions.
            </p>
            <p>
              It is possible to control animation priority at a lower-level by
              setting the <a>player start time</a> appropriately,
              (possibly after making compensatory adjustments to the <a>start
              delay</a> of the <a>source content</a>) or influencing the
              <a>player sequence number</a> by controlling when <a>players</a>
              are created.
            </p>
          </div>
        </section>
      </section>
      <section>
        <h3>Calculating the result of an animation stack</h3>
        <p>
          In order to calculate the final value of an <a>animation stack</a>,
          the <a>intermediate animation values</a> of each
          <a>animation effect</a> in the stack are combined in order of priority
          from lowest to highest priority.
        </p>
        <p>
          Each step in the process of evaluating an <a>animation stack</a> takes
          an <dfn>underlying value</dfn> as input.
          The initial <a>underlying value</a> is the <a>base value</a> of the
          target property as defined in <a
          href="#combining-with-other-styles--the-override-stylesheet"
          class="sectionRef"></a>.
        </p>
        <p>
          For each <a>animation effect</a> in the stack, the appropriate
          <a>intermediate animation value</a> from the <a>animation effect</a>
          is combined with the <a>underlying value</a> to produce a new value.
          This resulting value becomes the <a>underlying value</a> for combining
          the next <a>animation effect</a> in the stack.
        </p>
        <p>
          The final value of an <a>animation stack</a>, called the
          <dfn>composited value</dfn>, is simply the result of combining the
          <a>intermediate animation value</a> of the final (highest priority)
          <a>animation effect</a> in the stack with the <a>underlying value</a>
          at that point.
        </p>
      </section>
      <section>
        <h3>Animation composition</h3>
        <p>
          The specific operation used to combine an <a>intermediate animation
          value</a> with an <a>underlying value</a> is determined by the
          <a>animation effect</a> that produced the <a>intermediate animation
          value</a> and is called the <dfn>composition operation</dfn>.
        </p>
        <p>
          This specification defines two common <a>composition operations</a> as
          follows:
        </p>
        <dl>
          <dt><dfn title="composition operation replace">replace</dfn></dt>
          <dd>
            The result of compositing the <a>intermediate animation value</a>
            with the <a>underlying value</a> is simply the <a>intermediate
            animation value</a>.
          </dd>
          <dt><dfn title="composition operation add">add</dfn></dt>
          <dd>
            <p>
              The <a>intermediate animation value</a> is <a
              title="addition">added</a> to the <a>underlying value</a>.
              For <a>property types</a> where
              <a>addition</a> is defined such that it is not commutative, the
              order of the operands is <code><a>underlying value</a>
              + <a>intermediate animation value</a></code>.
            </p>
            <p>
              If <a>intermediate animation value</a> and <a>underlying value</a>
              are not of the same <a>property type</a>, or if they are of the
              same <a>property type</a> but that <a>property type</a> is not
              <a>additive</a>, <a
              title="composition operation replace">replace</a> behavior is
              applied.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>Combining with other styles: the override stylesheet</h3>
        <p>
          Applying a <a>composited value</a> to a property depends on
          establishing an <a>override stylesheet</a>.
        </p>
        <p>
          The <dfn>override stylesheet</dfn> contains
          <a title="composited value">composited animation values</a>
          and acts with a higher priority than all other stylesheets.
          However, <code>!important</code> rules from all other stylesheets act
          with a higher priority than the <a>override stylesheet</a>.
          The <a>override stylesheet</a> is regenerated each time the
          <a>animation model</a> is updated (see <a href="#animation-effects"
          class="sectionRef"></a>).
        </p>
        <p>
        </p>
        <p>
          The <a>composited value</a> calculated for a property is applied
          using the following process.
        </p>
        <ol>
          <li>Calculate the <dfn>base value</dfn> of the property as
              the value generated for that property by computing the <a
              href="http://www.w3.org/TR/CSS2/cascade.html#used-value">used
              value</a> [[!CSS21]] for that property in the absence of the
              <a>override stylesheet</a>.</li>
          <li>Establish the <a>animation stack</a> for the property (see <a
              href="#the-animation-stack" class="sectionRef"></a>).</li>
          <li>Calculate the <a>composited value</a> of the <a>animation
              stack</a> passing in the <a>base value</a> of the property as the
              initial <a>underlying value</a> (see <a
              href="#calculating-the-result-of-an-animation-stack"
              class="sectionRef"></a>).</li>
          <li>Insert the <a>composited value</a> into the <a>override
              stylesheet</a>.</li>
        </ol>
      </section>
    </section>

    <section>
      <h2>Keyframe animation effects</h2>
      <p>
        A <dfn>keyframe animation effect</dfn> is an <a>animation effect</a>
        that produces <a>intermediate animation values</a> for its <a>target
        properties</a> by interpolating between a series of property values
        positioned at fractional offsets.
      </p>
      <p>
        Each set of property values indexed by a positional offset is called
        a <dfn>keyframe</dfn>.
      </p>
      <p>
        The <dfn>positional offset of a keyframe</dfn> is a value in the range
        [0, 1].
        The list of <a>keyframes</a> for a <a>keyframe animation effect</a> is
        sorted in ascending order by the <a
        title="positional offset of a keyframe">positional offset of each
        keyframe</a>.
      </p>
      <p class="note">
        Unlike CSS syntax, <a>timing functions</a> are <em>not</em> directly
        associated with a <a>keyframe</a>.
        Rather, this is achieved by setting a chain of <a>timing functions</a>
        on the <a>timed item</a> (proposal for this is still in the works).
      </p>
      <p>
        If, due to a <a>timing function</a> specified on the <a>timed
        item</a> from which the <a>time fraction</a> is derived, the <a>time
        fraction</a> lies outside the range [0, 1], the specified
        <a>keyframe</a> property values are extrapolated to cover the extended
        range.
      </p>
      <p>
        The behavior when <a>keyframes</a> overlap or have unsupported values
        is defined in <a
        href="#the-unaccumulated-animation-value-of-a-keyframe-animation-effect"
        class="sectionRef"></a>.
      </p>
      <p>
        Each <a>keyframe animation effect</a> has an associated <a>composition
        operation</a> that specifies how it is combined with other <a>animation
        effects</a> in the <a>animation stack</a>.
      </p>
      <p>
        Furthermore, each <a>keyframe</a> may also have an associated
        <a>composition operation</a> that is applied to all values specified in
        that <a>keyframe</a>.
        If no <a>composition operation</a> is specified for a <a>keyframe</a>,
        the <a>composition operation</a> specified for the <a>keyframe
        animation effect</a> is used.
      </p>
      <section>              
        <h3>The unaccumulated animation value of a keyframe animation effect</h3>
        <p>
          The <a>unaccumulated animation value</a> of a single property
          referenced by a <a>keyframe animation effect</a> as one of its
          <a>target properties</a>, for a given <a>time fraction</a> and
          <a>underlying value</a> is calculated as follows.
        </p>
        <ol>
          <li>Let <var>target property</var> be the property for which the
              <a>unaccumulated animation value</a> is to be calculated.
          <li>If <var>target property</var> is not <a>animatable</a> abort the
              procedure since the effect cannot be applied.</li>
          <li>Let <var>time fraction</var> be the <a>time fraction</a> for which
              the <a>unaccumulated animation value</a> is to be calculated.</li>
          <li>Let <var>underlying value</var> be the current <a>underlying
              value</a>.
          <li>Define the <dfn>neutral value for composition</dfn> as a value
              which, when combined with an <a>underlying value</a> using the <a
              title="composition operation add">add</a> <a>composition
              operation</a>, produces the <a>underlying value</a>.
              <p class="note">
                Note that this definition does not require determining
                a suitable zero value for each possible <a>property type</a>.
                This behavior could be realized, for example, by use of
                a sentinel value.
              </p>
          <li>Let <var>property-specific keyframes</var> be a copy of the list
              of <a>keyframes</a> specified on the effect.</li>
          <li>Remove any <a>keyframes</a> from <var>property-specific
              keyframes</var> that do not have a property value for
              <var>target property</var>.
          <li>If <var>property-specific keyframes</var> is empty, return
              <var>underlying value</var>.
          <li>If there is no <a>keyframe</a> with a <a
              title="positional offset of a keyframe">positional offset</a> of
              0, create a new <a>keyframe</a> with a positional offset of 0,
              a property value set to the <a>neutral value for composition</a>,
              and a <a>composition operation</a> of <a title="composition
              operation add">add</a>, and add it to the beginning of
              <var>property-specific keyframes</var>.
          <li>Similarly, if there is no <a>keyframe</a> with a <a
              title="positional offset of a keyframe">positional offset</a> of
              1, create a new <a>keyframe</a> with a positional offset of 1,
              a property value set to the <a>neutral value for composition</a>,
              and a <a>composition operation</a> of <a title="composition
              operation add">add</a>, and append it to the end of
              <var>property-specific keyframes</var>.
          <li>Iterate over each <var>keyframe</var> in <var>property-specific
              keyframes</var> and for each <var>keyframe</var>, if:
              <ul>
                <li><var>keyframe</var> has a <a>composition operation</a>
                    of <a title="composition operation add">add</a>, or
                <li><var>keyframe</var> has no <a>composition operation</a>
                    and the <a>composition operation</a> of this <a>keyframe
                    animation effect</a> is <a
                    title="composition operation add">add</a>
              </ul>
              perform the following steps:
              <ol>
                <li>Let <var>value to add</var> be the property value of
                    <var>target property</var> specified on <var>keyframe</var>.
                <li>If the <a>property type</a> of <var>underlying value</var>
                    and <var>value to add</var> is the same and is
                    <a>additive</a>, set the property value of <var>target
                    property</var> for <var>keyframe</var> to
                    <code><var>underlying value</var> + <var>value to
                    add</var></code>.
              </ol>
          <li>If <var>time fraction</var> &lt; 0 and there is more
              than one <a>keyframe</a> in <var>property-specific
              keyframes</var> with a positional offset of 0, return the property
              value for <var>target property</var> of the first <a>keyframe</a>
              in <var>property-specific keyframes</var>.</li>
          <li>If <var>time fraction</var> &ge; 1 and there is more than one
              <a>keyframe</a> in <var>property-specific keyframes</var> with
              a positional offset of 1, return the property value for
              <var>target property</var> of the last <a>keyframe</a> in
              <var>property-specific keyframes</var>.</li>
          <li>Let <var>start keyframe</var> be the last <a>keyframe</a> in
              <var>property-specific keyframes</var> whose positional offset is
              less than or equal to <var>time fraction</var> and less than 1.
              If there is no such <a>keyframe</a> (because, for example, the
              <a>time fraction</a> is negative), let <var>start keyframe</var>
              be the last <a>keyframe</a> whose positional offset is 0.</li>
          <li>Let <var>end keyframe</var> be the next <a>keyframe</a> in
              <var>property-specific keyframes</var> after <var>start
              keyframe</var>.</li>
          <li>If the pair of property values specified by <var>start
              keyframe</var> and <var>end keyframe</var>
              differ in <a>property type</a> or have the same <a>property
              type</a> but that type is not <a>interpolable</a>,
              then return the property value of <var>start keyframe</var>
              unless <var>time fraction</var> is greater than or equal to 1, in
              which case return the property value of <var>end
              keyframe</var>.</li>
          <li>Let <var>start offset</var> be the positional offset of <var>start
              keyframe</var>.</li>
          <li>Let <var>end offset</var> be the offset of <var>end
              keyframe</var>.</li>
          <li>
            Let <var>interval distance</var> be the result of evaluating
            <code>(<var>time fraction</var> - <var>start offset</var>) /
                  (<var>end offset</var> - <var>start offset</var>)</code>
          </li>
          <li>
            Return the result of <a title="interpolation">interpolating</a>
            between the property values defined for <var>start keyframe</var>
            and <var>end keyframe</var> using the procedure defined for their
            <a>property type</a> with <var>interval distance</var> as the
            interpolation parameter.
          </li>
        </ol>
        <div class="note">
          <p>Note that this procedure assumes the following about the list of
             <a>keyframes</a> specified on the effect:</p>
          <ul>
            <li>Each <a>keyframe</a> has a specified <a
                title="positional offset of a keyframe">positional offset</a> in
                the range [0, 1].
            <li>The list of <a>keyframes</a> is sorted in ascending order by
                <a title="positional offset of a keyframe">positional
                offset</a>.
            <li>Each specified property value is a valid and supported value.
            <li>For a given property, there is a most one specified property
                value on each keyframe.
          </ul>
          <p>
            It is the responsibility of the user of the model (for example,
            a declarative markup or programming interface) to ensure these
            conditions are met.
          </p>
        </div>
        <p class="note">
          Note that this procedure permits overlapping <a>keyframes</a>.
          The behavior is that at the point of overlap the output value jumps to
          the value of last defined <a>keyframe</a> at that offset.
          For overlapping frames at 0 or 1, the output value for <a
          title="time fraction">time fractions</a> less than 0 or greater than
          or equal to 1 is the value of the first <a>keyframe</a> or the last
          <a>keyframe</a> in <var>keyframes</var> respectively.
        </p>
        <div class="issue">
          <p>
            In the presence of certain timing functions, the input time
            fraction to an animation effect is not limited to the range [0, 1].
            Currently, however, keyframe offsets are limited to the range
            [0, 1] and property values are simply extrapolated for input time
            fractions outside this range. We are considering removing this
            restriction for the following reasons.
          </p>
          <p>
            We are considering removing the restriction since cases exist where
            it is useful to be able to specify non-linear changes in property
            values at time fractions outside the range [0, 1].
          </p>
          <p>
            While this effect could be achieved by careful modification of the
            timing function, this approach is complex and breaks the model's
            separation of timing concerns from animation effects. An example is
            an animation which is subject to an 'overshoot' timing function and
            which has an effect that sweeps through a non-linear color space.
          </p>
          <p>
            See <a
            href='http://lists.w3.org/Archives/Public/public-fx/2013AprJun/0184.html'>section
            4 (Keyframe offsets outside [0, 1]) of minuted discussion from Tokyo
              2013 F2F</a>.
          </p>
        </div>
      </section>
      <section>              
        <h3>Procedure for evenly distributing keyframes</h3>
        <p>
          Whilst the Web Animations model assumes a sorted list of
          <a>keyframes</a> with specified <a
          title="positional offset of a keyframe">positional offsets</a> in the
          range [0, 1] many users of the model require a facility for
          automatically distributing keyframes when positional offsets are not
          provided.
          A procedure for evenly distributing keyframes with unspecified
          positional offsets is provided below.
        </p>
        <p>
          Given a list of <a>keyframes</a> whose <a
          title="positional offset of a keyframe">positional offets</a> are
          either a real number in the range [0, 1] or unspecified,
          we define such as list as <dfn>loosely sorted by offset</dfn> if, for
          each <a>keyframe</a> in the list that has a specified offset, the
          offset is greater than or equal to the offset of the previous
          <a>keyframe</a> in the list with a specified offset, if any.
        </p>
        <p>
          Given a list of <a>keyframes</a>, <var>initial keyframe list</var>,
          that is <a>loosely sorted by offset</a> we can evenly distribute the
          <a>keyframes</a> with unspecified <a
          title="positional offset of a keyframe">positional offsets</a> between
          those frames with specified offsets using the following procedure:
        </p>
        <ol>
          <li>Let <var>distributed keyframes</var> be a copy of <var>initial
              keyframe list</var>.
          <li>If there is no <a>keyframe</a> in <var>distributed keyframes</var>
              with a <a title="positional offset of a keyframe">positional
              offset</a> of 0, then,
            <dl class="switch">
              <dt>If there is more than one <a>keyframe</a> in <var>distributed
                  keyframes</var> and the first <a>keyframe</a> does not have
                  a specified positional offset,</dt>
              <dd>
                Set the positional offset of the first <a>keyframe</a> in
                <var>distributed keyframes</var> to 0.
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                Temporarily add an empty <a>keyframe</a> to the
                start of <var>distributed keyframes</a> with a positional
                offset of 0.
              </dd>
            </dl>
          <li>Likewise, if there is no <a>keyframe</a> in <var>distributed
              keyframes</var> with a <a
              title="positional offset of a keyframe">positional offset</a> of
              1, then,
            <dl class="switch">
              <dt>If <var>distributed keyframes</var> is not empty and the last
                  <a>keyframe</a> does not have a specified positional
                  offset,</dt>
              <dd>
                Set the positional offset of the last <a>keyframe</a> in
                <var>distributed keyframes</var> to 1.
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                Temporarily append an empty <a>keyframe</a> to the end of
                <var>distributed keyframes</a> with a positional offset of 1.
              </dd>
            </dl>
          <li>Set the offset of all <a>keyframes</a> in <var>distributed
              keyframes</var> without a specified <a
              title="positional offset of a keyframe">positional offset</a> as
              so that for a <a>keyframe</a>, <var>k</var>, without a specified
              offset, if:
              <ul>
                <li><var>a</var> is the positional offset of the last
                    <a>keyframe</a> with a specified offset appearing in
                    <var>distributed keyframes</var> before <var>k</var>,
                <li><var>b</var> is the positional offset of the first
                    <a>keyframe</a> with a specified offset appearing in
                    <var>pre-processed keyframes</var> after <var>k</var>,
                <li><var>n</var> is the number of <a>keyframes</a> between
                    <var>a</var> and <var>b</var>, and
                <li><var>i</var> is the index of <var>k</var> among the
                    <a>keyframes</a> between <var>a</var> and <var>b</var>
                    such that the first <a>keyframe</a> has index 1 and the last
                    <a>keyframe</a> has index <var>n</var>;
              </ul>
              <p>
                then the offset of <var>k</var> is
                <code><var>a</var> + (<var>b</var> - <var>a</var>)
                * <var>i</var>
                / (<var>n</var> + 1)</code>
              </p>
          <li>If any temporary keyframes were added to <var>distributed
              keyframes</var> in steps 1 or 2, remove them from <var>distributed
              keyframes</var>.
          <li>Return <var>distributed keyframes</var>.
        </ol>
      </section>
    </section>

    <section>
      <h2>Path animation effects</h2>
      <p>
        A <dfn>path animation effect</dfn> is an <a>animation effect</a> that
        produces transform <a>unaccumulated animation values</a>
        such that a <a>target element</a> follows a specified geometric curve.
      </p>
      <p>
        The <dfn>path</dfn> of a <a>path animation effect</a> is provided by an
        SVG Path, as defined in SVG [[!SVG112]].
        A <a>path</a> consists of a list of <dfn>path elements</dfn>.
      </p>
      <p>
        The <dfn>automatic rotation flag</dfn> of a <a>path animation
        effect</a>, if set, specifies that the <a>unaccumulated animation
        value</a> generated by the <a>path animation effect</a> produces
        a rotation that matches the directional tangent vector of the
        <a>path</a>.
      </p>
      <p>
        The <dfn>rotation angle</dfn> parameter of a <a>path animation
        effect</a> specifies a constant rotation that applies to the target
        transform in addition to any rotation generated by setting the
        <a>automatic rotation flag</a>.
      </p>
      <p>
        Each <a>path animation effect</a> has an associated <a>composition
        operation</a> that specifies whether the <a>unaccumulated animation
        values</a> generated by the effect <a
        title="composition operation replace">replace</a> the underlying value
        or <a title="composition operation add">add</a> to it.
      </p>
      <section>
        <h3>The unaccumulated animation value of a path animation effect</h3>
        <p>
          The <a>unaccumulated animation value</a> of a <a>path animation
          effect</a> for a given <a>time fraction</a> and <a>underlying
          value</a> is given by the following process:
          <ol>
            <li>
              Determine the <a>current path element</a> and
              <a>element fraction</a> for the given <a>time fraction</a> using
              the procedure defined in 
              <a href='#determining-the-current-path-element-and-element-fraction' class='sectionRef'>
              </a>.
            <li>
              Calculate the <a title="rotation value along a path">rotation
              value</a> for the <var>current path element</var> and <var>element
              fraction</var> using the process defined in 
              <a
              href='#calculating-the-rotation-value-of-a-path-animation-effect' class='sectionRef'></a>.
            <li>
              Calculate the <a
              title="translation value along a path">translation
              value</a> for the <var>current path element</var> and <var>element
              fraction</var> using the process defined in 
              <a
              href='#calculating-the-translation-value-of-a-path-animation-effect' class='sectionRef'></a>.
            <li>
              Let the <var>transform value</var> be the result of combining
              the <a>rotation value</a> and <a> translation value</a>
              by constructing a transform list consisting of the
              translation value followed by the rotation value.
            <li>
              The <a>unaccumulated animation value</a> of the <a>path animation
              effect</a> depends on the value of its <a>composition
              operation</a> as follows,
              <dl class="switch">
                <dt>If the <a>composition operation</a> of this <a>path
                    animation effect</a> is <a title='composition operation
                    replace'>replace</a>,</dt>
                <dd>
                  the <a>unaccumulated animation value</a> of the effect is
                  <var>transform value</var>.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  the <a>unaccumulated animation value</a> of the effect is the
                  result of adding <var>transform value</var> to the
                  <a>underlying value</a> according to the process defined in <a
                  href='#the--transform-function--type' class='sectionRef'></a>.
                </dd>
              </dl>
          </ol>
        </p>
      </section>
      <section>
        <h3>Determining the current path element and element fraction</h3>
        <div class='informative'>
          <p>
            Each element in the path (excluding moveto elements) is allocated
            an equally sized non-overlapping segment, with segments 
            collectively partitioning the range [0, 1].
          </p>
          <p>
            The <a>current path element</a> is the <a title="path elements">path
            element</a> corresponding to a given <a>time fraction</a>.
          </p>
          <p>
            The <a>element fraction</a> represents the offset into the
            <a>current path element</a> at the given <a>time fraction</a>.
          </p>
        </div>
        <p>
          The <dfn>current path element</dfn> and <dfn>element fraction</dfn>
          for a given <a>time fraction</a>, <var>progress</var>, are
          determined by following the steps corresponding to the first matching
          condition from below:
        </p>
        <dl class='switch'>
          <dt>
            If <var>progress</var> is greater than or equal to 1,
          </dt>
          <dd>
            the <var>current path element</var> is the last element in the
            <a>path</a>,
            and the <var>element fraction</var> is 1.
          </dd>
          <dt>
            If <var>progress</var> is less than 0,
          </dt>
          <dd>
            the <var>current path element</var> is the first element in the
            <a>path</a>,
            and the <var>element fraction</var> is 0.
          </dd>
          <dt>
            Otherwise,
          </dt>
          <dd>
            <ol>
              <li>
                Let <var>effective element list</var> be a clone of the
                list of <a>path elements</a> with all moveto elements removed.
              </li>
              <li>
                Let <var>time index</var> be <var>progress</var>
                multiplied by the number of elements in <var>effective
                element list</var>.
              </li>
              <li>
                Let <var>current element</var> be the element in the
                <var>effective element list</var> at the index given by
                <code>floor(<var>progress</var>)</code>.
              </li>
              <li>
                Let <var>element fraction</var> be the value given by
                <code><var>progress</var> - floor(<var>progress</var>)
                </code>.
              </li>
            </ol>
          </dd>
        </dl>
      </section>
      <section>
        <h3>Calculating the rotation value of a path animation effect</h3>
        <p>
          For a given <a>path element</a> and <a>element fraction</a>,
          the <dfn title="rotation value along a path">rotation value</dfn> at
          that point is calculated according to the steps corresponding to the
          first matching condition from below:
        </p>
        <dl class='switch'>
          <dt>If the <a>automatic rotation flag</a> is not set,</dt>
          <dd>
            the <a title="rotation value along a path">rotation value</a> of the
            given <a>path element</a> is the <a>rotation angle</a>.
          </dd>
          <dt>Otherwise,</dt>
          <dd>
            the <a title="rotation value along a path">rotation value</a> of the
            <a>current element</a> is the sum of:
            <ul>
              <li>
                the angle of the tangent vector of the given <a>path element</a>
                at the point selected in
                <a
                href='#calculating-the-translation-value-of-a-path-animation-effect'
                class='sectionRef'></a>
                for the purpose of calculating the <a
                title="translation value along a path">translation value</a>; 
                and
              </li>
              <li>
                the <a>rotation angle</a>.
              </li>
            </ul>
          </dd>
        </dl>
        <p>
          For continuous <a>path elements</a> (all elements except moveto),
          the angle of the tangent vector for the purpose of these calculations
          is defined to be an integer multiple of 2&pi; different from the value
          given by <a
          href="http://en.wikipedia.org/wiki/Tangential_angle">standard
          mathematical formulae for tangents to curves in 2
          dimensional space</a>.
        </p>
        <p class="todo">
          What does &ldquo;different from&rdquo; mean here?
        </p>
        <p>
          For moveto <a>path elements</a>, which are discontinuous,
          the angle of the tangent vector for the purpose of these calculations
          is always an integer multiple of 2&pi;.
        </p>
        <p class="todo">
          Any multiple?
        </p>
        <p>
          At non-smooth junction points, the angle of the tangent vector for
          the purpose of these calculations is determined by the tangent to
          the curve after the junction.
        </p>
        <p>
          The initial value of the angle of the tangent vector is computed 
          using the first element of the curve, and is always in the range
          [0, 2&pi;).
        </p>
        <p>
          Single continuous path elements must never produce tangent
          vector angles that are discontinuous over their defined region. This
          implies that a single unique solution is available for all points on
          continuous path elements.
        </p>
        <p>
          When computing angles after discontinuous or non-smooth jumps,
          multiple possible solutions may be available.
          These solutions will differ by integer multiples of 2&pi;.
          In such cases the solution that lies closest to the previous tangent
          angle is used.
        </p>
        <p>
          Please see
          <a href='#algorithms-for-path-animation-effects' class='sectionRef'></a>
          for a non-normative treatment of this topic.
        </p>
      </section>
      <section>
        <h3>Calculating the translation value of a path animation effect</h3>
        <p>
          For a given <a>path element</a> and <a>element fraction</a>,
          the <dfn title="translation value along a path">translation
          value</dfn> is determined using the following procedure:
        </p>
        <ol>
          <li>
            <p>
              Let <var>length</var> be the length of the given
              <a>path element</a>.
            </p>
            <p class="todo">
              Need a reference to how this is calculated even if it's just
              a pointer to SVG (which says pretty much nothing).
            </p>
          </li>
          <li>
            Let <var>element distance</var> be the result of evaluating
            <code><var>element fraction</var> &#215; <var>length</var></code>.
          </li>
          <li>
            <p>
              Let <var>point</var> be the unique point along the
              <a>current element</a> which is <var>element distance</var>
              along the path from the start of the path.
            </p>
            <p class="todo">
              What is the significance of &ldquo;unique point&rdquo; here?
            </p>
          </li>
          <li>
            The <a>translation value</a> is the translation transform
            that transforms the point at the start of the path to 
            <var>point</var>.
          </li>
        </ol>
        <p>
          The length of a path element is determined, where possible, via 
          closed-form solutions. For some path elements (e.g. beziers) a
          closed-form solution is not generally possible, and approximations
          should be used.
        </p>
        <p>
          The length of a moveto element is always 0.
        </p>
        <p>
          Please see
          <a href='#algorithms-for-path-animation-effects' class='sectionRef'></a>
          for a full non-normative treatment of this topic.
        </p>
      </section>
      <div class="todo">
        <p>
          Need to describe how <a
          href="http://www.w3.org/TR/css3-transforms/#transform-origin">transform-origin</a>
          is applied.
        </p>
      </div>
    </section>

    <section>
      <h2>Animatable properties</h2>
      <section>
        <h3>CSS Properties</h3>
        <p>
          Unless specified otherwise, all CSS properties should be considered
          animatable. Examples of properties which are explicitly marked as not
          animatable are those defined in [[CSS3-TRANSITIONS]] and
          [[CSS3-ANIMATIONS]].
        </p>
        <div class='note'>
          <p>
            [[CSS3-TRANSITIONS]] requires future CSS specifications to provide
            an &lsquo;animatable:&rsquo; line for each newly defined property.
            This line defines whether properties can animate and how that
            animation occurs. Note that &lsquo;animatable: none&rsquo; in this
            regard merely means that a property is not continuously animatable
            - that is, not interpolable.
          </p>
        </div>
        <div class='informative'>
          <p>
            Animation and Transition properties are not animatable. As defined
            in <a href='#target-properties' class='sectionRef'></a> specifying
            these properties as part of an animation effect will not result in
            any changes to the target element. This restriction prevents
            self-modifying animations.
          </p>
        </div>
        <div class='note'>
          <p>
            Properties defined as animatable by CSS Transitions in
            [[CSS3-TRANSITIONS]] specify animation types. These types in turn
            specify interpolation procedures for each property. The procedures
            described in [[CSS3-TRANSITIONS]] are replaced by the interpolation
            definitions in <a href='#animation-of-property-types'
            class='sectionRef'></a>. Note that this change is
            backwards-compatible - the interpolation definitions in this
            specification produce the same result as [[CSS3-TRANSITIONS]]
            unless [[CSS3-TRANSITIONS]] specifies that no interpolation can
            occur.
          </p>
        </div>
        <div class='informative'>
          <p>
            The mechanism of action of [[CSS3-TRANSITIONS]] and this
            specification sometimes differ. However, the results of both
            mechanisms are consistent with each other.
          </p>
          <p>
            For example, [[CSS3-TRANSITIONS]] length values are always
            converted to computed style pixel lengths and interpolated as
            numbers, whereas this specification performs interpolation between
            different length units using calc expressions.
          </p>
        </div>
        <p>
          <a href='#animation-of-property-types' class='sectionRef'></a>
          defines how pairs of CSS values are interpolated, as well as how
          two values add together.
        </p>
      </section>
      <section>
        <h3>CSS Properties defined by SVG</h3>
        <p>
          All CSS properties defined in [[SVG112]] are animatable except where
          explicitly marked otherwise. Where SVG types take CSS values, this
          specification defines how those values interpolate and add together.
          For all other values, interpolation and addition is defined by
          [[SVG112]].
        </p>
      </section>
      <section>
        <h3>SVG Attributes</h3>
        <p>
          There are a number of SVG attributes which do not map to CSS
          properties which are nevertheless animatable. The procedures for
          animating these attributes are defined in <b>TBD</b>.
        </p>
      </section>
    </section>

    <section>
      <h2>Animation of property types</h2>
      <section>
        <p>
          When animating property types, procedures for interpolation and
          addition are required.
        </p>
        <p>
          [[CSS3-VALUES]] defines common values and units that CSS 
          properties accept.
        </p>
        <p>
          To determine the appropriate animation interpolation and addition
          algorithms to use for any given start and end value, first determine
          the types of the values. If the types match, then the algorithms used
          are given by <a href="#animation-of-like-types"
          class="sectionRef"></a>. 
        </p>
        <p>
          Some properties accept values of multiple different primitive types.
          For example, the padding-* properties accept a type of
          <code>&lt;padding-width&gt;</code>, which can either be a
          <code>&lt;length&gt;</code> or a <code>&lt;percentage&gt;</code>. <a
          href="#animation-of-non-matching-primitive-types"
          class="sectionRef"></a> defines the algorithm to be used to deal with
          interpolation when the type of the start and the type of the end do
          not match.
        </p>
        <p>
          Some properties accept a combination of typed values and keywords.
          For example, border-width accepts both <code>&lt;length&gt;</code>
          values and &lsquo;thick&rsquo;, &lsquo;medium&rsquo; and
          &lsquo;thin&rsquo; keywords. <a
          href="#animation-of-keywords-and-primitive-types"
          class="sectionRef"></a> describes how to deal with interpolation to
          and/or from a keyword value.
        </p>
        <p>
          <a href="#animation-of-shorthand-properties" class="sectionRef"></a>
          describes how to deal with interpolation between CSS shorthand values.
        </p>
        <p>
          Calc expressions can be used in place of <code>&lt;length&gt;</code>,
          <code>&lt;frequency&gt;</code>, <code>&lt;angle&gt;</code>,
          <code>&lt;time&gt;</code>, <code>&lt;number&gt;</code> and
          <code>&lt;integer&gt;</code> values. <a
          href="#animation-of-css-calc-expressions" class="sectionRef"></a>
          describes how to deal with interpolation to and/or from calc
          expressions.
        </p>
        <p>
          <a href="#animation-of-transform-lists" class="sectionRef"></a>
          describes how to deal with interpolation of CSS and SVG transform
          lists.
        </p>
        <p>
          If no specific algorithms are provided here, then the default 
          algorithms defined in 
          <a href="#default-animation-algorithms" class="sectionRef"></a> 
          are used.  Note that the neutral value does not match any value 
          type and thus all calculations involving the neutral value will 
          use the default algorithms.
        </p>
      </section>
      <section>
        <h3>Default Animation Algorithms</h3>
        <p>
        Given the output <i>p</i> of a timing function, the result
        <i>V</i><sub>res</sub> of interpolating between two values,
        <i>V</i><sub>start</sub> and <i>V</i><sub>end</sub> is given by
         <blockquote>
          <dl class="switch">
            <dt>If 0 &lt;= <i>p</i> &lt; 0.5</dt>
            <dd><i>V</i><sub>res</sub> = <i>V</i><sub>start</sub></dd>
            <dt>Otherwise,</dt>
            <dd><i>V</i><sub>res</sub> = <i>V</i><sub>end</sub></dd>
          </dl>
         </blockquote>
         Note that interpolation is never performed on invalid values.
        </p>
        <p>
          Addition is between two values <i>V</i><sub>a</sub> and 
          <i>V</i><sub>b</sub>. The result <i>V</i><sub>res</sub> is given by 
         <blockquote>
            <i>V</i><sub>res</sub> = <i>V</i><sub>a</sub> + <i>V</i><sub>a</sub> 
         </blockquote>
      </section>
      <section>
        <h3>Animation of like types</h3>
        <p>
          If the result of the interpolation is specified by a calc expression
          and the units of <i>V</i><sub>start</sub> and <i>V</i><sub>end</sub>
          are related by a constant scalar multiple then the result is
          evaluated as defined in [[CSS3-VALUES]] before being returned.
          <div class="annotation">
            The CSS &lsquo;px&rsquo; unit is related to the CSS &lsquo;in&rsquo;
            unit by a constant scalar multiple of 96 (i.e. 96px = 1in). On the
            other hand, the CSS &lsquo;em&rsquo; unit is not related to the
            &lsquo;in&rsquo; unit by a constant scalar multiple.
          </div>
          <div class="note">
            [[CSS3-TRANSITIONS]] defines the following default formula for interpolation:
            <blockquote>
              <i>V</i><sub>res</sub> = (1 - <i>p</i>) * <i>V</i><sub>start</sub>
                + <i>p</i>  * <i>V</i><sub>end</sub>
            </blockquote>
          </div>
        </p>
        <p>
          If the result of the addition is specified by a calc expression and
          the units of <i>V</i><sub>a</sub>  and <i>V</i><sub>b</sub>  are
          related by a constant scalar multiple then the result is evaluated as
          defined in [[CSS3-VALUES]] before being returned.
          <div class="note">
            The default formula for single valued types is to use the CSS3
            calc() function: 
            <blockquote>
              <i>V</i><sub>res</sub> = calc(<i>V</i><sub>a</sub> + 
              <i>V</i><sub>b</sub>)
            </blockquote>
          </div>
        </p>
        <section>
          <h4>
            The &lt;integer&gt;, &lt;number&gt; and &lt;percentage&gt; 
            types
          </h4>
          <p>
            Interpolation is performed as defined in [[CSS3-TRANSITIONS]].
          </p>
          <p>
            Addition is performed as <i>V</i><sub>res</sub> = 
            <i>V</i><sub>a</sub> + <i>V</i><sub>b</sub>.
          </p>
        </section>
        <section>
          <h4>
            The &lt;length&gt;, &lt;angle&gt;, &lt;time&gt; and 
            &lt;frequency&gt; types
          </h4>
          <p>
            Interpolation is performed as <i>V</i><sub>res</sub> = (1 - 
            <i>p</i>) * <i>V</i><sub>start</sub> + <i>p</i>  * <i>V</i>
            <sub>end</sub>.
          </p>
          <p>
            Addition is performed as <i>V</i><sub>res</sub> = calc(<i>V</i>
            <sub>a</sub> + <i>V</i><sub>b</sub>).
          </p>
        </section>
        <section>
          <h4>The &lt;resolution&gt; type</h4>
          <div class="issue">Do we want to interpolate this?</div>
          <p>
            Interpolation is performed as <i>V</i><sub>res</sub> = 
            (1 - <i>p</i>) * <i>V</i><sub>start</sub> + <i>p</i>  * 
            <i>V</i><sub>end</sub>.
          </p>
          <p>
            Addition is performed as <i>V</i><sub>res</sub> = 
            calc(<i>V</i><sub>a</sub> + <i>V</i><sub>b</sub>).
          </p>        
        </section>
        <section>
          <h4>The &lt;color&gt; type</h4>
          <p>
            Interpolation is performed as defined in [[CSS3-TRANSITIONS]].
          </p>
          <p>
            Addition is performed on each RGBA color component in premultiplied
            space, clamping so it is within the range specified in 
            [[CSS3COLOR]].
          </p>
          <div class="issue">
            What we do for addition depends on why we're adding. As defined
            here, the result will tend to saturate to opaque white.
          </div>
        </section>
        <section>
          <h4>The &lt;image&gt; type</h4>
          <p>
            Interpolation is performed using the cross-fade() function as
            defined in [[CSS4IMAGES]]:
            <blockquote>
              <i>V</i><sub>res</sub> = cross-fade(<i>p</i>,
              <i>V</i><sub>start</sub> , <i>V</i><sub>end</sub>).
            </blockquote>
          </p>
          <p>
            Addition is defined as the composition of <i>V</i><sub>a</sub> over
            <i>V</i><sub>b</sub>,, with <i>V</i><sub>a</sub> and
            <i>V</i><sub>b</sub> aligned at their top left corners. The height
            and width of the result is the maximum of the heights and widths of
            <i>V</i><sub>a</sub> and <i>V</i><sub>b</sub>. Any result pixels
            outside the bounds of <i>V</i><sub>a</sub> or <i>V</i><sub>b</sub>
            are defined to be rgba(0, 0, 0, 0).
          </p>
          <div class="issue">
            This does not match the saturating behaviour defined for addition 
            of colors.
          </div>
        </section>
        <section>
          <h4>The &lt;position&gt; type</h4>
          <p>
            Before interpolation or addition, any shorthand is expanded as
            described in [[CSS21]] to include both horizontal and vertical
            positions. Keywords are converted to their equivalent percentage
            values as described in [[CSS21]].
          </p>
          <p>
            Interpolation or addition is performed on each provided value in
            accordance with its type.
          </p>
        </section>
        <section>
          <h4>The &lt;transform-function&gt; type</h4>
          <p>
            Interpolation is performed as defined in [[CSS3-TRANSFORMS]].
          </p>
          <p>
            Addition is performed as an accumulation as defined in 
            [[CSS3-TRANSFORMS]].
          </p>
        </section>
      </section>
      <section>
        <h3>Animation of non-matching primitive types</h3>
        <p>
          In general, non-matching primitive types cannot be interpolated or
          added. Non-matching primitive types may only be interpolated or added
          if the property value they are defined on allows both those types,
          for example &lt;length&gt; and &lt;percent&gt;. In these cases, the CSS
          calc() function as defined in [[CSS3-VALUES]] is used.
        </p>
        <p>
          For interpolation:
          <blockquote>
            <i>V</i><sub>res</sub> = calc((1 - <i>p</i>) * 
            <i>V</i><sub>start</sub> + <i>p</i>  * <i>V</i><sub>end</sub>).
          </blockquote>  
        </p>
        <p>
          For addition:
          <blockquote>
            <i>V</i><sub>res</sub> = calc(<i>V</i><sub>a</sub> + <i>V</i><sub>b</sub>).
          </blockquote>
        </p>
      </section>
      <section>
        <h3>Animation of keywords and primitive types</h3>
        <p>
          A keyword value may be defined as equivalent to a primitive type,
          either directly, or via some intermediate calculation. For example,
          for the background-position property, [[CSS21]] defines the
          &lsquo;top&rsquo; keyword to be equivalent to &lsquo;0%&rsquo;. In
          these cases, the equivalent primitive type shall be used, and
          interpolation and addition performed as defined in <a
          href="#animation-of-like-types" class="sectionRef"></a> or <a
          href="#animation-of-non-matching-primitive-types"
          class="sectionRef"></a>.
        </p>
        <p>
          In the case that a keyword maps onto a finite ordered list of values
          with a determinable spacing between them, then a step-wise
          interpolation is used. For example, the font-weight property 
          accepts an ordered list of values from 100 to 900 in
          steps of 100. The interpolation in this case is defined as ((1 -
          <i>p</i>) * <i>V</i><sub>start</sub> + <i>p</i> *
          <i>V</i><sub>end</sub>), rounded to the nearest member of the list.
          Addition in this case is defined as (<i>V</i><sub>a</sub> +
          <i>V</i><sub>b</sub>), clamped to remain within the specifed list of
          values. 
        </p>
        <p>
          In all other cases, the keyword value is not interpolable. Result of
          add is the right hand side.
        </p>
      </section>
      <section>
        <h3>Animation of shorthand properties</h3>
        <p>
          Shorthand properties are animated as defined in [[CSS3-TRANSITIONS]].
        </p>
      </section>
      <section>
        <h3>Animation of CSS calc expressions</h3>
        <p>
          For interpolation:
          <blockquote>
            <i>V</i><sub>res</sub> = calc((1 - <i>p</i>) *
            <i>V</i><sub>start</sub> + <i>p</i>  * <i>V</i><sub>end</sub>).
          </blockquote>  
        </p>
        <p>
          For addition:
          <blockquote>
            <i>V</i><sub>res</sub> = calc(<i>V</i><sub>a</sub> +
            <i>V</i><sub>b</sub>).
          </blockquote>
        </p>
      </section>
      <section>
        <h3>Animation of transform lists</h3>
        <p>
          Interpolation of transform lists is performed as defined in
          [[CSS3-TRANSFORMS]]
        </p>
        <p>
          Addition of transform lists is performed by appending
          <i>V</i><sub>b</sub> to <i>V</i><sub>a</sub>.
        </p>
      </section>
    </section>

    <section>
      <h3>Custom effects</h3>
      <div class="informative">
        <p>
          In some situations the <a>animation
          effects</a> provided by Web Animations may be insufficient.
          For example, the <a>animation effects</a>
          defined here are only able to target certain CSS properties and DOM
          attributes.
          They are unable, therefore, to modify the <a
          href="http://www.w3.org/TR/SVG11/struct.html#__svg__SVGSVGElement__currentScale"><code>currentScale</code></a>
          property of an SVG element to smoothly zoom the viewport without
          affecting the document content.
        </p>
        <p>
          In such cases where the provided <a>animation
          effects</a> do not provide needed functionality, an effect defined by
          script may be used.
          Such <a>custom effects</a> receive a <a>time
          fraction</a> from the timing model and are responsible for producing
          the desired effect corresponding to the specified time.
        </p>
        <p>
          Using an effect defined in script it is possible to animate not only
          otherwise un-animatable attributes and properties, but potentially
          anything that is accessible via script, including even producing audio
          or creating vibrations.
        </p>
        <p>
          For example, using a <a>custom effect</a> that draws to a <a
          href="http://www.w3.org/TR/html5/embedded-content-0.html#the-canvas-element"><code>canvas</code></a>
          element it is possible to produce a complex animated effect
          featuring patterns that may be difficult to create using CSS or
          SVG.
          Compared to using the <a
          href="http://www.w3.org/TR/animation-timing/">WindowAnimationTiming</a>
          interface, this approach ensures the animation is frame-rate
          independent and can be paused, reversed, eased with timing effects,
          accelerated, synchronized with other animations, and be controlled
          in the same manner as any other Web Animations animation without any
          additional programming.
        </p>
      </div> <!-- informative -->
      <p>
        A <dfn>custom effect</dfn> is an author-defined programming callback
        that is passed timing information whenever a <a>sample</a> is performed.
      </p>
      <section>
        <h4>Execution order of custom effects</h4>
        <p>
          Since <a>custom effects</a>, unlike <a
          title="animation effect">animation effects</a>, are not limited to
          a single <a>target property</a> and the steps for assessing their
          order of execution differs from <a>animation
          effects</a>.
        </p>
        <p>
          <a>Custom effects</a> are executed after all
          <a>animation effects</a> have completed and
          applied their result to their targets (see <a
          href="#combining-with-other-styles--the-override-stylesheet"
          class="sectionRef"></a>).
        </p>
        <p class="issue">
          Need to define this more precisely.
          Are styles flushed?
          Presumably they are.
          Can we suspend reflow for the duration of executing the script-based
          animation effects and just do it once afterwards?
        </p>
        <p>
          Within the set of <a>custom effects</a>, the
          order of execution is initially the same as that defined for <a
          title="animation effect">animation effects</a> in <a
          href="#the-animation-stack" class="sectionRef"></a>.
          However, <a>custom effects</a> may also override
          this ordering through a <dfn
          title="custom effect priority">priority</dfn> property associated with
          the effect.
          This <a title="custom effect priority">priority</a> property, if
          defined, specifies the order in which the callbacks are executed
          such that the callback of the <a>custom effect</a> with the least
          priority is executed first.
        </p>
        <p>
          In deciding which of two <a>custom effects</a>,
          <var>A</var> and <var>B</var>, should be executed first, the following
          rules are applied.
        </p>
        <ol>
          <li>Sort <var>A</var> and <var>B</var> based on their
              <a title="custom effect priority">priority</a> properties such
              that lower priorities are sorted first.
              If either does not have a defined <a
              title="custom effect priority">priority</a>, then treat the <a
              title="custom effect priority">priority</a> as being zero for the
              purposes of sorting.</li>
          <li>If <var>A</var> and <var>B</var> have the same <a
              title="custom effect priority">priority</a>,
              sort <var>A</var> and <var>B</var> using the procedure defined for
              sorting <a>animation effects</a> in <a
              href="#the-animation-stack" class="sectionRef"></a>.</li>
        </ol>
        <p>
          Items sorted earlier are executed before those sorted later.
        </p>
      </section>
    </section>
    </section> <!-- End of animation model -->

    <section>
      <h2>Timing events</h2>
      <div class="issue">
        Possibly move this section into <a href="#timing-model"
        class="sectionRef"></a>.
      </div>
      <div class='issue'>
      <p>
        The current event model has two undesirable consequences:
        <ul>
          <li>
            Applications that need good-quality information on events will
            need to implement both seeked mode handling and normal mode
            handling. Having both is likely to result in applications only
            relying on the information available in the lower-quality
            seeked mode, as switching between the two is system-dependent,
            opaque to users of the model, and uncontrollable. This makes the
            higher-quality mode seem to be a complication rather than an
            improvement.
          </li>
          <li>
            Uneased timing can cause events to be reordered with respect
            to how they are visually percieved; and can also cause events
            to be delivered with timestamps in the future. This is likely to
            be quite confusing to users of the model.
          </li>
        </ul>
      </p>
      <p>
        We've explored a few different models to try and mitigate these
        problems. Some ideas we've looked at that seem promising:
        <ul>
          <li>
            Primitive onstart / onend events that fire only when an 
            animation first starts playing and last stops playing.
          </li>
          <li>
            An onchange event that fires when the play state (e.g. current
            iteration, fill state, etc.) of an Animation changes, and provides
            a summary only of ther changes since the last sample. This is 
            guaranteed to generate no more than one event per animation per
            sample.
          </li>
          <li>
            A lazily-constructed list of change elements that provides a more
            detailed understanding of the changes since the last sample. This
            would be somewhat costly to generate for large sample intervals,
            but would not be constructed by default.
          </li>
        </ul>
        <p>
          See <a href='http://lists.w3.org/Archives/Public/public-fx/2013AprJun/0184.html'>
          Sections 8 and 14 of minuted discussion</a>.
        </p>
      </p>
      </div>
      <p>
        As <a>timed items</a> play they report changes to
        their status through <dfn title="timing event">timing events</dfn>.
      </p>
      <p>
        <a>Timing events</a> are a property of the Web
        Animations timing model.
        As a result they are dispatched even for <a
        title="animation">animations</a> that do not have an associated
        <a>animation effect</a>, for <a>animations</a> whose
        <a>target element</a> is not rendered because it or a parent element has
        <span class="property">display</span> property of <span
        class="prop-value">none</span>, and for <a>timed
        items</a> that perform no animation such as <a>timing groups</a>.
      </p>
      <div class="annotation">
        <p><strong>Relationship to CSS and SVG events</strong></p>
        <p>
          CSS defines <code>AnimationEvent</code>s and
          <code>TransitionEvent</code>s and SVG defines <code>TimeEvent</code>s.
          The proposal here is to dispatch <a>TimingEvent</a>s in parallel to
          these events.
        </p>
        <p>
          A key difference is that the target of a <a>TimingEvent</a> is a
          <a>TimedItem</a> and not content.
          This model leaves firing of events at content up to the declarative
          mapping onto the model (e.g. CSS or SVG).
          This approach makes the Web Animations model more self-contained
          whilst permitting different mappings for different markup.
          For example, CSS fires events at the target element whilst SVG fires
          events at the element that generated the animation.
        </p>
      </div>
      <section>
        <h3>Types of timing events</h3>
          <dl>
          <dt><dfn>timingstart</dfn></dt>
          <dd>
            <p>
              Occurs at the moment when a <a>timed item</a> enters its <a>active
              interval</a> (from either direction).
            </p>
            <p>
              Note that if the <a>parent timing group</a> starts a new
              iteration, this is treated as if this element momentarily exited
              its <a>active interval</a> (producing a new <a>timingend</a>
              event), and entered it again (producing a new <a>timingstart</a>
              event).
            </p>
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
              <li>Context Info: localTime, documentTime, iterationIndex,
                                seeked</li>
            </ul>
          </dd>
          <dt><dfn>timingiteration</dfn></dt>
          <dd>
            <p>
              Occurs at the moment when a <a href="#repeating">repeating</a>
              <a>timed item</a>'s <a>current iteration</a> changes value
              excluding changes to and from <code>null</code>.
            </p>
            <p>
              Note that if the <a>parent timing group</a> starts a new
              iteration, this is treated as if this element momentarily exited
              its <a>active interval</a> (causing the <a>current iteration</a>
              to become <code>null</code>), and entered it again (producing
              a new value for <a>current iteration</a>) and hence producing no
              <a>timingiteration</a> event since the only changes to <a>current
              iteration</a> are to and from <code>null</code>.
            </p>
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
              <li>Context Info: localTime, documentTime, iterationIndex,
                                seeked</li>
            </ul>
          </dd>
          <dt><dfn>timingend</dfn></dt>
          <dd>
            <p>
              Occurs at the moment when a <a>timed item</a> leaves its <a>active
              interval</a> (from either direction).
            </p>
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
              <li>Context Info: localTime, documentTime, iterationIndex,
                                seeked</li>
            </ul>
          </dd>
          <dt><dfn>timingcancel</dfn></dt>
          <dd>
            <p>
              Occurs when a <a>timed item</a> loses its association with
              a <a>player</a>.
            </p>
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
              <li>Context Info: None</li>
            </ul>
          </dd>
        </dl>
        <p class="issue">
          Can we rename these to just <em>start</em>, <em>iteration</em>,
          <em>end</em>, and <em>cancel</em>?
          They are only fired at <a>timed items</a>, never
          DOM nodes, so they won't clash with other events.
          Is that enough or do the names need to be globally unique?
        </p>
        <div class="annotation">
          <p>
            Other potential event types for a later version:
          </p>
          <ul>
            <li><em>timingpause</em> &mdash;
              fired whenever <code>paused</code> is newly true on the associated
              <a>player</a>.
              <p>
                Use case: show a graphic overlay to mark a cartoon as
                paused.<br> Likewise <em>unpause</em>.
              </p>
            </li>
            <li><em>timingseek</em> &mdash;
              fired whenever <code>currentTime</code> is set on the
              <a>player</a> associated with a <a>timed item</a>.
              <p>
                Use case: If you are implementing something like SVG's syncbase
                timing with script you often need to do some bookkeeping on
                a seek.
              </p>
            </li>
            <li><em>timingdirectionchange</em> &mdash;
              fired whenever the effective direction of the item changes (due to
              the direction attribute, changes to playbackRate, calling reverse
              etc. on either the item or an ancestor)
              <p>
                Use case: update UI to represent rewinding;
                stop audio when playing backwards.
              </p>
            </li>
            <li><em>timingnewanimation</em> &mdash;
              fired whenever a new <a>Animation</a> object is created.
              <p>
                Use case: a timeline debugger. You want to show all animations
                that are playing or yet-to-play.
                Using this event (and
                <code>document.timeline.getCurrentAnimations</code>) you could
                build up a timegraph.
              </p>
              <p>
                I think this sort of event and this sort of use case would fit
                the MutationObserver pattern well.
                We could introduce a whole class of mutation records targetted
                at debugging (e.g. <em>timereschedule</em>)
              </p>
          </ul>
          <p>
            Also, although this is a bit different to a regular event (since
            it's qualified by a parameter), it seems like it might be nice to be
            able to do something like:
          </p>
          <pre class='example sh_javascript'>
            anim.onprogress(0.8,
             function() {
              // Issue a request to prefetch the next episode
             });
          </pre>
          <p>
            It would be called whenever you got a sample where
            <code>(<a>active time</a> / <a>active duration</a>)</code> &ge;
            <var>progress</var> was newly true.
          </p>
        </div>
      </section>
      <section>
        <h3>Uneased timing</h3>
        <div class="informative">
          <p>
            <a>Timing events</a> in Web Animations rely on
            a mode of operating the timing model that does not apply <a
            title="timing function">timing functions</a> called <em>uneased
            timing</em>.
            There are two reasons for this:
          </p>
          <ul>
            <li>
              <p>
                <a>Timing functions</a> are not always invertible.
              </p>
              <p>
                In order to dispatch events in the correct order it is often
                necessary to convert from a <a>timed item</a>'s <a>local
                time</a> to a common time space for sorting and non-invertible
                <a>timing functions</a> make this
                impractical.
              </p>
            </li>
            <li>
              <p>
                <a>Timing functions</a> on parent <a
                title="timing group">timing groups</a> can cause unnecessary
                events to be generated.
              </p>
              <p>
                For example, consider a <a>timing group</a> that has a <a>timing
                function</a> that is not monotonically increasing such as
                a bounce effect.
                Within a single iteration of the <a>timing group</a> child <a
                title="timed item">timed items</a> may repeatedly exit and enter
                their <a>active interval</a>.
                Dispatching a <a>timing event</a> on each such moment is
                unlikely to be useful to most applications.
              </p>
            </li>
          </ul>
          <p>
            An analogue is a graphics editing program where the user can apply
            a blur filter to a geometric shape.
            The graphics program may draw a selection box around the bounding
            box of the geometric shape ignoring the fact that the blur stretches
            (infinitely) beyond the selection box.
          </p>
          <p>
            Furthermore, since <a>fill modes</a> affect the
            calculation of times in ways that obscure the boundaries of the
            <a>active interval</a> they are also ignored when operating in
            <em>uneased time</em>.
          </p>
        </div>
        <p>
          The <dfn>uneased timing</dfn> of a <a>timed item</a> refers to
          performing any of the calculations defined for the <a>timed item</a>
          with the following exceptions:
        </p>
        <ul>
          <li><a>Timing functions</a> on the <a>timed
              item</a> and all <a>ancestor</a> <a>timing groups</a> are
              ignored.</li>
          <li>The <a>fill modes</a> of the <a>timed item</a>
              and all <a>ancestor</a> <a>timing groups</a> are
              treated as <span class="prop-value">none</a>.</li>
        </ul>
        <p>
          For example, the <em>uneased inherited time</em> of a <a>timed
          item</a> is calculated using the regular definition of <a>inherited
          time</a> after applying the two modifications to the timing of the
          item and its <a>ancestors</a> noted above.
        </p>
        <p>
          Normally the time value used as input to a child <a>timed item</a>
          of a <a>timing group</a> is the group's <a>transformed time</a>.
          However, since <a>uneased timing</a> does not apply <a
          title="timing function">timing functions</a>, we refer to <dfn>uneased
          child time</dfn> which is equivalent to both <em>uneased transformed
          time</em> and <em>uneased directed time</em>.
        </p>
      </section>
      <section>
        <h3>Inverse timing calculations</h3>
        <p>
          For times calculated using <a>uneased timing</a> it is possible to
          perform the reverse operation to, for example, convert times from
          a <a>child timed item</a> to that of its its <a>parent timing
          group</a> or <a>timeline</a>.
        </p>
        <p>
          Calculating the <dfn><em>uneased local time</em> from <a>uneased child
          time</a></dfn> of a given <a>timed item</a> requires recording the
          iteration index that corresponds to the <a>uneased child time</a> and
          is calculated as follows.
        </p>
        <ol>
          <li>Let <var>item</var> be the <a>timed item</a> for which the
              <em>uneased local time</em> is to be calculated.</li>
          <li>Let <var>child time</var> be the <a>uneased child time</a> to be
              converted.</li>
          <li>Let <var>iteration index</var> be the value of <a>current
              iteration</a> corresponding to <var>child time</var>.</li>
          <li>Calculate the <var>current direction</var> of <var>item</var>
              using the procedure defined in <a
              href="#calculating-the-directed-time"
              class="sectionRef"></a> substituting <var>iteration index</var>
              for the <em>current iteration</em>.</li>
          <li>
            <p>
              Let the <var>uneased iteration time</var> be the result
              corresponding to the first matching condition from below.
            </p>
            <dl class="switch">
              <dt>If the <var>current direction</a> is <em>forwards</em>,</dt>
              <dd>
                <var>child time</var>
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                <code><a>iteration duration</a> - <var>child time</var></code>
              </dd>
            </dl>
          </li>
          <li>
            <p>
              Let the <var>uneased scaled active time</var> be the result
              corresponding to the first matching condition from below.
            </p>
            <dl class="switch">
              <dt>If <a>iteration duration</a> is zero,</dt>
              <dd>
                zero
              </dd>
              <dt>If <var>uneased iteration time</var> equals <a>iteration
                  duration</a>,</dt>
              <dd>
                <code><a>repeated duration</a> * <a>start offset</a></code>
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                <code><var>iteration index</var> * <a>iteration duration</a>
                + <var>uneased iteration time</var></code>
              </dd>
            </dl>
          </li>
          <li>
            <p>
              Let the <var>uneased active time</var> be the result corresponding
              to the first matching condition from below.
            </p>
            <dl class="switch">
              <dt>If the <a title="timed item playback rate">playback rate</a>
                  is zero,</dt>
              <dd>
                positive infinity unless <var>scaled active time</var> is zero,
                in which case the <var>active time</a> is zero
              </dd>
              <dt>If the <a title="timed item playback rate">playback rate</a>
                  is positive,</dt>
              <dd>
                <code>(<var>uneased scaled active time</var> - <a>start
                offset</a>) / <a title="timed item playback rate">playback
                rate</a></code>
              </dd>
              <dt>Otherwise,
              <dd>
                <code>(<var>uneased scaled active time</var> - <a>start
                offset</a>) / <a title="timed item playback rate">playback
                rate</a> + <a>active duration</a></code>
              </dd>
          </li>
          <li>Return <code><var>uneased active time</var> + <a>start
              delay</a></code>.
          </li>
        </ol>
        <p>
          Note that the above procedure is only defined when the <a>uneased
          child time</a> is defined, that is, not <code>null</code>.
        </p>
        <p>
          The <dfn><em>uneased inherited time</em> from <em>uneased local
          time</em></dfn> is simply the sum of the <em>uneased local time</em>
          and the <a>timed item</a>'s <a title="timed item">start time</a>.
        </p>
        <p>
          The <dfn><em><a>timeline</a> time</em> from the <a>current time</a> of
          a <a>player</a></dfn> is calculated as follows.
        </p>
        <blockquote>
          <code><var>timeline time</var> =
            (<a>current time</a> + <a>time drift</a>) /
            <a title="player playback rate">playback rate</a> +
            <a title="player start time">start time</a></code>
        </blockquote>
        <p>
          If the <a title="player playback rate">player's playback rate</a> is
          zero, the <var>timeline time</var> is undefined.
          The handling of an undefined value depends on the context in which it
          is used.
          Typically, a current <a>time value</a> for the <a>timeline</a> is
          available and this is used in place of the undefined value.
        </p>
        <p>
          Provided that the <a>current iteration</a> values used when
          calculating the <em>uneased local time</em> are recorded, it is
          possible, by applying the above definitions in succession, to
          calculate the <a>time value</a> of a <a>timeline</a> corresponding to
          the <em>uneased local time</em> of a <a>timed item</a> associated with
          that <a>timeline</a>.
        </p>
      </section>
      <section>
        <h3>Event parameters</h3>
        <p>
          <a>Timing events</a> have an associated <a>event
          local time</a>, <a>event timeline time</a>, <a>event iteration
          index</a>, and <a>seeked dispatch flag</a>.
        </p>
        <p>
          The <dfn>event local time</dfn> is the <em>uneased local time</em> of
          the <a>timed item</a> that generated event at the moment the event is
          scheduled to occur.
          This time is constrained by the timing of the <a>parent timing
          group</a>'s <a>iteration interval</a> such that when converted to an
          <em>uneased iteration time</em> in the parent's <a
          href="#iteration-time-space">iteration time space</a> (see <a
          href="#inverse-timing-calculations" class="sectionRef"></a>) it lies
          within the range 0 &le; <em>uneased iteration time</em> &le;
          <a>iteration duration</a> (of the <a title="parent timing
          group">parent</a>).
        </p>
        <p>
          The <dfn>event timeline time</dfn> is the result of converting the
          <a>event local time</a> into the time space of the <a>timeline</a>
          that sampled the <a>timed item</a>.
          If is calculated using the procedures defined in <a
          href="#inverse-timing-calculations" class="sectionRef"></a>.
        </p>
        <p>
          The <dfn>event iteration index</dfn> is the value of the <a>timed
          item</a>'s <a>current iteration</a> and moment the event is scheduled
          to occur.
        </p>
        <p>
          The <dfn>seeked dispatch flag</dfn> is a boolean value set to
          <code>true</code> if this event was generated as a result of applying
          <a>seeked event dispatch</a>.
        </p>
      </section>
      <section>
        <h3>Propagation path</h3>
        <p>
          The <a
          href="http://www.w3.org/TR/DOM-Level-3-Events/#glossary-propagation-path">propagation
          path</a> for a <a>timing event</a> generated by <var>item</var>,
          is simply <var>item</var> itself.
        </p>
        <p class="note">
          Note that unlike <code>AnimationEvent</code>s and
          <code>TransitionEvent</code>s in CSS, and <code>TimeEvent</code>s in
          SVG, all of which target an Element; the target of a <a>timing
          event</a> is a <a>timed item</a>.
        </p>
      </section>
      <section>
        <h3>Sequence of events</h3>
        <p>
          The sequence in which <a>timing events</a> are queued is as follows:
        </p>
        <ol>
          <li><a>timingcancel</a> events are queued first.
              The sequence within <a>timingcancel</a> events is as follows:
              <ol>
                <li>
                  Events generated by a <a>timed item</a>
                  associated with a <a>player</a> that was created earlier
                  precede events generated by a <a>timed item</a> associated
                  with a <a>player</a> created later.
                </li>
                <li>
                  Events generated by the same <a>player</a> are queued in the
                  order that the <a>unattached timed items</a> that generated
                  the events appear in the <a>player</a>'s <a>queue of
                  unattached timed items</a>
                  (see <a href="#event-dispatch-and-unattached-timed-items"
                  class="sectionRef"></a>).
                </li>
              </ol>
          </li>
          <li>All other events are ordered by <a>event timeline time</a> with
              earlier times preceding later times in the queue.</li>
          <li>For events with the same <a>event timeline time</a>, the following
              rules are applied in succession until the order in the queue is
              resolved,
            <ol>
              <li><a>timingstart</a> events of <a
                  title="parent timing group">parents</a> precede all events
                  generated by <a title="child timed item">children</a>.</li>
              <li><a>timingiteration</a> events of <a
                  title="parent timing group">parents</a> precede all events
                  generated by <a title="child timed item">children</a> during
                  the iteration corresponding to the
                  <a>timingiteration</a> event's <a>event iteration
                  index</a>.</li>
              <li><a>timingend</a> events of <a
                  title="parent timing group">parents</a> follow all events
                  generated by <a title="child timed item">children</a>.
                  <p class="note">
                    In effect, <a title="child timed item">child timed items</a>
                    operate <em>inside</em> an iteration of their <a>parent
                    timing group</a> and hence events generated by children are
                    <em>wrapped</em> by their parents' events.
                  </p>
              </li>
              <li>For events generated by different <a>timed
                  items</a>, <a>timingend</a> events precede <a>timingstart</a>
                  events which precede <a>timingiteration</a> events.
                  <p class="note">
                    Note that sorting end events before start events is
                    consistent with the end-point exclusive nature of intervals
                    (see <a href="#interval-timing" class="sectionRef"></a>).
                    When animation A ends at the same time as animation
                    B begins, we can imagine that animation A ends an infinitely
                    short amount of time before animation B begins such that
                    there is no overlap.
                  </p>
              </li>
              <li>For events generated by the same <a>timed
                  items</a>, <a>timingstart</a> events precede
                  <a>timingiteration</a> events which precede
                  <a>timingend</a> events.</li>
              <li>
                For events generated by <a>timed items</a>
                with a common <a>ancestor</a> <a>timing group</a>, events are
                ordered based on a <a>tree order</a> traversal of the
                descendents of the <a>ancestor</a> <a>timing group</a>.
              </li>
              <li>
                Events generated by a <a>timed item</a>
                associated with a <a>player</a> that was created earlier precede
                events generated by a <a>timed item</a> associated with
                a <a>player</a> created later.
              </li>
            </ol>
          </li>
        </ol>
      </section>
      <section>
        <h3>Event dispatch</h3>
        <p>
          <dfn>Events are queued</dfn> when either of the following occurs:
        </p>
        <ul>
          <li>a <a>timeline</a> is <a title="sampling">sampled</a>, or</li>
          <li>a <a>player</a> is <a title="seeking">seeked</a>.</li>
        </ul>
        <p>
          In the former case&mdash;when a <a>timeline</a> is <a
          title="sampling">sampled</a>&mdash;since Web Animations put no
          requirements on the time between successive samples, it is often the
          case  that the moment when a change in state that should produce an
          event is scheduled to occur does not line up with a sample.
        </p>
        <p>
          As such, except for the specific circumstances mentioned in following
          sections, the events that should be queued when <a>sampling</a>
          a <a>timeline</a> includes all events scheduled to occur in the
          interval since the previous sample time up to and including the
          current timeline time.
        </p>
        <p class="note">
          Note that when a <a>player</a> is first <a
          title="sampling">sampled</a>, it will employ <a>seeked event
          dispatch</a> as described in <a
          href="#event-dispatch-and-time-adjustments" class="sectionRef"></a>
          after which point the previous sample time for that <a>player</a>
          will be resolved.
          As a result, there is never an occasion where the previous sample time
          is used and yet is undefined.
        </p>
        <p>
          For the latter case&mdash;when a <a>player</a> is <a
          title="seeking">seeked</a>&mdash;the behavior is defined in <a
          href="#event-dispatch-and-seeking-a-player" class="sectionRef"></a>.
        </p>
        <p class="todo">
          Make sure we update the previous sample time for a seek/etc.
        </p>
        <p class="note">
          Note that <a href="#algorithms-for-event-dispatch"
          class="sectionRef"></a> provides non-normative algorithms that
          incorporate the behavior defined in this section as well as <a
          href="#sequence-of-events" class="sectionRef"></a>.
        </p>
        <section>
          <h4>Seeked event dispatch</h4>
          <div class="informative">
            <p>
              Under some circumstances the usual behavior of dispatching all
              events scheduled between two times is not appropriate either
              because it would produce such a large number of events that
              performance may be adversely affected,
              or because it would produce counter-intuitive results in the
              circumstances.
              In such situations, an alternative form of event dispatch called
              <a>seeked event dispatch</a> is used.
            </p>
          </div>
          <p>
            <dfn>Seeked event dispatch</dfn> is a mode of event dispatch that
            produces at most one <a>timing event</a> per <a>timed item</a> by
            comparing whether the <a>timed item</a> was <a>active</a> or not at
            some <var>initial moment</var> and at some <var>final moment</var>.
          </p>
          <p>
            To facilitate this, each <a>timed item</a> has an associated
            <dfn>previous active state</dfn> property that initially has the
            value <em>inactive</em>.
          </p>
          <p>
            For a given <a>timed item</a> the events queued as a result of
            performing <a>seeked event dispatch</a> at <em>uneased local
            time</em> <var>t</var> is as follows:
          </p>
          <ol>
            <li>Let <var>timeline time</var> be the <a>time value</a> of the
                <a>timeline</a> with which the <a>timed item</a> is
                associated.
                The procedures for calculating the timeline time from a <a>timed
                item</a>'s <em>uneased local time</em> or the <a>current
                time</a> of a <a>player</a> are defined in <a
                href="#inverse-timing-calculations" class="sectionRef"></a>.
                </li>
            <li>Let <var>iteration index</var> be the result of calculating the
                <a>current iteration</a> at <var>t</var>.</li>
            <li>Let <var>timeline time</var> be the <a>time value</a> of the
                <a>timeline</a> with which the <a>timed item</a> is
                associated.
                The procedures for calculating the timeline time from a <a>timed
                item</a>'s <em>uneased local time</em> or the <a>current
                time</a> of a <a>player</a> are defined in <a
                href="#inverse-timing-calculations" class="sectionRef"></a>.
                </li>
            <li>Let <var>current active state</var> be <em>active</em> if the
                timed item is <a>active</a> at <var>t</var>, and
                <em>inactive</em> otherwise.</li>
            <li>The events to be queued depend on comparing the <var>current
                active state</var> and the <a>timed item</a>'s <a>previous active
                state</a> as follows.
            <dl class="switch">
              <dt>If the <a>timed item</a>'s <a>previous active state</a> is
                <em>active</em> and <var>current active state</var> is
                <em>inactive</em>,</dt>
              <dd>
                Queue a new <a>timingend</a> event with parameters:
                <ul>
                  <li><a>event local time</a>: <var>t</var></li>
                  <li><a>event timeline time</a>: <var>timeline time</var></li>
                  <li><a>event iteration index</a>: <var>iteration index</var>
                  <li><a>seeked dispatch flag</a>: <var>true</var>
                </ul>
              </dd>
              <dt>If the <a>timed item</a>'s <a>previous active state</a> is
                <em>inactive</em> and <var>current active state</var> is
                <em>active</em>,</dt>
              <dd>
                Queue a new <a>timingstart</a> event with parameters:
                <ul>
                  <li><a>event local time</a>: <var>t</var></li>
                  <li><a>event timeline time</a>: <var>timeline time</var></li>
                  <li><a>event iteration index</a>: <var>iteration index</var>
                  <li><a>seeked dispatch flag</a>: <var>true</var>
                </ul>
              </dd>
            </dl>
            </li>
            <li>
              Let the <a>timed item</a>'s <a>previous active state</a> be
              <var>current active state</var>.
            </li>
          </ol>
          <p>
            For <a>timing groups</a>, this procedure is
            applied recursively to all <a>child timed
            items</a>.
            The resulting events are sorted using the sequence defined in <a
            href="#sequence-of-events" class="sectionRef"></a>.
          </p>
          <p>
            Note that <a>seeked event dispatch</a> is only defined for <a>timed
            items</a> associated with a <a>player</a>.
            <a>Timed items</a> not associated with a <a>player</a> dispatch
            <a>timingcancel</a> events as defined in <a
            href="#event-dispatch-and-time-adjustments"
            class="sectionRef"></a>.
          </p>
        </section>
        <section>
          <h4>Event dispatch and seeking a player</h4>
          <p>
            When a seek is performed on a <a>player</a> (see <a
            href="#performing-a-seek" class="sectionRef"></a>) <a>seeked event
            dispatch</a> is applied.
          </p>
          <p>
            Prior to performing the seek, the <a>previous active state</a> of
            each <a>timed item</a> that is either the <a>source content</a> of
            the <a>player</a> or a descendent of the <a>source content</a> is
            updated to reflect whether the <a>timed item</a> is <a>active</a> or
            not at the moment prior to performing the seek.
          </p>
          <p>
            If the <a>time adjusted flag</a> of the <a>player</a> has been set,
            no update of the <a>previous active state</a> of the <a>source
            content</a> and its <a>descendants</a> is performed.
          </p>
          <p>
            The <var>timeline time</var> used in the <a>seeked event
            dispatch</a> procedure is simply the <var>seek time</var>.
          </p>
          <p>
            After completing the seek, the previous sample time of the
            <a>player</a> is updated to reflect the <var>seek time</var> and the
            <a>time adjusted flag</a>, if set, is cleared.
          </p>
          <p class="annotation">
            Suppressing events during seeking is necessary to provide performant
            seeking.
            It is also arguably the more intuitive behavior as, for example,
            when rewinding a cartoon one probably does not expect a bucketload
            of events to arrive as a result of traversing backwards over each
            <a>timed item</a>.
          </p>
        </section>
        <section>
          <h4>Event dispatch and time adjustments</h4>
          <div class="informative">
            <p>
              Apart from seeking a <a>player</a>, making adjustments to the
              arrangement or timing of a player's <a>source content</a> can also
              cause the <a>timed items</a>' <a>local time</a> to jump.
              Like seeking, in such circumstances it is often not sensible to
              dispatch all the intermediate events but rather to employ
              <a>seeked event dispatch</a>.
            </p>
            <p>
              The range of circumstances where this behavior is necessary is
              quite broad when we consider the interdependencies in the timing
              of <a>timed items</a>.
              For example,
            </p>
            <ul>
              <li><a>Timing groups</a> calculate their <a>intrinsic iteration
              duration</a> based on the <a>active duration</a> of their
              <a title="child timed item">children</a>.</li>
              <li>Children of a <a>sequence timing group</a> base their
              <a title="timed item start time">start time</a> on the <a>active
              duration</a> of sibling <a>timed items</a> that appear earlier in
              the group.</li>
            </ul>
            <p>
              As such, even small changes to the timing of a <a>timed item</a>
              can have knock-on effects that affect all other <a>timed items</a>
              <a title="associated with a player">associated</a> with the same
              player possibly causing their <a>local time</a> to jump.
              As a result, <a>seeked event dispatch</a> is employed for the
              <a>source content</a> of a <a>player</a> and <em>all</em> its
              descendents whenever <em>any</em> change is made to the timing or
              arrangement of any of those <a>timed items</a>.
            </p>
          </div>
          <p>
            Associated with each <a>player</a> is a <dfn>time adjusted
            flag</dfn> that is initially <code>false</code>.
          </p>
          <p>
            The <a>time adjusted flag</a> is set to <code>true</code> whenever
            any of the following actions is performed on any of the <a>timed
            items</a> <a title="associated with a player">associated</a> with
            the <a>player</a>.
          </p>
          <ul>
            <li>The <a>parent timing group</a> changes identity including
                changes to and from <code>null</code>.
                This includes <a>timed items</a> that become newly <a
                title="associated with a player">associated</a> with the
                <a>player</a> or likewise cease to be associated with the
                player.</li>
            <li>
              The following timing parameters are modified:
              <ul>
                <li><a>start delay</a></li>
                <li><a>iteration start</a></li>
                <li><a>iteration count</a></li>
                <li><a>iteration duration</a></li>
                <li><a>active duration</a></li>
                <li><a title="timed item playback rate">playback rate</a></li>
                <li><a>playback direction</a></li>
              </ul>
              <p class="note">
                Note that the <a>fill mode</a> and <a>timing function</a>
                associated with a <a>timed item</a> are not included in this
                list since they do not effect <a>uneased timing</a>.
              </p>
              <p>
                This behavior extends only to actual changes to the
                values.
                Setting a property to its current value&mdash;for example, by
                using the <a href="#script-interface">script
                interface</a>&mdash; does <em>not</em> cause the flag to be set.
              </p>
            </li>
            <li>
              The sequence of <a title="child timed item">children</a> within
              a <a>timing group</a> is changed.
            </li>
          </ul>
          <p>
            The <a>time adjusted flag</a> is cleared after <a>events are
            queued</a> for the given <a>player</a>.
          </p>
          <p>
            When <a title="events are queued">queuing events</a> for
            a <a>player</a>, if the <a>time adjusted flag</a> of the
            <a>player</a> is set, <a>seeked event dispatch</a> is used for all
            <a>timed items</a> <a title="associated with
            a player">associated</a> with the <a>player</a>.
          </p>
        </section>
        <section>
          <h3>Event dispatch and unattached timed items</h3>
          <div class="issue">
            <p>
              The <a>timingcancel</a> event may not be necessary.
            </p>
            <p>
              It was introduced since in some situations it is useful to
              distinguish between an animation completing normally
              (<a>timingend</a>&mdash;in which case actions that are scheduled
              to occur at the end of the animation should be performed) and
              being prematurely terminated (<a>timingcancel</a>&mdash;in which
              case such actions will generally not be performed).
            </p>
            <p>
              Currently the only way to prematurely end a <a>timed item</a> is
              to manually disassociate it from any <a>player</a> which seems too
              rare to warrant a special event.
              If <a>players</a> could be cancelled or stopped in some way then
              this event may make more sense.
            </p>
            <p>
              Note that the <em>touchcancel</em> event is conceptually similar
              and may be an argument in favor of keeping this event.
            </p>
          </div>
          <p>
            A <a>timed item</a> that is not <a>associated with a player</a> is
            an <dfn>unattached timed item</dfn>.
          </p>
          <p>
            Each time an operation is performed that causes a <a>timed item</a>
            that was <a>associated with a player</a> to become an <a>unattached
            timed item</a> it is appended to the end of a <dfn>queue of
            unattached timed items</dfn> associated with the <a>player</a>.
          </p>
          <p>
            Should an <a>unattached timed item</a> later become <a>associated
            with a player</a> it is removed from any <a>queue of unattached
            timed items</a> it may be present in.
            As a result a <a>timed item</a> will only ever appear in at most one
            <a>queue of unattached times</a> and never twice in the same queue.
          </p>
          <p>
            When <a>events are queued</a> as a result of <a>sampling</a>,
            the following steps are performed for all <a>timed items</a> in the
            <a>queue of unattached items</a> for each <a>player</a> that is <a
            title="sampling">sampled</a>.
          </p>
          <ol>
            <li>If the <a>previous active state</a> of the <a>timed item</a> is
                <em>active</em>,
                <ol>
                  <li>Queue a new <a>timingcancel</a> event with all parameters
                      set to <code>null</code>.</li>
                  <li>Set the <a>previous active state</a> to
                      <em>inactive</em>.</li>
                </ol>
            </li>
            <li>
              Remove the <a>timed item</a> from the <a>queue of unattached timed
              items</a>.
            </li>
          </ol>
          <p class="note">
            Note that <a>timingcancel</a> events are not dispatched when <a
            title="seeking">seeking</a> a <a>player</a>.
            As a result it is possible, using the <a
            href="#script-interface">script interface</a> to make a batch of
            changes to the arrangement of <a>timed items</a> including
            <a>seeking</a> and provided all <a>timed items</a> are <a>associated
            with a player</a> when the script block completes no
            <a>timingcancel</a> events will be dispatched.
          </p>
        </section>
        <section>
          <h4>Event dispatch and extended delays</h4>
          <div class="informative">
            <p>
              In some circumstances, when <a>events are queued</a> during
              a <a>sample</a>, the number of events generated may be excessive.
              This can happen, for example, if the user agent dramatically
              reduces the sample rate for a background application to conserve
              battery, or if the device is activated after being in a sleep
              state for an extended period of time.
            </p>
            <p>
              In such situations, requiring the user agent to dispatch all
              <a>timing events</a> scheduled in the interim period would result
              in a significant drop in performance and in extreme circumstances
              may render the user agent temporarily unusable whilst it catches
              up on event processing.
            </p>
            <p>
              In order to ensure a good user experience even in such
              circumstances a user agent may switch to <a>seeked event
              dispatch</a> to alleviate the burden of dispatching excessive
              events.
            </p>
          </div>
          <p>
            If, whilst <a>sampling</a> a <a>timeline</a>, more than 30 <a>events
            are queued</a>, the user agent MAY employ <a>seeked event
            dispatch</a> for all <a>timed items</a> <a
            title="associated with a timeline">associated</a> with the
            <a>timeline</a>.
          </p>
          <p class="issue">
            30 is somewhat arbitrary.
            Need feedback both from implementations (on the most constrained
            device, when does this start being burdensome?) and authoring (what
            is the minimum guarantee necessary to cover most regular content?)
          </p>
          <div class="annotation">
            The SVG bindings may add additional requirements here so that when
            a protracted delay may make resolving syncbase dependencies in the
            interim period difficult to achieve without adversely impacting
            performance, a seek is performed.
          </div>
        </section>
      </section>
    </section>

    <section>
      <h2>Script interface</h2>
      <div class="informative">
        <p>
          In addition to the abstract model described above, Web Animations also
          defines a programming interface to the model.
          This interface can be used to inspect and extend animations produced
          by declarative means or for directly producing animations when
          a procedural approach is more suitable.
        </p>
      </div>
      <section>
        <h3>The <code>Timeline</code> interface</h3>
        <p>
          <a>Timelines</a>, including the <a>document
          timeline</a> are represented in the Web Animations API by the
          <a title="Timeline interface">Timeline</a> interface.
        </p>
        <dl title="interface Timeline" class="idl">
          <dt>readonly attribute double? currentTime</dt>
          <dd>
            <p>
              Returns the <a>time value</a> for this timeline or
              <code>null</code> if this timeline is <a>not started</a>.
            </p>
            <p>
              For a <a>document timeline</a> this will never be negative and
              represents the number of seconds since the document with which
              this <a>timeline</a> is associated was ready to fire its load
              event.
            </p>
          </dd>
          <dt>Player play()</dt>
          <dd>
            <p>
              Creates a new <a title="Player interface">Player</a> object
              associated with this <a>timeline</a> that is scheduled to start
              at <code>currentTime</code>.
            </p>
            <p>
              The <code>timeline</code> attribute of the newly-created <a
              title="Player interface">Player</a> object will be set to this
              object.
            </p>
            <p>
              Similarly, the <code>startTime</code> attribute will be set to the
              value of this object's <code>currentTime</code> attribute at the
              moment the method was called, or, if <code>currentTime</code> is
              <code>null</code>, zero.</li>
            </p>
            <p>
              The setting of the <code>source</code> attribute is described
              below under the description of the <em>source</em> parameter.
            </p>
            <p>
              The <code>currentTime</code> attribute of the <a title="Player
              interface">Player</a> object is a calculated value described in <a
              href="#the-current-time-of-a-player" class="sectionRef"></a>.
            </p>
            <p>
              The <code>playbackRate</code> and <code>paused</code> attributes
              take on their default values as described in the definitions of
              the <a title="player playback rate">playback rate</a> and
              <a>paused state</a> properties of <a>player</a> objects.
            </p>
            <dl class="parameters">
              <dt>optional TimedItem? source = null</dt>
              <dd>
                <p>
                  The <a>source content</a> to assign to the newly-created <a
                  title="Player interface">Player</a> object.
                </p>
                <p>
                  The <a href="#widl-Player-source"><code>source</code></a>
                  attribute of the created <a title="Player
                  interface">Player</a> is set by following the procedure
                  defined for updating that attribute.
                  As a result, if <em>source</em> is already associated with
                  a <code>player</code>, it will be disassociated first before
                  being associated with the new <a title="Player
                  interface">Player</a> object.
                </p>
              </dd>
            </dl>
            <div class="issue">
              <p>
                We will likely change this interface to the following format:
              </p>
              <pre class="example webidl">
                Promise play(optional TimedItem? source = null);
                Player  playNow(optional TimedItem? source = null);
              </pre>
              <p>
                Under this arrangement <code>play</code> would begin at the next
                possible moment whilst attempting to ensure that the animation
                begins from the first frame.
                This allows implementations to make adjustments for vsync or
                overhead in triggering the animation in another process.
              </p>
              <p>
                The <code>play</code> callback passes the created <a
                title="Player interface">Player</a> as the argument to the
                Promise's fulfill callback.
              </p>
              <p>
                <code>playNow</code> matches the existing definition of the
                function and causes the start time of the player to be set to
                this timeline's <code>currentTime</code> even though this may
                cause the first part of the animation to be dropped.
              </p>
            </div>
          </dd>
          <dt>sequence&lt;Player&gt; getCurrentPlayers()</dt>
          <dd>
            <p>
              Returns the set of <a title="Player interface">Player</a> objects
              associated with this <a>timeline</a> that have associated
              <a>source content</a> which is <a>current</a>.
            </p>
            <p>
              The returned list is sorted in increasing order of the <a
              title="player start time">start time</a> of the <a title="Player
              interface">Player</a> objects.
              If any two <a title="Player interface">Player</a> objects have the
              same <a title="player start time">start time</a> they are sorted
              in the order in which the objects were created.
            </p>
            <div class="issue">
              <p>
                Does this ordering make sense?
              </p>
              <p>
                Ordering by creation order only is simpler and useful for the
                case of fetching the most recently created player (e.g. when you
                call a utility function that plays an animation but
                inconsiderately does not return the player) but that doesn't
                work for <code>Element.getCurrentPlayers</code> (unless we make
                creation order global?) and the two methods should probably use
                consistent ordering.
              </p>
            </div>
          </dd>
          <dt>double? toTimelineTime (double otherTime, Timeline other)</dt>
          <dd>
            <p>
              Returns the <a>time value</a>, <em>otherTime</em>, from another
              <a title="Timeline interface">Timeline</a> also tied to the
              <a>global clock</a>, <em>other</em>, converted to a <a>time
              value</a> relative to this timeline's <a>zero time</a>.
            </p>
            <p>
              Returns <code>null</code> if:
            </p>
            <ul>
              <li>this timeline is <a>not started</a>, or</li>
              <li><em>other</em> is <a>not started</a>.</li>
            </ul>
            <p>
              Note that unlike <code>currentTime</code>, this method may return
              a negative <a>time value</a> if <em>otherTime</em> occurred prior
              to this timeline's <a>zero time</a>.
            </p>
            <p>
              Furthermore, negative values for <em>otherTime</em> are also
              allowed.
            </p>
            <p>
              If this timeline records the <a>time value</a> of the <a>global
              clock</a> at its <a>zero time</a> as <var>global clock
              offset</var>, and so does <em>other</em> as <var>other global
              clock offset</var>, then the result of this method is simply:
            </p>
            <blockquote>
              <code><var>other global clock offset</var> + <var>otherTime</var>
              - <var>global clock offset</var></code>
            </blockquote>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>InvalidNodeTypeError</code></dt>
              <dd>
                Raised if <em>other</em> is a timeline that is not tied to the
                <a>global clock</a>.
                <p class="annotation">
                  The reason for choosing <code>InvalidNodeTypeError</code> here
                  is that DOM4 describes it as meaning, "The supplied node is
                  incorrect or has an incorrect ancestor for this operation."
                  In this case the error is because <em>other</em> does not have
                  the <a>global clock</a> as an ancestor so it seems
                  appropriate.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>double? toTimelineTime (Event event)</dt>
          <dd>
            <p>
              Returns the number of seconds between when <em>event</em> was
              fired and this <a>timeline</a>'s <a>zero time</a>.
            </p>
            <p>
              Since the <code>timeStamp</code> attribute of the
              <code>Event</code> interface specified in [[DOM-LEVEL-3-EVENTS]]
              is not guaranteed to be monotonically increasing, implementations
              SHOULD record alongside each event the <a>time value</a> of the
              <a>global clock</a> when the event is dispatched so that it can be
              converted to an accurate <a>time value</a> here.
            </p>
            <p>
              Unlike <code>currentTime</code>, this method may return a negative
              <a>time value</a> if the event was fired prior to this
              <a>timeline</a>'s <a>zero time</a>.
            </p>
            <p>
              Returns <code>null</code> if this <a>timeline</a> is <a>not
              started</a>.
            </p>
            <p class="issue">
              This might be deferred to a later version.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>Player</code> interface</h3>
        <p>
          <a>Players</a> are represented in the Web Animations
          API by the <a title="Player interface">Player</a> interface.
        </p>
        <dl title="interface Player" class="idl">
          <dt>attribute TimedItem? source</dt>
          <dd>
            <p>
              The <a>source content</a> associated with this player.
            </p>
            <p>
              A <a>player</a> can only be associated with at most one <a>timed
              item</a>, and likewise, a <a>timed item</a> can only be
              associated&mdash;either directly or via an
              <a>ancestor</a>&mdash;with at most one <a>player</a>.
              In order to maintain these invariants, on setting this value, the
              following procedure is performed:
            </p>
            <ol>
              <li>Let <var>old value</var> be the current value of the
                  <code>source</code> attribute.</li>
              <li>Let <var>new value</var> be the value to set.</li>
              <li>If <var>new value</var> is the same object as <var>old
                  value</var>, return.</li>
              <li>If <var>old value</var> is not <code>null</code>,
                  disassociate <var>old value</var> from this player.</li>
              <li>If <var>new value</var> is not <code>null</code>,
                  perform the steps associated with the first matching condition
                  of the following:
                <dl class="switch">
                  <dt>If <var>new value</var> has no parent group and is
                      associated with a player,</dt>
                  <dd>disassociate <var>new value</var> from its player.</dd>
                  <dt>If <var>new value</var> has a parent group,</dt>
                  <dd>remove <var>new value</var> from its parent group by
                      calling <code><var>new value</var>.remove()</code>.</dd>
                  <dt>Otherwise,</dt>
                  <dd>do nothing.</dd>
                </dl>
              </li>
              <li>Associate <var>new value</var> with this player.
              <li>Set the <code>source</code> attribute to <var>new
                  value</var>.</li>
            </ol>
          </dd>
          <dt>readonly attribute Timeline timeline</dt>
          <dd>
            The <a>timeline</a> associated with this player.
          </dd>
          <dt>attribute double startTime</dt>
          <dd>
            The <a title="player start time">start time</a> of this player.
          </dd>
          <dt>attribute double currentTime</dt>
          <dd>
            The <a>effective current time</a> of this player.
            Setting this attribute follows the procedure defined in <a
            href="#performing-a-seek" class="sectionRef"></a>.
          </dd>
          <dt>attribute double playbackRate</dt>
          <dd>
            The <a title="player playback rate">playback rate</a> of this
            player.
            Setting this attribute follows the procedure defined in <a
            href="#updating-the-playback-rate" class="sectionRef"></a>.
          </dd>
          <dt>attribute boolean paused</dt>
          <dd>
            The <a>paused state</a> of this player.
            Setting this attribute follows the procedure defined in <a
            href="#updating-the-paused-state" class="sectionRef"></a>.
          </dd>
        </dl>
        <div class="feedbackWanted">
          <p>
            A reverse method would be very useful here for effects like
            transitions.
          </p>
          <p>
            The behavior would be:
          </p>
          <ol>
            <li>If <code>currentTime</code> is beyond the <a>end
                time</a> of the <a>source content</a> seek back to the end of
                the <a>active interval</a>.
            <li>Set <code>playbackRate</code> to
                <code>-playbackRate</code>.</li>
          </ol>
          <p>
            This reflects how transitions work as well as common usage.
          </p>
          <p>
            Some objections:
          </p>
          <ul>
            <li>Calling <code>reverse</code> twice should be a noop.</li>
            <li><a>Players</a> should be independent of their
                <a>source content</a>.</li>
          </ul>
          <p>
            Some suggestions:
          </p>
          <ul>
            <li>Call it <code>reverseSource</code> to make the link to the the
                <a>source content</a> obvious and remove any expectation that
                calling it twice is a noop.</li>
            <li>Make <a>players</a> actually stop when they reach
                the end of their <a>source content</a> much like a video/DVD/CD
                player.
                This would eliminate the need for the reverse seek and would
                make calling twice a noop.</li>
          </ul>
          <p>
            Your feedback is most welcome at <a
            href="mailto:public-fx@w3.org">public-fx@w3.org</a>, subject
            <em>[web-anim] &hellip;</em>.
          </p>
        </div>
      </section>
      <section>
        <h3>The <code>TimedItem</code> interface</h3>
        <p>
          <a>Timed items</a> are represented in the Web
          Animations API by the <a>TimedItem</a> interface.
        </p>
        <dl title="interface TimedItem : EventTarget" class="idl">
          <dt>// Playback state</dt><dd></dd>
          <dt>readonly attribute double? localTime</dt>
          <dd>
            <p>
              The <a>local time</a> of this <a>timed item</a>.
            </p>
            <p>
              <code>localTime</code> will be <code>null</code> if this <a>timed
              item</a> is not directly or indirectly associated with
              a <a>player</a> or if it has a parent <a>timing group</a> that is
              not <a>in effect</a>.
            </p>
          </dd>
          <dt>readonly attribute unsigned long? currentIteration</dt>
          <dd>
            The <a>current iteration</a> index beginning with zero for the first
            iteration.
          </dd>
          <dt>// Specified timing</dt><dd></dd>
          <dt>readonly attribute Timing specified</dt>
          <dd>
            <p>
              Returns the input timing properties for this <a>timed item</a>.
            </p>
            <div class="feedbackWanted">
              <p>
                Representing these parameters has been a particularly
                contentious topic.
              </p>
              <p>
                The current arrangement:
              </p>
              <ul>
                <li>requires defining both a <a>Timing</a> interface and
                    a <a>TimingInput</a> dictionary type which increases the API
                    surface area somewhat
                <li>means that setting the value occurs at a different place
                    (<code>anim.specified.iterationDuration</code>) to reading
                    the value (typically, <code>anim.iterationDuration</code>)
                <li>opens up questions about whether <a>Timing</a> objects
                    should be share-able or not
                <li>uses a union of a string and a double to represent
                    a duration which opens up questions about whether strings
                    such as <code>"3s"</code> should be allowed (and allowing
                    them makes walking the tree more complex).
              </ul>
              <p>
                However, it separates "specified" timing from "computed" timing
                which some consider advantageous.
              </p>
              <p>
                The only situation where calculated values and input values
                differ is for <code>iterationDuration</code> and
                <code>activeDuration</code>.
              </p>
              <p>
                One alternative that has been proposed is to introduce
                a <code>Duration</code> interface as follows:
              </p>
              <pre class="example webidl">
interface TimedItem : EventTarget {
   // Timing
   attribute double   startDelay;
   attribute FillMode fillMode;
   attribute Duration iterationDuration;
   attribute Duration activeDuration;
   attribute double   playbackRate;
   // ...
   
   // Scheduled time
   readonly attribute double              startTime;
   readonly attribute unrestricted double endTime;
};

interface Duration {
  double    sec;
  DOMString string;
}
              </pre>
              <p>
                Usage is as follows:
              </p>
              <pre class='example sh_javascript'>
 var specifiedDur  = anim.iterationDuration.string; // "auto"
 var calculatedDur = anim.iterationDuration.sec; // 5
 
 // Update duration to 3s
 anim.iterationDuration.sec = 3;
 // anim.iterationDuration.string -&gt; "3s"
 
 // Update duration to 3s (alt.)
 anim.iterationDuration.string = "3s";
 // anim.iterationDuration.sec -&gt; 3
 
 // Reset to auto
 anim.iterationDuration.string = "auto";  
 // anim.iterationDuration.sec -&gt; 5
              </pre>
              <p>
                Your feedback is most welcome at <a
                href="mailto:public-fx@w3.org">public-fx@w3.org</a>, subject
                <em>[web-anim] &hellip;</em>.
              </p>
            </div>
          </dd>
          <dt>// Calculated timing</dt><dd></dd>
          <dt>readonly attribute double startTime</dt>
          <dd>
            <p>
              The <a>start time</a> of this <a>timed item</a> in seconds.
              This is the time at which the parent <a>timing group</a>, if any,
              has scheduled this child to run within its <a title="transformed
              time">transformed time space</a>, that is, the <a>timed item</a>'s
              <a title="inherited time">inherited time space</a>.
            </p>
            <p>
              The start of the <a>active interval</a> is based on the sum of
              the <a title="timed item start time">start time</a> and
              <a>start delay</a>.
            </p>
          </dd>
          <dt>readonly attribute unrestricted double iterationDuration</dt>
          <dd>
            <p>
              The <a>iteration duration</a> of this <a>timed item</a>.
            </p>
            <p>
              Unlike the <code>iterationDuration</code> attribute of
              the <a>Timing</a> interface or <a>TimingInput</a> dictionary,
              this attribute returns the calculated value of the <a>iteration
              duration</a>.
              If <code>specified.iterationDuration</code> is the
              string <code>auto</code> or any unsupported value, this attribute
              will return the current calculated value of the <a>intrinsic
              iteration duration</a>.
            </p>
            <p>
              This value may be changed by setting the
              <code>iterationDuration</code> attribute of the
              <code>specified</code> member of this interface.
            </p>
          </dd>
          <dt>readonly attribute unrestricted double activeDuration</dt>
          <dd>
            <p>
              The <a>active duration</a> of this <a>timed item</a>.
            </p>
            <p>
              As with <code>iterationDuration</code>, this attribute returns the
              calculated value of the <a>active duration</a>.
              If <code>specified.activeDuration</code> is the
              string <code>auto</code> or any unsupported value,
              this is the result of evaluating the <a>active duration</a> using
              the procedure defined in <a
              href="#calculating-the-active-duration" class="sectionRef"></a>.
              Otherwise, it is the value specified for
              <code>specified.activeDuration</code>.
            </p>
            <p>
              This value may be changed by setting the
              <code>activeDuration</code> attribute of the
              <code>specified</code> member of this interface.
            </p>
          </dd>
          <dt>readonly attribute unrestricted double endTime</dt>
          <dd>
            <p>
              The upper bound of the <a>active interval</a> expressed in
              seconds in <a title="inherited time">inherited time space</a>.
            </p>
            <p>
              <code>endTime</code> is calculated as
              <code><a title="timed item start time">start time</a> + <a>start
                    delay</a> + activeDuration</code>
            </p>
            <div class="note">
              <p>
                Note that while the <code>endTime</code> is read-only, it can be
                set indirectly as follows:
              </p>
              <pre class="example sh_javascript">
                // Set endTime to 't'
                var t = 6;
                timing.specified.activeDuration =
                  t - anim.startTime - anim.specified.startDelay;
              </pre>
            </div>
          </dd>
          <dt>// Timing hierarchy</dt><dd></dd>
          <dt>readonly attribute TimingGroup? parent</dt>
          <dd>
            <p>
              The <a>parent timing group</a> of this <a>timed item</a> or
              <code>null</code> if this <a>timed item</a> does not have
              a <a>parent timing group</a>.
            </p>
            <div class="issue">
              Should this be <code>parentGroup</code>?
            </div>
          </dd>
          <dt>readonly attribute TimedItem? previousSibling</dt>
          <dd>
            The <a>previous sibling</a> of this <a>timed item</a>.
          </dd>
          <dt>readonly attribute TimedItem? nextSibling</dt>
          <dd>
            The <a>next sibling</a> of this <a>timed item</a>.
          </dd>
          <dt>void before (TimedItem... items)</dt>
          <dd>
            <p>
              Inserts <var>items</var> before this <a>timed item</a>.
            </p>
            <ol>
              <li>If there is no <a>parent timing group</a>, terminate these
                  steps.
              <li>If any of the <a>timed items</a> in <var>items</var> is an
                  <a>inclusive ancestor</a> of this <a>timed item</a>
                  throw a <code>HierarchyRequestError</code> exception and
                  terminate these steps. 
              <li><a title="insert children">Insert</a> <var>items</var> before
                  this <a>timed item</a>.
            </ol>
            <div class="note">
              <p>
                Note that this definition precludes the following usage since
                <code>item</code> is an <a>inclusive ancestor</a> of itself:
              </p>
              <pre class="example sh_javascript">
                item.before(item); // throws HierarchyRequestError
              </pre>
            </div>
          </dd>
          <dt>void after (TimedItem... items)</dt>
          <dd>
            <p>
              Inserts <var>items</var> after this <a>timed item</a>.
            </p>
            <ol>
              <li>If there is no <a>parent timing group</a>, terminate these
                  steps.
              <li>If any of the <a>timed items</a> in <var>items</var> is an
                  <a>inclusive ancestor</a> of this <a>timed item</a>
                  throw a <code>HierarchyRequestError</code> exception and
                  terminate these steps. 
              <li>Let <var>reference child</var> be the <a
                  title="next sibling not included">next sibling of
                  this timed item not in <var>items</var></a>.
              <li><a title="insert children">Insert</a> <var>items</var> before
                  <var>reference child</var>.
            </ol>
          </dd>
          <dt>void replace (TimedItem... items)</dt>
          <dd>
            <p>
              Replaces this <a>TimedItem</a> with the passed in
              <var>items</var>.
            </p>
            <ol>
              <li>If there is no <a>parent timing group</a>, terminate these
                  steps.
              <li>If any of the <a>timed items</a> in <var>items</var> is an
                  <a>inclusive ancestor</a> of the <a>parent timing group</a>
                  throw a <code>HierarchyRequestError</code> exception and
                  terminate these steps. 
              <li>Let <var>reference child</var> be the <a
                  title="next sibling not included">next sibling of
                  this timed item not in <var>items</var></a>.
              <li><a title="remove a timed item">Remove</a> this <a>timed
                  item</a> from its <a>parent timing group</a>.
              <li><a title="insert children">Insert</a> <var>items</var> before
                  <var>reference child</var>.
            </ol>
          </dd>
          <dt>void remove ()</dt>
          <dd>
            <a title="remove a timed item">Removes</a> this <a>timed
            item</a> from its <a>parent timing group</a>.
          </dd>
          <dt>// Associated player</dt><dd></dd>
          <dt>readonly attribute Player? player</dt>
          <dd>
            <p>
              The <a>player</a> associated with this <a>timed
              item</a>&mdash;either <a
              title="directly associated with a player">directly</a> or
              <a
              title="indirectly associated with a player">indirectly</a>.
              This object can be used to perform play control such as pausing or
              rewinding on this <a>timed item</a> <em>and all other timed items
              in the same hierarchy</em>.
            </p>
            <p>
              This method will return <code>null</code> if this <a>timed
              item</a> is not associated with a <a>player</a>.
            </p>
          </dd>
          <dt>// Event callbacks</dt><dd></dd>
          <dt>attribute EventHandler onstart</dt>
          <dd>
            The event handler for the <a>timingstart</a> event.
          </dd>
          <dt>attribute EventHandler oniteration</dt>
          <dd>
            The event handler for the <a>timingiteration</a> event.
          </dd>
          <dt>attribute EventHandler onend</dt>
          <dd>
            The event handler for the <a>timingend</a> event.
          </dd>
          <dt>attribute EventHandler oncancel</dt>
          <dd>
            The event handler for the <a>timingcancel</a> event.
          </dd>
        </dl>
        <p class="note">
          Note that the <a
          href="http://www.w3.org/TR/html5/webappapis.html#eventhandler">EventHandler</a>
          callback interface type is defined in [[!HTML5]].
        </p>
      </section>
      <section>
        <h3>The <code>Timing</code> interface</h3>
        <p>
          Timing parameters for a <a>TimedItem</a> are collected together under
          the <a>Timing</a> type.
        </p>
        <dl title="interface Timing" class="idl">
          <dt>attribute double startDelay</dt>
          <dd>
            <p>
              The <a>start delay</a> which represents the number of seconds from
              a <a>timed item</a>'s <a title="start time">start time</a> to the
              start of the <a>active interval</a>.
            </p>
          </dd>
          <dt>attribute FillMode fillMode</dt>
          <dd>
            <p>
              The <a>fill mode</a> as specified by one of the <a>FillMode</a>
              enumeration values.
            </p>
          </dd>
          <dt>attribute double iterationStart</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a>iteration start</a> property.
            </p>
            <p>
              A finite real number greater than or equal to zero representing
              the number of iterations into the timed item at which to begin.
              For example, a value of 0.5 would cause the timed item to begin
              half-way through the first iteration.
            </p>
            <p>
              Values less than zero are clamped to zero for the purpose of
              timing model calculations.
            </p>
            <div class="note">
              <p>
                Note that the <code>iterationCount</code> is effectively
                <em>added</em> to the <code>iterationStart</code> such that
                a timed item with an <code>iterationStart</code> of
                &lsquo;0.5&rsquo; and <code>iterationCount</code> of
                &lsquo;2&rsquo; would still repeat twice however it would begin
                and end half-way through the timed item's <a>iteration
                interval</a>.
              </p>
              <p>
                Setting the <code>iterationStart</code> to a value greater than
                or equal to one is typically only useful in combination with an
                animation effect that has an <code>accumulate</code> property of
                &lsquo;accumulate&rsquo;.
              </p>
            </div>
          </dd>
          <dt>attribute unrestricted double iterationCount</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a>iteration count</a> property.
            </p>
            <p>
              A real number greater than or equal to zero (including positive
              infinity) representing the number of times to repeat the
              timed item.
            </p>
            <p>
              Values less than zero are treated as the value 1.0 for the purpose
              of timing model calculations.
            </p>
          </dd>
          <dt>attribute (unrestricted double or DOMString) iterationDuration</dt>
          <dd>
            <p>
              The <a>iteration duration</a> which is a real number greater than
              or equal to zero (including positive infinity) representing the
              time taken to complete a single iteration of the <a>timed
              item</a>.
            </p>
            <p>
              The string value <code>auto</code> is used to indicate that the
              <a>iteration duration</a> reflects the timed item's <a>intrinsic
              iteration duration</a>.
            </p>
            <p>
              Real numbers less than zero and strings other than the value
              lowercase value <code>auto</code> are treated the same as
              <code>auto</code> for the purpose of timing model calculations.
            </p>
          </dd>
          <dt>attribute (unrestricted double or DOMString) activeDuration</dt>
          <dd>
            <p>
              The <a>active duration</a> of this <a>timed item</a>, that is, the
              length of its <a>active interval</a>.
            </p>
            <p>
              The string value <code>auto</code> is used to indicate that the
              <a>active duration</a> is calculated using the procedure defined
              in <a href="#calculating-the-active-duration"
              class="sectionRef"></a>.
              Otherwise, if a real number greater than or equal to zero
              (including positive infinity) is specified, that procedure is
              ignored and the value provided here is used for all timing model
              calculations that refer to the active duration.
            </p>
            <p>
              Real numbers less than zero and strings other than the value
              lowercase value <code>auto</code> are treated the same as
              <code>auto</code> for the purpose of timing model calculations.
            </p>
            <div class="issue">
              <p>Should we allow strings such as <code>"3s"</code> here?
              i.e. a CSS <a
              href="http://www.w3.org/TR/css3-values/#time">&lt;time&gt;</a>.
              It might be useful for readability but introduces complexity when
              handling this member (need to test the type, then possibly parse
              the string).
              It also introduces the issue of whether we should parse a full
              <a
              href="http://www.w3.org/TR/SVG11/animate.html#ClockValueSyntax">clock
              value</a>.
            </div>
          </dd>
          <dt>attribute double playbackRate</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a
              title="timed item playback rate">playback rate</a> property.
            </p>
            <p>
              This is a multiplier applied to the <a>local time</a> potentially
              causing the item to run at a different rate to its natural speed.
            </p>
          </dd>
          <dt>attribute PlaybackDirection direction</dt>
          <dd>
            <p>
              The <a>playback direction</a> of the <a>timed item</a> as
              specified by one of the <a>PlaybackDirection</a> enumeration
              values.
            </p>
          </dd>
          <dt>attribute DOMString timingFunction</dt>
          <dd>
            <p>
              The <a>timing function</a> used to scale the time to
              produce easing effects.
            </p>
            <p>
              The acceptable values and their meanings are those defined for the
              <a
              href="http://www.w3.org/TR/css3-transitions/#transition-timing-function-property">transition-timing-function</a>
              property in CSS Transitions [[!CSS3-TRANSITIONS]].
            </p>
            <p>
              In addition to the values defined in CSS Transitions, this method
              extends the <code>steps()</code> function notation to allow
              &lsquo;middle&rsquo; as a transition point keyword (e.g.
              <code>steps(3, middle)</code>).
              Similarly, the keyword &lsquo;steps-middle&rsquo; is recognized
              and given the meaning <code>steps(1, middle)</code>.
            </p>
            <p>
              Strings that specify a <code>cubic-bezier()</code> timing function
              result produce a <a>cubic Bézier timing function</a>.
              Strings that specify a <code>steps()</code> function produce a
              <a>step timing function</a>. Strings that specify a<code>paced()</code>
              timing function result produce a <a>paced timing function</a>.
            </p>
            <p>
              Unrecognized string values are treated as if the
              <code>linear</code> keyword was specified for the purpose of
              timing model calculations.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>TimingInput</code> dictionary</h3>
        <p>
          The <a>TimingInput</a> dictionary is used as a convenience for
          specifying the timing properties of a <a>TimedItem</a> in bulk.
        </p>
        <dl title="dictionary TimingInput" class="idl">
          <dt>double startDelay = 0</dt>
          <dd>
            <p>
              The specified <a>start delay</a>.
            </p>
            <p>
              See the description of the <code>startDelay</code> attribute on
              the <a>Timing</a> interface.
            </p>
          </dd>
          <dt>FillMode fillMode = "forwards"</dt>
          <dd>
            <p>
              The <a>fill mode</a> as specified by one of the <a>FillMode</a>
              enumeration values.
            </p>
            <p class="note">
              Note that in both CSS Animations [[CSS3-ANIMATIONS]] and SVG
              [[SVG112]] the default fill mode is "none".
              Web Animations differs in this regard since it was determined
              that when generating animations from script, forwards filling is
              the more commonly-desired behavior.
            </p>
            <p class="issue">
              Some feedback suggests the default here should be "both".
            </p>
          </dd>
          <dt>double iterationStart = 0.0</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a>iteration start</a> property.
            </p>
            <p>
              See the description of the <code>iterationStart</code> attribute
              on the <a>Timing</a> interface.
            </p>
          </dd>
          <dt>unrestricted double iterationCount = 1.0</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a>iteration count</a> property.
            </p>
            <p>
              See the description of the <code>iterationCount</code> attribute
              on the <a>Timing</a> interface.
            </p>
          </dd>
          <dt>(unrestricted double or DOMString) iterationDuration = "auto"</dt>
          <dd>
            <p>
              The <a>iteration duration</a> of the <a>timed item</a>.
            </p>
            <p>
              See the description of the <code>iterationDuration</code>
              attribute on the <a>Timing</a> interface.
            </p>
          </dd>
          <dt>(unrestricted double or DOMString) activeDuration = "auto"</dt>
          <dd>
            <p>
              The <a>active duration</a> of the <a>timed item</a>.
            </p>
            <p>
              See the description of the <code>activeDuration</code> attribute
              on the <a>Timing</a> interface.
            </p>
          </dd>
          <dt>double playbackRate = 1.0</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a
              title="timed item playback rate">playback rate</a> property.
            </p>
            <p>
              See the description of the <code>playbackRate</code> attribute
              on the <a>Timing</a> interface.
            </p>
          </dd>
          <dt>PlaybackDirection direction = "normal"</dt>
          <dd>
            <p>
              The <a>playback direction</a> of the <a>timed item</a>.
            </p>
            <p>
              See the description of the <code>direction</code> attribute
              on the <a>Timing</a> interface.
            </p>
          </dd>
          <dt>DOMString timingFunction = "linear"</dt>
          <dd>
            <p>
              The <a>timing function</a> used to scale the time to produce
              easing effects.
            </p>
            <p>
              See the description of the <code>timingFunction</code> attribute
              on the <a>Timing</a> interface.
            </p>
          </dd>
        </dl>
        <section>
          <h4>The <code>FillMode</code> enumeration</h4>
          <dl title="enum FillMode" class="idl">
            <dt>none</dt>
            <dd>
              No fill.
            </dd>
            <dt>forwards</dt>
            <dd>
              Fill forwards.
            </dd>
            <dt>backwards</dt>
            <dd>
              Fill backwards.
            </dd>
            <dt>both</dt>
            <dd>
              Fill backwards and forwards.
            </dd>
          </dl>
        </section>
        <section>
          <h4>The <code>PlaybackDirection</code> enumeration</h4>
          <dl title="enum PlaybackDirection" class="idl">
            <dt>normal</dt>
            <dd>
              All iterations are played as specified.
            </dd>
            <dt>reverse</dt>
            <dd>
              All iterations are played in the reverse direction from the way
              they are specified.
            </dd>
            <dt>alternate</dt>
            <dd>
              Even iterations are played as specified, odd iterations are played
              in the reverse direction from the way they are specified.
            </dd>
            <dt>alternate-reverse</dt>
            <dd>
              Even iterations are played in the reverse direction from the way
              they are specified, odd iterations are played as specified.
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>The <code>TimingGroup</code> interface</h3>
        <p>
          The different types of <a>timing groups</a>
          defined by Web Animations share a common <a>TimingGroup</a>
          interface as defined below.
        </p>
        <dl title="interface TimingGroup : TimedItem" class="idl">
          <dt>readonly attribute TimedItemList children</dt>
          <dd>
            The list of <a>child timed items</a> in the group.
          </dd>
          <dt>readonly attribute TimedItem? firstChild</dt>
          <dd>
            The <a>first child</a> of this <a>timing group</a>.
          </dd>
          <dt>readonly attribute TimedItem? lastChild</dt>
          <dd>
            The <a>last child</a> of this <a>timing group</a>.
          </dd>
          <dt>void prepend (TimedItem... items)</dt>
          <dd>
            <ol>
              <li>If any of the <a>timed items</a> in <var>items</var> is an
                  <a>inclusive ancestor</a> of this <a>timed item</a>
                  throw a <code>HierarchyRequestError</code> exception and
                  terminate these steps. 
              <li><a title="insert children">Insert</a> <var>items</var> before
                  the <a>first child</a>.
            </ol>
          </dd>
          <dt>void append (TimedItem... items)</dt>
          <dd>
            <ol>
              <li>If any of the <a>timed items</a> in <var>items</var> is an
                  <a>inclusive ancestor</a> of this <a>timed item</a>
                  throw a <code>HierarchyRequestError</code> exception and
                  terminate these steps. 
              <li><a title="insert children">Insert</a> <var>items</var> before
                  <code>null</code>.
            </ol>
          </dd>
        </dl>
        <section>
          <h2>Common definitions for manipulating hierarchies</h2>
          <p>The <dfn title="next sibling not included">next sibling of
             <var>item</var> not included</dfn> in a set of <a>timed
             items</a>, <var>items</var> is determined using the following
             steps:</p>
          <ol>
            <li>Let <var>context item</var> be <var>item</var>.
            <li>While the <a>next sibling</a> of <var>context item</var> is not
                <code>null</code> perform the following steps:
              <ol>
                <li>Let <var>context item</var> be the <a>next sibling</a> of
                    <var>context item</var>.
                <li>If <var>context item</var> is not in <var>items</var> return
                    <var>context item</var> and terminate these steps.
              </ol>
            <li>Return <code>null</code>.
          </ol>
          <p>To <dfn title="remove a timed item">remove</dfn> an <var>item</var>
             its parent or player, perform the steps corresponding to the first
             matching condition from below, if any:
          <dl class="switch">
            <dt>If <var>item</var> has a <a>parent timing group</a>,</dt>
            <dd>
              Remove <var>item</var> from the <a>parent timing group</a>'s list
              of <a>child timed items</a>.
            </dd>
            <dt>If <var>item</var> is <a>directly associated with
                a player</a>,</dt>
            <dd>
              Disassociate <var>item</var> from the <a>player</a>.
            </dd>
          </dl>
          <p>To <dfn title="insert children">insert</dfn> a series of zero or
             more <a>timed items</a>, <var>items</var>, to <var>parent</var>'s
             list of <a>child timed items</a> before <var>reference child</var>
             perform the following steps for each <var>item</var> in
             <var>items</var>:</p>
          <ol>
            <li><a title="remove a timed item">Remove</a> <var>item</var>
                from its parent.
            <li>Insert <var>item</var> to <var>parent</var>'s list of <a>child
                timed items</a> before <var>reference child</var>.
          </ol>
        </section>
      </section>
      <section>
        <h3>The <code>TimedItemList</code> interface</h3>
        <p>
          A list of <a>timed items</a> may be represented by
          a <a>TimedItemList</a>.
        </p>
        <p>
          The <code>TimedItemList</code> interface supports indexed
          properties with indices in the range 0 &le; <var>index</var> &lt;
          <code>length</code>. 
        </p>
        <p class="annotation">
          The only reason this interface exists is to provide a familiar
          experience for authors familiar with DOM interfaces where child nodes
          are accessed via a <code>children</code> member.
        </p>
        <dl title="interface TimedItemList" class="idl">
          <dt>readonly attribute unsigned long length</dt>
          <dd>
            The number of <a>timed items</a> in the list.
          </dd>
          <dt>getter TimedItem? item(unsigned long index)</dt>
          <dd>
            <p>
              Returns the <a>timed item</a> at <code>index</code>.
              If <code>index</code> is greater than or equal to
              <code>length</code> returns <code>null</code>.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>ParGroup</code> interface</h3>
        <p>
          <a>Parallel timing groups</a> are
          represented by the <code>ParGroup</code> interface.
        </p>
        <dl title="interface ParGroup : TimingGroup" class="idl">
          <dt>Constructor ()</dt>
          <dd>
            <p>
              Creates a new <a>ParGroup</a> object using the following
              procedure:
            </p>
            <ol>
              <li>Create a new <a>ParGroup</a> object, <var>group</var>.</li>
              <li>Set <var>timing input</var> as follows,
                <dl class="switch">
                  <dt>If <var>timing</var> is a <a>TimingInput</a> object,</dt>
                  <dd>
                    Let <var>timing input</var> refer to <var>timing</var>.
                  </dd>
                  <dt>If <var>timing</var> is a <code>double</code>,</dt>
                  <dd>
                    Let <var>timing input</var> be a new
                    <a>TimingInput</a> object with all members set to their
                    default values and <code>iterationDuration</code> set to
                    <var>timing</var>.
                  </dd>
                  <dt>Otherwise (<var>timing</var> is <code>null</code> or
                      undefined),</dt>
                  <dd>
                    Let <var>timing input</var> be a new <a>TimingInput</a>
                    object with all members set to their default values.
                  </dd>
                </dl>
              </li>
              <li>
                Set <code><var>animation</var>.specified</code> to a new
                <a>Timing</a> object whose attributes are assigned the
                value of the member of the same name on <var>timing input</var>.
                <p class="todo">
                  The above two steps are identical with the constructor for <a
                  title="Animation interface">Animation</a> and should be
                  factored out somewhere.
                </p>
              </li>
              <li>
                Add <var>children</var> to the group by calling
                <code><var>group</var>.splice(0, 0,
                <var>children</var>)</code>.
              </li>
            </ol>
            <div class="note">
              <p>
                Note that since <a>Timing</a> objects have the same member
                names as <a>TimingInput</a> dictionaries, it is also possible to
                pass the <code>specified</code> member of another
                <a>TimedItem</a> as the <var>timing</var> parameter.
              </p>
              <p>
                Doing so will cause the <a>Timing</a> object to be treated as
                a <a>TimingInput</a> dictionary and thus it will effectively be
                cloned, not shared.
              </p>
            </div>
            <dl class="parameters">
              <dt>sequence&lt;TimedItem&gt;? children</dt>
              <dd>
                <p>
                  A sequence of timed items to add as children of this group.
                </p>
                <p>
                  These children are appended in sequence using the same
                  semantics as the <code><a>TimingGroup</a>.add</code> method.
                </p>
              </dd>
              <dt>optional (unrestricted double or TimingInput)? timing = null</dt>
              <dd>
                <p>
                  The timing properties or <a>iteration duration</a> of the new
                  timing group.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>ParGroup clone ()</dt>
          <dd>
            <p>
              Creates a deep copy of this <a>ParGroup</a> object using the
              following procedure.
            </p>
            <ol>
              <li>Let <var>source</var> be this <a>ParGroup</a> object, the
                  object to be cloned.</li>
              <li>Let <var>cloned timing</var> be a new <a>TimingInput</a>
                  object whose members are assigned the value of the attribute
                  with the same name on
                  <code><var>source</var>.specified</code>.</li>
              <li>Let <var>cloned children</var> be an empty sequence of
                  <a>TimedItem</a> objects.</li>
              <li>For each <var>child</var> in
                  <code><var>source</var>.children</code>, append the result
                  of calling <code><var>child</var>.clone()</code>
                  to <var>cloned children</var>.
              <li>Return a new <a>ParGroup</a> object created by
                  calling the <a>ParGroup</a> constructor with parameters
                  <code>ParGroup(<var>cloned children</var>,
                  <var>cloned timing</var>)</code>.</li>
            </ol>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>SeqGroup</code> interface</h3>
        <p>
          <a>Sequence timing groups</a> are
          represented by the <code>SeqGroup</code> interface.
        </p>
        <dl title="interface SeqGroup : TimingGroup"
          class="idl">
          <dt>
          Constructor (sequence&lt;TimedItem&gt;? children,
              optional (unrestricted double or TimingInput)? timing = null)
          </dt>
          <dd>
            The meaning and handling of each of the parameters in this
            constructor is identical to the constructor for
            <a>ParGroup</a>.
          </dd>
          <dt>SeqGroup clone ()</dt>
          <dd>
            <p>
              Creates a deep copy of this <a>SeqGroup</a> object using the same
              procedure as defined for <a
              href="#widl-ParGroup-clone-ParGroup">ParGroup.clone</a> except
              that a new <a>SeqGroup</a> object is created instead of
              a <a>ParGroup</a>.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>Animation</code> interface</h3>
        <p>
          <a>Animations</a> are represented by the
          <code>Animation</code> interface.
        </p>
        <dl title="interface Animation : TimedItem" class="idl">
          <dt>Constructor ()</dt>
          <dd>
            <p>
              Creates a new <a title="Animation interface">Animation</a> object
              using the following procedure:
            </p>
            <ol>
              <li>Create a new <a title="Animation interface">Animation</a>
                  object, <var>animation</var>.</li>
              <li>Set the <code>specified</code> member of <var>animation</var>
                  as follows,
                <dl class="switch">
                  <dt>If <var>timing</var> is a <a>TimingInput</a> object,</dt>
                  <dd>
                    Let <var>timing input</var> refer to <var>timing</var>.
                  </dd>
                  <dt>If <var>timing</var> is a <code>double</code>,</dt>
                  <dd>
                    Let <var>timing input</var> be a new
                    <a>TimingInput</a> object with all members set to their
                    default values and <code>iterationDuration</code> set to
                    <var>timing</var>.
                  </dd>
                  <dt>Otherwise (<var>timing</var> is <code>null</code> or
                      undefined),</dt>
                  <dd>
                    Let <var>timing input</var> be a new <a>TimingInput</a>
                    object with all members set to their default values.
                  </dd>
                </dl>
              </li>
              <li>
                If <var>timing input</var> is set to a <a>TimingInput</a>
                object,
                set <code><var>animation</var>.specified</code> to a new
                <a>Timing</a> object whose attributes are assigned the
                value of the member of the same name on <var>timing input</var>.
              </li>
              <li>Assign the animation effect based on the type of
                <var>effect</var> as follows,
                <dl class="switch">
                  <dt>If <var>effect</var> is an <a>AnimationEffect</a>
                      object or a <a>CustomEffect</a> object,</dt>
                  <dd>
                    Assign <code><var>animation</var>.effect</code> to
                    <var>effect</var>.
                  </dd>
                  <dt>If <var>effect</var> is a <a>OneOrMoreKeyframes</a>,</dt>
                  <dd>
                    Set <code><var>animation</var>.effect</code> to
                    a new <a>KeyframeAnimationEffect</a> object constructed by
                    passing <var>effect</var> as the <var>frames</var> parameter
                    and with the other parameters set to their default values.
                  </dd>
                  <dt>Otherwise,</dt>
                  <dd>
                    Set <code><var>animation</var>.effect</code> to
                    <code>null</code>.
                  </dd>
                </dl>
              </li>
            </ol>
            <p>
              Examples of the usage of this constructor are given in <a
              href="#creating-a-new-animation-object" class="sectionRef"></a>.
            </p>
            <div class="note">
              <p>
                Note that as with <a
                href="#widl-ctor-TimingEvent--DOMString-type-TimingEventInit-eventInitDict">the
                constructor for <a>TimingGroup</a></a>s
                it is possible to pass in a <a>Timing</a> object here (e.g. the
                <code>specified</code> member of another <a>TimedItem</a>) in
                which case it will be cloned.
              </p>
            </div>
            <dl class="parameters">
              <dt>AnimationTarget? element</dt>
              <dd>
                The <a>target element</a> or target pseudo-element.
                This may be <code>null</code> for animations that do not target
                a specific element.
              </dd>
              <dt>(AnimationEffect or CustomEffect or OneOrMoreKeyframes)? effect</dt>
              <dd>
                The animation effect used to set the <code>effect</code>
                attribute of the newly-created <a title="Animation
                interface">Animation</a> object.
                <p>
                  If this parameter is an <a>AnimationEffect</a> object or
                  <a>CustomEffect</a> object, it will shared with any
                  other <a title="Animation interface">Animation</a> objects
                  referring to the same <a>AnimationEffect</a> or
                  <a>CustomEffect</a> object.
                  It will <em>not</em> be copied.
                </p>
                <p>
                  If this parameter of type <a>OneOrMoreKeyframes</a>,
                  the <a>animation effect</a> of the newly-created
                  <a title="Animation interface">Animation</a> will be
                  a newly-created <a>KeyframeAnimationEffect</a> object
                  initialized by using this object as the list of
                  <a>keyframes</a> and with all other parameters set to their
                  default values.
                </p>
                <p>
                  If this parameter is <code>null</code>, the newly-created
                  <a title="Animation interface">Animation</a> will also have
                  a <code>null</code> animation effect.
                </p>
              </dd>
              <dt>optional (unrestricted double or TimingInput)? timing = null</dt>
              <dd>
                <p>
                  The timing properties or <a>iteration duration</a> of the new
                  animation.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>attribute (AnimationEffect or CustomEffect)? effect</dt>
          <dd>
            <p>
              The <a>animation effect</a> or <a>custom effect</a> to apply.
              May be <code>null</code> in which case the animation will produce
              no noticeable effect other than dispatching events (see <a
              href="#timing-events" class="sectionRef"></a>).
            </p>
          </dd>
          <dt>readonly attribute AnimationTarget? target</dt>
          <dd>
            <p>
              The element or pseudo-element being animated by this object.
              This may be <code>null</code> for animations that do not target
              a specific element such as an animation that produces a sound
              using an audio API.
            </p>
            <p class="note">
              Note that in a future version <a>AnimationTarget</a> may be
              extended to allow targetting, for example, a sequence of elements.
              Therefore, code that is intended to be used with arbitrary
              <a>Animation</a> objects should test the concrete type of
              <code>target</code> before using it and not assume that it refers
              to an Element.
            </p>
            <p class="issue">
              If SVG is extended to allow multiple targets (using, e.g.,
              <code>select="rect"</code>) then it might be most natural to
              represent that in the API but allowing the <code>target</code> to
              refer to multiple elements.
              It's something that deserves attention for version 1.
            </p>
            <dt>Animation clone ()</dt>
            <dd>
              <p>
                Creates a copy of this <a title="Animation
                interface">Animation</a> object using the following procedure.
              </p>
              <ol>
                <li>Let <var>source</var> be a the <a
                    title="Animation interface">Animation</a> object to
                    clone, that is, this object.</li>
                <li>Let <var>cloned timing</var> be a new <a>TimingInput</a>
                    object whose members are assigned the value of the attribute
                    with the same name on
                    <code><var>source</var>.specified</code>.</li>
                <li>
                  The <a>AnimationEffect</a> is cloned depending on the type of
                  <code><var>source</var>.effect</code> as follows,
                  <dl class="switch">
                    <dt>If <code><var>source</var>.effect</code> is an
                        <a>Animation</a> object,</dt>
                    <dd>
                      Let <var>cloned effect</var> be the result of calling
                      <code><var>source</var>.effect.clone()</code>.
                    </dd>
                    <dt>If <code><var>source</var>.effect</code> is a
                        <a>CustomEffect</a> object,</dt>
                    <dd>
                      If <code><var>source</var>.effect</code> has a method
                      called <code>clone</code> let <var>cloned effect</var> be
                      the result of calling that method, otherwise let
                      <var>cloned effect</var> be
                      <code><var>source</var>.effect</code>.
                    </dd>
                    <dt>Otherwise,</dt>
                    <dd>
                      Let <var>cloned effect</var> be <code>null</code>.
                    </dd>
                  </dl>
                </li>
                <li>Return a new <a>Animation</a> object created by
                    calling the <a
                    href="#widl-ctor-Animation--AnimationTarget-element--AnimationEffect-or-CustomEffect-or-OneOrMoreKeyframes--effect--unrestricted-double-or-TimingInput--timing">Animation
                    constructor</a> with parameters
                    <code>Animation(<var>source</var>.target, <var>cloned
                    effect</var>, <var>cloned timing</var>)</code>.</li>
              </ol>
            </dd>
          </dd>
        </dl>
        <section class="informative">
          <h4>Creating a new <code>Animation</code> object</h4>
          <p>
            The <a>Animation</a> constructor offers a number of approaches to
            creating a new <a>Animation</a> object.
            At its simplest, an <a>Animation</a> object that changes the
            &lsquo;left&rsquo; property of <var>elem</var> to 100 over three
            seconds can be achieved as follows:
          </p>
          <pre class='example sh_javascript'>
var anim = new Animation(elem, { left: '100px' }, 3);
          </pre>
          <p>
            The second parameter, representing the animation effect, may specify
            multiple properties, an <a>AnimationEffect</a> object, or even
            a callback object.
          </p>
          <pre class='example sh_javascript'>
// Specify multiple properties at once
var animA = new Animation(elem, { left: '100px', top: '300px' }, 3);

// Specify multiple frames
var animA = new Animation(elem, [ { left: '100px' } , { left: '300px' } ], 3);

// Share the animation effect of another animation
var animB = new Animation(elem, animA.effect, 3);

// Supply a specialized animation effect
var animC = new Animation(elem, new PathAnimationEffect( ... ), 3);

// Supply a custom script-based animation effect
var animC = new Animation(elem,
  { 
    sample: function(time) { 
      if (time !== null) {
        document.documentElement.currentScale = 1.0 + time * 2.0;
      } else {
        document.documentElement.currentScale = 1.0;
      }
    },
    clone: function { return this; }
  }, 3);
          </pre>
          <p class="todo">
            Fill in the parameters for <a>PathAnimationEffect</a> above once
            we have decided on them.
          </p>
          <p>
            The third parameter representing the animation's timing, may
            simply be a number representing the <a>iteration duration</a> as
            above, or, to specify further timing properties such as the <a
            title="timed item playback rate">playback rate</a>,
            a <a>TimingInput</a> can be used as follows:
          </p>
          <pre class='example sh_javascript'>
var anim =
  new Animation(elem, { left: '100px' }, { iterationDuration: 3, playbackRate: 2 });
          </pre>
          <p>
            It is also possible to omit the timing parameter altogether in which
            case default timing values will be used.
            Since the <a>intrinsic iteration duration</a> of an animation is
            zero, and the default <code>fillMode</code> when constructing an
            <a>Animation</a> is <span class="prop-value">forwards</span>, it is
            possible to create animations that simply set a property without
            any interpolation as follows,
          </p>
          <pre class='example sh_javascript'>
new Animation(elem, { display: 'none' });
          </pre>
          <p>
            This is particularly useful in combination with other <a
            title="animation">animations</a> or <a>timed
            items</a>.
            For example, fading an element before switching
            &lsquo;display&rsquo; to &lsquo;none&rsquo; can be achieved as
            follows,
          </p>
          <pre class='example sh_javascript'>
new SeqGroup(
  [
    new Animation(elem, { opacity: '0%' }, 1),
    new Animation(elem, { display: 'none' })
  ]
);
          </pre>
          <p>
            Having created an <a title="Animation interface">Animation</a>, it
            can be played using
            <code>document.timeline.play(<var>anim</var>)</code>.
            For simple effects, the <a
            href="#extensions-to-the-element-interface"><code>Element.animate</code></a>
            shortcut is more convenient since it performs this last step
            automatically.
          </p>
        </section>
      </section>
      <section>
        <h3>The <code>PseudoElementReference</code> interface</h3>
        <p class="issue">
          We should replace this with the <a
          href="http://dev.w3.org/csswg/cssom/#the-pseudoelement-interface"><code>PseudoElement</code></a>
          from CSSOM unless it gets dropped.
        </p>
        <p>
          Since <a>animations</a> may also target
          pseudo-elements, Web Animations API introduces the
          <a>PseudoElementReference</a> interface to represent such targets.
        </p>
        <dl title="interface PseudoElementReference" class="idl">
          <dt>Constructor (Element element, DOMString pseudoElement)</dt>
          <dd>
            Creates a new pseudo-element reference using <var>element</var> as
            the <a
            href="http://www.w3.org/TR/css3-selectors/#subject">subject</a>
            and <var>pseudoElement</var> as the pseudo-element to match (e.g.
            &lsquo;<code>::first-line</code>&rsquo;).
          </dd>
          <dt>attribute Element element</dt>
          <dd>
            The element used as the <a
            href="http://www.w3.org/TR/css3-selectors/#subject">subject</a> for
            matching a pseudo-element.
            <p>Exceptions:</p>
            <dl class="exceptions">
              <dt>DOMException of type
                  <code>NoModificationAllowedError</code></dt>
              <dd>
                Raised on setting if this object is a readonly object.
              </dd>
            </dl>
          </dd>
          <dt>attribute DOMString pseudoElement</dt>
          <dd>
            The pseudo-element including the initial colon(s). For example,
            &lsquo;<code>::after</code>&rsquo;.
            <p>Exceptions:</p>
            <dl class="exceptions">
              <dt>DOMException of type
                  <code>NoModificationAllowedError</code></dt>
              <dd>
                Raised on setting if this object is a readonly object.
              </dd>
            </dl>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>AnimationTarget</code> typedef</h3>
        <div class="idl"
          title="typedef (Element or PseudoElementReference) AnimationTarget">
          For simplicity, throughout this specification <a>AnimationTarget</a>
          is used wherever either an <a>Element</a> or
          a <a>PseudoElementReference</a> can be used.
        </div>
      </section>
      <section>
        <h3>The <code>AnimationEffect</code> interface</h3>
        <p>
          <a>Animation effects</a> are represented by
          the <code>AnimationEffect</code> interface.
          <a>AnimationEffect</a> is an abstract interface of which several
          concrete subinterfaces are provided.
        </p>
        <dl title="interface AnimationEffect" class="idl">
          <dt>attribute AccumulateOperation accumulate</dt>
          <dd>
            <p>
              The <a>accumulation operation</a> property of this <a>animation
              effect</a> as specified by one of the <a>AccumulateOperation</a>
              constants.
            </p>
          </dd>
          <dt>AnimationEffect clone ()</dt>
          <dd>
            <p>
              Creates and returns a new object of the same type as this object's
              most-derived interface such that it will produce the same output
              as this object.
            </p>
            <p class="todo">
              We either need a more rigorous definition here or (probably
              better) a sets of steps on a per-subclass basis.
            </p>
          </dd>
        </dl>
        <div class="annotation">
          In future, we may expose <code>any sample (double?  timeFraction,
          double currentIteration, AnimationTarget? target, any
          underlyingValue)</code> so that the animation effects can be driven
          apart from the timing model.
        </div>
      </section>
      <section>
        <h3>The <code>AccumulateOperation</code> enumeration</h3>
        <p>
          The possible values of an <a>animation effect</a>'s
          <a>accumulation</a> behavior are represented by the
          <a>AccumulateOperation</a> enumeration.
        </p>
        <dl title="enum AccumulateOperation" class="idl">
          <dt>sum</dt>
          <dd>
            Corresponds to the <a
            title="accumulation operation sum">sum</a>
            accumulation operation value such that
            subsequent iterations of an <a>animation</a> build on the final
            value of the previous iteration.
          </dd>
          <dt>none</dt>
          <dd>
            Corresponds to the <a
            title="accumulation operation none">none</a>
            accumulation operation value such that the <a>intermediate animation
            value</a> produced is independent of the <a>current iteration</a>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>CompositeOperation</code> enumeration</h3>
        <p>
          The possible values of an <a>animation effect</a>'s
          composition behavior are represented by the
          <a>CompositeOperation</a> enumeration.
        </p>
        <dl title="enum CompositeOperation" class="idl">
          <dt>replace</dt>
          <dd>
            Corresponds to the <a
            title="composition operation replace">replace</a>
            <a>composition operation</a> value such that
            the <a>animation effect</a> overrides the <a>base value</a> it is
            combined with.
          </dd>
          <dt>add</dt>
          <dd>
            Corresponds to the <a
            title="composition operation add">add</a>
            <a>composition operation</a> value such that
            the <a>animation effect</a> is <a title="addition">added</a> to
            <a>base value</a> it is combined with.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>KeyframeAnimationEffect</code> interface</h3>
        <p>
          <a>Keyframe animation effects</a> are represented by the
          <a>KeyframeAnimationEffect</a> interface.
        </p>
        <dl title="interface KeyframeAnimationEffect : AnimationEffect"
          class="idl">
          <dt>Constructor ()</dt>
          <dd>
            <p>
              Creates a new <a>KeyframeAnimationEffect</a> object for the
              given set of keyframes.
            </p>
            <p>
              Before storing, each of the keyframes in <var>frames</var> is
              normalized using the procedure in <a
              href="#normalizing-a-keyframe-object" class="sectionRef"></a>.
            </p>
            <dl class="parameters">
              <dt>OneOrMoreKeyframes frames</dt>
              <dd>
                The set of <a>keyframes</a> used for calculating animation
                values for this <a>animation effect</a>.
                The constraints on this parameter and its processing are
                indentical as with <code>setFrames</code>.
              </dd>
              <dt>optional CompositeOperation composite = "replace"</dt>
              <dd>
                The <a>composition operation</a> used to composite this
                animation with the <a>animation stack</a>, as specified by one
                of the <a>CompositeOperation</a> enumeration values.
                This is used for all keyframes that do not specify
                a <a>composition operation</a>.
              </dd>
              <dt>optional AccumulateOperation accumulate = "none"</dt>
              <dd>
                The <a>accumulation operation</a> used to define the way
                animation values build from iteration to iteration.
              </dd>
            </dl>
          </dd>
          <dt>attribute CompositeOperation composite</dt>
          <dd>
            <p>
              The <a>composition operation</a> used to composite this animation
              with the <a>animation stack</a>, as specified by one of the
              <a>CompositeOperation</a> enumeration values.
            </p>
            <p>
              This is used for all keyframes that do not specify
              a <a>composition operation</a>.
            </p>
          </dd>
          <dt>sequence&lt;Keyframe&gt; getFrames()</dt>
          <dd>
            <p>
              Returns the <a>keyframes</a> that make up this effect as
              a sequence of <a>Keyframe</a> objects.
            </p>
            <p>
              Note that the normalization applied to the <em>list</em> of
              <a>keyframes</a> as defined in <a
              href="#normalizing-the-list-of-keyframes"
              class="sectionRef"></a> does not affect the value returned by this
              method.
            </p>
          </dd>
          <dt>void setFrames(OneOrMoreKeyframes frames)</dt>
          <dd>
            <p>
              Replaces the set of <a>keyframes</a> that make up this effect.
            </p>
            <p>
              Upon setting, each keyframe in <var>frames</var> is normalized
              using the procedure in <a href="#normalizing-a-keyframe-object"
              class="sectionRef"></a> before storing.
            </p>
            <p>
              Before being used by the animation model, the set of frames
              associated with this effect is normalized using the procedure
              defined in <a
              href="#normalizing-the-list-of-keyframes" class="sectionRef"></a>.
            </p>
            <p>
              As a result of the normalization of the list, if <var>frames</var>
              is not <a>loosely sorted by offset</a> this effect will not
              contribute to the final <a>composited value</a>.
            </p>
          </dd>
        </dl>
        <section>
          <h4>Normalizing the list of keyframes</h4>
          <div class="issue">
            This behavior is expected to be revised such that keyframe lists
            that are not in sequence are accepted and keyframe offsets outside
            the range [0, 1] are also allowed.
            Doing so may make this procedure unnecessary.
          </div>
          <p>
            Before passing the list of <a
            title="Keyframe interface">Keyframes</a> specified in the API to the
            animation model so that the <a>unaccumulated animation value</a> can
            be calculated (see <a
            href="#the-unaccumulated-animation-value-of-a-keyframe-animation-effect"
            class="sectionRef"></a>), the following normalization is performed.
          </p>
          <ol>
            <li>Let <var>normalized keyframes</var> be a copy of the
                <a>keyframe</a> list returned by <code>getFrames</code>.
            <li>If <var>normalized keyframes</var> is not <a>loosely sorted by
                offset</a>, return an empty list.
            <li>If there exist any <a>keyframes</a> whose specified positional
                offset is less than zero, remove all <a>keyframes</a> from the
                start of <var>normalized keyframes</var> up to and including the
                <a>keyframe</a> with the largest specified positional offset
                that is still less than zero.
            <li>Likewise, if there exist any <a>keyframes</a> whose specified
                offset is greater than one, remove all <a>keyframes</a> from
                <a>keyframe</a> with the smallest specified positional offset
                that is still greater than one until the end of
                <var>normalized keyframes</var>.
            <li>Set the <a title="positional offset of a keyframe">positional
                offset</a> of any keyframes without a specified offset using the
                procedure defined in <a
                href="#procedure-for-evenly-distributing-keyframes"
                class="sectionRef"></a>.
            <li>Remove all property values in <var>normalized keyframes</var>
                that are invalid or not supported by the implementation.
            <li>For each <a>keyframe</a> in <var>normalized keyframes</var>,
                if there are two or more properties for the same property,
                remove all but the last property value for each property.
            <li>Return <var>normalized keyframes</var>.
          </ol>
          <div class="note">
            <p>
              Note that this normalization is only applied to the keyframes
              before they are passed to the model and does not affect the result
              returned by <code>getFrames</code>.
            </p>
          </div>
        </section>
      </section>
      <section>
        <h3>The <code>Keyframe</code> dictionary</h3>
        <p>
          Individual <a>keyframes</a> are represented by a special kind of
          <a title="Keyframe interface">Keyframe</a> dictionary type whose
          members map to the properties to be animated.
          At the time of writing, this kind of open-ended dictionary is not able
          to be represented using WebIDL and hence special
          ECMAScript-specific handling for this type is defined in
          <a href="#normalizing-a-keyframe-object" class="sectionRef"></a>.
          No handling is defined for other languages.
        </p>
        <dl class="idl" title="dictionary Keyframe">
          <dt>// ... property-value pairs ...</dt><dd></dd>
          <dt>double? offset = null</dt>
          <dd>
            <p>
              The <a title="positional offset of a keyframe">positional
              offset</a> of the <a>keyframe</a> specified as a number between
              0.0 and 1.0 inclusive or <code>null</code>.
            </p>
            <p>
              <a>Keyframes</a> with offsets outside the range [0.0, 1.0] are
              ignored when calculating animation values as defined in
              <a href="#normalizing-the-list-of-keyframes"
              class="sectionRef"></a>.
            </p>
            <p>
              A <code>null</code> value indicates that the <a>keyframe</a>
              should be positioned automatically using the algorithm defined in
              <a href="#procedure-for-evenly-distributing-keyframes"
              class="sectionRef"></a> and applied in
              <a href="#normalizing-the-list-of-keyframes"
              class="sectionRef"></a>.
            </p>
          </dd>
          <dt>CompositeOperation? composite = null</dt>
          <dd>
            <p>
              The <a>composition operation</a> used to combine the values
              specified in this keyframe with the <a>underlying value</a>.
            </p>
            <p>
              If <code>null</code>, the <a>composition operation</a>
              specified on the <a>KeyframeAnimationEffect</a> will be used.
            </p>
          </dd>
        </dl>
        <section>
          <h4>Normalizing a <code>Keyframe</code> object</h4>
          <div class="note">
            <p>
              Since accessing the properties of an ECMAScript user object can
              have side effects, the manner in which these properties is
              accessed is important.
              In light of this consideration the procedure for normalizing
              a <a>Keyframe</a> has the following properties:
            </p>
            <ul>
              <li>Every property is read only once.</li>
              <li>Properties are read in a well-defined order.</li>
              <li>Properties corresponding to unsupported target properties or
                  attributes are not read.</li>
            </ul>
          </div>
          <p>
            A <a>Keyframe</a> object, <var>keyframe input</var>, is
            converted to a normalized internal representation <var>keyframe
            result</var> using the following procedure:
          </p>
          <ol>
            <li>Let the initial <a
                title="positional offset of a keyframe">positional offset</a>
                of <var>keyframe result</var> be <code>null</code>.
            <li>Let the initial <a>composition operation</a>
                of <var>keyframe result</var> be <code>null</code>.
            <li>Create a list, <var>supported properties</var>, of property
                names and attribute names that <a title="animatable">can be
                animated</a> by the implementation.
            <li>Convert each property name in <var>supported properties</var>
                to the equivalent IDL attribute by applying the <a
                href="http://dev.w3.org/csswg/cssom/#css-property-to-idl-attribute">CSS
                property to IDL attribute</a> algorithm [[!CSSOM]].
            <li>If the user agent supports animation of the <span
                class="prop-name">float</a> CSS property, replace 'float' in
                <var>supported properties</var> with 'cssFloat'.
            <li>Let <var>animation properties</var> be an empty sequence.
            <li>Iterate over the properties of <var>keyframe input</var>.
                For each <var>property</var> in <var>keyframe input</var>,
                perform the step corresponding to the first matching condition
                from below, if any.
              <dl class="switch">
                <dt>If <var>property</var> is a case-sensitive match for
                  the string 'offset',</dt>
                <dd>
                  If <code><var>keyframe input</var>.offset</code> is
                  a Number, set the <a
                  title="positional offset of a keyframe">positional offset</a>
                  of <var>keyframe input</var> to 
                  <code><var>keyframe input</var>.offset</code>.
                </dd>
                <dt>if <var>property</var> is a case-sensitive match for
                  the string 'composite',</dt>
                <dd>
                  If <code><var>keyframe input</var>.composite</code> is
                  a case-sensitive match for one of the values of the
                  <a>CompositeOperation</a> enumeration,
                  set the <a>composition operation</a>
                  of <var>keyframe input</var> to 
                  <code><var>keyframe input</var>.composite</code>.
                </dd>
                <dt>Otherise, if <var>property</var> also exists in
                  <var>supported properties</var> based on a case-sensitive
                  comparison,</dt>
                <dd>append <var>property</var> to <var>animation
                  properties</var>.</dd>
              </dl>
            <li>For user agents that support both a prefixed and an
                unprefixed version of some CSS properties, remove all
                prefixed properties from <var>animation properties</var>
                where the corresponding unprefixed version is also
                present in <var>animation properties</var>.
            <li>Sort <var>animation properties</var> lexicographically by
                the Unicode codepoints that define each element.
            <li>Iterate over <var>animation properties</var> and for each
                element, <var>name</var>, add a new property-value pair to
                <var>keyframe result</var> as follows:
              <ul>
                <li><em>property name</em>: the result of applying the
                    the <a
                href="http://dev.w3.org/csswg/cssom/#idl-attribute-to-css-property">IDL
                    attribute to CSS property</a> algorithm [[!CSSOM]] to
                    <var>name</var> unless <var>name</var> is
                    a case-sensitive match for the string 'cssFloat' in
                    which case use the string 'float'.
                <li><em>property value</em>: the result of calling
                    <code>toString</code> on the <var>name</var> property of
                    <var>keyframe input</var>.
              </ul>
            <li>Return <var>keyframe result</var>.
          </ol>
          <p>
            This procedure is performed exactly once per call to
            <code>setFrames</code> or the constructor for
            <a>KeyframeAnimationEffect</a>.
          </p>
          <div class="issue">
            <p>
              The above algorithm gives special meaning to the property names
              'offset' and 'composite'.
              If a CSS property called 'offset' or 'composite' is ever
              introduced it will clash with the meaning here.
            </p>
            <p>
              We have a few options:
            </p>
            <ul>
              <li>Add special handling at that time to allow addressing the
                  property of the same name, e.g. <code>cssOffset</code>.
              <li>Rename these keywords now to avoid risk of a later clash,
                  e.g. 'keyframeOffset'.
                  (For consistency this should also be extended to the name of
                  the member of the <a>Keyframe</a> dictionary).
            </ul>
          </div>
        </section>
      </section>
      <section>
        <h3>The <code>OneOrMoreKeyframes</code> typedef</h3>
        <div class="idl"
          title="typedef (Keyframe or sequence&lt;Keyframe&gt;) OneOrMoreKeyframes">
          Throughout this specification we use the <a>OneOrMoreKeyframes</a>
          type to represent either a single keyframe or a list of such
          keyframes.
        </div>
      </section>
      <section>
        <h3>The <code>PathAnimationEffect</code> interface</h3>
        <p>
          <a>Path animation effects</a> are
          represented by the <a>PathAnimationEffect</a> interface.
        </p>
        <p class="todo">
          <a>Path animation effects</a> themselves
          are yet to be defined, and much more so this interface.
        </p>
        <dl title="[Constructor] interface PathAnimationEffect
          : AnimationEffect" class="idl">
          <dt>attribute CompositeOperation composite</dt>
          <dd>
            The <a>composition operation</a> used to composite this animation
            with the <a>animation stack</a>, as specified by one of the
            <a>CompositeOperation</a> enumeration values.
          </dd>
          <dt>attribute SVGPathSegList segments</dt>
          <dd>
            The list of segments that make up this path.
          </dd>
          <dt>attribute boolean rotate</dt>
          <dd>
            True if objects animating along this path should be rotated
            such that their positive x axis is aligned with the direction of
            movement along the path.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>CustomEffect</code> callback interface</h3>
        <p>
          <a>Custom effects</a> can be defined in script
          using the <a>CustomEffect</a> interface.
        </p>
        <div title="callback interface CustomEffect" class="idl">
          <dt>attribute long? priority</dt>
          <dd>
            The <a>custom effect priority</a> property of the effect (see <a
            href="#execution-order-of-custom-effects" class="sectionRef"></a>).
          </dd>
          <dt>attribute CustomEffectCloneCallback? clone</dt>
          <dd>
            <p>
              An optional callback method used to create an independent copy of
              this object.
            </p>
          </dd>
          <dt>void sample ()</dt>
          <dd>
            The callback used to produce an effect for the given timing
            information.
            <dl class="parameters">
              <dt>double? timeFraction</dt>
              <dd>
                The <a>time fraction</a> for which to produce an effect.
                When this is <code>null</code>, the callback object SHOULD
                remove the effect.
              </dd>
              <dt>double currentIteration</dt>
              <dd>
                The <a>current iteration</a> beginning with zero corresponding
                to the first iteration.
              </dd>
              <dt>AnimationTarget? target</dt>
              <dd>
                The element or pseudo-element to which the effect should be
                applied, if any.
                When this method is called as a result of this object being
                associated with an <a>Animation</a> object <var>A</var>, this
                value will be <code><var>A</var>.target</code>.
              </dd>
              <dt>double? previousTimeFraction</dt>
              <dd>
                <p>
                  The value of <var>timeFraction</var> that was passed to this
                  <a>CustomEffect</a> when <code>sample</code> was previously
                  called in the context of sampling the same <a>Animation</a>
                  that generated the current call.
                </p>
                <p>
                  If this <a>CustomEffect</a> has not previously been called
                  within the context of sampling the same <a>Animation</a> as
                  with the current call, or if the <a>time fraction</a> was
                  <code>null</code> on the previous call, this parameter will be
                  <code>null</code>.
                </p>
              </dd>
            </dl>
          </dd>
        </div>
        <p class="issue">
          Do we need to pass the <a>Animation</a> to <code>sample</code> as
          well?
          If possible I'd prefer not to but it may necessary for some types of
          effect.
          Might be an additional parameter to add later if it proves
          necessary?
        </p>
        <div title="callback CustomEffectCloneCallback = CustomEffect ()" class="idl">
          <p>
            <a>CustomEffectCloneCallback</a> is a type of callback function used
            to create an independent copy of a <a>CustomEffect</a>.
          </p>
          <p>
            When called, the <a
            href="http://www.w3.org/TR/WebIDL/#dfn-callback-this-value">callback
            this value</a> refers to <a>CustomEffect</a> object to be cloned.
          </p>
        </div>
      </section>
      <section>
        <h3>The <code>TimingEvent</code> interface</h3>
        <dl title="interface TimingEvent : Event" class="idl">
          <dt>Constructor
              (DOMString type, optional TimingEventInit eventInitDict)</dt>
          <dd>
            Constructs a new <a>TimingEvent</a> object as described in <a
            href="http://www.w3.org/TR/dom/#constructing-events">Constructing
            events</a> in [[!DOM4]].
          </dd>
          <dt>attribute double? localTime</dt>
          <dd>
            <p>
              The <a>event local time</a>.
            </p>
            <p class="annotation">
              This is the same time space used for <code>startTime</code> and
              <code>endTime</code> on <a>TimedItem</a>.
              This is the most useful time space if, for example, you receive
              a <a>timing event</a> and want to add a new animation that
              synchronizes with the item that dispatched the event by adding it
              to the same <a>timing group</a>.
            </p>
          </dd>
          <dt>attribute double? timelineTime</dt>
          <dd>
            <p>
              The <a>event timeline time</a>.
            </p>
            <div class="annotation">
              I think timeline time will be much more useful than global time.
              For the rarer case that you want to synchronize animations
              between documents using events, methods on <a>Timeline</a> will
              assist the conversion.
            </div>
          </dd>
          <dt>attribute unsigned long? iterationIndex</dt>
          <dd>
            The <a>event iteration index</a>.
          </dd>
          <dt>attribute boolean? seeked</dt>
          <dd>
            The <a>seeked dispatch flag</a>.
          </dd>
        </dl>
        <p>
          The <a>TimingEventInit</a> dictionary type is used to specify the
          parameters when constructing a <a>TimingEvent</a> object.
        </p>
        <dl title="dictionary TimingEventInit" class="idl">
          <dt>double? localTime = null</dt>
          <dd></dd>
          <dt>double? timelineTime = null</dt>
          <dd></dd>
          <dt>double? iterationIndex = null</dt>
          <dd></dd>
          <dt>boolean? seeked = null</dt>
          <dd></dd>
        </dl>
      </section>
      <section>
        <h3>Extensions to the <code>Document</code> interface</h3>
        <p>
          The following extensions are made to the <a
          href="http://www.w3.org/TR/dom/#interface-document">Document
          interface</a> defined in [[!DOM4]].
        </p>
        <dl title="partial interface Document" class="idl">
          <dt>readonly attribute Timeline timeline</dt>
          <dd>
            The <a title="Timeline interface">Timeline</a> object representing
            the <a>document timeline</a>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Extensions to the <code>Element</code> interface</h3>
        <p>
          To simplify the creation of <a>Animation</a> objects for a given
          Element, the <a class="externalDFN"
          href="http://www.w3.org/TR/dom/#interface-element">Element</a>
          interface [[!DOM4]] is extended as follows:
        </p>
        <dl class="idl" title="partial interface Element">
          <dt>Animation animate()</dt>
          <dd>
            <p>
              Creates a new <a title="Animation interface">Animation</a> object
              whose <a>target element</a> is the Element object on which the
              method is called, and calls
              the <a
              href="#widl-Timeline-play-Player-TimedItem-source"><code>play</code></a>
              method of the <a title="Timeline interface">Timeline</a> object of
              the <a>document timeline</a> of the <a
              href="http://www.w3.org/TR/dom/#concept-node-document">node
              document</a> [[!DOM4]] of the element passing the newly created
              <a title="Animation interface">Animation</a> as the argument to
              the method.
            </p>
            <p>
              The following code fragment:
            </p>
            <pre class="example sh_javascript">
              var anim = elem.animate({ opacity: '0' }, 2);
            </pre>
            <p>
              is equivalent to:
            </p>
            <pre class="example sh_javascript">
              var anim = new Animation(elem, { opacity: '0' }, 2);
              elem.ownerDocument.timeline.play(anim);
            </pre>
            <p>
              Returns the newly created <a
              title="Animation interface">Animation</a> object.
            </p>
            <dl class="parameters">
              <dt>(AnimationEffect or CustomEffect or OneOrMoreKeyframes)? effect</dt>
              <dd>
                The effect to apply.
                This value is passed to the <a
                href="#widl-ctor-Animation--AnimationTarget-element--AnimationEffect-or-CustomEffect-or-OneOrMoreKeyframes--effect--unrestricted-double-or-TimingInput--timing">Animation
                constructor</a> as the <var>effect</var> parameter and has the
                same interpretation as defined for that constructor.
              </dd>
              <dt>optional (double or TimingInput)? timing = null</dt>
              <dd>
                The timing parameters of the animation.
                This value is passed to the <a
                href="#widl-ctor-Animation--AnimationTarget-element--AnimationEffect-or-CustomEffect-or-OneOrMoreKeyframes--effect--unrestricted-double-or-TimingInput--timing">Animation
                constructor</a> as the <var>timing</var> parameter and has the
                same interpretation as defined for that constructor.
              </dd>
            </dl>
          </dd>
          <dt>sequence&lt;Animation&gt; getCurrentAnimations()</dt>
          <dd>
            <p>
              Returns the set of <a>current</a> <a title="Animation
              interface">Animation</a> objects that have an <a>animation
              effect</a> whose <a>target</a> is this Element.  Note that this
              does <em>not</em> include <a>PseudoElementReference</a>s whose
              <code>element</code> attribute refers to this Element.
            </p>
            <p>
              The returned list of <a title="Animation interface">Animation</a>
              objects is sorted by their associated <a>animation effect</a>
              using the procedure defined for sorting <a>animation effects</a>
              in <a href="#the-animation-stack" class="sectionRef"></a>.
            </p>
            <div class="note">
              <p>
                Note that the definition of a <a>current</a> <a>animation</a>
                does not include those <a>animations</a> whose
                <a>local time</a> falls <em>after</em> the <a>active
                interval</a> but which are still <a>in effect</a> due to
                a <a>fill mode</a> and hence such <a
                title="animation">animations</a> are <em>not</em> returned by
                this method.
              </p>
              <p>
                This is because in order to return such <a
                title="animation">animations</a>, user agents
                would be required to maintain all <a
                title="animation">animations</a> with a forwards
                <a title="fill mode">fill</a> indefinitely.
                As a result the resources consumed by an animated document would
                steadily accumulate over time.
              </p>
            </div>
          </dd>
          <dt>sequence&lt;Player&gt; getCurrentPlayers()</dt>
          <dd>
            <p>
              Returns the set of <a title="Player interface">Player</a> objects
              whose <a>source content</a> is <a>current</a> and contains at
              least one <a>animation</a> whose <a>target element</a> is this
              Element.
            </p>
            <p>
              If this Element is the <a>target element</a> of two or more <a
              title="animation">animations</a> which are associated with the
              same <a>player</a>, the corresponding <a
              title="Player interface">Player</a> object will still only appear
              in the returned list once.
            </p>
            <p>
              The returned list is sorted using the same order as defined for
              the <a
              href="#widl-Timeline-getCurrentPlayers-sequence-Player">getCurrentPlayers</a>
              method on the <a title="Timeline interface">Timeline</a>
              interface.
            </p>
            <div class="feedbackWanted">
              <p>
                The primary use case for this method is an application that
                wants to increase the speed of all animations targetting
                a particular element by a factor of 2 (not sure why and never
                mind that this will affect all sorts of other elements too).
              </p>
              <p>
                With only <code>getCurrentAnimations</code> a naïve author might
                write:
              </p>
              <pre class="example sh_javascript">
                elem.getCurrentAnimations().forEach(
                  function(anim) {
                    anim.player.playbackRate *= 2;
                  }
                );
              </pre>
              <p>
                However, if <code>elem</code> is the <a>target element</a> for
                two animations that have the same player, then those animations
                will be sped up by a factor of 4.
              </p>
              <p>
                Instead the author needs to generate a unique list of players
                first, hence this method.
              </p>
              <p>
                Is this kind of situation common enough to warrant this method?
                Or is it likely that when performing this kind of operation
                you're mostly working with single animations and not timing
                groups (as otherwise this operation could affect many other
                elements)?
              </p>
              <p>
                Your feedback is most welcome at <a
                href="mailto:public-fx@w3.org">public-fx@w3.org</a>, subject
                <em>[web-anim] &hellip;</em>.
              </p>
            </div>
          </dd>
        </dl>
      </section>
      <section>
        <h2>Script execution and live updates to the model</h2>
        <p>
          The iteraction between script execution and the state of
          the model is as follows:
        </p>
        <ul>
          <li>
            <p>
              Changes made to the Web Animations model via the script interface
              are reflected immediately in the values returned by the interfaces
              defined in this specification.
            </p>
            <p>
              Similarly, methods that operate on the current state of the model
              such as pausing or reversing are applied to a fully-updated timing
              model, that is, after all previous modifications have been
              incorporated.
            </p>
            <div class="informative">
              <p>
                For example, if the <a title="Player interface">Player</a>
                associated with an
                <a title="Animation interface">Animation</a>'s is <a
                title="seeking">seeked</a> via the API,
                the value returned when querying the
                animation's <code>startTime</code> will reflect updated state of
                the model immediately.
              </p>
              <pre class="example sh_javascript">
                // Initially anim's startTime is 3
                anim.player.currentTime += 2;
                alert(anim.startTime); // Displays '5'
              </pre>
              <p>
                The same concept applies to more complex modifications of the
                Web Animations model such as adding and removing children from
                a <a>TimingGroup</a>.
              </p>
            </div>
          </li>
          <li>
            <p>
              Changes to the model other than <a
              title="seeking">seek operations</a> do not cause
              <a href="#timing-events">timing events</a> to be queued
              immediately.
              Instead, such events are queued upon the next sample as defined
              in <a href="#event-dispatch" class="sectionRef"></a>.
            </p>
            <p>
              The behavior of events with relation to seek operations is defined
              in <a href="#event-dispatch-and-seeking-a-player"
              class="sectionRef"></a>.
            </p>
            <p>
              Operations such as <a href="#updating-the-playback-rate">updating
              the playback rate of a player</a> involve performing a <a
              title="seeking">seek</a> operation and therefore cause events to
              be queued immediately.
            </p>
            <div class="informative">
              <p>
                For example, if a series of modifications to the timing model in
                a single script block causes a <a>TimedItem</a>'s <a>item
                time</a> to jump from being outside the <a>active interval</a>,
                to inside the interval, and then outside again, no events are
                fired as in the following example.
              </p>
              <pre class="example sh_javascript">
  // anim is due to start in 3s
  anim.onstart = function() { alert("started"); };
  // Accelerate the parent causing anim to enter its active interval
  anim.parent.playbackRate *= 2;
  // Adjust the start delay of anim such that it is no longer in its
  // active interval
  anim.timing.startDelay = Infinity;
  // Result: no alert is shown
              </pre>
            </div>
          </li>
          <li>
            <p>
              Modifications to the model using the script interface do not cause
              the properties of the target element to be updated and nor is any
              <a>CustomEffect</a> called until the next sample has been
              performed at some time after the current script block completes
              execution.
            </p>
            <div class="informative">
              <p>
                For example, if the used style of an element is queried
                immediately after applying a new <a>Animation</a> to that
                element, the result of the new animation will <em>not</em> be
                incorporated in the value returned.
              </p>
              <pre class="example sh_javascript">
                // Set opacity to 0 immediately
                elem.animate({ opacity: '0' });
                alert(window.getComputedStyle(elem).opacity);
                // Displays '1'
              </pre>
            </div>
            <p class="issue">
              I'm unsure if this is the desired behavior for actions such as
              <a>seeking</a> and <code>play()</code> (and thus
              <code>animate()</code>).
              Gecko, for example, forces a synchronous sample when a seek is
              performed.
              This certainly makes testing simpler but I'm not sure if this is
              a good idea or not.
            </p>
          </li>
          <li>
            <p>
              The value returned by the <code>currentTime</code> attribute of
              a <a>document timeline</a> will not change within a script block.
            </p>
            <div class="informative">
              <p>
                For example, querying the <code>currentTime</code> twice within
                a long block of code that is executed in the same script block
                will return the same value as shown in the following example.
              </p>
              <pre class="example sh_javascript">
                var a = document.timeline.currentTime;
                // ... many lines of code ...
                var b = document.timeline.currentTime;
                alert(b - a); // Displays 0
              </pre>
            </div>
            <p class="issue">
              We may introduce timelines that can be started programmatically
              (e.g. for SVG).
              In such a case, the <code>currentTime</code> should probably
              become zero <em>immediately</em> which would violate this
              condition.
              If we do indeed want that then we should probably spec it to force
              a synchronous sample at that point and note it as an exception
              here.
            </p>
          </li>
        </ul>
      </section>
    </section>

    <section>
      <h2>Integration with Media Fragments</h2>
      <p>
        The Media Fragments specification [[!MEDIA-FRAGMENTS]] defines a means
        for addressing a temporal range of a media resource.
        The application of media fragments depends on the MIME type of the
        resource on which they are specified.
        For resources with the <a
        href="http://www.w3.org/TR/SVG/intro.html#MIMEType">SVG MIME type</a>
        [[!SVG11]], the application of temporal parameters is defined in the <a
        href="svg-integration.html">Web Animations and SVG Integration</a>
        specification.
      </p>
      <p class="note">
        Note that media fragments are defined to operate on resources based on
        their MIME type.
        As a result, temporal addressing may not be supported in all situations
        where Web Animations content is used.
      </p>
    </section>

    <section>
      <h2>Interaction with page display</h2>
      <p>
        HTML permits user agents to store <a
          href="http://www.w3.org/TR/html51/browsers.html#an-entry-with-persisted-user-state">user-agent
          defined state</a> along with a
        <a
          href="http://www.w3.org/TR/html51/browsers.html#session-history-entry">session
        history entry</a> so that as a user navigates between pages, the
        previous state of the page can be restored including state such as
        scroll position [[HTML5]].
      </p>
      <p>
        User agents that pause and resume <a
          href="http://www.w3.org/TR/html51/embedded-content-0.html#media-element">media
        elements</a> when the referencing document is
        unloaded and traversed,
        are encouraged to apply consistent handling to documents containing Web
        Animations content.
        If provided, this behavior SHOULD be achieved by applying a time drift
        to any <a>timelines</a> bound to the <a>global clock</a>.
      </p>
    </section>

    <section>
      <h2>Implementation requirements</h2>
      <section>
        <h3>Precision</h3>
        <p class="todo">
          TBD. Need to describe requirements for very large/small values.
        </p>
      </section>
      <section>
        <h3>Conformance criteria</h3>
        <p class="todo">
          Basically, for non-scripted user agents, there are none,
          For scripted user agents, do the API.
        </p>
      </section>
    </section>

    <section class='appendix' id="webidl-ref">
      <h2>Interface summary</h2>
    </section>

    <section class='appendix informative'>
      <h2>Algorithms for path animation effects</h2>
      <p class='todo'>Write me</p>
    </section>

    <section class="appendix informative">
      <h2>Algorithms for event dispatch</h2>
      <p>
        The following algorithms demonstrate a possible approach to handling
        event queuing that incorporates the various requirements outlined in <a
        href="#timing-events" class="sectionRef"></a>.
      </p>
      <p>
        Some of the features of the following approach are:
      </p>
      <ul>
        <li>Sorts only once per timeline.
        <li>Handles cotemporal samples without dispatching duplicate events.
        <li>Handles zero-length intervals.
        <li>Stores sample state only at the <a>player</a> level.
            (The <a>previous active state</a> is still per-<a>timed item</a>
            however.)
            This makes it possible for an implementation to optimize
            the case when there are no registered event listeners on part of the
            timing hierarchy.
            In such a case the whole procedure for determining and dispatching
            events can be skipped for that part of the hierarchy.
            Should event listeners be attached at a later point, the
            state stored at the player can be used to ensure the previously
            ignored timed items begin providing events as if they had always had
            event listeners.
      </ul>
      <section>
        <h3>Interval boundaries and time marks</h3>
        <p>
          With regards to event dispatch, interval boundary conditions are
          particularly important.
          For example, if we were to conduct a <a>sample</a> at time 3s and then
          another sample at 5s, on that second sample we should dispatch all
          events between the two times.
          If a <a>timed item</a> were to start at time 5s, then we
          should dispatch the corresponding <a>timingstart</a> event since that
          time has arrived.
          However, since we will have already dispatched all events at time 3s
          during the previous sample, we should <em>not</em> dispatch any events
          coinciding with time 3s.
        </p>
        <p>
          In other situations, however, such as when getting the events
          scheduled by <a>child timed items</a> within a given iteration, we
          should include <a>timingstart</a> events that coincide with the start
          of the iteration but not <a>timingend</a> events since, under Web
          Animations endpoint-exclusive timing model, those <a>timingend</a>
          events happened fractionally before the iteration started.
          To accommodate these different endpoint behaviors we introduce the
          concept of <a>time marks</a>.
        </p>
        <p>
          A <dfn>time mark</dfn> is a triple consisting of:
        </p>
        <ul>
          <li>a <span class="property">time value</span>,
          <li>a <span class="property">position</span>: <span
            class="position">minus</span>, <span class="position">zero</span>,
            or <span class="position">plus</span>, and
          <li>a Boolean flag indicating if the mark represents the endpoint of
              an interval or not (regardless of which &lsquo;end&rsquo; of the
              interval the mark represents)
        </ul>
        <p>
          We can use subscript notation to indicate these properties.
          For example, <var class="timeMark">t<sub>minus|end</sub></var>.
          If the time mark does not represent an interval endpoint, the
          &lsquo;|end&rsquo; part of the subscript text is dropped, as in
          <var class="timeMark">t<sub>minus</sub></var>.
        </p>
        <p>
          For a given <a>time mark</a>, |<var class="timeMark">t</var>|
          indicates just the <span class="property">time value</span> ignoring
          the other properties, and <var class="timeMark">t<sub>pos</sub></var>
          indicates just the <span class="property">position</span>.
        </p>
        <p>
          The <span class="position">minus</span> position represents a value
          an infinitely small amount less than the <span class="property">time
          value</span> whilst the <span class="position">plus</span> position
          represents a value infinitely small amount greater.
          <span class="position">zero</span> represents the moment at the time
          value.
        </p>
        <p>
          The meaning of these <span class="property">position</span> values is
          not affected by the direction in which playback proceeds.
          We can compare <span class="property">positions</span> and <span
          class="property">time values</span> as follows:
        </p>
        <p>
          For two <a>time marks</a> <var class="timeMark">a</var> and <var
            class="timeMark">b</var>, <var class="timeMark">a</var> is less than
          <var class="timeMark">b</var> if one of the following conditions is
          true:
        </p>
        <ul>
          <li>|<var class="timeMark">a</var>| &lt;
              |<var class="timeMark">b</var>|, or
          <li>|<var class="timeMark">a</var>| =
              |<var class="timeMark">b</var>| and
              <var class="timeMark">a<sub>pos</sub></var> =
              <span class="position">before</span> and
              <var class="timeMark">b<sub>pos</sub></var> &ne;
              <span class="position">before</span>, or
          <li>|<var class="timeMark">a</var>| =
              |<var class="timeMark">b</var>| and
              <var class="timeMark">a<sub>pos</sub></var>=
              <span class="position">zero</span> and
              <var class="timeMark">b<sub>pos</sub></var>=
              <span class="position">after</span>
        </ul>
        <p>
          For two <a>time marks</a> <var class="timeMark">a</var> and <var
            class="timeMark">b</var>, <var class="timeMark">a</var> equals 
          <var class="timeMark">b</var> if
          |<var class="timeMark">a</var>| equals |<var class="timeMark">b</var>|
          and
          <var class="timeMark">a<sub>pos</sub></var> equals
          <var class="timeMark">b<sub>pos</sub></var>.
        </p>
        <p>
          Operations such as greater-than and less-than-or-equal can be
          extrapolated from these definitions.
        </p>
        <p>
          Since these operations only apply to the <span
          class="property">position</span> and <span class="property">time
          value</span> of the <a>time mark</a>, we define
          the <code><a title="first(a,b)">first</a>()</code> and
          <code><a title="last(a,b)">last</a>()</code> operations which are
          for most purposes equivalent to <code>min()</code> and
          <code>max()</code> but in the case where the two arguments are equal,
          it preserves their order.
          Their definitions are as follows.
        </p>
        <ul>
          <li><dfn title="first(a,b)">first</dfn>(<var
              class="timeMark">a</var>,<var class="timeMark">b</var>) =
              <var class="timeMark">a</var> if <var class="timeMark">a</var>
              &le; <var class="timeMark">b</var> and
              <var class="timeMark">b</var> otherwise.
          <li><dfn title="last(a,b)">last</dfn>(<var
              class="timeMark">a</var>,<var class="timeMark">b</var>) =
              <var class="timeMark">a</var> if <var class="timeMark">a</var>
              &gt; <var class="timeMark">b</var> and
              <var class="timeMark">b</var> otherwise.
        </ul>
        <p>
          Given an interval delimited by two <a>time marks</a> <var
          class="timeMark">a</var> and <var class="timeMark">b</var>,
          a time <var>t</var> is <dfn>in the interval <var>ab</var></dfn> if the
          following relationship holds:
          <a title="first(a,b)">first<a>(<var class="timeMark">a</var>,
                                         <var class="timeMark">b</var>)
          &le; <var>t</var>
          &le; <a title="last(a,b)">last<a>(<var class="timeMark">a</var>,
                                            <var class="timeMark">b</var>).
        </p>
        <p>
          A <a>time mark</a> can be added to a <a>time value</a> by simply
          adding the time value components and keeping the <span
          class="property">position</span> and interval
          endpoint state of the <a>time mark</a>.
          Addition of two <a>time marks</a> is not defined.
        </p>
      </section>
      <section>
        <h3>Events when sampling a timeline</h3>
        <p>
          For a <a>timeline</a>, <a>sampled</a> such that the current <a>time
          value</a> is <var>t</var>, the set of <a>timing events</a> to queue
          can be determined as follows:
        </p>
        <ol>
          <li>Iterate over each <a>player</a> in the set of players 
            <!-- <a link="associated with a timeline"> -->
            associated<!-- </a> --> with this
            <a>timeline</a> in the order in which the players were created
            starting from the first created to the last, and for each
            <a>player</a>, perform the steps defined in
            <a href="#event-dispatch-and-unattached-timed-items"
              class="sectionRef"></a>.
          <li>Let <var>events</var> be an empty sequence of <a>timing
              events</a>.
          <li>Iterate over each <a>player</a> in the set of players i
            <!-- <a link="associated with a timeline"> -->
            associated<!-- </a> --> with this
            <a>timeline</a> in the order in which the players were created
            starting from the first created to the last and
            get the <a
            title="partially ordered set of events for a player at timeline time
            t">partially ordered set of events for the player</a> at
            <var>t</var> and append then to <var>events</var>.
          <li>Perform a stable sort on <var>events</var> by <a>event timeline
              time</a> such that earlier times sort first.</li>
          <li>Add <var>events</var> to the event queue in their current
              order.</li>
        </ol>
      </section>
      <section>
        <h3>Events when sampling a player</h3>
        <p>
          The <dfn>partially ordered set of events for a <a>player</a> at
          timeline time <var>t</var></dfn>, can be determined as follows:
        </p>
        <ol>
          <li>Let <var>previous sample mark</var> be a <a>time mark</a>
              associated with the <a>player</a> that is initialized to <span
              class="timeMark">0<sub>zero|end</sub></span> when the
              <a>player</a> is first created.
          <li>Let <var>sample time</var> be the result of calculating the
              <a>player</a>’s <a>current time</a> at timeline time <var>t</var>.
          <li>Let <var>sample mark</var> be <var class="timeMark">sample
              time<sub>plus</sub></var>.
          <li>Let <var>events</var> be an empty sequence of <a>timing
              events</a>.
          <li>
            The events queued depends on whether or not the <a>time adjusted
            flag</a> is set as follows,
            <dl class="switch">
              <dt>If the <a>time adjusted flag</a> of the
                  <a>player</a> is set,</dt>
              <dd>
                <ol>
                  <li>If this <a>player</a> has associated <a>source
                      content</a>, then get the <a
                      title="partially ordered set of events for a timed item seeked to time t">partially
                      ordered set of events scheduled for seek time <var>sample
                      time</var></a> and append them to <var>events</var>.
                  <li>Clear the <a>time adjusted flag</a>.
                </ol>
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                <ol>
                  <li>If this <a>player has associated <a>source content</a>,
                    then get the <a
                    title="partially ordered set of events for a timed item scheduled between time marks a and b">partially
                    ordered set of events scheduled between <var>previous sample
                    mark</var> and <var>sample mark</var></a> and append them to
                    <var>events</var>.
                </ol>
              </dd>
            </dl>
            <div class="note">
              <p>
                Note that this approach should correctly handle consecutive
                samples with the same time value.
              </p>
              <p>
                In such a case, both <var>previous sample mark</var> and
                <var>sample mark</var> will have a <span
                class="property">position</span> of <span
                class="position">plus</span>.
                Since no <a>timing events</a> are scheduled to be
                dispatched at the <span class="position">plus</span> position
                there should be no duplicate events.
              </p>
            </div>
          <li>Set <var>previous sample mark</var> to <var>sample mark</var>.
          <li>Return <var>events</var>.
        </ol>
      </section>
      <section>
        <h3>Events for a timed item during regular sampling</h3>
        <p>
          The <dfn>partially ordered set of events for a <a>timed item</a>
          scheduled between time marks <var>a</var> and <var>b</var></dfn>,
          expressed in <a title="uneased timing">uneased inherited time</a>, can
          be determined as follows:
        </p>
        <ol>
          <li>Let <var>events</var> be an empty sequence of <a>timing
              events</a>.
          <li>Let <var class="timeMark">range a</var> be the <a>time mark</a>
              resulting from calculating <var class="timeMark">a</var> + <a
              title="timed item start time">start time</a>.
          <li>Let <var class="timeMark">range b</var> be the <a>time mark</a>
              resulting from calculating <var class="timeMark">b</var> + <a
              title="timed item start time">start time</a>.
          <li>Define a <a>time mark</a> <var class="timeMark">t</var> as being
              <dfn>in range</dfn> if it is <a title="in the interval ab">in the
              interval</a> (<var class="timeMark">range a</var>,
              <var class="timeMark">range b</var>).
          <li>Let <var class="timeMark">range lhs</var> be <a
              title="first(a,b)">first</a>(<var class="timeMark">range a</var>,
              <var class="timeMark">range b</var>).
          <li>Let <var class="timeMark">range rhs</var> be <a
              title="last(a,b)">last</a>(<var class="timeMark">range a</var>,
              <var class="timeMark">range b</var>).
          <li>Let <var class="timeMark">active start</var> be <var
              class="timeMark">start delay<sub>zero|end</sub></var>.
          <li>Let <var class="timeMark">active end</var> be <span
              class="timeMark">(<a>start delay</a> + <a>active
              duration</a>)<sub>minus|end</sub></span>.
          <li>If |<var class="timeMark">active start</var>| = |<var
              class="timeMark">active end</var>| then set the <span
              class="property">position</span> of <var
              class="timeMark">active end</var> to <span
              class="position">zero</span>.
          <li>If either of the following conditions is true:
            <ul><li><var class="timeMark">active end</var> &lt;
                <var class="timeMark">range lhs</var>; or
                <li><var class="timeMark">active start</var> &gt;
                <var class="timeMark">range rhs</var>
            </ul>
            return <var>events</var>.
          <li>If |<var class="timeMark">active start</var>| =
              |<var class="timeMark">active end</var>| and the <a>timed
              item</a>’s <a>iteration count</a> is infinity, let
              <var>effective iteration count</var> be 1, otherwise let it be
              the <a>timed item</a>’s <a>iteration count</a>.
          <li>Let <var>iteration times</var> be a sequence of <a>time
              values</a> populated with the results of calculating |<var
              class="timeMark">active start</var>| + <var>i</var> * <a>iteration
              duration</a> for each integer <var>i</var> in the range 0 &lt;
              <var>i</var> &lt; <var>effective iteration count</var>.
          <li>Remove all <a>time values</a> from <var>iteration times</var>
              where <var class="timeMark">time value<sub>zero</sub></var> is not
              <a>in range</a>.
          <li>Let <var>subintervals</var> be an empty sequence of <a>time
              marks</a>.
          <li>If <var class="timeMark">active start</var> is <a>in range</a>,
              append it to <var>subintervals</var>, otherwise append <var
              class="timeMark">range lhs</var>.
          <li>For each <a>time value</a> <var>t</var> in <var>iteration
              times</var>, add the following two <a>time marks</a> to
              <var>subintervals</var>, in order,
              <var class="timeMark">t<sub>minus|end</sub></var>,
              <var class="timeMark">t<sub>zero|end</sub></var>
              unless the <a>iteration duration</a>
              is zero, in which case add
              <var class="timeMark">t<sub>zero|end</sub></var>,
              <var class="timeMark">t<sub>zero|end</sub></var> instead.
          <li>If <var class="timeMark">active end</var> is <a>in range</a>,
              append it to <var>subintervals</var>, otherwise append <var
              class="timeMark">range rhs</var>.
          <li>If the first pair of <a>time marks</a> in <var>subintervals</var>
              are not in order, that is, if <var
              class="timeMark">subintervals[0]</var> &gt; <var
              class="timeMark">subintervals[1]</var>, remove those two <a>time
              marks</a> from <var>subintervals</var>.
              <p class="note">
                This will happen if a non-zero-duration iteration ends at |<var
                class="timeMark">range lhs</var>| and the <span
                class="property">position</span> of <var class="timeMark">range
                lhs</var> is not <span class="position">minus</span>.
              </p>
          <li>If <var class="timeMark">range a</var> &lt; <var
              class="timeMark">range b</var>, let <var>direction</var> be
              <span class="prop-value">forwards</span>, otherwise let
              <var>direction</var> be <span
              class="prop-value">backwards</span>.
          <li>If <var>direction</var> is <span
              class="prop-value">backwards</span>, reverse the elements of
              <var>subintervals</var>.
          <li>Let <var class="timeMark">directed active start</var> be <var
              class="timeMark">active start</var> if <var>direction</var> is
              <span class="prop-value">forwards</span> and <var
              class="timeMark">active end</var> otherwise.
          <li>Likewise, let <var class="timeMark">directed active end</var> be
              <var class="timeMark">active end</var> if <var>direction</var> is
              <span class="prop-value">forwards</span> and <var
              class="timeMark">active start</var> otherwise.
          <li>Define the <dfn>iteration index at local <a>time mark</a>
              <var class="timeMark">t</var></dfn> as follows:
            <ol>
              <li>Let <var>iteration index</var> be the result of calculating
                  the <a>current iteration</a> at |<var
                  class="timeMark">t</var>|.
              <li>If <var class="timeMark">t<sub>pos</sub></var> is <span
                  class="position">minus</span> and (<var>iteration index</var>
                  x <var class="timeMark">active start</var>) % <a>iteration
                  duration</a> = 0,
                  let <var>iteration index</var> be max(0, <var>iteration
                  index</var> - 1).
              <li>The result is <var>iteration index</var>.
            </ol>
          <li>Define the <dfn>timeline time at local time <var>t</var></dfn> as
              follows:
            <ol>
              <li>Let the <var>uneased local root time</var> be the result of
                  repeatedly applying the procedures for calculating the
                  <a>uneased inherited time from uneased local time</a> and
                  <a>uneased local time from uneased child time</a>
                  defined in
                  <a href="#inverse-timing-calculations" class="sectionRef"></a>
                  for each <a>ancestor</a> of this <a>timed item</a> in turn up
                  to the <a>root</a> <a>timed item</a> using <var>t</var> as the
                  initial <var>uneased local time</var>.
              <li>Let the <var>uneased local player time</var> be the result of
                  calculating the
                  <a>uneased inherited time from uneased local time</a> for
                  the <var>uneased local root time</var> using the <var>uneased
                  local root time</a> as the <var>uneased local time</var>.
              <li>Let the <var>timeline time</var> be the result of calculating
                  the <a>timeline time from the current time of a player</a> for
                  the <a>player</a> with which this <a>timed item</a> is <a
                  title="associated with a player">associated</a> using the
                  <var>uneased local player time</var> as the <var>current
                  time</var>.
              <li>If the <var>timeline time</var> is undefined, let
                  <var>timeline time</var> use the current
                  <a>time value</a> of the <a>timeline</a> with which this
                  <a>timed item</a> is <a title="associated with
                  a timeline">associated</a>.
              <li>The result is <var>timeline time</var>.
            </ol>
          <li>If <var class="timeMark">directed active start</var> is <a>in
              range</a>, append to <var>events</var> a <a>timing event</a>
              with the following parameters:
            <ul>
              <li>type: <a>timingstart</a>
              <li>event target: this <a>timed item</a>
              <li><a>event local time</a>:
                  |<var class="timeMark">directed active start</var>|
              <li><a>event timeline time</a>:
                  <a title="timeline time at local time t">timeline
                  time for |<var class="timeMark">directed active
                  start</var>|</a>.
              <li><a>event iteration index</a>:
                  <a title="iteration index at local time mark t">iteration
                  index at <var class="timeMark">directed active
                  start</var></a>
              <li><a>seeked dispatch flag</a>: false
            </ul>
            Alternatively, if <var class="timeMark">range a</var> is an
            interval endpoint, append a <a>timing event</a> to
            <var>events</var> as above but substituting <var
            class="timeMark">range a</var> in place of <var
            class="timeMark">directed active start</var>.
          <li>Let <var>subinterval iteration index</var> be the <a
            title="iteration index at local time mark t">iteration index
            at the first <a>time mark</a> in <var>subintervals</var></a>.
          <li>Let <var>first iteration</var> be <code>true</code>
          <li>Iterate over each pair of <a>time marks</a> in
              <var>subintervals</var> in order such that each <a>time mark</a>
              is used only once.
              For each pair of <a>time marks</a>,
              (<var class="timeMark">subinterval start</var>,
              <var class="timeMark">subinterval end</var>)
              perform the following steps:
            <ol>
              <li>Let <var>subinterval iteration index</var> be the <a
                title="iteration index at local time mark t">iteration index
                at <var class="timeMark">subinterval start</var></a>.
              <li>If <em>either</em> of the following conditions is true,
                <ul>
                  <li><var>first iteration</var> is <code>false</code>, or
                  <li><var class="timeMark">subinterval start</var> =
                      <var class="timeMark">range a</var> &ne;
                      <var class="timeMark">subinterval end</var>
                </ul>
                append a new <a>timing event</a> to <var>events</var> with the
                following paramters:
                <ul>
                  <li>type: <a>timingiteration</a>
                  <li>event target: this <a>timed item</a>
                  <li><a>event local time</a>:
                      |<var class="timeMark">subinterval start</var>|
                  <li><a>event timeline time</a>:
                      <a title="timeline time at local time t">timeline
                      time for |<var class="timeMark">subinterval
                      start</var>|</a>.
                  <li><a>event iteration index</a>:
                      <var>subinterval iteration index</var>
                  <li><a>seeked dispatch flag</a>: false
                </ul>
              <li>Let <var class="timeMark">child start</var> be a <a>time
                mark</a> whose <span class="property">time value</span> is the
                result of calculating the <a>directed time</a> corresponding
                to |<var class="timeMark">subinterval start</var>| but using
                <var>subinterval iteration index</var> as the <var>current
                iteration value</var> and assuming a <a>fill mode</a> of
                <span class="prop-value">none</span> and whose <span
                class="property">position</span> is the same as that of <var
                class="timeMark">subinterval start</var>.
              <li>Likewise, let <var class="timeMark">child end</var> be the
                result of performing the same operation but for <var
                class="timeMark">subinterval end</var>.
              <li>Let <var>child direction</var> be
                <span class="prop-value">forwards</span> if
                |<var class="timeMark">child start</var>| &lt;
                |<var class="timeMark">child end</var>|,
                <span class="prop-value">backwards</span> if
                |<var class="timeMark">child start</var>| &gt;
                |<var class="timeMark">child end</var>|,
                and <code>null</code> if
                |<var class="timeMark">child start</var>| =
                |<var class="timeMark">child end</var>|.
              <li>If <var>child direction</var> is not <code>null</code> and is
                not equal to <var>direction</var>, invert the <span
                class="property">position</span> of <var
                class="timeMark">child start</var> and <var
                class="timeMark">child end</var> each such that <span
                class="position">plus</span> becomes <span
                class="position">minus</span>, and vice versa, and <span
                class="position">zero</span> remains
                unchanged.
              <li>Let <var>child events</var> be an empty sequence of
                <a>timing events</a>.
              <li>Iterate over each <a>child timed item</a> in order and for
                each child get the <a
                title="partially ordered set of events for a timed item scheduled between time marks a and b">partially
                ordered set of events scheduled between <var
                class="timeMark">child start</var> and <var
                class="timeMark">child end</var></a> and append to <var>child
                events</var>.
              <li>Append <var>child events</var> to <var>events</var>.
              <li>If <var>direction</var> is <span
                  class="prop-value">forwards</span>, increment
                  <var>subinterval iteration index</var>, otherwise decrement
                  it.
                  <p class="note">
                    This manual handling of the <var>subinterval iteration
                      index</var> (as opposed to simply recalculating the
                    <a title="iteration index at local time mark t">iteration
                    index for each <var>subinterval start</var></a> is
                    necessary for handling zero-length intervals.
                  </p>
              <li>Let <var>first iteration</var> be <code>false</code>.
            </ol>
          <li>If <var class="timeMark">directed active end</var> is <a>in
              range</a>, append to <var>events</var> a <a>timing event</a>
              with the following parameters:
            <ul>
              <li>type: <a>timingend</a>
              <li>event target: this <a>timed item</a>
              <li><a>event local time</a>:
                  |<var class="timeMark">directed active end</var>|
              <li><a>event timeline time</a>:
                  <a title="timeline time at local time t">timeline
                  time for |<var class="timeMark">directed active
                  end</var>|</a>.
              <li><a>event iteration index</a>:
                  <a title="iteration index at local time mark t">iteration
                  index at <var class="timeMark">directed active
                  end</var></a>
              <li><a>seeked dispatch flag</a>: false
            </ul>
            Alternatively, if <var class="timeMark">range b</var> is an
            interval endpoint, append a <a>timing event</a> to
            <var>events</var> as above but substituting <var
            class="timeMark">range b</var> in place of <var
            class="timeMark">directed active end</var>.
          <li>Return <var>events</var>.
        </ol>
      </section>
      <section>
        <h3>Events for a timed item during seeked event dispatch</h3>
        <p>
          The <dfn>partially ordered set of events for a <a>timed item</a>
          seeked to time <var>t</var></dfn>, expressed in <a
          title="uneased timing">uneased inherited time</a>,
          can be determined as follows:
        </p>
        <ol>
          <li>Let <var>events</var> be an empty sequence of <a>timing
              events</a>.
          <li>Let <var>local t</var> be <var>t</var> + <a>start time</a>.
          <li>Let <var>child time</var> be a <var>time value</var> that is the
              result of calculating the <a>directed time</a> corresponding to
              <var>local t</var> assuming a <a>fill mode</a> of <span
              class="prop-value">none</span>.
          <li>Iterate over each <a>child timed item</a> in order and for each
              child get the <a
              title="partially ordered set of events for a timed item seeked to time t">partially
              ordered set of events for seek time <var>child time</var></a>
              and append to <var>events</var>.
          <li>Let <var>current active state</var> be the result of evaluating if
              this <a>timed item</a> is <a>active</a> at time <var>local
              t</var>.
          <li>If this <a>timed item</a> has a <a>previous active state</a> of
              <em>inactive</em>, and a <var>current active state</var> of
              <em>active</em>, add to the beginning of <var>events</var> a new
              <a>timing event</a> with the following parameters:
              <ul>
                <li>type: <a>timingstart</a>
                <li>event target: this <a>timed item</a>
                <li><a>event local time</a>: <var>local t</var>
                <li><a>event timeline time</a>:
                    <a title="timeline time at local time t">timeline
                    time for <var>local t</var></a>.
                <li><a>event iteration index</a>:
                    the result of calculating the <a>current iteration</a> at 
                    at <var>local t</var></a>
                <li><a>seeked dispatch flag</a>: true
              </ul>
          <li>If this <a>timed item</a> has a <a>previous active state</a>
              of <em>active</em>, and a <var>current active state</var> of
              <em>inactive</em>, append to the end of <var>events</var> a new
              <a>timing event</a> with the following parameters:
              <ul>
                <li>type: <a>timingend</a>
                <li>event target: this <a>timed item</a>
                <li><a>event local time</a>: <var>local t</var>
                <li><a>event timeline time</a>:
                    <a title="timeline time at local time t">timeline
                    time for <var>local t</var></a>.
                <li><a>event iteration index</a>:
                    the result of calculating the <a>current iteration</a> at 
                    at <var>local t</var></a>
                <li><a>seeked dispatch flag</a>: true
              </ul>
          <li>Return <var>events</var>.
        </ol>
      </section>
    </section>

    <section class='appendix'>
      <h2>Acknowledgements</h2>
      <p>
        Thank you to Michiel &ldquo;Pomax&rdquo; Kamermans for help with the
        equations for a proposed smooth timing function although this feature
        has been deferred to a subsequent specification.
      </p>
      <p>
        Our deep gratitude goes out to <a
        href="http://www.southernstarentertainment.com.au/">Southern Star
        Animation</a> for their kind generosity and patience in introducing the
        editors to the processes and techniques used producing broadcast
        animations.
      </p>
    </section>
  </body>
</html>
