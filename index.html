<!DOCTYPE html>
<!-- vim: set expandtab ts=2 sw=2 tw=80: -->
<html>
  <head>
    <title>Web Animations 1.0</title>
    <meta charset="utf-8">
    <script src="respec/respec.js" class="remove"></script>
    <script src="respec/js/sh_javascript.min.js" class="remove"></script>
    <script class="remove">
      var respecConfig = {
        // specification status (e.g. WD, LCWD, NOTE, etc.). If in doubt use
        // ED.
        specStatus: "ED",

        // the specification's short name, as in
        // http://www.w3.org/TR/short-name/
        // shortName:            "web-anim",

        // if your specification has a subtitle that goes below the main
        // formal title, define it here
        // subtitle   :  "an excellent document",

        // if you wish the publication date to be other than today, set this
        // publishDate:  "2009-08-06",

        // if the specification's copyright date is a range of years, specify
        // the start date here:
        // copyrightStart: "2012"

        // if there is a previously published draft, uncomment this and set
        // its YYYY-MM-DD date and its maturity status
        // previousPublishDate: "1977-03-15",
        // previousMaturity: "WD",

        // if there a publicly available Editor's Draft, this is the link
        edDraftURI:
        "https://dvcs.w3.org/hg/FXTF/raw-file/default/web-anim/index.html",

        // if this is a LCWD, uncomment and set the end of its review period
        // lcEnd: "2009-08-05",

        // if you want to have extra CSS, append them to this list
        // it is recommended that the respec.css stylesheet be kept
        extraCSS: ["respec/respec.css",
                   "web-animations.css"],

        // Turning off inlineCSS for now since if extraCSS points to
        // a relative URL your testing from a file URL the XHR will fail.
        // Probably should turn this back on once this is hosted on a server
        // somewhere.
        inlineCSS: false,

        // editors, add as many as you like
        // only "name" is required
        editors:  [
            { name: "Brian Birtles", mailto: "bbirtles@mozilla.com",
              company: "Mozilla Japan", companyURL: "http://mozilla.jp/" },
            { name: "Shane Stephens", mailto: "shans@google.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
            { name: "Alex Danilo", mailto: "adanilo@google.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
            { name: "Dmitry Baranovskiy", mailto: "baranovs@adobe.com",
              company: "Adobe Systems", companyURL: "http://www.adobe.com/" },
            { name: "Tab Atkins", mailto: "jackalmage@gmail.com",
              company: "Google, Inc", companyURL: "http://www.google.com/" },
        ],

        // authors, add as many as you like.
        // This is optional, uncomment if you have authors as well as editors.
        // only "name" is required. Same format as editors.

        //authors:  [
        //    { name: "Your Name", url: "http://example.org/",
        //      company: "Your Company", companyURL: "http://example.com/" },
        //],

        // name of the WG(s)
        wg: [ "CSS Working Group",
              "SVG Working Group" ],

        // URI of the public WG page
        wgURI: [ "http://dev.w3.org/Style/CSS/members",
                 "http://www.w3.org/Graphics/SVG/WG" ],

        // Activity this WG is part of
        wgActivity: [ 
          [ "Style", "http://www.w3.org/Style/Activity" ],
          [ "Graphics", "http://www.w3.org/Graphics/Activity" ]
        ],

        // name (without the @w3c.org) of the public mailing to which comments
        // are due
        wgPublicList: "public-fx",

        // URI of the patent status for this WG, for Rec-track documents
        // !!!! IMPORTANT !!!!
        // This is important for Rec-track documents, do not copy a patent URI
        // from a random document unless you know what you're doing. If in
        // doubt ask your friendly neighbourhood Team Contact.
        wgPatentURI:  "",

        noIDLSorting: true,
        noIDLIn: true
      };
    </script>
    <!--
      ReSpec.js wishlist:

      Add here any issues you find with ReSpec including missing features. It
      will help us decide if we should continue using it and work out what we
      need to fix.

      * Allow making cross-references to specific methods and members.
    -->
  </head>
  <body>
    <section id='abstract'>
      This is the abstract for your specification.
    </section>

    <section class="informative">
      <h2>Introduction</h2>
      <p>
        Web Animations defines a model for supporting animation and
        synchronization on the Web platform.
        It is intended that other specifications will build on this model and
        expose its features through declarative means.
        In addition, this specification also defines a programming interface to
        the model that may be implemented by user agents that provide support
        for scripting.
      </p>
      <section>
        <h3>Use cases</h3>
        <p>
          The Web Animations model aims at three broad areas of application:
        </p>
        <dl>
          <dt>User interface effects</dt>
          <dd>
            <p>
              Animation can be used to give visual clues and feedback to make
              a user interface more readily comprehensible.
            </p>
            <p>
              For example, a user action results in a table row being
              removed to represent an item being removed from a shopping cart.
              In such a case, fading the row to transparent and then shifting
              the subsequent rows up to fill the space over a few hundred
              milliseconds provides the user with clear feedback as to the
              results of their action as opposed to instantly removing the row
              from the DOM.
            </p>
            <p>
              To support this scenario not only are the animated effects of
              fading and shifting required, but so is synchronization, both
              between the animations, and between animations and scripted
              actions (removing the table row from the DOM after the animations
              have completed).
            </p>
          </dd>
          <dt>Storytelling and visualisation</dt>
          <dd>
            <p>
              Another type of animation uses the animated effect to convey
              a story or represent some information.
              Unlike user interface effects which are largely a presentational
              adjunct to the content, these animations form an essential part of
              the content presented to the user.
            </p>
            <p>
              For example, in an animated cartoon two cats fly through space
              to another planet leaving a rainbow trail behind them.
              After arriving at the planet a change of scene occurs and the user
              should decide whether or not the cats enter a magic mountain by
              selecting one of two preset destinations in the scene.
            </p>
            <p>
              This scenario requires the following features:
            </p>
            <ul>
              <li>animated effects for moving characters along a path as well as
                  warping a path (the rainbow trail),</li>
              <li>synchronization that allows some actions to happen
                  simultaneously (the two cats moving) and others in sequence
                  (the change of scene),</li>
              <li>play control to allow rewinding the cartoon, or changing its
                  playback rate to accommodate particular learning or
                  accessibility needs (particularly if audio or textual captions
                  are included as described in the next use case category),</li>
              <li>the ability to trigger alternate animations at different
                  points in the overall story.</li>
            </ul>
            <p>
              Similar use cases in this category include visualising physical
              phenomena such as spring motion for educational purposes,
              or visualising data such as the prevalence of a disease over
              a geographical space over a year whereby animation is used to
              present the time-based component of the data.
            </p>
          </dd>
          <dt>Synchronizing media and animated effects</dt>
          <dd>
            <p>
              Finally, animation is often used in conjunction with other media
              such as video and audio.
            </p>
            <p>
              As an example, the subtitles shown on a karaoke video may indicate
              the current position in the lyrics through a ball bouncing from
              one syllable to the next.
              In this scenario it is necessary to maintain strict
              synchronization between the audio and animation even in the face
              of user interaction such as rewinding or pausing the audio or
              network events such as a delay due to media buffering.
            </p>
            <p>
              A more complicated example of this category is applying a series
              of independent sound effects to an animated cartoon or adding
              a video as the background of an animated scene such that is cued
              to start mid-way into the scene.
            </p>
          </dd>
        </dl>
        <p>
          The nature of these uses cases differs significantly and whilst Web
          Animations attempts to address each use case, technologies built on
          top of the Web Animations may expose features tailored towards more
          specific use cases rather catering to each scenario equally.
        </p>
      </section>
      <section>
        <h3>Relationship to other specifications</h3>
        <p>
          CSS Transitions [[CSS3-TRANSITIONS]], CSS Animations 
          [[CSS3-ANIMATIONS]], and SVG [[SVG112]] all provide mechanisms that
          generate animated content on a Web page.
          Although the three specifications provide many similar features,
          they are described in different terms.
          This specification proposes an abstract animation model that
          encompasses the common features of all three specifications.
          This model is backwards-compatible with the current behavior of these
          specifications such that they can be defined in terms of this model
          without any observable change.
        </p>
        <p>
          Defining CSS Transitions, CSS Animations and SVG's animation features
          in terms of a common model opens up possibilities of synchronizing
          animations, interchanging their definitions, and manipulating them
          using a common programming interface regardless of their markup.
          To facilitate this process of redefining these features in terms of
          a common model, this specification is accompanied by a CSS embedding
          specification, which describes how CSS features can be implemented in
          terms of Web Animations primitives, and an SVG embedding specification
          which does the same for SVG.
        </p>
        <p>
          The animation features in SVG 1.1 are defined in terms of SMIL
          Animation [[SMIL-ANIMATION]].
          It is intended that by defining SVG's animation features in terms of
          the Web Animations model, the dependency between SVG and SMIL
          Animation can be removed.
          To this end, features not present in Web Animations that are part of
          SVG are described in full in the SVG and Web Animations integration
          document.
        </p>
        <p>
          The programming interface component of this specification makes
          some additions to interfaces defined in HTML5 [[HTML5]].
        </p>
      </section>
      <section>
        <h3>Overview of this specification</h3>
        <p>
          This specification begins by defining an abstract model for animation.
          This is followed by a programming interface defined in terms of the
          abstract model.
          The programming interface is defined in terms of the abstract model
          and is only relevant to user agents that provide scripting support.
        </p>
      </section>
    </section>

    <section class="informative">
      <h2>Web Animations model overview</h2>
      <p>
        At a glance, the Web Animations model consists of two largely
        independent pieces, a <em>timing model</em> and an <em>animation
        model</em>.  The role of these pieces is as follows:
      </p>
      <dl>
        <dt>Timing model</dt>
        <dd>
          Takes a moment in time and converts it to a proportional distance
          within a single iteration of an animation called the <em>time
          fraction</em>.
        </dd>
        <dt>Animation model</dt>
        <dd>
          Takes the <em>time fractions</em> produced by the timing model and
          converts them into a series of values to apply to the target
          properties and attributes.
        </dd>
      </dl>
      <p>
        Graphically, this flow can be represented as follows:
      </p>
      <div class="figure">
        <img src="img/timing-and-animation-models.svg" width="600">
      </div>
      <p class="caption">
        Overview of the operation of the Web Animations model.<br>
        The current time is input to the timing model which produces a time
        fraction.<br>
        This distance is used as input to the animation model which produces
        the values to apply.
      </p>
      <p>
        For example, consider an animation that:
      </p>
      <ul>
        <li>starts after 3 seconds,</li>
        <li>runs twice,</li>
        <li>takes 2 seconds every time, and</li>
        <li>changes the width of a rectangle from 50 pixels to 100
            pixels.</li>
      </ul>
      <p>
        The first three points apply to the timing model.
        At a time of 6 seconds, it will calculate that the animation should be
        half-way through its second iteration and produces the result 0.5.
        The animation model then uses that information to calculate a width
        for the rectangle of 75.
      </p>
      <p>
        This specification begins with the timing model and then proceeds to
        the animation model.
      </p>
    </section>

    <section class="informative">
      <h2>The timing model at a glance</h2>
      <p>
        Two features characterise the Web Animations timing model: it is
        <em>stateless</em> and it is <em>hierarchical</em>.
      </p>
      <section>
        <h3>Stateless</h3>
        <p>
          The Web Animations timing model operates by taking an input time and
          producing an output time fraction.
          Since the output is based solely on the input time and is independent
          of previous inputs, the model may be described as stateless.
          This gives the model the following properties:
        </p>
        <dl>
          <dt>Frame-rate independent</dt>
          <dd>
            Since the output is independent of previous inputs, the rate at
            which the model is sampled will not affect its progress.
            Provided the input times are proportional to the progress of
            real-world time, animations will progress at an identical rate
            regardless of the capabilities of the device running them.
          </dd>
          <dt>Direction agnostic</dt>
          <dd>
            Since the sequence of inputs is insignificant, the model is
            directionless.
            This means that the model can be sampled in reverse or even in
            a backwards and forwards pattern without requiring any specialized
            handling.
          </dd>
          <dt>Constant-time seeking</dt>
          <dd>
            Since each input is independent of the previous input, the
            processing required to perform a seek operation, even far into the
            future, is at least potentially constant.
          </dd>
        </dl>
        <p>
          There are a few apparent exceptions to the stateless behavior of the
          timing model.
        </p>
        <p>
          Firstly, events are fired when, for example, one sample falls
          on the opposite side of an animation's interval boundary to the
          previous sample.
          This is certainly stative behavior.
          However, events should be considered as a layer added on top of the
          core timing model.
          When no event listeners are registered, the model is stateless.
        </p>
        <p>
          The other exception to this stateless behavior is that a number of
          methods defined in the <a href="#script-interface">programming
          interface</a> to the model provide play control such as pausing and
          reversing an item.
          These methods are defined in terms of the time at which they are
          called and are therefore stative.
          These methods are provided primarily for convenience and are not part
          of the core timing model but, like events, are layered on top.
        </p>
        <p>
          Finally, each time the model is sampled, it can be considered to
          establish a temporary state.
          While this temporary state affects the values returned from the <a
          href="#script-interface">programming interface</a>, it has no
          influence on the subsequent samples and hence does not conflict with
          the stateless qualities described above.
        </p>
      </section>
      <section>
        <h3>Hierarchical</h3>
        <p>
          The other characteristic feature of the Web Animations timing model is
          that time is inherited.
          Time begins with a monotonically increasing time source and cascades
          down a number of steps to each animation.
          At each step, time may be shifted backwards and forwards, scaled,
          reversed, paused, and repeated.
        </p>
        <div class="figure">
          <img src="img/time-hierarchy.svg" width="600">
        </div>
        <p class="caption">
          A hierarchy of timing nodes.
          Each node in the tree derives its time from its parent node.
          At the root of the tree is the global clock.
        </p>
        <p>
          A consequence of this hierarchical arrangement is that complex
          animation arrangements can be reversed, scheduled, accelerated and so
          on, as a whole unit since the manipulations applied to the parent
          cascade down to its descendants.
          Furthermore, since time has a common source, it is easy to synchronize
          animations.
        </p>
      </section>
    </section>

    <section>
      <h2>Timing model concepts</h2>
      <p>
        In Web Animations timing is based on a hierarchy of time relationships
        between timing nodes.
        Parent nodes provide timing information to their child nodes in the form
        of <a title="time value">time values</a>.
        A <dfn>time value</dfn> is a real number which nominally represents
        a number of seconds from some moment.
        The connection between <a title="time value">time values</a> and
        wall-clock seconds may be obscured by any number of transformations
        applied to the value as it passes through the time hierarchy.
      </p>
      <p class="annotation">
        In the future we may have timelines that are based on UI gestures in
        which case the connection between time values and seconds will be
        weakened even further.
      </p>
      <p>
        Periodically, the user agent will trigger an update to the timing model
        in a process called <dfn>sampling</dfn>.
        On each <dfn>sample</dfn> the <a title="time value">time values</a> of
        each timing node are updated.
      </p>
      <p class="note">
        A more precise definition of when the model is updated when scripting is
        involved is provided in <a href="#interaction-with-script"
        class="sectionRef"></a>.
      </p>
    </section>

    <section>
      <h2>The global clock</h2>
      <p>
        At the root of the Web Animations timing hierarchy is the <a>global
        clock</a>.
      </p>
      <p>
        The <dfn>global clock</dfn> is a source of monotonically increasing <a
        title="time value">time values</a> unaffected by adjustments to the
        system clock.
        The <a title="time value">time values</a> produced by the <a>global
        clock</a> represent wall-clock seconds from an unspecified historical
        moment.
        The absolute value of the <a title="time value">time values</a> produced
        by the <a>global clock</a> are insignificant, only their rate of change.
      </p>
      <p class="note">
        Note that the <a>global clock</a> is not exposed in the <a
        href="#script-interface">programming interface</a> and nor is it
        expected to be exposed by markup.
        As a result the moment from which <a>global clock</a> <a title="time
        value">time values</a> are measured, that is, the zero time of the
        clock, is allowed to be implementation-dependent.
        One user agent may measure the number of seconds since the the user
        agent was loaded whilst another may use the time when the device was
        started.
        Both approaches are acceptable and produce no observable difference
        in the output of the model.
      </p>
    </section>

    <section>
      <h2>Timelines</h2>
      <p>
        A <dfn>timeline</dfn> provides a source of <a title="time value">time
        values</a> for the purpose of synchronization.
      </p>
      <p>
        Typically, a <a>timeline</a> is tied to the <a>global clock</a> such
        that its absolute time is calculated as a fixed offset from the time of
        the <a>global clock</a>.
        This offset is established by designating some moment as the timeline's
        <dfn>zero time</dfn> and recording the <a>time value</a> of the
        <a>global clock</a> at that moment.
        At subsequent moments, the <a>time value</a> of the timeline is
        calculated as the difference between the current <a>time value</a> of
        the <a>global clock</a> and the value recorded at the <a>zero time</a>.
      </p>
      <p class="annotation">
        Note that we anticipate that other types of timelines may be introduced
        in the future that are not tied to the global clock.
        For example, a timeline whose time values correspond to UI gestures.
      </p>
      <p>
        Since a <a>timeline</a> may be defined to relative a moment that has yet
        to occur, it may not always be able to return a meaningful <a>time
        value</a>.
        A <a>timeline</a> is considered to be <dfn>not started</dfn> when it is
        in such a state that it cannot produce a <a>time value</a>.
      </p>
      <section>
        <h3>The document timeline</h3>
        <p>
          Each document has a <a>timeline</a> called the <dfn>document
          timeline</dfn> whose <a>time value</a> at a given moment is calculated
          as a fixed offset from the <a>global clock</a> such that its <a>zero
          time</a> corresponds to the moment immediately prior to dispatching
          the load event of the document.
          Prior to this moment, the <a>document timeline</a> is <a>not
          started</a>.
        </p>
        <p>
          For documents that support the concept of <a
          href="http://www.w3.org/TR/html51/dom.html#current-document-readiness
          ">current document readiness</a>, this is the moment after the <a
          href="http://www.w3.org/TR/html51/dom.html#current-document-readiness
          ">current document readiness</a> has changed to "complete" but
          before dispatching the load event.
          For user agents that support Navigation Timing [[NAVIGATION-TIMING]],
          this occurs between the <em>domComplete</em> and
          <em>loadEventStart</em> timings.
        </p>
        <p>
          Since the <a>document timeline</a> is tied to the <a>global clock</a>
          by a fixed offset, <a title="time value">time values</a> reported by
          the <a>document timeline</a> increase monotonically.
          Furthermore, since no scaling is applied, these <a title="time
          value">time values</a> represent wall-clock seconds.
        </p>
      </section>
    </section>

    <section>
      <h2>Players</h2>
      <div class="informative">
        <p>
          The children of a <a>timeline</a> are called <em>players</em>.
          A player takes a <a>timed item</a> which is a static description of
          some timed behavior and binds it to a <a>timeline</a> so that it runs.
          A player also allows run-time control of the connection between the
          <a>timed item</a> and its <a>timeline</a> by providing pausing,
          seeking, and speed control.
          The relationship between a player and a <a>timed item</a> is analogous
          to that of a DVD player and a DVD.
        </p>
      </div>
      <p>
        A <dfn>player</dfn> connects a single <a>timed item</a>, called its
        <dfn>source content</dfn>, to a <a>timeline</a> and provides playback
        control.
      </p>
      <p>
        A <a>player</a> records the <a>time value</a> of its <a>timeline</a>
        at which its <a>source content</a> is scheduled to begin
        as the <dfn title="player start time">start time</dfn>.
      </p>
      <section>
        <h3>The current time of a player</h3>
        <p>
          <a title="player">Players</a> also provide a <a>time value</a> to
          their <a>source content</a> called the player's <dfn>current
          time</dfn>.
          The calculation of the <a>current time</a> is as follows:
        </p>
        <blockquote>
          <code><a>current time</a> =
          (<var>timeline time</var> - <a title="player start time">start
          time</a>) * <a title="player playback rate">playback rate</a>
          - <a>time drift</a></code>
        </blockquote>
        <p>
          Where:
        </p>
        <ul>
          <li><var>timeline time</var> is the current <a>time value</a> of the
          <a>timeline</a> with which this <a>player</a> is associated.</li>
          <li><var>start time</var> is the player's <a
          title="player start time">start time</a>.</li>
          <li><var>playback rate</var> is the <a
          title="player playback rate">playback rate</a> value described in <a
          href="#speed-control" class="sectionRef"></a>.</li>
          <li><var>time drift</var> is the <a>time drift</a> value described in
          <a href="#seeking-and-pausing" class="sectionRef"></a>.</li>
        </ul>
        <p>
          If the <a>timeline</a> with which is <a>player</a> is <a>not
          started</a> then the <a>current time</a> is <code>null</code>.
        </p>
        <p>
          It is often useful to treat the <a>current time</a> as zero when it
          would otherwise be <code>null</code>.
          Hence we define the <dfn>effective current time</dfn> as being equal
          to <a>current time</a> unless it is <code>null</code>, in which case
          the <var>effective current time</var> be zero.</li>
        </p>
        <p>
          The procedure for performing manual updates to the <a>current time</a>
          is defined in <a href="#performing-a-seek" class="sectionRef"></a>.
        </p>
      </section>
      <section>
        <h3>Seeking and pausing</h3>
        <p>
          Seeking and pausing a player are closely related and are described
          here together.
        </p>
        <section class="informative">
          <h4>Introduction to seeking</h4>
          <p>
            Changing the current playback position of a player can be used to
            rewind its <a>source content</a> to its start point, fast-forward
            to a point in the future, or to provide ad-hoc synchronization
            between timed items.
          </p>
          <p>
            However, in Web Animations, the <a title="player start time">start
            time</a> of a <a>player</a> has special significance in determining
            the priority of animations (see <a href="#combining-animations"
            class="sectionRef"></a>) and so we cannot simply adjust the <a
            title="player start time">start time</a>.
            Instead, an additional offset is introduced called the <a>time
            drift</a> that further offsets a player's <a>current time</a> from
            its timeline.
            The effect of the <a>time drift</a> when seeking is illustrated
            below.
          </p>
          <div class="figure">
            <img src="img/seeking.svg" width="600">
          </div>
          <p class="caption">
            At time <var>t</var>, a seek is performed on the player changing its
            <a>current time</a> from 1.5s to 2s.<br>
            As a result, the <a>time drift</a> is set to -0.5s.<br>
            Note that the <a title="player start time">start time</a> indicated
            by a red star does not change.
          </p>
          <p>
            It is possible to seek a player even if its <a>timeline</a> is
            <a>not started</a>.
            Once the timeline begins, the player will being playback from the
            seeked time.
          </p>
        </section>
        <section class="informative">
          <h4>Introduction to pausing</h4>
          <p>
            Pausing can be used to temporarily suspend a <a>player</a>.
            Like seeking, pausing effectively causes the <a>current time</a> of
            a player to be offset from its <a>timeline</a> by means of
            setting the <a>time drift</a>.
          </p>
          <p>
            Pausing before a player's <a title="player start time">start
            time</a> will cause the player's <a>source content</a> to begin in
            a paused state but does not delay its start as is illustrated below.
          </p>
          <div class="figure">
            <img src="img/pausing.svg" width="600">
          </div>
          <p class="caption">
            The effect of pausing a player at different moments.<br>
            In case A, the player is paused and unpaused before its <a>start
            time</a>.
            The pause has no effect.<br><br>
            In case B, the player is paused before the
            <a title="player start time">start time</a> and remains paused.
            At the scheduled <a title="player start time">start time</a> the
            <a>source content</a> begins playing in a paused state.
            When the player is unpaused it continues playing.
            The resulting player has a <a>time drift</a> equivalent to the
            interval from the <a title="player start time">start time</a> to
            when it was unpaused.<br><br>
            In case C, the player is paused and unpaused during the <a>active
            interval</a> of the source content.
            After unpausing, the player has a <a>time drift</a> equivalent to
            the duration of the pause interval.
          </p>
          <p class="issue">
            I suspect we don't want this behavior now that player is a separate
            object.
          </p>
        </section>
        <section>
          <h4>Seeking and pausing properties</h4>
          <p>
            <a title="player">Players</a> track three properties related to
            seeking and pausing.
          </p>
          <dl>
            <dt><dfn>time drift</dfn></dt>
            <dd>
              The offset from a player's scheduled current time as defined by
              its <a title="player start time">start time</a>, and its actual
              current time after accounting for the effects of seeking and
              pausing.
              The <a>time drift</a> is initially zero and is updated as per the
              definition in <a href="#calculating-the-time-drift"
              class="sectionRef"></a>.
            </dd>
            <dt><dfn>paused state</dfn></dt>
            <dd>
              A boolean value that is true if the player is currently paused.
              The <a>paused state</a> is initially false.
            </dd>
            <dt><dfn>pause start time</dfn></dt>
            <dd>
              The player's <a>effective current time</a> at the time when the
              <a>paused state</a> was last newly true.
              The <a>pause start time</a> is initially zero.
            </dd>
          </dl>
          <p>
            A number of calculations for performing seeking and pausing are
            defined to operate even when the associated <a>timeline</a> is
            <a>not started</a>.
            For such situations we define the <dfn>effective timeline time</dfn>
            as the current <a>time value</a> of the <a>timeline</a> associated
            with a <a>player</a>;
            if the timeline is <a>not started</a>, then the <var>effective
            timeline time</var> is zero.
          </p>
        </section>
        <section>
          <h4>Calculating the <a>time drift</a></h4>
          <p>
            The <a>time drift</a> value is both a stored and a calculated value.
            When a player is paused, the value is calculated from the <a>pause
            start time</a>.
            When a player is not paused, the stored value is used.
            The stored value is initially zero, and is updated when the player
            is unpaused or seeked.
          </p>
          <p>
            Since pausing does not take effect prior to when a player's source
            content begins, we first define the beginning of a player's source
            content for the purposes of pausing as a player's <em>earliest
            moment</em>.
            The calculation is as follows:
          </p>
          <blockquote>
            <dfn>earliest moment</dfn> = <code>min(0, <var>start delay of
            source content</var>)</code>
          </blockquote>
          <p class="issue">
            I'm pretty sure we don't want this behavior now that the player is
            separate to the source content.
          </p>
          <p>
            Using this definition we can define the value of <a>time drift</a>
            at a given moment as follows:
          </p>
          <dl class="switch">
            <dt>If the <a>paused state</a> is true,</dt>
            <dd>
              Return the result of 
              <code>(<a>effective timeline time</a> - <a
              title="player start time">start time</a>) * <a
              title="player playback rate">playback rate</a> -
              max(<a>pause start time</a>, <a>earliest moment</a>)</code>.
            </dd>
            <dt>Otherwise,</dt>
            <dd>
              Return the stored value for this property.
            </dd>
          </dl>
        </section>
        <section>
          <h4>Updating the <a>paused state</a></h4>
          <p>
            The procedure for updating the <a>paused state</a> is as
            follows:
          </p>
          <ol>
            <li>
              Let <var>new value</var> be the new paused state to set.
            </li>
            <li>
              If <var>new value</var> equals the current <a>paused state</a>,
              return.
            </li>
            <li>
              The next step depends on the current <a>paused state</a> as
              follows,
              <dl class="switch">
                <dt>If <a>paused state</a> is true,</dt>
                <dd>
                  Set the <em>stored</em> value of <a>time drift</a> to the
                  <em>current calculated</em> value of <a>time drift</a> as
                  defined in <a href="#calculating-the-time-drift"
                  class="sectionRef"></a>.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  Record the current value of the <a>effective current time</a>
                  as <a>pause start time</a>.
                </dd>
              </dl>
            </li>
            <li>
              Update <a>paused state</a> to <var>new value</var>.
            </li>
          </ol>
        </section>
        <section>
          <h4>Performing a seek</h4>
          <p>
            <dfn>Seeking</dfn> is the process of updating a player's <a>current
            time</a> to a desired value.
            It is achieved using the following procedure:
          </p>
          <ol>
            <li>Let <var>seek time</var> be the desired <a>time value</a> for
                the player's <a>current time</a>.</li>
            <li>The steps for adjusting the <a>current time</a> depend on the
                <a>paused state</a> as follows:
              <dl class="switch">
                <dt>If the <a>paused state</a> is true,</dt>
                <dd>
                  Set <a>pause start time</a> to <var>seek time</var>.
                </dd>
                <dt>If the <a>paused state</a> is false,</dt>
                <dd>
                  Set the stored value for the <a>time drift</a> to
                  the result of evaluating
                  <code>(<a>effective timeline time</a> - <a
                     title="player start time">start time</a>)
                     * <a title="player playback rate">playback rate</a> -
                     <var>seek time</var></code>.
                </dd>
              </dl>
            </li>
          </ol>
          <p>
            The animation events dispatched when a seek is performed are
            described in <a href="#event-dispatch-during-seeking"
            class="sectionRef"></a>.
          </p>
        </section>
      </section>
      <section>
        <h3>Speed control</h3>
        <div class="informative">
          <p>
            The rate of play of a player can be controlled by setting its
            <em>playback rate</em>.
            For example, setting a playback rate of 2 will cause the player's
            <a>current time</a> to increase at twice the rate of its
            <a>timeline</a>.
            Similarly, a playback rate of -1 will cause the player's <a>current
            time</a> to decrease at the same rate as the <a title="time
            value">time values</a> from its <a>timeline</a> increase.
          </p>
          <p>
            Note that <a title="timed item">timed items</a> also have a <a
            title="timed item playback rate">playback rate</a> associated with
            them that behaves differently to that defined here.
          </p>
        </div>
        <p>
          <a title="player">Players</a> have a <dfn title="player playback
          rate">playback rate</dfn> that provides a scaling factor from the rate
          of change of the associated <a>timeline</a>'s <a title="time
          value">time values</a> to the player's <a>current time</a>.
          The <a title="player playback rate">playback rate</a> is initially 1.
        </p>
        <p>
          Setting a player's <a title="player playback rate">playback rate</a>
          to zero effectively pauses the player but without affecting the
          player's <a>paused state</a>.
        </p>
        <section>
          <h4>Updating the playback rate</h4>
          <p>
            Changes to the <a title="player playback rate">playback rate</a>
            also trigger a compensatory seek so that that the player's
            <a>current time</a> is unaffected by the change to the playback
            rate.
          </p>
          <p>
            The procedure is as follows:
          </p>
          <ol>
            <li>Let <var>previous time</var> be the value of the <a>effective
                current time</a> before updating the <a
                title="player playback rate">playback rate</a>.</li>
            <li>Update the <a title="player playback rate">playback rate</a> to
                the new value.</li>
            <li>Seek to <var>previous time</var> using the procedure defined in
                <a href="#performing-a-seek" class="sectionRef"></a>.</li>
          </ol>
        </section>
      </section>
    </section>

    <section>
      <h2>Timed items</h2>
      <p>
        The <a>source content</a> of a <a>player</a>, if set, is a type of
        <dfn>timed item</dfn>.
        There are three types of <a>timed item</a>:
      </p>
      <ul>
        <li><a title="animation">animations</a>,</li>
        <li><a title="timing group">timing groups</a>, and</li>
        <li><a title="media reference">media references</a>.</li>
      </ul>
      <p>
        At a given moment, a <a>timed item</a> can be associated with at most
        one <a>player</a>.
      </p>
      <p>
        <a title="timed item">Timed items</a> can be chained together into
        a hierarchy using <a title="timing group">timings groups</a> in which
        case a <a>timed item</a> may be <dfn>indirectly associated</dfn> with
        a <a>player</a> via an ancestor <a>timing group</a>.
        Only the root <a>timed item</a> of such a hierarchy can be associated
        directly with a <a>timed item</a>.
        Attempting to associate a <a>timed item</a> that has a <a>parent timing
        group</a> with a <a>player</a> results in the <a>timed item</a> being
        removed from the <a>parent timing group</a>.
      </p>
      <p>
        All types of <a>timed item</a> define a number of common properties.
      </p>
      <section>
        <h3>The active interval</h3>
        <div class="informative">
          <p>
            The period that a <a>timed item</a> is scheduled to run is called
            the <a>active interval</a>.
            Each <a>timed item</a> has only one such interval.
          </p>
          <p>
            The lower bound of the <a>active interval</a> is determined by the
            <a title="timed item start time">start time</a> of the <a>timed
            item</a> but may be shifted by a <a>start delay</a> on the <a>timed
            item</a>.
          </p>
          <p>
            The upper bound of the interval is determined by the <a>active
            duration</a>.
          </p>
          <p>
            The relationship between the <a title="timed item start time">start
            time</a>, <a>start delay</a>, and <a>active duration</a> is
            illustrated below.
          </p>
          <div class="figure">
            <img src="img/active-interval-examples.svg" width="600">
          </div>
          <p class="caption">
            Examples of the effect of the <a>start delay</a> on the endpoints of
            the <a>active interval</a>.<br>
            (a) A timed item with no delay; the <a title="timed item start
            time">start time</a> and beginning of the <a>active interval</a> are
            coincident.<br>
            (b) A timed item with a positive delay; the beginning of the
            <a>active interval</a> is deferred by the delay.<br>
            (c) A timed item with a negative delay; the beginning of the
            <a>active interval</a> is brought forward by the delay.
          </p>
        </div>
        <p>
          <a title="timed item">Timed items</a> define an <dfn>active
          interval</dfn> which is the period of time during which the item is
          scheduled to produce its effect (with the exception of <a title="fill
          mode">fill modes</a> which apply outside the <a>active interval</a>).
        </p>
        <p>
          The lower bound of the <a>active interval</a> is defined by the
          combination of the timed item's <a title="timed item start time">start
          time</a> and <a>start delay</a>
        </p>
        <p>
          A <a>timed item</a>'s <dfn title="timed item start time">start
          time</dfn> is the moment at which the <a>parent timing group</a>, if
          any, has scheduled the <a>timed item</a> to begin.
          It is expressed in <a>inherited time</a>.
          In most cases, including the case when the <a>timed item</a> has no
          <a>parent timing group</a>, the <a title="timed item start time">start
          time</a> is zero.
          The singular exception is <a title="sequence timing group">sequence
          timing groups</a> which set the <a title="timed item start time">start
          times</a> of their children as described in <a
          href="#the-start-time-of-children-of-a-sequence-timing-group"
          class="sectionRef"></a>.
        </p>
        <p>
          In addition to the <a title="timed item start time">start time</a>,
          a <a>timed item</a> also has a <dfn>start delay</dfn> which is an
          offset from the <a title="timed item start time">start time</a>.
          Unlike the <a title="timed item start time">start time</a> which is
          determined by the <a>parent timing group</a>, the <a>start delay</a>
          is a property of the <a>timed item</a> itself.
        </p>
        <p>
          The lower bound of the <a>active interval<a> of a <a>timed item</a>,
          expressed in <a title="inherited time">inherited time space</a>, is
          the sum of the <a title="timed item start time">start time</a> and the
          <a>start delay</a>.
        </p>
        <p>
          These definitions are incorporated in the calculation of the <a>local
          time</a> (see <a href="#local-time-and-inherited-time"
          class="sectionRef"></a>) and <a>active time</a>.
        </p>
        <p>
          The length of the <a>active interval</a> is called the <dfn>active
          duration</dfn>, the calculation of which is defined in <a
          href="#calculating-the-active-duration" class="sectionRef"></a>.
        </p>
      </section>
      <section>
        <h3>Local time and inherited time</h3>
        <div class="informative">
          <p>
            In Web Animations all times are relative to some point of reference.
            These different points of reference produce different <em>time
            spaces</em>.
          </p>
          <p>
            This can be compared to coordinate spaces as used in computer
            graphics.
            The zero time of a time space is analogous to the origin of
            a coordinate space.
          </p>
          <p>
            Just as with coordinate spaces, time spaces can also be nested.
            <a title="timing group">Timing groups</a> typically perform some
            transformations on the <a title="time value">time values</a> they
            receive from their <a title="parent timing group">parent</a> or
            <a>player</a> before passing on the transformed <a
            title="time value">time values</a> to their children.
            Child <a title="timed item">timed items</a> then operate
            <em>within</em> that transformed time space.
          </p>
          <p>
            Children take the transformed time values from their
            parent&mdash;called the <a>inherited time</a>&mdash; and add their
            <a title="timed item start time">start time</a> to establish their
            own <a title="local time">local time space</a> as illustrated below.
          </p>
          <div class="figure">
            <img src="img/local-time.svg" width="600">
          </div>
          <p class="caption">
            Inherited time and local time.<br>
            At time <var>t</var>, the <a>inherited time</a> is 2.5.<br>
            For <a>timed item</a> (a) which has a <a
              title="timed item start time">start time</a> of 1, the <a>local
              time</a> is 1.5.<br>
            For <a>timed item</a> (b) which has a <a
              title="timed item start time">start time</a> of 1
              and a <a>start delay</a> of 1,
              the <a>local time</a> is also 1.5
              since <a>local time</a> is based on a <a>timed item</a>'s
              <a title="timed item start time">start time</a> only,
              and not on its <a>start delay</a>.
          </p>
        </div>
        <p>
          For a <a>timed item</a>, the <dfn>inherited time</dfn> at
          a given moment is based on the first matching condition from the
          following:
        </p>
        <dl class="switch">
          <dt>If the <a>timed item</a> has a <a>parent timing group</a>,</dt>
          <dd>
            the inherited time is the <a>parent timing group</a>'s current
            <a title="transformed time">transformed time value</a>.
          </dd>
          <dt>If the <a>timed item</a> is directly associated with
              a <a>player</a>,</dt>
          <dd>
            the inherited time is the <a>current time</a> of the
            <a>player</a>.
          </dd>
          <dt>Otherwise,</dt>
          <dd>
            the inherited time is <code>null</code>.
          </dd>
        </dl>
        <p>
          The <dfn>local time</dfn> of a <a>timed item</a> is the sum of the
          <a>timed item</a>'s <a>inherited time</a> and its <a
          title="timed item start time">start time</a>.
          If the <a>inherited time</a> is <code>null</code> then the local time
          is also <code>null</code>.
        </p>
      </section>
      <section>
        <h3>Timed item states</h3>
        <div class="informative">
          <p>
            At given moment, a <a>timed item</a> may be described as being in
            one of several overlapping states.
            These states are only established for the duration of a single
            sample and are primarily a convenience for describing stative parts
            of the model such as event dispatch.
          </p>
          <p>
            The different states are illustrated below.
          </p>
          <div class="figure">
            <img src="img/timed-item-states.svg" width="700">
          </div>
          <p class="caption">
            An example of the different states used for describing a <a>timed
            item</a> at a given time.
            Note that a <a>timed item</a> is considered to be <a>in effect</a>
            for all times inside the <a>active interval</a> as well as times
            outside the <a>active interval</a> where a <a>fill mode</a> is
            applied.
          </p>
          <p>
            These states and their useage within the model are summarised as
            follows:
          </p>
          <dl>
            <dt><a>scheduled</a></dt>
            <dd>
              The <a>timed item</a>'s <a>local time</a> falls before the item's
              <a>active interval</a>.
              This state is only used in conjunction with the
              <a><em>active</em></a> state to define the <a><em>current</em></a>
              state.
            </dd>
            <dt><a>active</a></dt>
            <dd>
              The <a>timed item</a>'s <a>local time</a> falls inside the item's
              <a>active interval</a>.
              Transitions to and from the <a><em>active</em></a> state trigger
              timing events as defined in <a href="#timing-events"
              class="sectionRef"></a>.
            </dd>
            <dt><a>current</a></dt>
            <dd>
              <p>
                The <a>timed item</a>'s <a>local time</a> falls either before or
                inside the item's <a>active interval</a>, <em>or</em> the
                <a>local time</a> of an ancestor <a>timing group</a> falls
                before or inside its <a>active interval</a> thereby opening up
                the possibility that this <a>timed item</a> might play again
                (e.g. due to repeating).
              </p>
              <p>
                This state is used in the <a
                href="#script-interface">programming interface</a> to identify
                all <a title="animation">animations</a> and <a
                title="player">players</a> that are likely to be of interest.
              </p>
              <p>
                Furthermore, the <a>current</a> state provides an important
                definition for managing the amount of memory required by
                implementations.
                Assuming a monotonically increasing <a>timeline</a>, in the
                absence of dynamic changes to the model, an implementation can
                safely discard all <a title="timed item">timed items</a> that
                are <em>not</em> <a>current</a> and not referenced elsewhere
                provided they take care to preserve any <a title="fill
                mode">fill values</a> since they will not have any dynamic
                effect.
              </p>
            </dd>
            <dt><a>in effect</a></dt>
            <dd>
              The <a>timed item</a>'s <a>local time</a> falls either inside the
              item's <a>active interval</a> or outside the interval but at
              a time where the item's <a>fill mode</a> (see <a
              href="#fill-behavior" class="sectionRef"></a>) causes it to affect
              its target.
              <a title="timed item">Timed items</a> only produce
              a <a>transformed time</a> when the item is <a>in effect</a>.
              At all other times, the <a>transformed time</a> of a <a>timed
              item</a> is <code>null</code>.
            </dd>
          </dl>
          <p>
            The normative definition of each of these states follows.
          </p>
        </div>
        <p>
          A <a>timed item</a> is <dfn>scheduled</dfn> if <em>either</em> of the
          following conditions is true:
        </p>
        <ol>
          <li>the timed item's <a>local time</a> is not <code>null</code> and is
              less than the item's <code>startDelay</code>, or</li>
          <li>the timed item has a <a>parent timing group</a> which is
              a <a>scheduled</a> timed item.</li>
        </ol>
        <p>
          A <a>timed item</a> is <dfn>active</dfn> if <em>all</em> of the
          following conditions are met:
        </p>
        <ol>
          <li>the <a>timed item</a>'s <a>local time</a> is not
              <code>null</code>, and</li>
          <li>the <a>timed item</a>'s <a>local time</a> is <em>greater than or
              equal</em> to its <a>start delay</a>, and</li>
          <li>the <a>timed item</a>'s <a>local time</a> is <em>less than</em>
              the sum of its <a>start delay</a> and <a>active duration</a>.</li>
        </ol>
        <p>
          A timed item is <dfn>current</dfn> if it is either <a>scheduled</a> or
          <a>active</a> or it has a <a>parent timing group</a> and the
          <a>parent timing group</a> is <a>current</a>.
        </p>
        <p>
          A timed item is <dfn>in effect</dfn> if its <a>active time</a> as
          calculated according to the procedure in <a
          href="#calculating-the-active-time" class="sectionRef"></a> is not
          <code>null</code>.
        </p>
      </section>
    </section>

    <section>
      <h2>Fill behavior</h2>
      <p>
        The effect of a <a>timed item</a> outside its <a>active interval</a> is
        determined by its <dfn>fill mode</dfn>.
      </p>
      <p>
        The possible <a title="fill mode">fill modes</a> are:
      </p>
      <ul>
        <li>none,</li>
        <li>forwards,</li>
        <li>backwards, and</li>
        <li>both.</li>
      </ul>
      <p>
        The normative definition of these modes is incorporated in the
        calculation of the <a>active time</a> in <a
        href="#calculating-the-active-time" class="sectionRef"></a>.
      </p>
      <section class="informative">
        <h3>Fill modes</h3>
        <p>
          The effect of each <a>fill mode</a> is as follows:
        </p>
        <dl>
          <dt>none</dt>
          <dd>
            The timed item has no effect outside of the <a>active interval</a>.
          </dd>
          <dt>forwards</dt>
          <dd>
            For times that occur later than the <a>active interval</a>, the
            timed item will continue to produce the same <a title="transformed
            time">transformed time value</a> that was used at the end of the
            <a>active interval</a>.

            For times that occur before the <a>active interval</a>, the
            timed item will have no effect.
          </dd>
          <dt>backwards</dt>
          <dd>
            For times that occur before the <a>active interval</a>, the timed
            item will produce the same <a title="transformed time">transformed
            time value</a> that will be used at the start of the <a>active
            interval</a>.

            For times that occur later than the <a>active interval</a>, the
            timed item will have no effect.
          </dd>
          <dt>both</dt>
          <dd>
            For times that occur before the <a>active interval</a>, the
            backwards fill behavior is used.

            For times that occur after the <a>active interval</a>, the
            forwards fill behavior is used.
          </dd>
        </dl>
        <p>
          Some examples of the these fill modes are illustrated below.
        </p>
        <div class="figure">
          <img src="img/animation-state-and-fill-behavior.svg" width="600">
        </div>
        <p class="caption">
          Examples of various fill modes and the states produced.<br>
          (a) fill mode &lsquo;none&rsquo;. The timed item has no effect outside
              its active interval.<br>
          (b) fill mode &lsquo;forwards&rsquo;. After the active interval has
              finished, the timed value continues to maintain a fill value.<br>
          (c) fill mode &lsquo;backwards&rsquo;. The timed item produces a fill
              value until the start of the active interval.<br>
          (d) fill mode &lsquo;both&rsquo;. Both before and after the active
              interval the timed item produces a fill value.
        </p> 
        <p class="note">
          Note that setting a fill mode has no bearing on the endpoints of the
          <a>active interval</a>.
          However, the fill mode <em>does</em> have an effect on various other
          properties of the timing model since the <a>active time</a> of a timed
          item is only defined (that is, not <code>null</code>) inside the
          <a>active interval</a> <em>or</em> when a fill is applied.
        </p>
      </section>
    </section>

    <section>
      <h2>Repeating</h2>
      <section>
        <h3>Iteration intervals</h3>
        <p>
          It is possible to specify that a timed item should repeat
          a fixed number of times or indefinitely.
          This repetition occurs <em>within</em> the <a>active interval</a>.
          The span of time during which a single repetition takes place is
          called an <dfn>iteration interval</dfn>.
        </p>
        <p>
          Unlike the <a>active interval</a>, a timed item can have multiple
          <a title="iteration interval">iteration intervals</a> although
          typically only the interval corresponding to the <a>current
          iteration</a> is of interest.
        </p>
        <p>
          The length of a single iteration is called the <dfn>iteration
          duration</dfn>.
          The initial <a>iteration duration</a> of a timed item is simply its
          <a>intrinsic iteration duration</a>.
        </p>
        <p>
          The <dfn>intrinsic iteration duration</dfn> of a timed item is zero,
          however some specific types of timed item such as timing groups
          override this behavior and provide an alternative intrinsic duration
          (see <a
          href="#the-intrinsic-iteration-duration-of-a-parallel-timing-group"
          class="sectionRef"></a> and <a
          href="#the-intrinsic-iteration-duration-of-a-sequence-timing-group"
          class="sectionRef"></a>).
        </p>
        <p>
          The <a>iteration duration</a> of a <a>timed item</a> may be set by the
          author to represent a value other than the <a>intrinsic iteration
          duration</a>.
        </p>
        <div class="informative">
          <p>
            Comparing the <a>iteration duration</a> and the <a>active
            duration</a> we have:
          </p>
          <dl>
            <dt>Iteration duration</dt>
            <dd>
              The time taken for a single iteration of the timed item to
              complete.
            </dd>
            <dt>Active duration</dt>
            <dd>
              The time taken for the entire timed item to complete, including
              repetitions.
              This may be longer or shorter than the <a>iteration duration</a>.
            </dd>
          </dl>
          <p>
            The relationship between the <a>iteration duration</a> and <a>active
            duration</a> is illustrated below.
          </p>
          <div class="figure">
            <img src="img/iteration-intervals.svg" width="600">
          </div>
          <p class="caption">
            A comparison of the <a>iteration duration</a> and <a>active
            duration</a> of a timed item with an <a>iteration count</a> of 2.5.
            Note that the <a>iteration duration</a> for the final iteration does
            not change, it is simply cut-off by the <a>active duration</a>.
          </p>
        </div>
      </section>
      <section>
        <h3>Controlling iteration</h3>
        <p>
          The number of times a <a>timed item</a> repeats is called its
          <dfn>iteration count</dfn>.
          The <a>iteration count</a> is a real number greater than or equal to
          zero.
          The <a>iteration count</a> may also be positive infinity to represent
          that the <a>timed item</a> repeats indefinitely.
        </p>
        <p>
          In addition to the <a>iteration count</a>, <a title="timed item">timed
          items</a> also have an <dfn>iteration start</dfn> property which
          specifies an offset into the series of iterations at which the
          <a>timed item</a> should begin.
          The <a>iteration start</a> is a finite real number greater than or
          equal to zero.
        </p>
        <p>
          The behavior of these parameters is defined in the calculations in <a
          href="#core-timed-item-calculations" class="sectionRef"></a>.
        </p>
        <div class="informative">
          <p>
            The effect of the <a>iteration count</a> and <a>iteration start</a>
            parameters is illustrated below.
          </p>
          <div class="figure">
            <img src="img/iteration-count-and-start.svg" width="600">
          </div>
          <p class="caption">
            The effect of the <a>iteration count</a> and <a>iteration start</a>
            parameters.<br>
            In the first case the <a>iteration count</a> is 2.5 resulting in the
            third iteration being cut-off half way through its <a>iteration
            interval</a>.<br>
            The second case is the same but with an <a>iteration start</a> of
            0.5.
            This causes the <a>timed item</a> to begin half way through the
            first iteration.
          </p>
          <p>
            Unlike the <a>iteration count</a> parameter, the <a>iteration
            start</a> parameter does not effect the length of the <a>active
            duration</a>.
          </p>
          <p>
            Note that values of <a>iteration start</a> greater than or equal to
            one are generally not useful unless used in combination with an
            animation effect that has an <a>accumulation operation</a> property
            of <a title="accumulation operation accumulate">accumulate</a>.
          </p>
        </div>
      </section>
      <section class="informative">
        <h3>Iteration time space</h3>
        <p>
          We have already encountered different time spaces in describing
          <a>local time and inherited time</a> (see <a
          href="#local-time-and-inherited-time" class="sectionRef"></a>).
          Repetition introduces yet another time space: the iteration time
          space.
        </p>
        <p>
          <em>Iteration time space</em> is a time space whose zero time is the
          beginning of a timed item's current iteration.
        </p>
        <p>
          Within the Web Animations model we also refer to <a>active
          time</a> which is a time relative to the beginning of the active
          interval.
          This time space, however, is internal to the model and not exposed in
          the script interface or in markup.
        </p>
        <p>
          These time spaces are illustrated below.
        </p>
        <div class="figure">
          <img src="img/time-spaces.svg" width="600">
        </div>
        <p class="caption">
          A comparison of item time, active time, and iteration time for an
          animation with a iteration duration of 1s and an iteration count of
          2.5.
        </p>
        <p class="note">
          Note that while the time spaces themselves are not bounded, Web
          Animations defines <a>active time</a> and <a>iteration
          time</a> such that they are clamped to a set range as shown in the
          diagram.
          For example, whilst a time of -1 second is a valid time in
          <em>active time space</em>, the procedure for calculating the
          <a>active time</a> defined in <a
          href="#calculating-the-active-time" class="sectionRef"></a> will
          never return a negative value.
        </p>
        <p>
          In addition to these time spaces we can also refer to the
          <em>document time space</em> which is time space of the <a title="time
          value">time values</a> of the <a>document timeline</a> of the <a
          href="http://www.w3.org/TR/html5/browsers.html#active-document">active
          document</a>.
        </p>
      </section>
      <section class="informative">
        <h3>Interval timing</h3>
        <p>
          When a timed item repeats we must define the behavior at the iteration
          boundaries.
          For this and indeed for all interval-timing, Web Animations uses an
          endpoint-exclusive timing model.
          This means that whilst the begin time of an interval
          is included in the interval, the end time time is not.
          In interval notation this can written <code>[begin,end)</code>.
          This model provides sensible behavior when intervals are repeated and
          sequenced since there is no overlap between the intervals.
        </p>
        <p>
          In the examples below, for the repeated item, at local time 1s,
          the iteration time is 0.
          For the sequenced items, at inherited time 1s, only item B will be
          <a>active</a>; there is no overlap.
        </p>
        <div class="figure">
          <img src="img/endpoint-exclusive-timing.svg" width="600">
        </div>
        <p class="caption">
          Illustration of end-point exclusive timing. For both repeated and
          sequenced timed items there is no overlap at the boundaries between
          intervals.
        </p>
        <p>
          An exception to this behavior is that when performing a <a
          href="#fill-behavior">fill</a>, if the fill begins at an
          interval endpoint, the endpoint is used.
          This behavior falls out of the algorithm given in <a
          href="#calculating-the-iteration-time"
          class="sectionRef"></a> and is illustrated below.
        </p>
        <div class="figure">
          <img src="img/endpoint-exclusive-timing-and-fill.svg" width="600">
        </div>
        <p class="caption">
          After one iteration, the iteration time is 0, but after two iterations
          (and thereonwards), the iteration time is equal to the iteration
          duration due to the special behavior defined when a timed item fills.
        </p>
      </section>
    </section>

    <section>
      <h2>Timed item speed control</h2>
      <p>
        Like <a title="player">players</a>, <a title="timed item">timed
        items</a> also have a <dfn title="timed item playback rate">playback
        rate</dfn> parameter.
        The <a title="timed item playback rate">playback rate</a> of a <a>timed
        item</a> is a finite real number that acts as a multiplier when
        calculating the <a>timed item</a>'s <a>transformed time</a> from its
        <a>local time</a>.
      </p>
      <p>
        The effect of setting the <a title="timed item playback rate">playback
        rate</a> of a <a>timed item</a> differs from the setting the <a
        title="player playback rate">playback rate</a> on a player.
        Its behavior is defined in the timing calculations given in <a
        href="#core-timed-item-calculations" class="sectionRef"></a>.
      </p>
      <div class="informative">
        <p>
          In summary, the behaviour of the <a title="timed item playback
          rate">playback rate</a> of a <a>timed item</a> is as follows:
        </p>
        <ul>
          <li>
            The <a title="timed item playback rate">playback rate</a> is applied
            only to the <a>active interval</a> of a <a>timed item</a> and not to
            the time while it is <a title="start delay">delayed</a> or <a
            title="fill mode">filling</a>.
          </li>
          <li>
            Setting a negative <a title="timed item playback rate">playback
            rate</a> on a <a>timed item</a> causes the <a>timed item</a> to
            begin at the end of its <a>active interval</a>.
            This differs from the <a title="player playback rate">playback
            rate</a> on a <a>player</a>.
            Setting a <a title="player playback rate">playback rate</a> on
            a <a>player</a> to a negative value at a moment before the
            <a>player</a>'s </a>source content</a> has begun, will result in the
            <a>source content</a> never playing.
          </li>
          <li>
            Setting the <a title="timed item playback rate">playback rate</a> of
            a <a>timed item</a> affects the calculated value of the <a>active
            duration</a> (see <a href="#calculating-the-active-duration"
            class="sectionRef"></a>).
          </li>
          <li>
            <p>
              Changing the <a title="timed item playback rate">playback rate</a>
              of a <a>timed item</a> whose <a>local time</a> is within its
              <a>active interval</a> will cause it to jump.
              This is because the <a>active duration</a> will be updated but the
              <a>local time</a> will not.
            </p>
            <p>
              Furthermore, if other <a title="timed item">timed items</a> depend
              on the <a>timed item</a>'s <a>active duration</a>, such as sibling
              <a title="timed item">timed items</a> in a <a>sequence timing
              group</a>, they too may jump as a result of setting the <a>timed
              item</a>'s <a title="timed item playback rate">playback rate</a>.
            </p>
            <p>
              For runtime speed control the <a title="player playback
              rate">playback rate</a> of the <a>player</a> should be used.
            </p>
          </li>
        </ul>
      </div>
    </section>

    <section>
      <h2>Core timed item calculations</h2>
      <section class="informative">
        <h3>Overview</h3>
        <p>
          At the core of the Web Animations timing model is the process that
          takes an <a>inherited time</a> value and converts it to an
          <a>iteration time</a>.
        </p>
        <p>
          Following this further transformations are applied before resulting at
          a final <a>transformed time</a>.
        </p>
        <p>
          The first step in this process is to calculate the boundary when the
          <a>timed item</a> is <a>active</a>, that is, the <a>active
          duration</a>.
        </p>
        <p>
          This process is illustrated below.
        </p>
        <div class="figure">
          <img src="img/active-duration-calculation.svg" width="650">
        </div>
        <p class="caption">
          Calculation of the <a>active duration</a> is based on
          multiplying the <a>iteration duration</a> by the <a>iteration
          count</a> and then dividing by the <a title="timed item playback
          rate">playback rate</a>.
        </p>
        <p>
          The process for calculating the <a>active duration</a> is normatively
          defined in <a href="#calculating-the-active-duration"
          class="sectionRef"></a>.
        </p>
        <p>
          Having established the <a>active duration</a>, the process for
          transforming a <a>timed item</a>'s <a>inherited time</a> into its
          <a>transformed time</a> is illustrated below.
        </p>
        <div class="figure">
          <img src="img/time-calculations.svg" width="650">
        </div>
        <p class="caption">
          An overview of timing model calculations.<br>
          (1) The <a>inherited time</a> is converted into a <a>local time</a> by
          incorporating the <a title="timed item start time">start time</a> and
          <a>time drift</a>.<br>
          (2) The <a>local time</a> is converted into an <a>active time</a> by
          incorporating the <a>start delay</a>.<br>
          (3) The <a>playback rate</a> and <a>iteration start</a> properties are
          applied to the <a>active time</a> to produce the <a>scaled active
          time</a>.<br>
          (4) The <a>scaled active time</a> is then converted to an offset
          within a single iteration: the <a>iteration time</a>.<br>
          (5) The <a>iteration time</a> is converted into a <a>directed time</a>
          by incorporating the <a>playback direction</a>.<br>
          (6) Finally any timing functions are applied to the <a>directed
          time</a> to produce the <a>transformed time</a>.
        </p>
        <p>
          Steps 2 to 4 in the diagram are described in the following sections.
          The first step, calculating the <a>local time</a> is described in <a
          href="#local-time-and-inherited-time" class="sectionRef"></a>.
          Steps 5 and 6 are described in
          <a href="#calculating-the-directed-time" class="sectionRef"></a>
          and
          <a href="#calculating-the-transformed-time" class="sectionRef"></a>
          respectively.
        </p>
      </section>
      <section>
        <h3>Calculating the active duration</h3>
        <p>
          In order to calculate the <a>active duration</a> we first define the
          <a>repeated duration</a> as follows:
        </p>
        <blockquote>
          <dfn>repeated duration</dfn> =
            <code><a>iteration duration</a> *
                  <a>iteration count</a></code>
        </blockquote>
        <p>
          The <a>active duration</a> is calculated according to the following
          steps:
        </p>
        <ol>
          <li>
            If the <a title="timed item playback rate">playback rate</a> is
            zero, return <code>Infinity</code>.
          </li>
          <li>
            Otherwise, return <code><a>repeated duration</a>
            / abs(<a title="timed item playback rate">playback rate</a>)</code>.
          </li>
        </ol>
      </section>
      <section>
        <h3>Transforming the local time</h3>
        <section>
          <h4>Calculating the active time</h4>
          <p>
            The <dfn>active time</dfn> is based on the <a>local time</a>
            and <a>start delay</a>.
            It is defined only when the <a>timed item</a> is <a>in effect</a>
            and is calculated according to the following steps:
          </p>
          <ol>
            <li>
              If <a>local time</a> is <code>null</code>, return
              <code>null</code>.
            </li>
            <li>
              If <code><a>local time</a> &lt; <a>start delay</a></code>
              the result depends on the <a>fill mode</a> as follows,
              <dl class="switch">
                <dt>
                  If the <a>fill mode</a> is <em>backwards</em> or
                  <em>both</em>,
                </dt>
                <dd>
                  return zero.
                <dd>
                <dt>
                  Otherwise,
                </dt>
                <dd>
                  return <code>null</code>.
                </dd>
              </dl>
            </li>
            <li>
              If <code><a>local time</a> &lt; <a
              title="timed item start time">start time</a> + <a>active
              duration</a></code>, return <code><a>local time</a> - <a>start
              delay</a></code>.
            </li>
            <li>
              Otherwise, the result depends on the <a>fill mode</a> as follows,
              <dl class="switch">
                <dt>
                  If the <a>fill mode</a> is <em>forwards</em> or <em>both</em>,
                </dt>
                <dd>
                  return the <a>active duration</a>.
                <dd>
                <dt>
                  Otherwise,
                </dt>
                <dd>
                  return <code>null</code>.
                </dd>
              </dl>
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the scaled active time</h4>
          <p>
            Before the <a>active time</a> can be converted to an <a>iteration
            time</a> we must factor in the <a>timed item</a>'s <a
            title="timed item playback rate">playback rate</a> and <a>iteration
            start</a>.
            The return is called the <a>scaled active time</a>.
          </p>
          <p>
            In order to calculate the <a>scaled active time</a> we first
            define the <a>start offset</a> as follows:
          </p>
          <blockquote>
            <dfn>start offset</dfn> =
              <code><a>iteration start</a> * <a>iteration duration</a></code>
          </blockquote>
          <p>
            The <dfn>scaled active time</dfn> is calculated according to
            the following steps:
          </p>
          <ol>
            <li>
              If the <a>active time</a> is <code>null</code>, return
              <code>null</code>.
            </li>
            <li>
              Return the scaled active time based on the
              <a title="timed item playback rate">playback rate</a> as follows,
              <dl class="switch">
                <dt>If the <a title="timed item playback rate">playback rate</a>
                    is negative,</dt>
                <dd>
                Return <code>(<a>active time</a> -
                              <a>active duration</a>)
                        * <a title="timed item playback rate">playback rate</a>
                        + <a>start offset</a></code>.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  Return <code><a>active time</a>
                  * <a title="timed item playback rate">playback rate</a>
                  + <a>start offset</a></code>.
                </dd>
            </li>
          </ol>
        </section>
        <section>
          <h4>Calculating the iteration time</h4>
          <p>
            The <dfn>iteration time</dfn> is calculated according to the
            following steps:
          </p>
          <ol>
            <li>
              If the <a>local time</a> is <code>null</code>,
              return <code>null</code>.
            </li>
            <li>
              If the <a>iteration duration</a> is zero, return zero.
            </li>
            <li>
              If <code><a>scaled active time</a> - <a>start
              offset</a></code> is equal to the <a>repeated duration</a>,
              and <a>iteration count</a> is not zero,
              and <code>(<a>iteration count</a> + <a>iteration start</a>)
              % 1</code> is zero,
              return the <a>iteration duration</a>.
            </li>
            <li>
              Otherwise, return <code><a>scaled active time</a>
              % <a>iteration duration</a></code>.
            </li>
          </ol>
        </section>
      </section>
      <section>
        <h3>Calculating the current iteration</h3>
        <p>
          The <dfn>current iteration</dfn> can be calculated using the
          following steps:
        </p>
        <ol>
          <li>
            If the <a>item time</a> is <code>null</code>, return
            <code>null</code>.
          </li>
          <li>
            If the <a>scaled active time</a> is zero, return zero.
          </li>
          <li>
            If the <a>iteration duration</a> is zero, return
            <code>floor(<a>iteration start</a> + <a>iteration count</a>)</code>.
          </li>
          <li>
            If the <a>iteration time</a> equals the <a>iteration
            duration</a>, return <code><a>iteration start</a>
            + <a>iteration count</a> - 1</code>.
          </li>
          <li>
            Return <code>floor(<a>scaled active time</a> /
            <a>iteration duration</a>)</code>.
            <p class="note">
              If the <a>iteration duration</a> is infinite, the
              result of <code>floor(<a>scaled active time</a> /
              <a>iteration duration</a>)</code> will be zero as defined by
              IEEE 754-2008.
            </p>
          </li>
        </ol>
      </section>
    </section>

    <section>
      <h2>Direction control</h2>
      <p>
        <a title="timed item">Timed items</a> may also be configured to run
        iterations in alternative directions using direction control.
        For this purpose, <a title="timed item">timed items</a> have
        a <dfn>playback direction</dfn> parameter which takes one of the
        following values:
      </p>
      <ul>
        <li>normal,</li>
        <li>reverse,</li>
        <li>alternate, or</li>
        <li>alternate-reverse.</li>
      </ul>
      <p>
        The semantics of these values are incorporated into the calculation of
        the <a>directed time</a> which follows.
      </p>
      <div class="informative">
        <p>
          A non-normative definition of these values is as follows:
        </p>
        <dl>
          <dt>normal</dt>
          <dd>
            All iterations are played as specified.
          </dd>
          <dt>reverse</dt>
          <dd>
            All iterations are played in the reverse direction from the way
            they are specified.
          </dd>
          <dt>alternate</dt>
          <dd>
            Even iterations are played as specified, odd iterations are played
            in the reverse direction from the way they are specified.
          </dd>
          <dt>alternate-reverse</dt>
          <dd>
            Even iterations are played in the reverse direction from the way
            they are specified, odd iterations are played as specified.
          </dd>
        </dl>
      </div>
      <section>
        <h3>Calculating the directed time</h3>
        <p>
          The <dfn>directed time</dfn> is calculated from the <a>iteration
          time</a> using the following steps:
        </p>
        <ol>
          <li>
            Calculate the <var>current direction</var> using the first
            matching condition from the following list:
            <dl class="switch">
              <dt>
                If <a>playback direction</a> is <code>normal</code>,
              </dt>
              <dd>Let the <var>current direction</var> be forwards.</dd>
              <dt>
                If <a>playback direction</a> is <code>reverse</code>,
              </dt>
              <dd>Let the <var>current direction</var> be reverse.</dd>
              <dt>
                Otherwise,
              </dt>
              <dd>
                <ol>
                  <li>
                    Let <var>d</var> be the <a>current iteration</a>.
                  </li>
                  <li>
                    If <a>playback direction</a> is
                    <code>alternate-reverse</code> increment
                    <var>d</var> by 1.
                  </li>
                  <li>
                    <p class="issue">
                      There used to be a step here which seemed to be adding
                      special handling for filling when the item ends on
                      a repeat boundary but it seems like that is taken care
                      of by the calcuation of <a>iteration time</a> and
                      <a>current iteration</a>.
                      Is anything actually needed here?
                    </p>
                  </li>
                  <li>
                    If <code><var>d</var> % 2 == 0</code>, let the
                    <var>current direction</var> be forwards, otherwise let
                    the <var>current direction</var> be reverse.
                  </li>
                </ol>
              </dd>
            </dl>
          </li>
          <li>
            If the <var>current direction</var> is forwards then return
            the <a>iteration time</a>.
            <p>
              Otherwise, return the <a>iteration duration</a>
              - <a>iteration time</a>.
            </p>
          </li>
        </ol>
      </section>
    </section>

    <section>
      <h2>Time transformations</h2>
      <section class="informative">
        <h3>Scaling the time</h3>
        <p>
          It is often desirable to control the rate at which a <a>timed item</a>
          progresses.
          For example, easing the rate of animation can create a sense of
          momentum and produce a more natural effect.
          Conversely, in other situations such as when modelling a discrete
          change, a smooth transition is undesirable and instead it is necessary
          for the <a>timed item</a> to progress in a series of distinct steps.
        </p>
        <p>
          For such situations Web Animations provides a variety of <a
          title="timing function">timing functions</a> that scale the progress
          of a <a>timed item</a>.
        </p>
        <p>
          <a title="timing function">Timing functions</a> take an input time
          fraction and produce a scaled output time fraction.
        </p>
        <div class="figure">
          <img src="img/timing-function-example.svg" width="350">
        </div>
        <p class="caption">
          Example of a timing function that produces a ease-in effect.
          Given a input timing fraction of 0.7, the timing function scales the
          value to produce an output time fraction of 0.52.<br>
          By applying this timing function, time will appear to progress more
          slowly at first but then gradually progress more quickly.
        </p>
        <p>
          Such <a title="timing function">timing functions</a> can be applied to
          an iteration of a <a>timed item</a> as a whole or to a segment of
          a <a>key frame animation effect</a>.
        </p>
      </section>
      <section>
        <h3>Timing functions</h3>
        <p>
          A <dfn>timing function</dfn> takes an input time fraction in the range
          [0, 1] and produces and output time fraction whose range is unbounded
          (i.e. positive and negative infinity are permitted).
        </p>
        <p>
          <a title="timed item">Timed items</a> may have at most one <a>timing
          function</a> associated with them.
        </p>
      </section>
      <section>
        <h3>Scaling using a cubic Bzier curve</h3>
        <div class="informative">
          <p>
            A common method of producing easing effects is to use a cubic Bzier
            curve to scale the time.
            The endpoints of the curve are fixed at (0,0) and (1,1) while two
            control points <var>P1</var> and <var>P2</var> define the shape of
            the curve.
            Provided the <var>x</var> values of <var>P1</var> and <var>P2</var>
            lie within the range [0,1] such a curve produces a function that is
            used to map input times (the <var>x</var> values) onto output times
            (the <var>y</var> values).
            This arrangement is illustrated below.
          </p>
          <div class="figure">
            <img src="img/cubic-bezier-timing-curve.svg" width="500">
          </div>
          <p class="caption">
            A cubic Bzier curve used as a timing function.<br>
            The shape of the curve is determined by the location of the control
            points <var>P1</var> and <var>P2</var>.<br>
            Input time fractions serve as <var>x</var> values of the curve,
            whilst the <var>y</var> values are the output time fractions.
          </p>
          <p>
            Some example cubic Bzier timing functions are illustrated below.
          </p>
          <div class="figure">
            <img src="img/curve-keywords.svg" width="500">
          </div>
          <p class="caption">
            The timing functions produced by each of the keyword values
            associated with cubic Bzier timing functions accepted by the
            <a href="#widl-TimingFunction-createFromString-TimingFunction-DOMString-spec"
            class="idlType"><code>TimingFunction.createFromString</code></a>
            method from the <a href="#script-interface">script interface</a>.
          </p>
        </div>
        <p>
          A <dfn>cubic Bzier timing function</dfn> is a type of <a>timing
          function</a> defined by four real numbers that specify the two control
          points, <var>P1</var> and <var>P2</var>, of a cubic Bzier curve whose
          end points are fixed at (0,0) and (1,1).
          The &#x1d4cd; coordinates of <var>P1</var> and <var>P2</var> are
          restricted to the range [0,1].
        </p>
        <p>
          The evaluation of this curve is convered in many sources such as
          [[FUND-COMP-GRAPHICS]].
        </p>
      </section>
      <section>
        <h3>Timing in discrete steps</h3>
        <div class="informative">
          <p>
            It is possible to scale a timed item's timing so that the timed item
            occurs in a series of discrete steps using a stepping function.
          </p>
          <p>
            Some example step timing functions are illustrated below.
          </p>
          <div class="figure">
            <img src="img/step-timing-func-examples.svg" width="700">
          </div>
          <p class="caption">
            Example step timing functions.
            In each case the domain is the input time fraction whilst the range
            represents the output time fraction produced by the step
            function.<br>
            The first row shows the function for each transition point when only
            one step is specified whilst the second row shows the same for three
            steps.
          </p>
        </div>
        <p>
          A <dfn>step timing function</dfn> is a type of <a>timing function</a>
          that divides the input time into a specified number of intervals that
          are equal in duration.
          The output time, starting at zero, rises by an amount equal to the
          interval duration once during each interval at the transition point
          which may be either the start, midpoint, or end of the interval.
        </p>
        <p>
          In keeping with Web Animation's model for endpoint exclusive
          interval timing (see <a href="#interval-timing"
          class="sectionRef"></a>), the output time at the transition point is
          the time <em>after</em> applying the increase (i.e. the top of the
          step).
        </p>
      </section>
      <section>
        <h3>Calculating the transformed time</h3>
        <p>
          The <dfn>transformed time</dfn> is calculated from the
          <a>directed time</a> using the following steps:
        </p>
        <ol>
          <li>
            If the <a>directed time</a> is <code>null</code>,
            return <code>null</code>.
          </li>
          <li>
            Scale the <a>directed time</a> as follows:
            <dl class="switch">
              <dt>If the <a>timed item</a> has a <a>timing function</a>
                  associated with it,</dt>
              <dd>
                <ol>
                  <li>Let <var>iteration fraction</var> be the result of
                      evaluating <code><a>directed time</a> / <a>iteration
                      duration</a></code> unless <a>iteration duration</a> is
                      zero, in which case let <var>iteration fraction</var> be
                      zero.</li>
                  <li>Let <var>scaled fraction</var> be the result of
                      evaluating the <a>timed item</a>'s <a>timing function</a>
                      with <var>iteration fraction</var> as the input time
                      fraction.
                  <li>Return the result of evaluating
                      <code><a>directed time</a> * <var>scaled
                      fraction</var></code>.
                  </li>
                </ol>
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                Return the <a>directed time</a>.
              </dd>
            </dl>
          </li>
        </ol>
      </section>
    </section>

    <section>
      <h2>Grouping and synchronization</h2>
      <div class="informative">
        <p>
          While it is possible to set the timing properties of <a title="timed
          item">timed items</a> individually, it is often useful to synchronize
          <a title="timed item">timed items</a> so that they share common timing
          properties and maintain their temporal relationship.
          This is achieved using a <a>timing group</a>.
        </p>
        <p>
          A simple example is illustrated below.
        </p>
        <div class="figure">
          <img src="img/grouping-delay.svg" width="800">
        </div>
        <p class="caption">
          Using groups to share common timing properties.<br>
          (a) Shows setting a delay of 5 seconds on individual animations.<br>
          (b) Produces the same effect by setting the delay on the group.
        </p>
        <p>
          When a <a>timing group</a> is directly associated with
          a <a>player</a>, the <a title="timed item">timed items</a> associated
          with the <a>timing group</a> can be seeked, paused, and stopped as
          a unit.
        </p>
      </div>
      <p>
        A <dfn>timing group</dfn> is a type of <a>timed item</a> that contains
        an ordered sequence of zero or more <a title="timed item">timed
        items</a> known as <dfn title="child timed item">child timed
        items</dfn>.
        At a given moment, a <a>timed item</a> may be a <a>child timed item</a>
        of at most one <a>timing group</a> known as the <dfn>parent timing
        group</dfn>.
        Furthermore, the <a>parent timing group</a> cannot be the same <a>timed
        item</a> as the <a>child timed item</a> itself.
      </p>
      <p>
        The temporal relationship between a <a>child timed item</a> and its
        <a>parent timing group</a> is incorporated in the definition of
        <a>inherited time</a> (see <a href="#local-time-and-inherited-time"
        class="sectionRef"></a>).
      </p>
      <section class="informative">
        <h3>Relationship of group time to child time</h3>
        <p>
          The timing of the children of a <a>timing group</a> is based on the
          timing of the group.
          Specifically, times for the children are based on the parent's
          <a>transformed time</a>.
          With regards to repetition, this means the children operate
          <em>inside</em> an iteration of the parent.
        </p>
        <p>
          For example, if a <a>timing group</a> has an <a>iteration count</a> of
          2, then the children of of the group will all play twice since they
          effectively play <em>inside</em> the group's iterations.
        </p>
        <div class="figure">
          <img src="img/grouping-repetition.svg" width="600">
        </div>
        <p class="caption">
          Since children of an <a>timing group</a> base their timing on the
          group's <a>transformed time</a>, when the group repeats, the
          children play again.
        </p>
        <p>
          Note that even in this case, the child <a title="timed item">timed
          items</a> still have only <em>one</em> <a>active interval</a>.
          However, as a result of the parent's timing, the <a>active
          interval</a> is played twice.
        </p>
        <p>
          If an <a>iteration count</a> is specified for the children of a group
          as well as for the group itself, the effect is as if the <a>iteration
          count</a> of the group was multiplied with the <a>iteration count</a>
          of the children.
        </p>
        <div class="figure">
          <img src="img/grouping-repetition-and-animation-repetition.svg"
            width="600">
        </div>
        <p class="caption">
          Specifying an <a>iteration count</a> of 2 on an <a>timing group</a>
          and an <a>iteration count</a> of 3 on one of its children results in
          that child playing 6 times.
        </p>
        <p>
          A further result of the children of a <a>timing group</a> basing their
          timing on the group's <a>transformed time</a> is that they cannot
          animate outside of the group's <a>active interval</a>.
          This is because the <a>transformed time</a> of a group will not
          change outside its <a>active interval</a>.
          This allows groups to <em>clip</em> the playback of their children.
        </p>
        <div class="figure">
          <img src="img/grouping-clipping.svg" width="600">
        </div>
        <p class="caption">
          In the first instance, a <a>timed item</a> has a negative delay and an
          infinite <a>iteration count</a>.<br>
          However, when a similar <a>timed item</a> is placed inside a <a>timing
          group</a> with a specified <a>iteration duration</a> it has the effect
          of clipping the child <a>timed item</a>'s <a>active interval</a>.
        </p>
        <p>
          Some further consequences of <a>timing group</a> children basing their
          timing on their parent group's <a>transformed time</a> are:
        </p>
        <ul>
          <li>
            Setting the <a title="timed item playback rate">playback rate</a> of
            a <a>timing group</a> will speed up or slow down all children.
          </li>
          <li>
            Changing the <a>playback direction</a> of a <a>timing group</a> will
            change the direction of all children.
          </li>
          <li>
            Applying a <a>timing function</a> to a <a>timing group</a> will
            affect the progress of all children.
          </li>
        </p>
      </section>
      <section class="informative">
        <h3>Types of timing groups</h3>
        <p>
          <a>Timing groups</a> can be used to provide different kinds of
          synchronization behavior for their children.
          For example, one type of <a>timing group</a> runs its children in
          parallel, whilst another type runs the children in sequence.
        </p>
        <p>
          Compare the two arrangements illustrated below:
        </p>
        <div class="figure">
          <img src="img/grouping-types.svg" width="600">
        </div>
        <p class="caption">
          Two types of <a title="timing group">timing groups</a>.<br>
          (a) is a <a>parallel timing group</a> where all the children run
              simultaneously.<br>
          (b) is a <a>sequence timing group</a> where the children run in turn.
        </p>
        <p>
          <a title="timing group">Timing groups</a> can also contain other
          <a title="timing group">timing groups</a> which allows for more
          sophisticated synchronization.
          An example is illustrated below.
        </p>
        <div class="figure">
          <img src="img/grouping-nesting.svg" width="600">
        </div>
        <p class="caption">
          A <a>sequence timing group</a> that contains a <a>parallel timing
          group</a> as a child.<br>
          The <a>parallel timing group</a> waits for the previous child of the
          <a>sequence timing group</a> to finish, and then the children of the
          <a>parallel timing group</a> play simultaneously.
          After they have finished the next child of the <a>sequence timing
          group</a> plays.
        </p>
        <p>
          Web Animations defines two types of <a title="timing group">timing
          groups</a>.
        </p>
        <dl>
          <dt><a title="parallel timing group">Parallel timing groups</a></dt>
          <dd>
            Children of the group play simultaneously.
            The <a title="timed item start time">start time</a> of each child
            coincides with the beginning of the group's <a>iteration
            interval</a>.
          </dd>
          <dt><a title="sequence timing group">Sequence timing groups</a></dt>
          <dd>
            Children of the group play in turn beginning with the first child
            and proceeding to the last.
            The <a title="timed item start time">start time</a> of each child is
            set to the end of the <a>active interval</a> of the previous
            sibling.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Parallel timing groups</h3>
        <p>
          A <dfn>parallel timing group</dfn> is a type of <a>timing group</a>
          that schedules its <a title="child timed item">child timed items</a>
          such that they play simultaneously.
        </p>
        <p>
          The <a title="timed item start time">start time</a> of a <a>child
          timed item</a> of a <a>parallel timing group</a> is zero.
        </p>
        <section>
          <h4>The intrinsic iteration duration of a parallel timing group</h4>
          <p>
            The <a>intrinsic iteration duration</a> of a <a>parallel timing
            group</a> is based on the time when the last <a>child timed item</a>
            completes its <a>active interval</a> and is calculated using the
            following procedure.
          </p>
          <ol>
            <li>
              <p>Define the <a>end time</a> of a <a>timed item</a> as
              :</p>
              <blockquote>
                <dfn>end time</dfn> =
                <code><a title="timed item start time">start time</a> + <a>start
                delay</a> + <a>active duration</a></code>
              </blockquote>
            </li>
            <li>
              <p>
                The <a>intrinsic iteration duration</a> depends on the number of
                <a title="child timed item">child timed items</a> as follows,
              </p>
              <dl class="switch">
                <dt>If the group has no <a title="child timed item">child timed
                  items</a>,</dt>
                <dd>
                  the <a>intrinsic iteration duration</a> is zero.
                </dd>
                <dt>Otherwise,</dt>
                <dd>
                  <ol>
                    <li>Let <var>maximum end time</var> be the maximum value
                        after calculating the <a>end time</a> of each <a>child
                        timed item</a> in the group.</li>
                    <li>The <a>intrinsic iteration duration</a> is the result of
                        evaluating <code>max(0, <var>maximum end
                        time</var>)</code>.</li>
                  </ol>
                </dd>
              </dl>
            </li>
          </ol>
          <p class="note">
            Note that for children of a <a>parallel timing group</a>, the <a
            title="timed item start time">start time</a> will always be zero but
            it is included in the definition of <a>end time</a> here since the
            <a>end time</a> is also used to define the <a>intrinsic iteration
            duration</a> of a <a>sequence timing group</a>
            (see <a
            href="#the-intrinsic-iteration-duration-of-a-sequence-timing-group"
            class="sectionRef"></a>).
          </p>
        </section>
      </section>
      <section>
        <h3>Sequence timing groups</h3>
        <p>
          A <dfn>sequence timing group</dfn> is a type of <a>timing group</a>
          that schedules its <a title="child timed item">child timed items</a>
          such that they play in turn following their order in the group.
          This ordering is achieved by adjusting the <a
          title="timed item start time">start time</a> of each <a>child timed
          item</a> in the group.
        </p>
        <section>
          <h4>The start time of children of a sequence timing group</h4>
          <p>
            The <a title="timed item start time">start time</a> of the <a
            title="child timed item">child timed items</a> of a <a>sequence
            timing group</a> is established according to the following
            procedure.
          </p>
          <ol>
            <li>Let the <var>accumulated start time</var> be zero.
            <li>
              <p>
                Iterate over each <a>child timed item</a> in the group beginning
                with the first item in the group and proceed to the last.
                For each child perform the following steps:
              </p>
              <ol>
                <li>
                  Let <var>child</var> be the current child.
                </li>
                <li>
                  Let the <a title="timed item start time">start time</a> of
                  <var>child</var> be <var>accumulated start time</var>.
                </li>
                <li>
                  Let <var>accumulated start time</var> be
                  the <a>end time</a> of <var>child</var> after updating
                  its <a title="timed item start time">start time</a>.
                </li>
              </ol>
            </li>
          </ol>
          <div class="note">
            <p>
              When the <a>active duration</a> is positive infinity the behavior
              for calculating the <a>end time</a> of an <a>timed item</a> and
              the <a title="timed item start time">start time</a> of subsequent
              children follows the usual behavior defined by IEEE 754-2008.
              As a result, if any of the children of a <a>sequence timing
              group</a> has an infinite <a>active duration</a>, any children
              that occur later in the sequence will not play.
            </p>
            <p>
              Similarly, the above procedure does not restrict
              <a title="timed item start time">start times</a> to positive
              values and hence some children may not play due to a negative
              <a>start delay</a> on children that occur earlier in the group
              since their <a>active interval</a> may end before the group's <a
              title="timed item start time">start time</a>.
            </p>
            <p class="todo">
              Need to define if events fire in this case.
            </p>
          </div>
          <div class="informative">
            <p>
              Because the start of the <a>active interval</a> is based on the
              sum of a <a>timed item</a>'s <a
              title="timed item start time">start time</a> <em>and</em> <a>start
              delay</a>, the <a title="active interval">active intervals</a> of
              children of a <a>sequence timing group</a> need not run in strict
              sequence but can be shifted back and forth by using the <a>start
              delay</a> as shown in the following diagram.
            </p>
            <div class="figure">
              <img src="img/sequence-groups-and-start-delays.svg" width="600">
            </div>
            <p>
              A negative <a>start delay</a> can be used to cause the <a>active
              interval</a> of two children to overlap.  Note that the <a>start
              delay</a> affects the <a title="timed item start time">start
              time</a> of subsequent children in the group.
            </p>
          </div>
        </section>
        <section>
          <h4>The intrinsic iteration duration of a sequence timing group</h4>
          <p>
            The <a>intrinsic iteration duration</a> of a <a>sequence timing
            group</a> is equivalent to the <a
            title="timed item start time">start time</a> of a hypothetical
            <a>child timed item</a> appended to the group's children calculated
            according to the procedure described in <a
            href="#the-start-time-of-children-of-a-sequence-timing-group"
            class="sectionRef"></a> unless that produces a negative value, in
            which case the <a>intrinsic iteration duration</a> is zero.
          </p>
          <p>
            As a result, if the <a>sequence timing group</a> has no <a
            title="child timed item">child timed items</a> the <a>intrinsic
            iteration duration</a> will be zero.
          </p>
        </section>
      </section>
    </section>

    <section>
      <h2>Animations</h2>
      <p>
        <dfn title="animation">Animations</dfn> are a kind of <a>timed item</a>
        that apply an <a>animation effect</a> to a target element or
        pseudo-element such as <code>::before</code> and
        <code>::first-line</code> [[!SELECT]].
      </p>
      <section>
        <h3>Calculating the time fraction</h3>
        <p>
          Before passing the <a>transformed time</a> of an <a>animation</a> to
          its <a>animation effect</a> we must convert it to a <em>time
          fraction</em>.  The <dfn>time fraction</dfn> of a <a>timed item</a> is
          calculated according to the following steps:
        </p>
        <dl class="switch">
          <dt>
            If the <a>iteration duration</a> is zero,
          </dt>
          <dd>
            <p>
              the <a>time fraction</a> is as follows,
            </p>
            <dl class="switch">
              <dt>
                If <a>local time</a> &lt; <a>start delay</a>,
              </dt>
              <dd>
                Return the result of recalculating the <a>transformed time</a>
                using a <a>local time</a> of zero and an <a>iteration
                duration</a> of 1.
              </dd>
              <dt>
                Otherwise,
              </dt>
              <dd>
                Return the result of recalculating the <a>transformed time</a>
                using a <a>local time</a> of <a>iteration count</a> and an
                <a>iteration duration</a> of 1.
              </dd>
            </dl>
          </dd>
          <dt>
            Otherwise,
          </dt>
          <dd>
            Return <a>transformed time</a> / <a>iteration duration</a>.
          </dd>
        </dl>
        <p class="note">
          Since <a title="timing function">timing functions</a> are
          allowed to produce output times outside the range [0,1] it is
          possible that the value calculated for a <a>time fraction</a> also
          lies outside this range.
        </p>
      </section>
    </section>

    <section class="informative">
      <h2>Overview of the animation model</h2>
      <p>
        The Web Animations <em>animation model</em> takes the <a
        title="time fraction">time fractions</a> and <a>current iteration</a>
        values produced by the <em>timing model</em> for a given
        <a>animation</a> and applies it as the input to the <a>animation</a>'s
        <a>animation effect</a>.
      </p>
      <p>
        The output of each <a>animation effect</a> is then combined with other
        <a title="animation effect">animation effects</a> using an <a>animation
        stack</a> before being applied to the target properties (see <a
        href="#combining-animations" class="sectionRef"></a>).
      </p>
    </section>

    <section>
      <h2>Animation effects</h2>
      <p>
        An <dfn>animation effect</dfn> takes a <a>time fraction</a> and
        a <a>current iteration</a> value and uses them to calculate an
        <a>animation value</a> for its <a>target property</a>.
        Each <a>animation</a> may have at most one <a>animation effect</a>
        associated with it.
      </p>
      <p class="issue">
        We will probably lift this restriction and allow animations to have
        multiple effects.
      </p>
      <p>
        Since the result of an <a>animation effect</a> is based on the
        <a>time fraction</a> and <a>current iteration</a> value, it is updated
        whenever the timing model is <a title="sampling">sampled</a>.
        Note that changes to the timing model caused by using the <a
        href="#script-interface">programming interface</a> do not cause the
        animation model (and hence <a title="animation effect">animation
        effects</a>) to be updated as described in <a
        href="#interaction-with-script" class="sectionRef"></a>.
      </p>
      <section>
        <h3>Target properties</h3>
        <p>
          Each <a>animation effect</a> has an associated <dfn>target
          property</dfn>.
          Not all properties may be targetted by an <a>animation effect</a>.
          Properties that may be targetted by an <a>animation effect</a> are 
          defined as <dfn>animatable</dfn>.
          The set of <a>animatable</a> properties is is defined in <a
          href="#animatable-properties" class="sectionRef"></a>.
        </p>
        <p>
          An <a>animation effect</a> whose <a>target property</a> has not
          <a>animatable</a> will have no effect on the <a>target property</a>
          although the <a>animation</a> that applies the <a>animation effect</a>
          will still exhibit the usual behavior for a <a>timed item</a> such as
          firing <a title="timing event">timing events</a> and occupying space
          in a <a>sequence timing group</a>.
        </p>
      </section>
      <section>
        <h3>Target property types</h3>
        <p>
          Since the specific operations involved in animating, for example
          a color as opposed to a position, differ, each <a>animatable</a>
          property defines one or more <dfn title="property type">property
          types</dfn> to use when animating.
        </p>
        <p>
          In order to produce a smooth change between property values,
          a procedure for <dfn>interpolation</dfn> is required.
          A given <a>property type</a> is <dfn>interpolable</dfn> if there is
          a procedure defined to interpolate between two values of that type.
        </p>
        <p>
          In order to support <a>accumulation</a> and <a title="composition
          operation add">additive composition</a>,
          a procedure for <dfn>addition</dfn> is required.
          A given <a>property type</a> is <dfn>additive</dfn> if there is
          a procedure defined to add two values of that type.
        </p>
        <p>
          An initial list of <a title="property type">property types</a> and
          their procedures for <a>interpolation</a> and <a>addition</a> is given
          in <a href="#animation-of-property-types" class="sectionRef"></a>.
        </p>
      </section>
      <section>
        <h3>Simple animation values</h3>
        <p>
          The procedure used to calculate an initial output value of an
          <a>animation effect</a> for a given <a>time fraction</a> is dependent
          on the specific type of <a>animation effect</a> and is defined
          subsequently (see <a
          href="#the-iteration-value-of-a-key-frame-animation-effect"
          class="sectionRef"></a> and <a
          href="#the-iteration-value-of-a-path-animation-effect"
          class="sectionRef"></a>).
          This value is called the <dfn>iteration value</dfn> and is
          independent of the <a>current iteration</a> value of the
          <a>animation</a> applying the <a>animation effect</a>.
        </p>
        <p class="issue">
          The name <em>iteration value</em> sounds like something that is part
          of the timing model. We need a more suitable name here. <em>simple
          animation value</em>?
        </p>
      </section>
      <section>
        <h3>Accumulating animation values</h3>
        <p>
          <a title="animation effect">Animation effects</a> may be defined such
          that as the <a>animation</a> that is applying them is repeated, the
          <a>animation value</a> produced builds on the value produced by
          previous iterations.
          This behavior is called <dfn>accumulation</dfn>.
        </p>
        <p>
          The <a>accumulation</a> behavior of an <a>animation effect</a> is
          specified by the <a>animation effect</a>'s <dfn>accumulation
          operation</dfn> property.
          The <a>accumulation operation</a> property takes one of the following
          two values.
        </p>
        <dl>
          <dt><dfn
            title="accumulation operation accumulate">accumulate</dfn></dt>
          <dd>
            <p>
              The <a>animation value</a> for the <a>animation effect</a> is
              added to the final <a>iteration value</a> of the previous
              iteration.
            </p>
            <p class="issue">
              Should this be called <code>linear</code> or <code>sum</code> (to
              match SVG)?
              The only other sort of values I can imagine being used here would
              be things like <code>exponential</code> etc.
            </p>
          </dd>
          <dt><dfn
            title="accumulation operation none">none</dfn></dt>
          <dd>
            The <a>animation value</a> for the <a>animation effect</a> is
            calculated independently of the <a>current iteration</a>.
          </dd>
        </dl>
        <p class="issue">
          Does accumulation actually make sense for path animations or should we
          define this as a property of key frame animations effects only?
        </p>
      </section>
      <section>
        <h3>Calculating the animation value</h3>
        <p>
          The <a>animation value</a> produced by an <a>animation effect</a>
          is based on combining the procedure for calculating an <a>iteration
          value</a> with <a>accumulation</a> behavior.
        </p>
        <p>
          The <dfn>animation value</dfn> for a given <a>time fraction</a> and
          <a>current iteration</a> value is calculated as follows:
        </p>
        <ol>
          <li>Let <var>current iteration value</var> be the <a>iteration
              value</a> calculated using the given <a>time fraction</a>.</li>
          <li>
            <p>
              Return the animation value based on the first matching condition
              from the following,
            </p>
            <dl class="switch">
              <dt>If <a>accumulation operation</a> is <a
                title="accumulation operation none">none</a>,
                or the <a>property type</a> of <var>current iteration
                value</var> is not <a>additive</a>,</dt>
              <dd>
                Return <var>current iteration value</var>.
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                <ol>
                  <li>Let <var>last value</var> be the result of evaluating
                      the <a>iteration value</a> of the <a>animation effect</a>
                      with a <a>time fraction</a> of 1.</li>
                  <li>Let <var>previous iteration value</var> be the result of
                      <a title="addition">adding</a> <var>last value</var> to
                      itself <a>current iteration</a> times.
                  <li>Return the result of <a title="addition">adding</a>
                      <var>current iteration value</var> to
                      <var>previous iteration value</var>.</li>
                </ol>
              </dd>
            </dl>
          </li>
        </ol>
        <p class="issue">
          This definition relies on the final value of <a
          title="timing function">timing functions</a> being 1.
        </p>
        <p class="issue">
          Should this be called <em>effect value</em>?
          <em>animation value</em> is quite generic and is likely to be used
          elsewhere with a different meaning.
          <em>effect value</em> emphasises that this is the output of a single
          <a>animation effect</a> before compositing.
        </p>
      </section>
    </section>

    <section>
      <h2>Animatable properties</h2>
      <div class="todo">
        Refer to where this is defined specifically, e.g. <a
        href="http://www.w3.org/TR/css3-transitions/#animatable-properties">http://www.w3.org/TR/css3-transitions/#animatable-properties</a>.
      </div>
    </section>

    <section>
      <h2>Animation of property types</h2>
      <div class="todo">
        <p>
          Write common definitions (e.g. generic formula for a weighted sum).
        </p>
        <p>
          Go through each type and define <a>interpolation</a> (if it's
          <a>interpolable</a>) and <a>addition</a> (if it's <a>additive</a>).
          A table or a definition list would do.
        </p>
        <p>
          Don't forget to include path data as one of the types.
        </p>
        <p>
          For transforms, point to CSS Transforms.
          <a href="http://www.w3.org/TR/css3-transforms/#animation">http://www.w3.org/TR/css3-transforms/#animation</a>.
          Addition (post-multiplication) is defined here: <a
          href="http://www.w3.org/TR/css3-transforms/#svg-animation">http://www.w3.org/TR/css3-transforms/#svg-animation</a>.
        </p>
      </div>
    </section>

    <section>
      <h2>Key frame animation effects</h2>
      <p>
        A <dfn>key frame animation effect</dfn> is an <a>animation effect</a>
        that produces <a title="animation value">animation values</a> for
        a property by interpolating between a series of property values
        positioned at fractional offsets in the range [0,1].
      </p>
      <p>
        Each pair of a property value and a corresponding offset is called
        a <dfn>key frame</dfn>.
        A <a>key frame</a> may also provide an optional <a>timing function</a>
        which scales the <a>timing fraction</a> values between the <a>key
        frame</a> and the next <a>key frame</a> in the list.
      </p>
      <p>
        If, due to a <a>timing function</a> specified on either the <a>timed
        item</a> from which the <a>time fraction</a> is derived or on an
        individual <a>key frame</a>, the scaled <a>time fraction</a> lies
        outside the range [0,1], the specified <a>key frame</a> property values
        are extrapolated to cover the extended range.
      </p>
      <p>
        The behavior when <a title="key frame">key frames</a> overlap or have
        unsupported values is defined in the following section, <a
        href="#the-iteration-value-of-a-key-frame-animation-effect"
        class="sectionRef"></a>.
      </p>
      <section>              
        <h3>The iteration value of a key frame animation effect</h3>
        <p>
          The <a>iteration value</a> of a <a>key frame animation effect</a> for
          a given <a>time fraction</a> is calculated as follows.
        </p>
        <ol>
          <li>If the target property of the effect is not <a>animatable</a>
              abort the procedure since the effect cannot be applied.</li>
          <li>Let <var>key frames</var> be the list of <a title="key frame">key
              frames</a> specified on the effect.</li>
          <li>Let <var>time fraction</var> be the <a>time fraction</a> for which
              the <a>iteration value</a> is to be calculated.</li>
          <li>Let <var>underlying value</var> be the current <a>underlying
              value</a> provided by the <a>compositor</a>.
          <li>Sort <var>key frames</var> using a <a
              href="http://en.wikipedia.org/wiki/Sorting_algorithm#Stability">stable
              sort</a> such that the <a>key frame</a> offsets are in ascending
              order.</li>
          <li>Remove any <a title="key frame">key frames</a> from <var>key
              frames</var> whose offset is outside the range [0,1].</li>
          <li>Remove any <a title="key frame">key frames</a> from <var>key
              frames</var> whose property value is invalid or unsupported.</li>
          <li>If <var>key frames</var> is an empty list, return <var>underlying
              value</var>.</li>
          <li>If there is no <a>key frame</a> with offset of 0, create a new key
              frame with an offset 0, a property value set to <var>underlying
              value</var>, and no <a>timing function</a> and add it to the
              beginning of <var>key frames</var>.
              <p class="issue">
                This behavior is currently under discussion.
              </p>
          </li>
          <li>Similarly, if there is no <a>key frame</a> with offset of 1,
              create a new key frame with an offset 1, a property value set to
              <var>underlying value</var>, and no <a>timing function</a> and
              append it to the end of <var>key frames</var>.</li>
          <li>If <var>time fraction</var> is less zero and there is more than
              one <a>key frame</a> in <var>key frames</var> with offset 0,
              return the property value of the first <a>key frame</a> in
              <var>key frames</var>.</li>
          <li>If <var>time fraction</var> is greater than or equal to 1 and
              there is more than one <a>key frame</a> in <var>key frames</var>
              with offset of 1, return the property value of the last <a>key
              frame</a> in <var>key frames</var>.</li>
          <li>Let <var>start key frame</var> be the last <a>key frame</a> in
              <var>key frames</var> whose offset is less than or equal to
              <var>time fraction</var> and less than 1.
              If there is no such <a>key frame</a> (because, for example,
              the <a>time fraction</a> is negative), let <var>start key
              frame</var> be the last <a>key frame</a> whose offset is 0.</li>
          <li>Let <var>end key frame</var> be the next <a>key frame</a> in
              <var>key frames</var> after <var>start key frame</var>.</li>
          <li>If the pair of property values specified by <var>start key
              frame</var> and <var>end key frame</var>
              differ in <a>property type</a> or have the same <a>property
              type</a> but that type is not <a>interpolable</a>,
              then return the property value of <var>start key frame</var>
              unless <var>time fraction</var> is greater than or equal to 1, in
              which case return the property value of <var>end key
              frame</var>.</li>
          <li>Let <var>start offset</var> be the offset of <var>start key
              frame</var>.</li>
          <li>Let <var>end offset</var> be the offset of <var>end key
              frame</var>.</li>
          <li>
            Let <var>interval distance</var> be the result of evaluating
            <code>(<var>time fraction</var> - <var>start offset</var>) /
                  (<var>end offset</var> - <var>start offset</var>)</code>
          </li>
          <li>
            Calculate the <var>scaled interval distance</var> as follows,
            <dl class="switch">
              <dt>If <var>start key frame</var> has a <a>timing
              function</a>,</dt>
              <dd>
                <p>
                  Let <var>scaled interval distance</var> be the result of
                  evaluating the <a>timing function</a> associated with
                  <var>start key frame</var> using <var>interval distance</var>
                  as the input to the funcion.
                </p>
                <p class="issue">
                  <var>interval distance</var> may be outside the range [0,1]
                  due to timing functions applied to the <a>timed item</a>.
                  The only sensible way I can think of for handling this is to
                  require that timing functions handle inputs outside the range
                  [0,1].
                </p>
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                The <var>scaled interval distance</var> is simply the
                <var>interval distance</var>.
              </dd>
            </dl>
          </li>
          <li>
            Return the result of <a title="interpolation">interpolating</a>
            between the property values defined for <var>start key frame</var>
            and <var>end key frame</var> using the procedure defined for their
            <a>property type</a> with <var>scaled interval distance</a> as the
            interpolation parameter.
          </li>
        </ol>
        <p class="note">
          Note that this procedure permits overlapping <a title="key frame">key
          frames</a>.
          The behavior is that at the point of overlap the output value jumps to
          the value of last defined <a>key frame</a> at that offset.
          For overlapping frames at 0 or 1, the output value for <a
          title="time fraction">time fractions</a> less than 0 or greater than
          or equal to 1 is the value of the first <a>key frame</a> or the last
          <a>key frame</a> in <var>key frames</var> respectively.
        </p>
      </section>
    </section>

    <section>
      <h2>Path animation effects</h2>
      <p>
        A <dfn>path animation effect</dfn> is an <a>animation effect</a> that
        produces transform <a title="animation value">animation values</a>
        such that a <a>target element</a> follows a specified geometric curve.
      </p>
      <div class="todo">
        <p>
          This whole section needs to be written.
          There are several parameters:
        </p>
        <ul>
          <li>The geometric curve</li>
          <li>The rotation parameter (can be none|auto|reverse)</li>
          <li>Parameters for controlling timing (cf. SVG's
              keyPoints/keyTimes)</li>
        </ul>
        <p>
          Not sure what we do about paced timing.
        </p>
        <p>
          Need to describe how <a
          href="http://www.w3.org/TR/css3-transforms/#transform-origin">transform-origin</a>
          is applied.
        </p>
      </div>
      <section>
        <h4>The iteration value of a path animation effect</h4>
        <div class="todo">
        <p>
          When  <var>rotate</var> is set to false, the <var>animation
          value</var> at <a>time fraction</a> <var>t</var> is the transform
          defined by a translation equal to the location on the path at
          <var>t</var>.
        </p>
        <p>
          When <var>rotate</var> is set to true, the
          <var>animation value</var> is the transform defined by the above
          translation followed by a rotation defined by the following
          process:
        </p>
        <ol>
          <li>
            Calculate the <var>normal</var> to the path at <var>t</var> (see <a href="#calculating-the-normal-to-a-path" class="sectionRef"></a>).
          </li>
          <li>
            Determine the <var>normal rotation</var>, which is given by 
            <code>atan2(normal.y, normal.x)</code>.
          </li>
          <li>
            The <var>rotation</var> is the transform that rotates by
            the <var>normal rotation</var>.
          </li>
        </ol>
        </div>
      </section>
      <section>
        <h3>Calculating the normal to a path</h3>
        <p class="todo">Write me</p>
      </section>
    </section>

    <section>
      <h2>Combining animations</h2>
      <div class="informative">
        <p>
          It is possible for multiple <a>in effect</a> <a
          title="animation">animations</a> to target the same property.
          When this happens it is necessary to determine both
          <em>how</em> the <a title="animation effect">animation effects</a>
          associated with the <a title="animation">animations</a> are combined
          with one another,
          as well as the <em>order</em> in which they are applied, that is,
          their relative <em>priority</em>.
        </p>
        <p>
          The matter of <em>how</em> <a title="animation effect">animation
          effects</a> are combined is governed by the <a>composition
          operation</a> associated with the <a>animation effect</a>.
        </p>
        <p>
          The relative <em>priority</em> of <a title="animation
          effect">animation effects</a> is determined by an <a>animation
          stack</a> established for each animated property.
        </p>
      </div>
      <section>
        <h3>The animation stack</h3>
        <p>
          Associated with each property targetted by an <a>animation effect</a>
          excluding <a title="custom animation effect">custom animation
          effects</a> is an <dfn>animation stack</dfn> that establishes the
          relative priority of the <a title="animation effect">animation
          effects</a>.
        </p>
        <p>
          The relative priority of any two <a title="animation effect">animation
          effects</a> is, <var>A</var> and <var>B</var>, within an <a>animation
          stack</a> is established by comparing the properties of the
          <a title="animation">animations</a> applying the <var>A</var> and
          <var>B</var> as follows:
        </p>
        <ol>
          <li>Let the <dfn>associated player</dfn> of an <a>animation effect</a>
              be the <a>player</a> associated with the <a>animation</a> that is
              applying the <a>animation effect</a> to the property with which
              this <a>animation stack</a> is associated.</li>
          <li>Let the <dfn>associated timeline</dfn> of an <a>animation
              effect</a> be the <a>timeline</a> with which the <a>associated
              player</a> is associated.</li>
          <li>Let the <dfn>effect start time</dfn> be the <a
              title="player start time">start time</a> of the <a>associated
              player</a> minus the <a>zero time</a> of the <a>associated
              timeline</a>.</li>
          <li>Sort <var>A</var> and <var>B</var> by <a>effect start time</a> so
              that the earlier time sorts first.</li>
          <li>If the order of <var>A</var> and <var>B</var> is not resolved
              (because they have the same <a>effect start time</a>) sort by the
              type of source that generated the <a
              title="animation">animations</a> applying <var>A</var> and
              <var>B</var> such that animations generated by CSS sort before
              animation generated by document markup (e.g. SVG animations) which
              sort before animation generated by calls to the <a
              href="#script-interface">script interface</a>.</li>
          <li>
            <p>
              If the order of <var>A</var> and <var>B</var> is still not
              resolved (because the animations applying them come from the same
              type of source) then resolve the order as follows:
            </p>
            <dl class="switch">
              <dt>If <var>A</var> and <var>B</var> are applied by CSS
                  animations,</dt>
              <dd>
                <p>
                  Sort <var>A</var> and <var>B</var> based on the <a
                  href="http://www.w3.org/TR/CSS21/cascade.html#cascading-order">cascading
                  order</a> [[!CSS21]] of the most specific declaration
                  associated with the <a title="animation">animations</a>
                  applying <var>A</var> and <var>B</var>.
                </p>
                <p class="todo">
                  Once the CSS integration spec has made more progress we
                  should be able to tighten this up by re-using some of the
                  terms defined there.
                </p>
              </dd>
              <dt>If <var>A</var> and <var>B</var> are applied by animations
                  created by markup (e.g. SVG),</dt>
              <dd>
                <ol>
                  <li>Let <var>element A</var> be the DOM <a href="">Element</a>
                      the produced the <a>animation</a> applying
                      <var>A</var>.
                      Likewise <var>element B</var> for <var>B</var>.
                  </li>
                  <li>
                    <p>
                      Sort <var>A</var> and <var>B</var> based on the associated
                      <var>element A</var> and <var>element B</var> as follows:
                    </p>
                    <dl class="switch">
                      <dt>If <var>element A</var> and <var>element B</var>
                          belong to the <em>same</em> document,</dt>
                      <dd>
                        Sort <var>A</var> and <var>B</var> by the <a
                        href="http://www.w3.org/TR/dom/#concept-tree-order">tree
                        order</a> [[!DOM4]] of <var>element A</var> and
                        <var>element B</var>.
                      </dd>
                      <dt>Otherwise,</dt>
                      <dd>
                        <p class="issue">
                          What do we do here?
                          If one element is in the same doc as the target
                          property it should probably have lower priority, but
                          what if they're both in different documents?
                        </p>
                      </dd>
                    </dl>
                  </li>
                </ol>
              </dd>
              <dt>Otherwise if <var>A</var> and <var>B</var> are applied by <a
                  title="Animation interface">Animation</a> objects generated by
                  calls to the <a href="#script-interface">script
                  interface</a>,</dt>
              <dd>
                <p>
                  Sort <var>A</var> and <var>B</var> by the order in which
                  <code>play</code> was called on their <a>associated
                  players</a>.
                </p>
                <p>
                  This may be achieved, for example, by associating each
                  <a>player</a> with the value of a global sequence number at
                  the time when <code>play</code> was called (explicitly or
                  implicitly via, for example, <code>Element.animate</code>) and
                  then incrementing that sequence number.
                </p>
                <p>
                  If <var>A</var> and <var>B</var> have the same <a>associated
                  player</a>, sort by a preorder depth-first traversal of the
                  <a>source content</a> of the <a>associated player</a>.
                </p>
              </dd>
            </dl>
          </li>
        </ol>
        <p>
          <a title="animation effect">Animation effects</a> that sort earlier
          have <em>lower</em> priority.
        </p>
        <p class="annotation">
          If we introduce <a title="timeline">timelines</a> that are not
          associated with the <a>global clock</a> we will need to revise this
          since it won't be possible to calculated an <a>effect start time</a>
          in global time space in that case.
        </p>
      </section>
      <section>
        <h3>Calculating the result of an animation stack</h3>
        <p>
          In order to calculate the final value of an <a>animation stack</a>
          the <a title="animation value">animation values</a> of each
          <a>animation effect</a> in the stack are combined in order of priority
          from lowest to highest priority.
        </p>
        <p>
          Each step in the process of evaluating an <a>animation stack</a> takes
          an <dfn>underlying value</dfn> as input.
          The initial <a>underlying value</a> is the <a>base value</a> of the
          target property as defined in <a
          href="#base-values--animation-values--and-the-override-stylesheet"
          class="sectionRef"></a>.
        </p>
        <p>
          For each <a>animation effect</a> in the stack, the <a>animation
          value</a> of the <a>animation effect</a> is combined with the
          <a>underlying value</a> and produces a new value.
          This resulting value becomes the <a>underlying value</a> for combining
          the next <a>animation effect</a> in the stack.
        </p>
        <p>
          The final value of an <a>animation stack</a>, called the
          <dfn>composited value</dfn>, is simply the result of the final
          (highest priority) <a>animation effect</a> in the stack.
        </p>
      </section>
      <section>
        <h3>Animation composition</h3>
        <p>
          The specific operation used to combine an <a>animation effect</a>'s
          <a>animation value</a> with an <a>underlying value</a> is determined
          by the <a>animation effect</a>'s <dfn>composition operation</dfn>.
        </p>
        <p>
          The possible <a title="composition operation">composition
          operations</a> and their meanings are as follows:
        </p>
        <dl>
          <dt><dfn title="composition operation replace">replace</dfn></dt>
          <dd>
            The result of compositing the <a>animation value</a> with the
            <a>underlying value</a> is simply the <a>animation value</a>.
          </dd>
          <dt><dfn title="composition operation add">add</dfn></dt>
          <dd>
            <p>
              The <a>animation value</a> is <a title="addition">added</a> to the
              <a>underlying value</a>.
              For <a title="property type">property types</a> where
              <a>addition</a> is defined such that it is not commutative, the
              order of the operands is <code><a>underlying value</a>
              + <a>animation value</a></code>.
            </p>
            <p>
              If <a>animation value</a> and <a>underlying value</a> are not of
              the same <a>property type</a>, or if they are of the same
              <a>property type</a> but that <a>property type</a> is not
              <a>additive</a>, <a
              title="composition operation replace">replace</a> behavior is
              applied.
            </p>
          </dd>
          <dt><dfn title="composition operation merge">merge</dfn></dt>
          <dd>
            <p class="issue">
              How do we define this?
              I think we wanted to go for a <a
              href="http://www.w3.org/Graphics/fx/wiki/Web_Animations/Issues/Grouping_of_Animations#Allow_parametric_merge">parametric
              merge</a> rather than rely on parent timing.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>Base values, animation values, and the override stylesheet</h3>
        <div class="informative">
          <p>
            The application of an <a>animation stack</a> occurs within a wider
            context of values applied to a property both before and after the
            <a>animation stack</a> as illustrated below.
          </p>
          <p class="todo">
            Diagram
          </p>
        </div>
        <p>
          Applying animation to a property depends on establishing an
          <a>override stylesheet</a>.
        </p>
        <p>
          The <dfn>override stylesheet</dfn> contains output animation values
          and acts with a higher priority than all other stylesheets.
          However, <code>!important</code> rules from all other stylesheets act
          with a higher priority than the override stylesheet.
          The <a>override stylesheet</a> is regenerated each time the
          <a>animation model</a> is updated (see <a href="#animation-effects"
          class="sectionRef"></a>).
        </p>
        <p>
        </p>
        <p>
          The <a>composited value</a> calculated for a property is applied
          using the following process.
        </p>
        <ol>
          <li>Calculate the <dfn>base value</dfn> of the property as
              the value generated for that property by computing the <a
              href="http://www.w3.org/TR/CSS2/cascade.html#used-value">used
              value</a> [[!CSS21]] for that property in the absence of the
              <a>override stylesheet</a>.</li>
          <li>Establish the <a>animation stack</a> for the property (see <a
              href="#the-animation-stack" class="sectionRef"></a>).</li>
          <li>Calculate the <a>composited value</a> of the <a>animation
              stack</a> passing in the <a>base value</a> of the property as the
              initial <a>underlying value</a> (see <a
              href="#calculating-the-result-of-an-animation-stack"
              class="sectionRef"></a>).</li>
          <li>Insert the <a>composited value</a> into the <a>override
              stylesheet</a>.</li>
        </ol>
      </section>
    </section>

    <section>
      <h3>Custom animation effects</h3>
      <div class="informative">
        <p>
          In some situations the animation effects provided by Web Animations
          may be insufficient.
          For example, the animation effects defined here are only able to
          target certain CSS properties and DOM attributes.
          They are unable, therefore, to modify the <a
          href="http://www.w3.org/TR/SVG11/struct.html#__svg__SVGSVGElement__currentScale"><code>currentScale</code></a>
          property of an SVG element to smoothly zoom the viewport without
          affecting the document content.
        </p>
        <p>
          In such cases where the provided animation effects do not provide
          needed functionality, an animation effect defined by script may be
          used.
          Such animation effects receive a time fraction from the timing
          model and are responsible for producing the animation effect
          corresponding to the specified time.
        </p>
        <p>
          Using an animation effect defined in script it is possible to
          animate not only previously un-animatable attributes and properties,
          but potentially anything that is accessible via script, including
          even producing audio or creating vibrations.
        </p>
        <p>
          For example, using an animation effect that draws to a <a
          href="http://www.w3.org/TR/html5/the-canvas-element.html#the-canvas-element"><code>canvas</code></a>
          element it is possible to produce a complex animated effect
          featuring patterns that may be difficult to create using CSS or
          SVG.
          Compared to using the <a
          href="http://www.w3.org/TR/animation-timing/">WindowAnimationTiming</a>
          interface, this approach ensures the animation is frame-rate
          independent and can be paused, reversed, eased with timing effects,
          accelerated, synchronized with other animations, and be controlled
          in the same manner as any other Web Animations animation without any
          additional programming.
        </p>
      </div> <!-- informative -->
      <div class="annotation">
        <p>
          I think we want two types of custom animation effects.
          Following is the general-purpose animate-anything kind of effect.
          The other type, which is not defined here, is the one that can
          participate in the animation sandwich just like any other.
        </p>
        <p>
          This, second, native-like animation effect, would have the
          following features:
        </p>
        <ul>
          <li>Shares the same function signature as
              <code><a>AnimationEffect</a>.sample</code></li>
          <li>Gets passed the underlying value and passes out the animated
              value.</li>
          <li>Has a target attribute and is sorted against other
              <a>AnimationEffect</a> objects (including platform
              objects)</li>
          <li>Can be added as a child of
              a <a>GroupedAnimationEffect</a>.</li>
        </ul>
        <p>
          That's a bit more difficult since you have to be careful that the
          custom effect doesn't do anything naughty while you're in the
          middle of compositing the animation sandwich.
          I think we should postpone this until Web Animations 2.
        </p>
      </div>
      <section>
        <h4>Execution order of custom animation effects</h4>
        <p>
          Custom animation effects allow authors to define animation effects
          using script.
          Such animation effects are not limited to a single CSS property or
          DOM attribute and therefore the steps for assessing their order of
          execution differs from regular animation effects.
        </p>
        <p>
          Custom animation effects are executed after all other
          <a>AnimationEffect</a> objects have completed and applied their
          effects to their targets.
        </p>
        <p class="issue">
          Need to define this more precisely.
          Are styles flushed?
          Presumably they are.
          Can we suspend reflow for the duration of executing the script-based
          animation effects and just do it once afterwards?
        </p>
        <p>
          Within the set of custom animation effects, the order of execution
          is mostly the same as that for other animation effects and is
          defined in <a href="#the-global-animation-stack"
          class="sectionRef"></a>.
          However, custom animation effects may also override this
          ordering through the <code>priority</code> attribute, which, if
          defined, specifies the priority of the effects with lower numbers
          are executed sooner.
        </p>
        <p>
          In deciding which of two <a>CustomAnimationEffect</a> objects,
          <var>A</var> and <var>B</var>, should be executed the following
          rules are applied.
        </p>
        <ol>
          <li>Sort <var>A</var> and <var>B</var> based on their
              <code>priority</code> such that lower priorities are sorted
              first.
              If either does not have a defined <code>priority</code>,
              then treat the priority as being positive infinity for the
              purposes of sorting.</li>
          <li>If <var>A</var> and <var>B</var> have the same priority,
              sort according to the <code>startTime</code>s of the
              <a>TimedItem</a>s with which <var>A</var> and <var>B</var> are
              associated such that earlier start times are sorted first.
          <li>If <var>A</var> and <var>B</var> have the same priority and
              start time, sort by the position of the corresponding
              <a>Animation</a> objects occur within the animation tree (see
              issue below).</li>
        </ol>
        <p>
          Items sorted earlier, are executed first.
        </p>
        <p class="issue">
          That last point is quite wrong. I don't think we've specified
          exactly what script order is in <a
          href="#the-global-animation-stack" class="sectionRef"></a>.
          But I wonder if it makes more sense to effectively enumerate all the
          script-based nodes in the animation tree using some well-defined
          order and use that index.
          Can that be done efficiently?
        </p>
      </section>
    </section>

    <section>
      <h2>Synchronizing with media</h2>
      <div class="todo">
        Currently investigating integration with HTML5's MediaController object.
      </div>
      <section>
        <h3>The <code>MediaItem</code> interface</h3>
        <dl title="interface MediaItem : TimedItem" class="idl">
          <dt>attribute HTMLMediaElement element</dt>
          <dd>
            A pointer to the element?
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Script interface</h2>
      <div class="informative">
        <p>
          In addition to the abstract model described above, Web Animations also
          defines a programming interface to the model.
          This interface can be used to inspect and extend animations produced
          by declarative means or for directly producing animations when
          a procedural approach is more suitable.
        </p>
      </div>
      <section>
        <h3>The <code>Timeline</code> interface</h3>
        <p>
          <a title="timeline">Timelines</a>, including the <a>document
          timeline</a> are represented in the Web Animations API by the
          <a title="Timeline interface">Timeline</a> interface.
        </p>
        <dl title="interface Timeline" class="idl">
          <dt>readonly attribute double? currentTime</dt>
          <dd>
            <p>
              Returns the <a>time value</a> for this timeline or
              <code>null</code> if this timeline is <a>not started</a>.
            </p>
            <p>
              For a <a>document timeline</a> this will never be negative and
              represents the number of seconds since the document with which
              this timeline is associated was ready to fire its load event.
            </p>
          </dd>
          <dt>Player play()</dt>
          <dd>
            <p>
              Creates a new <a title="Player interface">Player</a> object
              associated with this <a>timeline</a> that is scheduled to start
              at <code>currentTime</code>.
            </p>
            <p>
              The <code>timeline</code> attribute of the newly-created <a
              title="Player interface">Player</a> object will be set to this
              object.
            </p>
            <p>
              Similarly, the <code>startTime</code> attribute will be set to the
              value of this object's <code>currentTime</code> attribute at the
              moment the method was called, or, if <code>currentTime</code> is
              <code>null</code>, zero.</li>
            </p>
            <p>
              The setting of the <code>source</code> attribute is described
              below under the description of the <em>source</em> parameter.
            </p>
            <p>
              The <code>currentTime</code> attribute of the <a title="Player
              interface">Player</a> object is a calculated value described in <a
              href="#the-current-time-of-a-player" class="sectionRef"></a>.
            </p>
            <p>
              The <code>playbackRate</code> and <code>paused</code> attributes
              take on their default values as described in the definitions of
              the <a title="player playback rate">playback rate</a> and
              <a>paused state</a> properties of <a>player</a> objects.
            </p>
            <dl class="parameters">
              <dt>optional TimedItem? source = null</dt>
              <dd>
                <p>
                  The <a>source content</a> to assign to the newly-created <a
                  title="Player interface">Player</a> object.
                </p>
                <p>
                  The <code>source</code> attribute is set by following the
                  procedure defined for updating that attribute.
                  As a result, if <em>source</em> is already associated with
                  a <code>player</code>, it will be disassociated first before
                  being associated with the new <a title="Player
                  interface">Player</a> object.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>double? toTimelineTime (double otherTime, Timeline other)</dt>
          <dd>
            <p>
              Returns the <a>time value</a>, <em>otherTime</em>, from another
              <a title="Timeline interface">Timeline</a> also tied to the
              <a>global clock</a>, <em>other</em>, converted to a <a>time
              value</a> relative to this timeline's <a>zero time</a>.
            </p>
            <p>
              Returns <code>null</code> if:
            </p>
            <ul>
              <li>this timeline is <a>not started</a>, or</li>
              <li><em>other</em> is <a>not started</a>.</li>
            </ul>
            <p>
              Note that unlike <code>currentTime</code>, this method may return
              a negative <a>time value</a> if <em>otherTime</em> occurred prior
              to this timeline's <a>zero time</a>.
            </p>
            <p>
              Furthermore, negative values for <em>otherTime</em> are also
              allowed.
            </p>
            <p>
              If this timeline records the <a>time value</a> of the <a>global
              clock</a> at its <a>zero time</a> as <var>global clock
              offset</var>, and so does <em>other</em> as <var>other global
              clock offset</var>, then the result of this method is simply:
            </p>
            <blockquote>
              <code><var>other global clock offset</var> + <var>otherTime</var>
              - <var>global clock offset</var></code>
            </blockquote>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>InvalidNodeTypeError</code></dt>
              <dd>
                Raised if <em>other</em> is a timeline that is not tied to the
                <a>global clock</a>.
                <p class="annotation">
                  The reason for choosing <code>InvalidNodeTypeError</code> here
                  is that DOM4 describes it as meaning, "The supplied node is
                  incorrect or has an incorrect ancestor for this operation."
                  In this case the error is because <em>other</em> does not have
                  the <a>global clock</a> as an ancestor so it seems
                  appropriate.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>double? toTimelineTime (Event event)</dt>
          <dd>
            <p>
              Returns the number of seconds between when <em>event</em> was
              fired and when this document time source began.
            </p>
            <p>
              Since the <code>timeStamp</code> attribute of the
              <code>Event</code> interface specified in [[DOM-LEVEL-3-EVENTS]]
              is not guaranteed to be monotonically increasing, implementations
              SHOULD record alongside each event the <a>time value</a> of the
              <a>global clock</a> when the event is dispatched so that it can be
              converted to an accurate <a>time value</a> here.
            </p>
            <p>
              Returns <code>null</code> if the time of the event precedes when
              this document time source <a title="begins to play">began to
              play</a> or if this document time source has not yet begun to
              play.
            </p>
            <p class="issue">
              This might be deferred to a later version.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>Player</code> interface</h3>
        <p>
          <a title="player">Players</a> are represented in the Web Animations
          API by the <a title="Player interface">Player</a> interface.
        </p>
        <dl title="interface Player" class="idl">
          <dt>attribute TimedItem? source</dt>
          <dd>
            <p>
              The <a>source content</a> associated with this player.
            </p>
            <p>
              A <a>player</a> can only be associated with at most one <a>timed
              item</a>, and likewise, a <a>timed item</a> can only be
              associated&mdash;either directly or via an ancestor&mdash;with at
              most one <a>player</a>.
              In order to maintain these invariants, on setting this value, the
              following procedure is performed:
            </p>
            <ol>
              <li>Let <var>old value</var> be the current value of the
                  <code>source</code> attribute.</li>
              <li>Let <var>new value</var> be the value to set.</li>
              <li>If <var>new value</var> is the same object as <var>old
                  value</var>, return.</li>
              <li>If <var>old value</var> is not <code>null</code>,
                  disassociate <var>old value</var> from this player.</li>
              <li>If <var>new value</var> is not <code>null</code>,
                  perform the steps associated with the first matching condition
                  of the following:
                <dl class="switch">
                  <dt>If <var>new value</var> has no parent group and is
                      associated with a player,</dt>
                  <dd>disassociate <var>new value</var> from its player.</dd>
                  <dt>If <var>new value</var> has a parent group,</dt>
                  <dd>remove <var>new value</var> from its parent group by
                      calling <code><var>new
                      value</var>.parentGroup.remove(<var>new
                      value</var>.parentGroup.indexOf(<var>new
                      value</var>))</code>.</dd>
                  <dt>Otherwise,</dt>
                  <dd>do nothing.</dd>
                </dl>
              </li>
              <li>Associate <var>new value</var> with this player.
              <li>Set the <code>source</code> attribute to <var>new
                  value</var>.</li>
            </ol>
          </dd>
          <dt>readonly attribute Timeline timeline</dt>
          <dd>
            The <a>timeline</a> associated with this player.
          </dd>
          <dt>attribute double startTime</dt>
          <dd>
            The <a>start time</a> of this player.
          </dd>
          <dt>attribute double currentTime</dt>
          <dd>
            The <a>effective current time</a> of this player.
            Setting this attribute follows the procedure defined in <a
            href="#performing-a-seek" class="sectionRef"></a>.
          </dd>
          <dt>attribute double playbackRate</dt>
          <dd>
            The <a title="player playback rate">playback rate</a> of this
            player.
            Setting this attribute follows the procedure defined in <a
            href="#updating-the-playback-rate" class="sectionRef"></a>.
          </dd>
          <dt>attribute boolean paused</dt>
          <dd>
            The <a>paused state</a> of this player.
            Setting this attribute follows the procedure defined in <a
            href="#updating-the-paused-state" class="sectionRef"></a>.
          </dd>
          <dt>void reverse()</dt>
          <dd>
            Sets the <code>playbackRate</code> to the negative complement of its
            current value by following the procedure defined in <a
            href="#updating-the-playback-rate" class="sectionRef"></a>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>TimedItem</code> interface</h3>
        <p>
          <a title="timed item">Timed items</a> are represented in the Web
          Animations API by the <a>TimedItem</a> interface.
        </p>
        <dl title="interface TimedItem : EventTarget" class="idl">
          <dt>// Playback state</dt><dd></dd>
          <dt>readonly attribute double? localTime</dt>
          <dd>
            <p>
              The <a>local time</a> of this <a>timed item</a> in seconds.
            </p>
            <p>
              <code>localTime</code> will be <code>null</code> if this <a>timed
              item</a> is not directly or indirectly associated with
              a <a>player</a> or if it has a parent <a>timing group</a> that is
              not <a>in effect</a>.
            </p>
          </dd>
          <dt>readonly attribute unsigned long? currentIteration</dt>
          <dd>
            The current iteration index beginning with zero for the first
            iteration as described in <a
              href="#calculating-the-current-iteration" class="sectionRef"></a>.
          </dd>
          <dt>// Specified timing</dt><dd></dd>
          <dt>readonly attribute TimingDictionary specified</dt>
          <dd>
            <p>
              The timing parameters for this <a>TimedItem</a>.
            </p>
            <div class="note">
              <p>
                Note that while the <a>TimingDictionary</a> object itself is
                readonly, its members are writeable. For example:
              </p>
              <pre class='example sh_javascript'>
anim.specified.startDelay = 3; // OK
anim.specified = { startDelay: 3 }; // Not OK--'specified' is read-only
              </pre>
            </div>
          </dd>
          <dt>// Calculated timing</dt><dd></dd>
          <dt>readonly attribute double startTime</dt>
          <dd>
            <p>
              The <a>start time</a> of this <a>timed item</a> in seconds.
              This is the time at which the parent <a>timing group</a>, if any,
              has scheduled this child to run within its <a title="transformed
              time">transformed time space</a>, that is, the <a>timed item</a>'s
              <a title="inherited time">inherited time space</a>.
            </p>
            <p>
              The start of the <a>active interval</a> is based on the sum of
              the <code>startTime</code> and <code>specified.startDelay</code>.
            </p>
          </dd>
          <dt>readonly attribute unrestricted double iterationDuration</dt>
          <dd>
            <p>
              The <a>iteration duration</a> of this <a>timed item</a>.
            </p>
            <p>
              Unlike <code>specified.iterationDuration</code>,
              this attribute never returns the string <code>auto</code>.
              Instead, such values are expanded to the current calculated value
              of the <a>intrinsic iteration duration</a>.
            </p>
            <p>
              This attribute cannot be set.
              To set the timed item's <a>iteration duration</a> use
              <code>specified.iterationDuration</code>.
            </p>
          </dd>
          <dt>readonly attribute unrestricted double activeDuration</dt>
          <dd>
            <p>
              The calculated length, in seconds, of the <a>active interval</a>.
            </p>
            <p>
              This value may be overridden by setting
              <code>specified.activeDuration</code>.
            </p>
          </dd>
          <dt>readonly attribute unrestricted double endTime</dt>
          <dd>
            <p>
              The upper bound of the <a>active interval</a> expressed in
              seconds in <a title="inherited time">inherited time space</a>.
            </p>
            <p>
              <code>endTime</code> is calculated as
              <code><a>start time</a> + <a>start delay</a> + <a>active
                    duration</a></code>
            </p>
            <p class="note">
              Note that while the <code>endTime</code> is read-only, it can be
              set indirectly by setting <code>specified.activeDuration</code>.
              For example, to set <code>endTime</code> to time <var>t</var> in
              <a>inherited time</a>,
              set <code>specified.activeDuration</code> to
              <code><var>t</var> - startTime - specified.startDelay</code>.
            </p>
          </dd>
          <dt>// Associated player</dt><dd></dd>
          <dt>Player? getPlayer()</dt>
          <dd>
            <p>
              The <a>player</a> associated with this <a>timed item</a> either
              directly or indirectly.
              This object can be used to perform play control such as pausing or
              rewinding on this <a>timed item</a> <em>and all other timed items
              in the same hierarchy</em>.
            </p>
            <p>
              Since <a title="player">players</a> are only associated with the
              root <a>timed item</a> in a hierarchy, this method will look up
              the parent <a>timing group</a> of this <a>timed item</a>, if any,
              and continue all the way to the root of the hierarchy and then
              return the <a>player</a> associated with the root item, if any.
            </p>
            <p>
              This method will return <code>null</code> if this <a>timed
              item</a> is not associated&mdash;directly or indirectly&mdash;with
              a <a>player</a>.
            </p>
          </dd>
        </dl>
        <p class="annotation">
          In future we may introduce <code>iterationTime</code> which
          corresponds to the <a>iteration time</a>.
          The advantage of exposing this is that it could be writeable since the
          transformation from iteration time to local time should be invertible.
          It is also probably the time we will use for <a>TimingEvent</a> times.
        </p>
      </section>
      <section>
        <h3>The <code>TimingDictionary</code> dictionary</h3>
        <p>
          Timing parameters for a <a>TimedItem</a> are collected together under
          the <a>TimingDictionary</a> type.
        </p>
        <dl title="dictionary TimingDictionary" class="idl">
          <dt>double startDelay = 0</dt>
          <dd>
            <p>
              The <a>start delay</a> which represents the number of seconds from
              a <a>timed item</a>'s <code>startTime</code> to the start of the
              <a>active interval</a>.
            </p>
          </dd>
          <dt>FillMode fillMode = "forwards"</dt>
          <dd>
            <p>
              The <a>fill mode</a> as specified by one of the <a>FillMode</a>
              enumeration values.
            </p>
            <p class="note">
              Note that in both CSS Animations [[CSS3-ANIMATIONS]] and SVG
              [[SVG112]] the default fill mode is "none".
              Web Animations differs in this regard since it was determined
              that when generating animations from script, forwards filling is
              the more commonly-desired behavior.
            </p>
            <p class="issue">
              Some feedback suggests the default here should be "both".
            </p>
          </dd>
          <dt>double iterationStart = 0.0</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a>iteration start</a> property.
            </p>
            <p>
              A finite real number greater than or equal to zero representing
              the number of iterations into the timed item at which to begin.
              For example, a value of 0.5 would cause the timed item to begin
              half-way through the first iteration.
            </p>
            <p>
              The <code>iterationCount</code> is effectively <em>added</em> to
              the <code>iterationStart</code> such that a timed item with an
              <code>iterationStart</code> of &lsquo;0.5&rsquo; and
              <code>iterationCount</code> of &lsquo;2&rsquo; would still
              repeat twice however it would begin and end half-way through
              the timed item's <a>iteration interval</a>.
            </p>
            <p>
              Setting the <code>iterationStart</code> to a value greater than
              or equal to one is typically only useful in combination with an
              animation effect that has an <code>accumulate</code> property of
              &lsquo;accumulate&rsquo;.
            </p>
            <p>
              Values less than zero are clamped to zero for the purpose of
              timing model calculations.
            </p>
          </dd>
          <dt>unrestricted double iterationCount = 1.0</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a>iteration count</a> property.
            </p>
            <p>
              A real number greater than or equal to zero (including positive
              infinity) representing the number of times to repeat the
              timed item.
            </p>
            <p>
              Values less than zero are treated as the value <code>1.0</code>
              for the purpose of timing model calculations.
            </p>
          </dd>
          <dt>(unrestricted double or DOMString) iterationDuration = "auto"</dt>
          <dd>
            <p>
              A real number greater than or equal to zero (including positive
              infinity) representing the number of times to repeat the
              timed item, that is, the <a>iteration duration</a>.
            </p>
            <p>
              The string value <code>auto</code> is used to indicated that the
              <a>iteration duration</a> reflects the timed item's <a>intrinsic
              iteration duration</a>.
            </p>
            <p>
              Real numbers less than zero and strings other than the value
              <code>auto</code> (in lowercase) are treated are treated the same
              as <code>auto</code>, that is, the <a>intrinsic iteration
              duration</a> for the purpose of timing model calculations.
            </p>
          </dd>
          <dt>double playbackRate = 1.0</dt>
          <dd>
            <p>
              The <a>timed item<a>'s <a
              title="timed item playback rate">playback rate</a> property.
            </p>
            <p>
              A multiplier applied to the <a>local time</a> potentially causing
              the item to run at a different rate to its natural speed.
            </p>
          </dd>
          <dt>PlaybackDirection direction = "normal"</dt>
          <dd>
            <p>
              The <a>playback direction</a> of the <a>timed item</a> as
              specified by one of the <a>PlaybackDirection</a> enumeration
              values.
            </p>
          </dd>
          <dt>(DOMString or TimingFunction)? timingFunction = null</dt>
          <dd>
            <p>
              An optional timing function used to scale the time to produce
              easing effects and the like.
            </p>
            <p>
              Unlike the <a>TimedItem</a> interface, the member here may be set
              to either a <a>TimingFunction</a> object or
              a <code>DOMString</code> corresponding to one of the values
              recognized by <a
              href="#widl-TimingFunction-createFromString-TimingFunction-DOMString-spec"
              class="idlType"><code>TimingFunction.createFromString</code></a>.
            </p>
          </dd>
        </dl>
        <section>
          <h4>The <code>FillMode</code> enumeration</h4>
          <dl title="enum FillMode" class="idl">
            <dt>none</dt>
            <dd>
              No fill.
            </dd>
            <dt>forwards</dt>
            <dd>
              Fill forwards.
            </dd>
            <dt>backwards</dt>
            <dd>
              Fill backwards.
            </dd>
            <dt>both</dt>
            <dd>
              Fill backwards and forwards.
            </dd>
          </dl>
        </section>
        <section>
          <h4>The <code>PlaybackDirection</code> enumeration</h4>
          <dl title="enum PlaybackDirection" class="idl">
            <dt>normal</dt>
            <dd>
              All iterations are played as specified.
            </dd>
            <dt>reverse</dt>
            <dd>
              All iterations are played in the reverse direction from the way
              they are specified.
            </dd>
            <dt>alternate</dt>
            <dd>
              Even iterations are played as specified, odd iterations are played
              in the reverse direction from the way they are specified.
            </dd>
            <dt>alternate-reverse</dt>
            <dd>
              Even iterations are played in the reverse direction from the way
              they are specified, odd iterations are played as specified.
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>The <code>TimingFunction</code> interface</h3>
        <p>
          The <a title="timing function">timing functions</a> provided by Web
          Animations share a common <a>TimingFunction</a> interface as defined
          below.
        </p>
        <dl title="interface TimingFunction" class="idl">
          <dt>double scaleTime()</dt>
          <dd>
            <p>
              Takes an input time fraction in the range [0, 1] and applies some
              transformation on the value to produce an output time fraction.
            </p>
            <dl class="parameters">
              <dt>double time</dt> <!-- Oh yeah! -->
              <dd>
                The input time fraction.
              </dd>
              <dt>TimedItem? item</dt>
              <dd>
                <p>
                  The <a>TimedItem</a> for which the time scaling operation is
                  being performed.
                </p>
                <p>
                  Some timing functions, for example, may produce different
                  results depending on the animation values involved to produce
                  an even rate of change.
                </p>
                <p>
                  This may be <code>null</code>, for example, when invoked
                  directly by user code for the purpose of testing or re-using
                  the scaling operation in another context.
                </p>
                <p>
                  Implementations of this interface for which there is no
                  meaningful result in the absence of a <a>TimedItem</a> will
                  simply return <code>time</code> unchanged when
                  <code>item</code> is <code>null</code>.
                </p>
              </dd>
            </dl>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <var>time</var> is outside the range [0, 1].
              </dd>
            </dl>
            <p class="issue">
              Should be just clamp x values to the range [0, 1] ?
            </p>
          </dd>
          <dt>TimingFunction clone()</dt>
          <dd>
            <p>
              For implementations of this interface that have local state,
              produces an identical but independent copy of this object.
              For implementations without local state, returns the same object.
            </p>
          </dd>
          <dt>static TimingFunction? createFromString(DOMString spec)</dt>
          <dd>
            <p>
              Creates a new <a>TimingFunction</a> object based on a string-based
              specification (e.g. "ease-in").
            </p>
            <p>
              The acceptable values and their meanings are those defined for the
              <a
              href="http://www.w3.org/TR/css3-transitions/#transition-timing-function-property">transition-timing-function</a>
              property in CSS Transitions [[!CSS3-TRANSITIONS]].
            </p>
            <p>
              In addition to the values defined in CSS Transitions, this method
              extends the <code>steps()</code> function notation to allow
              &lsquo;middle&rsquo; as a transition point keyword (e.g.
              <code>steps(3, middle)</code>) corresponding to the
              &lsquo;middle&rsquo; <a>StepPosition</a> value.
              Similarly, the keyword &lsquo;steps-middle&rsquo; is recognized by
              and given the meaning <code>steps(1, middle)</code>.
            </p>
            <p>
              Strings that specify a <code>cubic-bezier()</code> timing function
              result in a new <a>CubicBezierTimingFunction</a> being returned.
              Strings that specify a <code>steps()</code> function produce a new
              <a>StepTimingFunction</a>.
            </p>
            <p>
              If <code>spec</code> is unrecognized, <code>null</code> is
              returned.
              User agents that provide debugging feedback SHOULD report the
              unrecognized value.
            </p>
            <p class="issue">
              Should we make the &lsquo;linear&rsquo; keyword return
              <code>null</code> or <code>new CubicBezierTimingFunction([0, 0, 1,
              1])</code>?<br>
              I think <code>null</code> except that this may mark it
              harder to detect error cases.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h4>The <code>CubicBezierTimingFunction</code> interface</h4>
        <p>
          <a title="cubic Bzier timing function">Cubic Bzier timing
          functions</a> are represented using the
          <code>CubicBezierTimingFunction</code> interface defined below.
        </p>
        <dl title="interface CubicBezierTimingFunction : TimingFunction"
          class="idl">
          <dt>Constructor (sequence&lt;double&gt; points)</dt>
          <dd>
            <p>
              Creates a new <a>CubicBezierTimingFunction</a> object and
              initializes the <code>points</code> member to the passed in list
              of <code>points</code>.
            </p>
            <p class="annotation">
              It would be more convenient for authors if the passed in list of
              points could be longer than four items and we simply read the
              first four items and ignored the rest.
              However, applications may begin to depend on that behavior and
              we could not easily allow this object to take longer lists (to
              represent more complex curves) in the future without adding
              a separate constructor for that purpose.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if any of the <var>x</var> values in
                <code>points</code> is outside the range [0, 1]
                or if the length of <code>points</code> is not 4 items.
              </dd>
            </dl>
          </dd>
          <dt>attribute sequence&lt;double&gt; points</dt>
          <dd>
            <p>
              A sequence of four real numbers representing the coordinates of
              the two control points in the following sequence
              <var>&lt;p1-x&gt;</var> <var>&lt;p1-y&gt;</var>
              <var>&lt;p2-x&gt;</var> <var>&lt;p2-y&gt;</var>.
            </p>
            <p>
              Each of the <var>x</var> values (i.e. <var>p1-x</var> and
              <var>p2-x</var>) must be in the range [0, 1].
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised on setting if an <var>x</var> value is outside the
                range [0, 1].
              </dd>
              <dt>DOMException of type
                  <code>InvalidModificationError</code></dt>
              <dd>
                Raised on attempting to alter the length of
                <code>points</code>.
              </dd>
            </dl>
          </dd>
          <dt>double scaleTime(double time, TimedItem? item)</dt>
          <dd>
            Applies the timing function produced by the cubic Bzier curve
            with points (0,0), (<code>points[0], points[1]</code>),
            (<code>points[2]</code>, <code>points[3]</code>), (1, 1).
          </dd>
          <dt>TimingFunction clone()</dt>
          <dd>
            Returns a copy of this object.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>StepTimingFunction</code> interface</h3>
        <p>
          <a title="step timing function">Step timing functions</a> are
          represented by the <a>StepTimingFunction</a> interface.
        </p>
        <dl title="interface StepTimingFunction : TimingFunction" class="idl">
          <dt>Constructor (unsigned integer numSteps,
                           optional StepPosition position = 'end')</dt>
          <dd>
            <p>
              Creates a new <a>StepTimingFunction</a> with the specified
              number of steps and transition point.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <code>numSteps</code> is zero.
              </dd>
            </dl>
          </dd>
          <dt>attribute unsigned integer numSteps</dt>
          <dd>
            <p>
              A number greater than or equal to one representing the number of
              steps in the function.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised on setting if the number of steps is zero.
              </dd>
            </dl>
          </dd>
          <dt>attribute StepPosition position</dt>
          <dd>
            The point within each interval at which the change in value
            occurs.
          </dd>
          <dt>double scaleTime(double time, TimedItem? item)</dt>
          <dd>
            Returns the value of applying the step function defined by
            <code>numSteps</code> and <code>position</code> with input
            <var>time</var>.
            The behavior of the step function is described in <a
            href="#timing-in-discrete-steps" class="sectionRef"></a>.
          </dd>
          <dt>TimingFunction clone()</dt>
          <dd>
            Returns a copy of this object.
          </dd>
        </dl>
        <section>
          <h4>The <code>StepPosition</code> enumeration</h4>
          <p>
            The point within a step interval at which the change in value occurs
            is specified using one of the <a>StepPosition</a> enumeration
            values.
          </p>
          <dl title="enum StepPosition" class="idl">
            <dt>start</dt>
            <dd>
              The change in value occurs at the beginning of the interval.
            </dd>
            <dt>middle</dt>
            <dd>
              The change in value occurs at the midpoint of the interval.
            </dd>
            <dt>end</dt>
            <dd>
              The change in value occurs at the end of the interval.
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>The <code>TimingGroup</code> interface</h3>
        <p>
          The different types of <a title="timing group">timing groups</a>
          defined by Web Animations share a common <a>TimingGroup</a>
          interface as defined below.
        </p>
        <p>
          The <code>TimingGroup</code> interface supports indexed
          properties with indices in the range 0 &le; <var>index</var> &lt;
          <code>group.size</code>. 
        </p>
        <dl title="interface TimingGroup : TimedItem"
          class="idl">
          <dt>readonly attribute unsigned long length</dt>
          <dd>
            The number of <a title="child timed item">child timed items</a> in
            the group.
          </dd>
          <dt>void clear ()</dt>
          <dd>
            <p>
              Removes all <a title="child timed item">child timed items</a> from
              the group.
            </p>
          </dd>
          <dt>getter TimedItem? (unsigned long index)</dt>
          <dd>
            <p>
              Returns the <a>child timed item</a> at <code>index</code>.
              If <code>index</code> is greater than or equal to
              <code>length</code> returns <code>null</code>.
            </p>
          </dd>
          <dt>setter TimedItem (unsigned long index, TimedItem newItem)</dt>
          <dd>
            <p>
              Replaces the <a>child timed item</a> at <code>index</code> with
              <code>newItem</code> by calling <code>splice(index, 1,
              newItem)</code>.
            </p>
            <p>
              No attempt is made to check if the item at <code>index</code> is
              already <code>newItem</code>.
              In such a case, <code>newItem</code> will be removed from this
              group and re-added as per the usual operation of
              <code>slice</code>.
            </p>
            <p>
              Returns <code>newItem</code>.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <code>index</code> is outside of the range 0 &le;
                <var>index</var> &lt; <code>length</code>.
              </dd>
            </dl>
            <div class="note">
              Whilst <code>splice</code> allows negative indices,
              WebIDL requires index property setters to take an index of type
              <code>unsigned long</code> and hence <code>index</code> is
              restricted to the range 0 &le; <var>index</var> &lt;
              <code>group.length</code>.
            </div>
          </dd>
          <dt>sequence&lt;TimedItem&gt; add (TimedItem newItem,
                                             TimedItem... otherItems)</dt>
          <dd>
            <p>
              Adds <code>newItem</code> and each <code>otherItems</code> as the
              last item(s) in the group by calling <code>splice(group.length, 0,
              newItem, otherItem1, ... otherItemN)</code>.
            </p>
            <p>
              Returns a sequence containing the added items:
              <code>[newItem, otherItem1, ... otherItemN]</code>.
            </p>
          </dd>
          <dt>sequence&lt;TimedItem&gt; remove (
                long index, optional unsigned long count = 1)</dt>
          <dd>
            <p>
              Removes the item(s) at <code>index</code> by calling
              <code>splice(index, count)</code>.
            </p>
            <p>
              Returns the removed items.
            </p>
          </dd>
          <dt>
            sequence&lt;TimedItem&gt; splice ()
          </dt>
          <dd>
            <p>
              Modifies the sequence of <a title="child timed item">child timed
              items</a> of this group by first removing <code>deleteCount</code>
              items from <code>start</code> followed by adding
              <code>newItems</code> at the same point.
            </p>
            <p>
              The operation of slice is based on <a
                href="http://www.ecma-international.org/publications/files/ECMA-ST-ARCH/ECMA-262%205th%20edition%20December%202009.pdf#page=140">ECMAScript 5's
                Array.prototype.splice</a>.
            </p>
            <p>
              Returns a sequence of the items removed from group during the
              removal step (regardless of whether these items were re-added
              during the addition step).
            </p>
            <dl class="parameters">
              <dt>long start</dt>
              <dd>
                The index at which items should be removed and inserted.
                Negative indices represent an offset from the end of the list of
                items.
                This value is clamped to the range [-<code>length</code>,
                <code>length</code>].
              </dd>
              <dt>unsigned long deleteCount</dt>
              <dd>
                The number of items to remove from the group beginning at
                <code>start</code>.
                Negative values are clamped to zero, and all other values are
                clamped such that
                0 &lt; <code>start</code> + <code>deleteCount</code> &le;
                length.
              </dd>
              <dt>sequence&lt;TimedItem&gt; newItems</dt>
              <dd>
                The items to be added at <code>start</code>.
                Each item, if it already has a parent group (including this
                group), is first removed from its parent group before being
                added to this group.
              </dd>
            </dl>
          </dd>
          <dt>
            sequence&lt;TimedItem&gt; splice (long start,
              unsigned long deleteCount, TimedItem... newItem)
          </dt>
          <dd>
            An overload of <code>splice</code> that takes a variadic list of
            items rather than requiring a sequence.
            The operation is identical to <code>splice(unsigned long start,
            unsigned long deleteCount, sequence&lt;TimedItem&gt;
            newItems)</code>.
          </dd>
          <dt>long indexOf (TimedItem item)</dt>
          <dd>
            Returns the index of <code>item</code> within the group.
            If <code>item</code> is not in the group, returns <code>-1</code>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>ParGroup</code> interface</h3>
        <p>
          <a title="parallel timing group">Parallel timing groups</a> are
          represented by the <code>ParGroup</code> interface.
        </p>
        <dl title="interface ParGroup : TimingGroup" class="idl">
          <dt>Constructor ()</dt>
          <dd>
            <p>
              Creates a new <a>ParGroup</a> object using the following
              procedure:
            </p>
            <ol>
              <li>Create a new <a>ParGroup</a> object, <var>group</var>.</li>
              <li>Establish a temporary <a>TimingDictionary</a>, <var>timing
                 dictionary</var>, based on the type of <var>timing</var> as
                 follows,
                <dl class="switch">
                  <dt>If <var>timing</var> is a <a>TimingDictionary</a>
                  object,</dt>
                  <dd>
                    Let <var>timing dictionary</var> refer to
                    <var>timing</var>.
                  </dd>
                  <dt>If <var>timing</var> is a <code>double</code>,</dt>
                  <dd>
                    Let <var>timing dictionary</var> be a new
                    <a>TimingDictionary</a> object with all properties set to
                    their default values and <code>iterationDuration</code> set
                    to <var>timing</var>.
                  </dd>
                  <dt>Otherwise (<var>timing</var> is <code>null</code>),</dt>
                  <dd>
                    Let <var>timing dictionary</var> be a new
                    <a>TimingDictionary</a> object with all properties set to
                    their default values.
                  </dd>
                </dl>
              </li>
              <li>
                <p class="issue">
                  We want to clone <var>timing dictionary</var> to the
                  <code>specified</code> member of <var>group</var> but it seems
                  like WebIDL doesn't allow live dictionaries.
                  Also, we need to decide if we expand timing functions defined
                  by strings, e.g. <code>ease-in</code>, into real
                  <a>TimingFunction</a> objects using
                  <a
                  href="#widl-TimingFunction-createFromString-TimingFunction-DOMString-spec"
                  class="idlType"><code>TimingFunction.createFromString</code></a>.
                </p>
              </li>
              <li>
                Add <var>children</var> to the group by calling
                <code><var>group</var>.splice(0, 0,
                <var>children</var>)</code>.
              </li>
            </ol>
            <dl class="parameters">
              <dt>sequence&lt;TimedItem&gt;? children</dt>
              <dd>
                <p>
                  A sequence of timed items to add as children of this group.
                </p>
                <p>
                  These children are appended in sequence using the same
                  semantics as the <code><a>TimingGroup</a>.add</code> method.
                </p>
              </dd>
              <dt>optional (double or TimingDictionary)? timing = null</dt>
              <dd>
                <p>
                  The timing properties of the new timing group.
                </p>
                <p>
                  If this parameter is a <code>double</code>, then it
                  specifies the duration of a single iteration of the
                  animation, that is, the <a>iteration duration</a>, in
                  seconds.
                </p>
                <p>
                  If this parameter is <code>null</code> the default value for
                  <a>iteration duration</a> specified in the
                  <a>TimingDictionary</a> definition will be used, that is,
                  zero.
                </p>
                <p>
                  If this parameter is of type <a>TimingDictionary</a>, then
                  the values of the passed-in dictionary will be used.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>ParGroup clone ()</dt>
          <dd>
            <p>
              Creates a deep copy of this <a>ParGroup</a> object using the
              following procedure.
            </p>
            <ol>
              <li>Let <var>source</var> be this <a>ParGroup</a> object, the
                  object to be cloned.</li>
              <li>Create a new <a>TimingDictionary</a>,
                  <var>cloned timing</var> with all members set to their
                  default values (see <a
                  href="#the-timingdictionary-dictionary"
                  class="sectionRef"></a>).</li>
              <li>
                <p>
                  Set <code><var>cloned timing</var>.timingFunction</code> based
                  on the type of
                  <code><var>source</var>.specified.timingFunction</code> as
                  follows:
                </p>
                <dl class="switch">
                  <dt>If <code><var>source</var>.specified.timingFunction</code>
                  is a <a>TimingFunction</a> object,</dt>
                  <dd>
                    Set <code><var>cloned timing</var>.timingFunction</code> to
                    the result of calling
                    <code><var>source</var>.timingFunction.clone()</code>.
                  </dd>
                  <dt>If <code><var>source</var>.specified.timingFunction</code>
                  is a DOMString,</dt>
                  <dd>
                    Set <code><var>cloned timing</var>.timingFunction</code> to
                    <code><var>source</var>.specified.timingFunction</code>.
                  </dd>
                  <dt>Otherwise
                  <code><var>source</var>.specified.timingFunction</code>
                  (<code>null</code>),</dt>
                  <dd>
                    Set <code><var>cloned timing</var>.timingFunction</code> to
                    <code>null</code>.
                  </dd>
                </dl>
              </li>
              <li>Set the remainder of the members of <var>cloned timing</var>
                  to the properties of the same name on
                  <var>source</var>.</li>
              <li>Let <var>cloned children</var> be an empty sequence of
                  <a>TimedItem</a> objects.</li>
              <li>For each <var>child</var> in
                  <code><var>source</var>.children</code>, append the result
                  of calling <code><var>child</var>.clone()</code>
                  to <var>cloned children</var>.
              <li>Return a new <a>ParGroup</a> object created by
                  calling the <a>ParGroup</a> constructor with parameters
                  <code>ParGroup(<var>cloned children</var>,
                  <var>cloned timing</var>)</code>.</li>
            </ol>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>SeqGroup</code> interface</h3>
        <p>
          <a title="sequence timing group">Sequence timing groups</a> are
          represented by the <code>SeqGroup</code> interface.
        </p>
        <dl title="interface SeqGroup : TimingGroup"
          class="idl">
          <dt>
          Constructor (sequence&lt;TimedItem&gt;? children,
              optional (double or TimingDictionary)? timing = null)
          </dt>
          <dd>
            The meaning and handling of each of the parameters in this
            constructor is identical to the constructor for
            <a>ParGroup</a>.
          </dd>
          <dt>SeqGroup clone ()</dt>
          <dd>
            <p>
              Creates a deep copy of this <a>SeqGroup</a> object using the same
              procedure as defined for <a
              href="#widl-ParGroup-clone-ParGroup">ParGroup.clone</a> except
              that a new <a>SeqGroup</a> object is created instead of
              a <a>ParGroup</a>.
            </p>
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>Animation</code> interface</h3>
        <p>
          <a title="animation">Animations</a> are represented by the
          <code>Animation</code> interface.
        </p>
        <dl title="interface Animation : TimedItem" class="idl">
          <dt>Constructor ()</dt>
          <dd>
            <p>
              Creates a new <a title="Animation interface">Animation</a> object
              using the following procedure:
            </p>
            <ol>
              <li>Create a new <a title="Animation interface">Animation</a>
                  object, <var>animation</var>.</li>
              <li>Establish a temporary <a>TimingDictionary</a>, <var>timing
                  dictionary</var>, based on the type of <var>timing</var> as
                  follows,
                <dl class="switch">
                  <dt>If <var>timing</var> is a <a>TimingDictionary</a>
                  object,</dt>
                  <dd>
                    Let <var>timing dictionary</var> refer to <var>timing</var>.
                  </dd>
                  <dt>If <var>timing</var> is a <code>double</code>,</dt>
                  <dd>
                    Let <var>timing dictionary</var> be a new <var>timing
                    dictionary</var> object with all properties set to their
                    default values and <code>iterationDuration</code> set to
                    <var>timing</var>.
                  </dd>
                  <dt>Otherwise (<var>timing</var> is <code>null</code> or
                      undefined),</dt>
                  <dd>
                    Let <var>timing dictionary</var> be a new <var>timing
                    dictionary</var> object with all properties set to their
                    default values.
                  </dd>
                </dl>
              </li>
              <li>
                <p class="issue">
                  As with <a>ParGroup</a> we want to clone <var>timing
                  dictionary</var> here but that depends on us working out what
                  the type of <code>specified</code> actually is (or if it still
                  even exists).
                </p>
              </li>
              <li>Assign the animation effect based on the type of
                <var>effect</var> as follows,
                <dl class="switch">
                  <dt>If <var>effect</var> is an <a>AnimationEffect</a>
                      object or a <a>CustomAnimationEffect</a> object,</dt>
                  <dd>
                    Assign <code><var>animation</var>.effect</code> to
                    <var>effect</var>.
                  </dd>
                  <dt>If <var>effect</var> is <code>null</code>,</dt>
                  <dd>
                    Set <code><var>animation</var>.effect</code> to
                    <code>null</code>.
                  </dd>
                  <dt>Otherwise,</dt>
                  <dd>
                    Set <code><var>animation</var>.effect</code> to the return
                    value of calling <a
                  href="#widl-AnimationEffect-createFromProperties-AnimationEffect-object-properties"
                  class="idlType"><code>AnimationEffect.createFromProperties</code></a><code>(<var>effect</var>)</code>.
                  </dd>
                </dl>
              </li>
            </ol>
            <p>
              Examples of the usage of this constructor are given in <a
              href="#creating-a-new-animation-object" class="sectionRef"></a>.
            </p>
            <dl class="parameters">
              <dt>AnimationTarget? element</dt>
              <dd>
                The target element or pseudo-element.
                This may be <code>null</code> for animations that do not target
                a specific element.
              </dd>
              <dt>object? effect</dt>
              <dd>
                The animation effect used to set the <code>effect</code>
                attribute of the newly created <a>Animation</a> object.
                <p>
                  If this parameter is an <a>AnimationEffect</a> object or
                  <a>CustomAnimationEffect</a> object, it will shared with any
                  other <a>Animation</a> objects referring to the same
                  <a>AnimationEffect</a> or <a>CustomAnimationEffect</a>
                  object.
                  It will <em>not</em> be copied.
                </p>
                <p>
                  If this parameter is <code>null</code>, the newly created
                  <a>Animation</a> will also have a <code>null</code> animation
                  effect.
                </p>
                <p>
                  Otherwise, if this parameter is any other type of object, it
                  will be passed to <a
                  href="#widl-AnimationEffect-createFromProperties-AnimationEffect-object-properties"
                  class="idlType"><code>AnimationEffect.createFromProperties</code></a>
                  and the resulting <a>AnimationEffect</a> object used as the
                  animation effect.
                </p>
              </dd>
              <dt>optional (double or TimingDictionary)? timing = null</dt>
              <dd>
                <p>
                  The timing properties of the new animation.
                </p>
                <p>
                  If this parameter is a <code>double</code>, then it
                  specifies the duration of a single iteration of the animation,
                  that is, the <a>iteration duration</a>, in seconds.
                </p>
                <p>
                  If this parameter is <code>null</code> the default value for
                  <a>iteration duration</a> specified in the
                  <a>TimingDictionary</a> definition will be used, that is,
                  zero.
                </p>
                <p>
                  If this parameter is of type <a>TimingDictionary</a>, then
                  the values of the passed-in dictionary will be used.
                </p>
              </dd>
            </dl>
          </dd>
          <dt>attribute (AnimationEffect or CustomAnimationEffect)? effect</dt>
          <dd>
            <p>
              The animation effect to apply (see <a
              href="#animation-values" class="sectionRef"></a>).
              May be <code>null</code> in which case the animation will produce
              no noticeable effect other than dispatching events (see <a
              href="#timing-events" class="sectionRef"></a>).
            </p>
          </dd>
          <dt>readonly attribute AnimationTarget? target</dt>
          <dd>
            <p>
              The element or pseudo-element being animated by this object.
              This may be <code>null</code> for animations that do not target
              a specific element such as an animation that produces a sound
              using an audio API.
            </p>
            <p class="note">
              Note that in a future version <a>AnimationTarget</a> may be
              extended to allow targetting, for example, a sequence of elements.
              Therefore, code that is intended to be used with arbitrary
              <a>Animation</a> objects should test the concrete type of
              <code>target</code> before using it and not assume that it refers
              to an Element.
            </p>
            <p class="issue">
              If SVG is extended to allow multiple targets (using, e.g.,
              <code>select="rect"</code>) then it might be most natural to
              represent that in the API but allowing the <code>target</code> to
              refer to multiple elements.
              It's something that deserves attention for version 1.
            </p>
            <dt>Animation clone ()</dt>
            <dd>
              <p>
                Creates a copy of this <a title="Animation
                interface">Animation</a> object using the following procedure.
              </p>
              <ol>
                <li>Let <var>source</var> be a the <a
                    title="Animation interface">Animation</a> object to
                    clone, that is, this object.</li>
                <li>Create a new <a>TimingDictionary</a>,
                    <var>cloned timing</var> with all members set to their
                    default values (see <a
                    href="#the-timingdictionary-dictionary"
                    class="sectionRef"></a>).</li>
                <li>Set <code><var>cloned timing</var>.timingFunction</code> to
                    the result of calling
                    <code><var>source</var>.timingFunction.clone()</code>
                    or <code>null</code> if
                    <code><var>source</var>.timingFunction</code> is
                    <code>null</code>.</li>
                    <p class="todo">
                      Need to update this if we continue allowing
                      <code>timingFunction</code> to be a string.
                    </p>
                <li>Set the remainder of the members of <var>cloned timing</var>
                    to the properties of the same name on
                    <var>source</var>.</li>
                <li>
                  The <a>AnimationEffect</a> is cloned depending on the type of
                  <code><var>source</var>.effect</code> as follows,
                  <dl class="switch">
                    <dt>If <code><var>source</var>.effect</code> is an
                        <a>Animation</a> object,</dt>
                    <dd>
                      Let <var>cloned effect</var> be the result of calling
                      <code><var>source</var>.effect.clone()</code>.
                    </dd>
                    <dt>If <code><var>source</var>.effect</code> is a
                        <a>CustomAnimationEffect</a> object,</dt>
                    <dd>
                      If <code><var>source</var>.effect</code> has a method
                      called <code>clone</code> let <var>cloned effect</var> be
                      the result of calling that method, otherwise let
                      <var>cloned effect</var> be
                      <code><var>source</var>.effect</code>.
                    </dd>
                    <dt>Otherwise,</dt>
                    <dd>
                      Let <var>cloned effect</var> be <code>null</code>.
                    </dd>
                  </dl>
                </li>
                <li>Return a new <a>Animation</a> object created by
                    calling the <a
                    href="#widl-ctor-Animation--AnimationTarget-element-object-effect--double-or-TimingDictionary--timing">Animation
                    constructor</a> with parameters
                    <code>Animation(<var>source</var>.target, <var>cloned
                    effect</var>, <var>cloned timing</var>)</code>.</li>
              </ol>
            </dd>
          </dd>
        </dl>
        <section class="informative">
          <h4>Creating a new <code>Animation</code> object</h4>
          <p>
            The <a>Animation</a> constructor offers a number of approaches to
            creating a new <a>Animation</a> object.
            At its simplest, an <a>Animation</a> object that changes the
            &lsquo;left&rsquo; property of <var>elem</var> to 100 over three
            seconds can be achieved as follows:
          </p>
          <pre class='example sh_javascript'>
var anim = new Animation(elem, { left: '100px' }, 3);
          </pre>
          <p>
            The second parameter representing the animation effect may specify
            multiple properties, an <a>AnimationEffect</a> object, or even
            a callback object.
          </p>
          <pre class='example sh_javascript'>
// Specify multiple properties at once
var animA = new Animation(elem, { left: '100px', top: '300px' }, 3);

// Share the animation effect of another animation
var animB = new Animation(elem, animA.effect, 3);

// Supply a specialized animation effect
var animC = new Animation(elem, new PathAnimationEffect( ... ), 3);

// Supply a custom script-based animation effect
var animC = new Animation(elem,
  { 
    sample: function(time) { 
      if (time !== null) {
        document.documentElement.currentScale = 1.0 + time * 2.0;
      } else {
        document.documentElement.currentScale = 1.0;
      }
    },
    clone: function { return this; }
  }, 3);
          </pre>
          <p class="todo">
            Fill in the parameters for <a>PathAnimationEffect</a> above once
            we have decided on them.
          </p>
          <p>
            The third parameter representing the animation's timing, may
            simply be a number representing the <a>iteration duration</a> as
            above, or, to specify further timing properties such as the <a
            title="timed item playback rate">playback rate</a>,
            a <a>TimingDictionary</a> can be used as follows:
          </p>
          <pre class='example sh_javascript'>
var anim = new Animation(elem, { left: '100px' }, { duration: 3, playbackRate: 2 });
          </pre>
          <p>
            It is also possible to omit the timing parameter altogether in which
            case default timing values will be used.
            Since the <a>intrinsic iteration duration</a> of an animation is
            zero, and the default <code>fillMode</code> when constructing an
            <a>Animation</a> is <em>forwards</em>, it is possible to
            create animations that simply set a property without any
            interpolation as follows,
          </p>
          <pre class='example sh_javascript'>
new Animation(elem, { display: 'none' });
          </pre>
          <p>
            This is particularly useful in combination with other <a
            title="animation">animations</a> or <a title="timed item">timed
            items</a>.
            For example, fading an element before switching
            &lsquo;display&rsquo; to &lsquo;none&rsquo; can be achieved as
            follows,
          </p>
          <pre class='example sh_javascript'>
new SeqGroup(
  [
    new Animation(elem, { opacity: '0%' }, 1),
    new Animation(elem, { display: 'none' })
  ]
);
          </pre>
          <p>
            Having created an <a title="Animation interface">Animation</a> it
            can be played using
            <code>document.timeline.play(<var>anim</var>)</code>.
            For simple effects the <a
            href="#extensions-to-the-element-interface"><code>Element.animate</code></a>
            shortcut is more convenient since it performs this last step
            automatically.
          </p>
        </section>
      </section>
      <section>
        <h3>The <code>PseudoElement</code> interface</h3>
        <p>
          Since <a title="animation">animations</a> may also target
          pseudo-elements, Web Animations API introduces the
          <a>PseudoElement</a> interface to represent such targets.
        </p>
        <dl title="interface PseudoElement" class="idl">
          <dt>Constructor (Element element, DOMString pseudoElement)</dt>
          <dd>
            Creates a new pseudo-element using <var>element</var> as the <a
            href="http://www.w3.org/TR/css3-selectors/#subject">subject</a>
            and <var>pseudoElement</var> as the pseudo-element to match (e.g.
            &lsquo;<code>::first-line</code>&rsquo;).
          </dd>
          <dt>attribute Element element</dt>
          <dd>
            The element used as the <a
            href="http://www.w3.org/TR/css3-selectors/#subject">subject</a> for
            matching a pseudo-element.
            <p>Exceptions:</p>
            <dl class="exceptions">
              <dt>DOMException of type
                  <code>NoModificationAllowedError</code></dt>
              <dd>
                Raised on setting if this object is a readonly object.
              </dd>
            </dl>
          </dd>
          <dt>attribute DOMString pseudoElement</dt>
          <dd>
            The pseudo-element including the initial colon(s). For example,
            &lsquo;<code>::after</code>&rsquo;.
            <p>Exceptions:</p>
            <dl class="exceptions">
              <dt>DOMException of type
                  <code>NoModificationAllowedError</code></dt>
              <dd>
                Raised on setting if this object is a readonly object.
              </dd>
            </dl>
          </dd>
        </dl>
        <div class="feedbackWanted">
          <p>
            This is an interface that may be useful in other specifications and
            so there are a few considerations to bear in mind:
          </p>
          <ul>
            <li>
              <p>
                Currently no validation is performed at all.
                You can set <code>pseudoElement</code> to
                &lsquo;<code>::batman</code>&rsquo; and we'll just ignore it
                when compositing (still need to define this).
              </p>
              <p>
                This is in order to provide better fallback.
                For example, if a UA doesn't support a particular pseudo-element
                it will still run the animation in terms of occupying time and
                firing events.
                There simply won't be any visual effect.
              </p>
              <p>
                Also, we have a general pattern in this specification that
                constructors don't throw.
              </p>
              <p>
                So while this works for this API, is this behavior useful in
                other specifications?
              </p>
            </li>
            <li>
              <p>
                The other issue is that we could just make <a>PseudoElement</a>
                have an optional <code>pseudoElement</code> attribute and use
                that everywhere instead of a union of <a>Element</a> or
                <a>PseudoElement</a> (see <a>AnimationTarget</a>).
              </p>
              <p>
                The reason we don't is that it complicates the 99% case where
                you're not using pseudo-elements. For example, you have to type
                <code>anim.target.element</code> which is what so many people
                don't like about SVG.
              </p>
              <p>
                So, again, this works for this specification, but is it ok for
                others?
              </p>
            </li>
            <li>
              While we're at it, should we enforce using double-colons somehow?
            </li>
          </ul>
        </div>
      </section>
      <section>
        <h3>The <a>AnimationTarget</a> typedef</h3>
        <div class="idl"
          title="typedef (Element or PseudoElement) AnimationTarget">
          For simplicity, throughout this specification <a>AnimationTarget</a>
          is used wherever either an <a>Element</a> or a <a>PseudoElement</a>
          can be used.
        </div>
      </section>
      <section>
        <h3>The <code>AnimationEffect</code> interface</h3>
        <p>
          <a title="animation effect">Animation effects</a> are represented by
          the <code>AnimationEffect</code> interface.
          <a>AnimationEffect</a> is an abstract interface of which several
          concrete subinterfaces are provided.
        </p>
        <dl title="interface AnimationEffect" class="idl">
          <dt>attribute AccumulateOperation accumulate</dt>
          <dd>
            <p>
              The <a>accumulation operation</a> property of this <a>animation
              effect</a> as specified by one of the <a>AccumulateOperation</a>
              constants.
            </p>
            <p>
              This value defaults to <code>"replace"</code>.
            </p>
          </dd>
          <dt>attribute CompositeOperation composite</dt>
          <dd>
            <p>
              The <a>composition operation</a> used to composite this animation
              with the stack, as specified by one of the
              <a>CompositeOperation</a> enumeration values.
            </p>
            <p>
              This value defaults to <code>"replace"</code>
            </p>
          </dd>
          <dt>AnimationEffect clone ()</dt>
          <dd>
            <p>
              Creates and returns a new object of the same type as this object's
              most-derived interface such that it will produce the same output
              as this object.
            </p>
            <p class="todo">
              We either need a more rigorous definition here or (probably
              better) a sets of steps on a per-subclass basis.
            </p>
          </dd>
          <dt>static AnimationEffect? createFromProperties ()</dt>
          <dd>
            <p>
              Creates an <a>AnimationEffect</a> representing the passed-in
              collection of properties.
            </p>
            <div class="note">
              <p>
                Note that this method requires handling the passed in parameter
                in a manner not yet supported by Web IDL and hence this method
                is ECMAScript-specific.
              </p>
              <p>
                Since accessing the properties of an ECMAScript user object can
                have side effects, the manner in which these properties is
                accessed is important.
                In light of this consideration the following procedure has the
                following properties:
              </p>
              <ul>
                <li>Every property is read only once.</li>
                <li>Properties are read in a well-defined order.</li>
                <li>Properties corresponding to unsupported target properties or
                    attributes are not read.</li>
              </ul>
            </div>
            <p>
              The interpretation of the passed-in <code>properties</code> object
              can be described in three parts.
            </p>
            <p><strong>Part 1 &ndash; Determine the set of
               animation properties</strong></p>
            <ol>
              <li>Create a list, <var>supported properties</var>, of property
                  names and attribute names that can be animated by the
                  implementation.</li>
              <li>Let <var>animation properties</var> be an empty sequence.</li>
              <li>Iterate through the properties of <code>properties</code>. For
                  each <var>property</var> in <code>properties</code>, if
                  <var>property</var> also exists in <var>supported
                  properties</var> based on a case-sensitive comparison, append
                  <var>property</var> to <var>animation properties</var>.
                  <p class="note">
                    Whilst the iteration order for properties of an ECMAScript
                    object is implementation-dependent, the order here is not
                    significant to the outcome as <var>animation
                    properties</var> will be sorted before being iterated over.
                  </p>
                  <p class="issue">
                    How do we handle <code>accumulate</code> and
                    <code>composite</code>? We'd like to be able to
                    list them in the same property bag but that would mean we
                    could never animate properties of the same name.
                  </p>
              </li>
            </ol>
            <p><strong>Part 2 &ndash; Create the <a>AnimationEffect</a>
               objects</strong></p>
            <p>
              The <a>AnimationEffect</a> object produced depends on the length
              of <var>animation properties</var> as follows:
            </p>
            <dl class="switch">
              <dt>If <var>animation properties</var> is of zero length,</dt>
              <dd>
                return <code>null</code>.
                <div class="note">
                  <p>
                    This behavior of returning <code>null</code> allows
                    alternative animation effects to be provided based on the
                    capabilities of the user agent as follows:
                  </p>
                  <pre class="example sh_javascript">
elem.animate(
  AnimationEffect.createFromProperties({ transform: 'translate(-100px)' }) ||
  AnimationEffect.createFromProperties({ top: '-100px' }),
  3);
                  </pre>
                </div>
              </dd>
              <dt>If <var>animation properties</var> has only one element,</dt>
              <dd>
                <ol>
                  <li>Let <var>name</var> be the value of the element
                      in <var>animation properties</var>.</li>
                  <li>Let <var>value</var> be the value of
                      <code>properties.<var>name</var></code>.</li>
                  <li>Return a new <a>KeyframeAnimationEffect</a> object
                      according to the steps in part 3 below based on
                      <var>name</var> and <var>value</var>.</li>
                </ol>
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                <ol>
                  <li>Let <var>group</var> be a newly constructed
                      <a>GroupedAnimationEffect</a>.</li>
                  <li>Sort <var>animation properties</var> lexicographically by
                      the Unicode codepoints that define each property
                      name.</li>
                  <li>For user agents that support both a prefixed and an
                      unprefixed version of some CSS properties, remove all
                      prefixed properties from <var>animation properties</var>
                      where the corresponding unprefixed version is also
                      present.</li>
                  <li>Iterate through <var>animation properties</var>. For each
                      <var>name</var> in <var>animation properties</var>:
                    <ol>
                      <li>Let <var>value</var> be the value of
                          <code>properties.<var>name</var></code>.</li>
                      <li>Create a new <a>KeyframeAnimationEffect</a>,
                          <var>effect</var> object according to the steps in
                          part 3 below based on <var>name</var> and
                          <var>value</var>.</li>
                      <li>Append <var>effect</var> to <var>group</var>.
                    </ol>
                  </li>
                  <li>Return <var>group</var>.
                </ol>
              </dd>
            </dl>
            <p><strong>Part 3 &ndash; Create each
               <a>KeyframeAnimationEffect</a> object</strong></p>
            <p>
              Based on a given <var>name</var> and <var>value</var>, a new
              <a>KeyframeAnimationEffect</a> is created as follows:
            </p>
            <dl class="switch">
              <dt>If <var>value</var> is not of type <code>(DOMString or
              sequence&lt;(<a>KeyframeDictionary</a> or
              DOMString)&gt;)</code>,</dt>
              <dd>
                Throw a <code>TypeError</code> as defined by [[!ECMA-262]].
              </dd>
              <dt>Otherwise,</dt>
              <dd>
                Construct a new <a>KeyframeAnimationEffect</a> by calling
                <code>KeyframeAnimationEffect(<var>name</var>,
                <var>value</var>)</code>.
              </dd>
            </dl>
            <dl class="parameters">
              <dt>object properties</dt>
              <dd>
                An object whose object properties represent the CSS properties
                or element attributes to be animated.
                The values corresponding to these properties are the animation
                values to be applied as described above.
              </dd>
            </dl>
          </dd>
        </dl>
        <div class="annotation">
          In future, we may expose <code>any sample (double?  timeFraction,
          double currentIteration, AnimationTarget? target, any
          underlyingValue)</code> so that the animation effects can be driven
          apart from the timing model.
          Also, doing so would allow us to do real native custom animation
          effects if we decide to go in that direction
          (see annotation in <a href="#custom-animation-effects"
          class="sectionRef"></a>).
        </div>
      </section>
      <section>
        <h3>The <code>AccumulateOperation</code> enumeration</h3>
        <p>
          The possible values of an <a>animation effect</a>'s
          <a>accumulation</a> behavior are represented by the
          <a>AccumulateOperation</a> enumeration.
        </p>
        <dl title="enum AccumulateOperation" class="idl">
          <dt>accumulate</dt>
          <dd>
            Corresponds to the <a
            title="accumulation operation accumulate">accumulate</a>
            accumulation operation value such that
            subsequent iterations of an <a>animation</a> build on the final
            value of the previous iteration.
          </dd>
          <dt>none</dt>
          <dd>
            Corresponds to the <a
            title="accumulation operation none">none</a>
            accumulation operation value such that the <a>animation value</a>
            produced is independent of the <a>current iteration</a>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>CompositeOperation</code> enumeration</h3>
        <p>
          The possible values of an <a>animation effect</a>'s
          composition behavior are represented by the
          <a>CompositeOperation</a> enumeration.
        </p>
        <dl title="enum CompositeOperation" class="idl">
          <dt>replace</dt>
          <dd>
            Corresponds to the <a
            title="composition operation replace">replace</a>
            <a>composition operation</a> value such that
            the <a>animation effect</a> overrides the <a>base value</a> it is
            combined with.
          </dd>
          <dt>add</dt>
          <dd>
            Corresponds to the <a
            title="composition operation add">add</a>
            <a>composition operation</a> value such that
            the <a>animation effect</a> is <a title="addition">added</a> to
            <a>base value</a> it is combined with.
          </dd>
          <dt>merge</dt>
          <dd>
            Corresponds to the <a
            title="composition operation merge">merge</a>
            <a>composition operation</a> value such that
            the <a>animation effect</a> is combined with its <a>base value</a>
            in a time-dependent fashion.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>KeyframeAnimationEffect</code> interface</h3>
        <dl title="interface KeyframeAnimationEffect : AnimationEffect"
          class="idl">
          <dt>Constructor (DOMString property,
      (DOMString or sequence&lt;(KeyframeDictionary or DOMString)&gt;) frames,
      optional AccumulateOperation accumulate = "none",
      optional CompositeOperation composite = "replace")</dt>
          <dd>
            <p>
              Creates a new <a>KeyframeAnimationEffect</a> object for the
              specified property from the given list of keyframes.
            </p>
            <p>
              The list of keyframes may be a sequence of
              <a>KeyframeDictionary</a> dictionaries, a sequence of
              <code>DOMString</code>s, a combination of both, or
              a single <code>DOMString</code>.
            </p>
            <p>
              <code>DOMString</code>s are used to create keyframes with an
              offset of 1.
              When the list of keyframes is a sequence consisting entirely of
              <code>DOMString</code>s the offsets of the newly created
              <a>Keyframe</a>s are distributed evenly from 0 to 1.
            </p>
            <p>
              The <var>property</var>, <var>accumulate</var> and
              <var>composite</var> arguments are assigned to the
              attributes of the same names.
            </p>
            <p>
              The <var>frames</var> argument is processed as follows:
            </p>
            <ol>
              <li>Let <var>effect</var> be the
                  <a>KeyframeAnimationEffect</a> currently under construction.
              </li>
              <li>
                <p>
                  The processing of <var>frames</var> depends on its type as
                  follows:
                </p>
                <dl class="switch">
                  <dt>If <var>frames</var> is a <code>DOMString</code>,</dt>
                  <dd>
                    <ol>
                      <li>
                        Let <var>frame</var> be a new <a>Keyframe</a>
                        constructed from a <a>KeyframeDictionary</a> whose
                        <code>value</code> member is set to
                        <var>frames</var> and whose other members are set
                        to their default values.
                      </li>
                      <li>
                        Call
                <code><var>effect</var>.frames.add(<var>frame</var>)</code>.
                      </li>
                    </ol>
                  </dd>
                  <dt>If <var>frames</var> is a sequence of <code>(DOMString
                      or <a>KeyframeDictionary</a>)</code>,</dt>
                  <dd>
                    <ol>
                      <li>Set a flag <var>all strings</var> to
                          <code>true</code>.</li>
                      <li>
                        For each <var>item</var> in <var>frames</var>:
                        <ol>
                          <li>
                            <dl class="switch">
                              <dt>If <var>item</var> is
                                  a <code>DOMString</code>,</dt>
                              <dd>
                                Let <var>frame</var> be a new <a>Keyframe</a>
                                constructed from a <a>KeyframeDictionary</a>
                                whose <code>value</code> member is set to
                                <var>item</var> and whose other members are
                                set to their default values.
                              </dd>
                              <dt>Otherwise (<var>item</var> is
                                  a <a>KeyframeDictionary</a>),</dt>
                              <dd>
                                <ol>
                                  <li>
                                    Let <var>frame</var> be a new
                                    <a>Keyframe</a> constructed by calling
                                    <code>Keyframe(<var>item</var>)</code>.
                                  </li>
                                  <li>
                                    Set <var>all strings</var> to
                                    <code>false</code>.
                                  </li>
                                </ol>
                              </dd>
                            </dl>
                          </li>
                          <li>
                            Call
                <code><var>effect</var>.frames.add(<var>frame</var>)</code>.
                          </li>
                        </ol>
                      </li>
                      <li>If flag <var>all strings</var> is
                          <code>true</code> call
                        <code><var>effect</var>.frames.distribute()</code>.
                      </li>
                    </ol>
                  </dd>
                </dl>
              </li>
            </ol>
          </dd>
          <dt>attribute DOMString property</dt>
          <dd>
            The name of the target property or attribute.
          </dd>
          <dt>readonly attribute KeyframeList frames</dt>
          <dd>
            The series of values that make up this effect sorted by their
            offset within the iteration duration of the animation.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>KeyframeList</code> interface</h3>
        <p>
          The <a>KeyframeList</a> object is a collection of <a>Keyframe</a>
          objects sorted by the offset of each <a>Keyframe</a>.
        </p>
        <dl title="interface KeyframeList" class="idl">
          <dt>readonly attribute unsigned long length</dt>
          <dd>
            The number of frames in the list.
          </dd>
          <dt>void clear ()</dt>
          <dd>
            Removes all frames from this list.
          </dd>
          <dt>getter Keyframe? (unsigned long index)</dt>
          <dd>
            Returns the frame at <code>index</code> if it exists or
            <code>null</code> otherwise.
          </dd>
          <dt>Keyframe add((Keyframe or KeyframeDictionary) frame)</dt>
          <dd>
            <p>
              Adds <var>frame</var> to the list such that the list remains
              sorted by the offset of the frames.
            </p>
            <p>
              If <var>frame</var> is of type <a>KeyframeDictionary</a> then
              a <a>Keyframe</a> object is first constructed by calling
              <code>Keyframe(<var>frame</var>)</code> before adding the
              newly constructed <a>Keyframe</a> to the list.
            </p>
            <p>
              If there already exists a frame in this list with offset
              <code><var>frame</var>.offset</code>, the newly added
              <var>frame</var> will appear in the list <em>after</em> the
              already existing frames in the list with the same offset.
            </p>
            <p>
              If <var>frame</var> is already part of another <a>KeyframeList</a>
              it is first removed from that list before being added to this
              list.
            </p>
            <p>
              Exceptions:
            </p>
            <dl class="exceptions">
              <dt>DOMException of type <code>IndexSizeError</code></dt>
              <dd>
                Raised if <var>frame</var> is a <a>KeyframeDictionary</a> whose
                offset is outside the range [0,1] or missing.
              </dd>
            </dl>
          </dd>
          <dt>Keyframe? remove(unsigned long index)</dt>
          <dd>
            Removes the frame at position <var>index</var> and returns it.
            If index is outside the range [0, length), then <code>null</code> is
            returned.
          </dd>
          <dt>long indexOf(Keyframe frame)</dt>
          <dd>
            Returns the index of <var>frame</var> within the list. If
            <var>frame</var> is not a member of the list, returns
            <code>-1</code>.
          </dd>
          <dt>KeyframeList distribute()</dt>
          <dd>
            <p>
              Adjusts the offsets of the frames in the list such that the
              offsets are spaced equidistantly whilst maintaining their current
              order and such that the first frame (when there are multiple
              frames) has offset 0 and the last frame (if any) has offset 1.
            </p>
            <p>
              For <var>frame</var> at position <var>i</var> in the list where
              0 &le; <var>i</var> &lt; <code>length</code>, an offset will be
                assigned equal to <code>i / (length - 1)</code> unless
                <code>length</code> is 1 in which case it will be given offset
                1.
            </p>
            <p>
              After applying the changes, this list is returned.
            </p>
          </dd>
        </dl>
        <div class="annotation">
          <p>
            The following changes for making keyframes easier to work with in
            future have been proposed:
          </p>
          <pre class="example sh_javascript">
// Currently you have to do this
effect.frames.add({ property: 'left', offset: 0.3, value: '100px' }); 

// It would be nice if you could also do this
effect.frames.add(0.3, 'left', '100px');

// Also, fetching by offset would be good

// Returns the last frame with offset 0.3 if there is one.
// If there is none, does the interpolation and returns a new frame? 
var frame = effect.frames['0.3']; 
          </pre>
        </div>
      </section>
      <section>
        <h3>The <code>Keyframe</code> interface</h3>
        <p>
          A <a>Keyframe</a> represents a moment within an animation that has
          a specified value to be applied to the target property or attribute.
          In between such moments values may be interpolated or filled based on
          the <a>TimingFunction</a> specified on the <a>TimedItem</a> where the
          <a>Keyframe</a> is used, or on the previous <a>Keyframe</a>.
        </p>
        <div class="issue">
          <p>
            Currently a <a>Keyframe</a> can only target a single property which
            is defined on the <a>KeyframeAnimationEffect</a>.
            This is different to CSS.
            Is this something we want to change?
            It would complicate the API, of course, but is it worth it?
          </p>
        </div>
        <p>
          <dl title="interface Keyframe" class="idl">
            <dt>Constructor (KeyframeDictionary dictionary)</dt>
            <dd>
              <p>
                Creates a new <a>Keyframe</a> object using the parameters
                specified in <var>dictionary</var>.
              </p>
              <p>
                <code><var>dictionary</var>.offset</code> is clamped to the
                range [0, 1] before setting.
              </p>
            </dd>
            <dt>attribute DOMString value</dt>
            <dd>
              The value to assign to the target attribute or property at the
              given offset.
            </dd>
            <dt>attribute double offset</dt>
            <dd>
              <p>
                A value between 0 and 1 inclusive representing the offset
                within the iteration duration of the animation where this value
                should appear.
              </p>
              <p>
                If this keyframe belongs to a <a>KeyframeList</a>, changes to
                this value cause the <a>KeyframeList</a> to be immediately
                re-sorted using a stable sort such that all children are ordered
                by their offset but children with identical offsets retain their
                relative position in the list.
              </p>
              <p>
                Exceptions:
              </p>
              <dl class="exceptions">
                <dt>DOMException of type <code>IndexSizeError</code></dt>
                <dd>
                  Raised on setting a value outside the range [0,1].
                </dd>
              </dl>
            </dd>
            <dt>attribute TimingFunction? timingFunction</dt>
            <dd>
              <p>
                The timing function to apply between this keyframe and the
                next keyframe in any <a>KeyframeList</a> in which this object
                appears.
              </p>
              <p>
                May be <code>null</code> in which case linear interpolation will
                be used.
              </p>
            </dd>
          </dl>
        </p>
      </section>
      <section>
        <h3>The <code>KeyframeDictionary</code> dictionary</h3>
        <p>
          To simplify creation of <a>Keyframe</a> objects
          a <code>KeyframeDictionary</code> can be used.
        </p>
        <p>
          The members of the dictionary correspond to attributes in the
          <a>Keyframe</a> interface which provides a more complete description
          of their meaning and usage.
        </p>
        <dl title="dictionary KeyframeDictionary" class="idl">
          <dt>DOMString value = ""</dt>
          <dd>
            The value to assign to the target attribute or property at the given
            offset.
          </dd>
          <dt>double offset = 1</dt>
          <dd>
            A value between 0 and 1 (inclusive) representing the offset within
            the iteration duration of the animation where this value should
            appear.
          </dd>
          <dt>TimingFunction? timingFunction = null</dt>
          <dd>
            The timing function to apply between this keyframe and the
            next keyframe in any <a>KeyframeList</a> in which this object
            appears.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>PathAnimationEffect</code> interface</h3>
        <dl title="[Constructor] interface PathAnimationEffect
          : AnimationEffect" class="idl">
          <dt>attribute SVGPathSegList segments</dt>
          <dd>
            The list of segments that make up this path.
          </dd>
          <dt>attribute boolean rotate</dt>
          <dd>
            True if objects animating along this path should be rotated
            such that their positive x axis is aligned with the direction of
            movement along the path.
          </dd>
        </dl>
      </section>
      <section>
        <h3>The <code>CustomAnimationEffect</code> callback interface</h3>
        <p>
          Custom animation effects can be defined in script using the
          <a>CustomAnimationEffect</a> interface.
        </p>
        <p class="issue">
          Should this be a dictionary?
          I'd like to make <code>clone</code> optional.
        </p>
        <div title="callback interface CustomAnimationEffect" class="idl">
          <dt>attribute unsigned integer priority</dt>
          <dd>
            The order in which this animation effect will be executed in
            relation to other custom animation effects such that items with
            a lower priority are executed earlier as defined in <a
            href="#execution-order-of-custom-animation-effects"
            class="sectionRef"></a>.
          </dd>
          <dt>void sample ()</dt>
          <dd>
            The callback used to produce the animation effect corresponding to
            the sample time determined by the timing model.
            <dl class="parameters">
              <dt>double? timeFraction</dt>
              <dd>
                The distance within a single iteration of the animation effect
                of the current sample.
                When this is <code>null</code>, the callback object SHOULD
                remove the animation effect.
              </dd>
              <dt>double currentIteration</dt>
              <dd>
                The current iteration index beginning with zero for the first
                iteration.
              </dd>
              <dt>AnimationTarget? target</dt>
              <dd>
                The element to which the effect should be applied, if any.
                When this method is called as a result of this object being
                associated with an <a>Animation</a> object, it will be
                <code><a>Animation</a>.target</code>
              </dd>
            </dl>
          </dd>
          <dt>CustomAnimationEffect clone ()</dt>
          <dd>
            Creates an independent copy of this object.
          </dd>
        </div>
        <p class="issue">
          Do we need to pass in the <a>TimedItem</a> as well?
          If possible I'd prefer not to but it may necessary for some types of
          effect.
          Might be an additional parameter to add later if it proves
          necessary?
        </p>
        <p class="issue">
          I think we will also need to pass the previous time fraction.
          Animations will often use this to check if they are paused, playing
          in reverse etc.
          They can track this themselves but then you need a separate object
          everywhere you use it.
        </p>
      </section>
      <section>
        <h3>Extensions to the <code>Document</code> interface</h3>
        <p>
          The following extensions are made to the <a
          href="http://www.w3.org/TR/dom/#interface-document">Document
          interface</a> defined in [[!DOM4]].
        </p>
        <dl title="partial interface Document" class="idl">
          <dt>readonly attribute Timeline timeline</dt>
          <dd>
            The <a title="Timeline interface">Timeline</a> object representing
            the <a>document timeline</a>.
          </dd>
        </dl>
      </section>
      <section>
        <h3>Extensions to the <code>Element</code> interface</h3>
        <p>
          To simplify the creation of <a>Animation</a> objects for a given
          Element, the <a class="externalDFN"
          href="http://www.w3.org/TR/dom/#interface-element">Element</a>
          interface [[!DOM4]] is extended as follows:
        </p>
        <dl class="idl" title="partial interface Element">
          <dt>Animation animate()</dt>
          <dd>
            <p>
              Creates a new <a>Animation</a> object whose target element is the
              Element object on which the method is called, and calls
              <code>play()</code> on the newly created animation.
            </p>
            <p>
              The following code fragment:
            </p>
            <pre class="example sh_javascript">
              var anim = elem.animate({ 'opacity': 0 }, 2);
            </pre>
            <p>
              is equivalent to:
            </p>
            <pre class="example sh_javascript">
              var anim = new Animation(elem, { 'opacity': 0 }, 2);
              anim.play();
            </pre>
            <p>
              Returns the newly created <a>Animation</a> object.
            </p>
            <dl class="parameters">
              <dt>object? effect</dt>
              <dd>
                The animation effect to apply.
                This value is passed to the <a
                href="#widl-ctor-Animation--AnimationTarget-element-object-effect--double-or-TimingDictionary--timing">Animation
                constructor</a> as the <var>effect</var> parameter and has the
                same interpretation as defined for that constructor.
              </dd>
              <dt>optional (double or TimingDictionary)? timing</dt>
              <dd>
                The timing parameters of the animation.
                This value is passed to the <a
                href="#widl-ctor-Animation--AnimationTarget-element-object-effect--double-or-TimingDictionary--timing">Animation
                constructor</a> as the <var>timing</var> parameter and has the
                same interpretation as defined for that constructor.
              </dd>
            </dl>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Timing events</h2>
      <p>
        As timed items play they report changes to their status through
        <a>TimingEvent</a>s.
      </p>
      <div class="annotation">
        <p><strong>Relationship to CSS and SVG events</strong></p>
        <p>
          CSS defines <code>AnimationEvent</code>s and
          <code>TransitionEvent</code>s and SVG defines <code>TimeEvent</code>s.
          The proposal here is to dispatch <a>TimingEvent</a>s in parallel to
          these events.
          This has the following properties:
        </p>
        <ul>
          <li>It is possible to register for <em>just</em> CSS animation events,
          or <em>just</em> CSS transition events, or <em>just</em> SVG time
          events, or <em>all</em> animation-related events
          (by registering for the timing events defined here).</li>
          <li>Backwards compatibility&mdash;existing content continues to work
          as is.</li>
        </ul>
        <p>
          An alternative is to make CSS and SVG events subclass
          <a>TimingEvent</a> and just fire the one event.
          Two issues arrive with this.
          Firstly, the event type would change on the subclasses so it wouldn't
          be possible to catch all "start" events, for example.
          Secondly, the propagation path for SVG events is different since they
          are fired at the animation template element rather than the animation
          target element.
        </p>
        <p>
          Nevertheless, there may be alternative approaches here such as
          augmenting CSS Animation events only and firing them from the API
          (although that may cause compatibility issues when SVG animations
          start reporting events to content expecting only CSS animations).
        </p>
      </div>
      <div class="todo">
        Clarify somewhere that timing events are a property of the <em>timing
        model</em> hence they continue to fire even if there is no animation
        effect and even if the target property is in a <code>display:
        none</code> block.
      </div>
      <section>
        <h3>The <code>TimingEvent</code> interface</h3>
        <dl title="interface TimingEvent : Event" class="idl">
          <dt>Constructor
              (DOMString type, optional TimingEventInit eventInitDict)</dt>
          <dd>
            Constructs a new <a>TimingEvent</a> object as described in <a
            href="http://www.w3.org/TR/dom/#constructing-events">Constructing
            events</a> in [[!DOM4]].
          </dd>
          <dt>attribute double documentTime</dt>
          <dd>
            <p>
              The <code>currentTime</code> of the <a>DocumentTimeSource</a> with
              which the <a>TimedItem</a> is associated when the event was
              dispatched.
            </p>
            <div class="annotation">
              <p>
                I think document time will be much more useful than global time.
                For the rarer case that you want to synchronise animations
                between documents using events, I anticipate
                <a>DocumentTimeSource</a> will have a method to convert
                a document to global time and vice-versa and/or convert times
                from one <a>DocumentTimeSource</a> to another
                <a>DocumentTimeSource</a>.
              </p>
              <p>
                When we come to define animations that aren't necessarily linked
                to a document time source we'll need to make this nullable or
                redefine it to mean "root time source".
              </p>
            </div>
          </dd>
          <dt>attribute double localTime</dt>
          <dd>
            <p>
              The <a>output time value</a> of the <a>TimeSource</a> with which
              the <a>TimedItem</a> is associated when the event was dispatched.
              For animations that do not belong to an <a>TimingGroup</a> this
              will be equal to <code>documentTime</code>.
            </p>
            <p class="annotation">
              If we allow animations to be associated with, for example,
              MediaControllers, we'll need to revise the above description to
              cover more than just <a>TimingGroup</a>s.
            </p>
            <p class="annotation">
              If we rename <a>item time</a> to local time we'll need to rename
              this.
              Note that the time given here is in <em>parent iteration
              time</em>.
              This is the same time space used for <code>startTime</code> and
              <code>endTime</code>.
              This is the most useful time space if, for example, you receive
              a timing event and want to add a new animation that synchronises
              with the item that dispatched the event by adding it to the same
              time source (e.g. group).
            </p>
          </dd>
          <dt>attribute unsigned long? iterationIndex</dt>
          <dd>
            The value of <code>currentIteration</code> on the target
            <a>TimedItem</a> when the event was dispatched.
          </dd>
        </dl>
        <p class="issue">
          Suggestions for naming? CSS has taken <code>AnimationEvent</code> and
          <code>TransitionEvent</code> and SVG has <code>TimeEvent</code>.
          Call it <code>SyncEvent</code>?
          Or we could just augment <code>AnimationEvent</code> since it has
          a similar propagation path.
        </p>
        <dl title="dictionary TimingEventInit" class="idl">
          <dt>double documentTime = 0</dt>
          <dd></dd>
          <dt>double localTime = 0</dt>
          <dd></dd>
          <dt>double iterationIndex = 0</dt>
          <dd></dd>
        </dl>
      </section>
      <section>
        <h3>Types of <a>TimingEvent</a></h3>
          <dt>timingstart</dl>
          <dd>
            Occurs at the moment when an item enters an <a>animation
            interval</a> (from either direction).
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
            </ul>
          </dd>
          <dt>timingiteration</dl>
          <dd>
            Occurs at the moment when a repeating item's
            <code>currentIteration</code> changes excluding changes to and from
            <code>null</code>.
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
            </ul>
          </dd>
          <dt>timingend</dl>
          <dd>
            Occurs at the moment when an item leaves an <a>animation
            interval</a> (from either direction).
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
            </ul>
          </dd>
          <dt>timingcancel</dl>
          <dd>
            Occurs when <code>TimedItem.cancel</code> is called.
            In this case, a <em>timingend</em> event is not fired
            (see the description of
             <a href="#widl-TimedItem-cancel-void">TimedItem.cancel</a>).
            <ul>
              <li>Bubbles: yes</li>
              <li>Cancelable: no</li>
            </ul>
          </dd>
        </dl>
        <p class="annotation">
          The naming here is not great.
          Would <code>syncstart</code> be any better?
          If we augment <code>AnimationEvent</code> then at least we could use
          <code>animationstart</code> etc.
        </p>
        <div class="annotation">
          <p>
            Other potential event types for a later version:
          </p>
          <ul>
            <li><em>pause</em> &mdash;
              fires whenever <code>paused</code> is newly true.<br>
              Use case: show a graphic overlay to mark a cartoon as paused.<br>
              Likewise <em>unpause</em>.</li>
            <li><em>seek</em> &mdash;
              fires whenever <code>currentTime</code> is set on the item or an
              ancestor.<br>
              Use case: Acts as a signal that intermediate events may have been
              dropped (see <a href="#event-dispatch-during-seeking"
              class="sectionRef"></a>).
              For example, if you have an iteration event handler that assumes
              it will get one call per iteration, then a seek event would be
              a cue that you need to check <code>iterationIndex</code> and
              adjust.
              Also, if you were implementing something like SVG's syncbase
              timing with script you often need to do some bookkeeping on
              a seek.
            </li>
            <li><em>directionchange</em> &mdash;
              fires whenever the effective direction of the item changes (due to
              the direction attribute, changes to playbackRate, calling reverse
              etc. on either the item or an ancestor)<br>
              Use case: update UI to represent rewinding;
              stop audio when playing backwards to prevent secretly encoded
              messages being revealed.
            </li>
            <li><em>newanimation</em> &mdash;
              fires whenever a new <a>Animation</a> object is created.
              Use case: a timeline debugger. You want to show all animations
              that are playing or yet-to-play.
              Using this event (and <code>document.getCurrentAnimations</code>?)
              you could build up a timegraph.
              <p>
                I think this sort of event and this sort of use case would fit
                the MutationObserver pattern well.
                We could introduce a whole class of mutation records targetted
                at debugging (e.g. <em>timewindowchange</em>)
              </p>
          </ul>
          <p>
            Also, although this is a bit different to a regular event (since
            it's qualified by a parameter), it seems like it might be nice to be
            able to do something like:
          </p>
          <pre class='example sh_javascript'>
            anim.onprogress(0.8,
             function() {
              // Issue a request to prefetch the next episode
             });
          </pre>
          <p>
            It would be called whenever you got a sample where
            <code>iterationTime</code> &ge; <var>progress</var> was newly true.
          </p>
        </div>
      </section>
      <section>
        <h4>Event dispatch</h4>
        <p>
          The <a
          href="http://www.w3.org/TR/DOM-Level-3-Events/#glossary-propagation-path">propagation
          path</a> for all events depends on the <a>TimedItem</a> where the
          status change took place.
          If the item is an <a>Animation</a> with a <code>target</code> that is
          not <code>null</code>, the propagation path follows the usual <a
          href="http://www.w3.org/TR/DOM-Level-3-Events/#event-flow">DOM event
          flow</a> from <code>DefaultView</code> down the parent chain to
          <code>target</code> and finally to the
          <a>TimedItem</a> where the status change took place.
          Otherwise, the propagation path is simply the <code>TimedItem</code>
          object itself.
        </p>
        <p class="note">
          Note that unlike <code>AnimationEvent</code>s and
          <code>TransitionEvent</code>s in CSS, and <code>TimeEvent</code>s in
          SVG which target an Element, the target of a <a>TimingEvent</a> is
          a <a>TimedItem</a>.
        </p>
        <p>
          Since Web Animations makes no guarantees about the time between
          successive frames of animation, it is possible that the time when
          a change in state that should produce an event is scheduled to occur
          does not line up with a frame.
        </p>
        <p>
          As such, the events that should be dispatched when sampling the model
          is based on the interval between samples as follows.
        </p>
        <ul>
          <li>
            Let <var>previous sample</var> be the moment when the timing model
            was last sampled, recorded in document time.
            If there was no previous sample, then let <var>previous sample</var>
            be -1.
          </li>
          <li>
            Let <var>current sample</var> be the current document time.
          </li>
          <li>
            Let <var>progress interval</var> be the interval (<var>previous
            sample</var>, <var>current sample</var>].
          </li>
        </ul>
        <p>
          The events to be dispatched are therefore those whose document time
          lies within <var>progress interval</var>.
        </p>
        <div class="todo">
          <p>
            I think we will need to make sample times per-timed item.
            Then, if we have a timed item that has a previous sample, but can't
            get the current time (because it has no timeline), then we fire
            a timingcancel event.
          </p>
          <p>
            That way, you can switch players and their source content around and
            you'll only get a cancel event if on the next sample the timed item
            is not connected to a player.
          </p>
          <p>
            The time for the cancel event would be the time of the previous
            sample.
          </p>
        </div>
        <div class="issue">
          <p>
            This description fails to account for newly-added animations,
            removed animations, and other tree surgery.
            For example, if I have a sample at t=3s, I add an animation whose
            animation interval starts at t=2s, and then conduct another sample
            at t=4s, the <em>timingstart</em> event should fire even though the
            event's document time lies outside the progress interval.
          </p>
          <p>
            We could possibly fix this by making the previous sample times and
            current sample times per-<a>TimedItem</a> but that won't work for
            repeating groups.
            Needs work.
          </p>
        </div>
        <div class="issue">
          <p>
            This last part here requires calculating document times (both for
            testing against the progress interval and also for filling in the
            <code>documentTime</code> attribute of the event) and that's hard to
            calculate since our current model allows non-invertible timing
            functions on groups.
            That means you can't easily just traverse the descendants (by child
            and iteration) and generate a list of interval and iteration
            boundaries then filter out the ones that don't fit in the interval
            because you can't easily convert from local time to document time.
          </p>
          <p>
            You can, of course, convert from document time to local time
            and while that's probably enough to tell if there was an interval or
            iteration edge or not, it's not enough to determine the exact time
            at which it occurred (to fill in the event parameters).
          </p>
          <p>
            A complex example is where you have an group whose iteration time
            goes from 0 to 1.5 to 0.7 back to 1.
            Suppose you have a child animation that finishes its animation
            interval at 80% of the way through the parent's iteration interval.
            It would then finish, do nothing, then start reversing part-way,
            then finish again.
            In that case I think you expect to get: start, finish, start,
            finish.
          </p>
          <p>
            It's probably not impossible, so long as we allow for the fact that
            the inverse may have several (even equal) roots but it sounds tricky
            and possibly expensive to calculate on each iteration.
          </p>
          <p>
            I think we might need to re-consider allowing non-invertible timing
            functions on groups.
            Alternatively we could say that the children of a group with
            a non-interval timing function don't generate events.
            Or, alternatively again, that they occur on the non-transformed
            times.
          </p>
          <p>
            This final options of making event times untransformed times is not
            such a bad option, especially if we split time transformations into
            a separate step and perhaps even a separate interface.
            It's similar to some vector graphics editing programs that provide
            bitmap filter effects&mdash;often the bounding box of the filtered
            shape reflects the dimensions of the vector shape and not that of
            the bitmapped result.
          </p>
          <p>
            Also, in the case of an animation that bounces back and forth before
            resting at its final value, it's probably more useful to get just
            one end event when it finally rests than lots of little end/start
            events each time it crosses the 1.0 iteration time boundary.
          </p>
        </div>
        <div class="issue">
          <p>
            One implementation issue with events is that sometimes you find you
            suddenly have a large backlog of events to dispatch and this may
            have an adverse impact on performance.
            Some such situations include:
          </p>
          <ul>
            <li>
              You have a short iteration duration, e.g. 50ms, then you get put
              in a background tab and throttled really low.
              On the next sample, you might have hundreds of iteration events to
              dispatch.
            </li>
            <li>
              You have an arrangement of animations such that they keep spawning
              new ones for ever.
              You can easily get this in SVG using syncbase timing or in the
              model here by using repeating groups.
              In this case, you can have a lot of events to dispatch if you get
              throttled low.
              Once you have a global clock, you also encounter this situation
              when the computer goes to sleep since when it wakes up it will
              have a lot of start/end/iteration events to catch up on.
            </li>
          </ul>
          <p>
            It seems like the Mutation Observer pattern might help here except,
            firstly, that might prevent simple usage such as:
          </p>
          <pre class='example sh_javascript'>
elem.animate({ opacity: '0%' }, 1).onend =
   function() { elem.parentNode.removeChild(elem); };
          </pre>
          <p>
            Secondly, even using the observer pattern doesn't relieve the
            implementation of having to walk through the model and determine
            all the mutations that have occured and their corresponding times
            and this could be expensive if the computer has been asleep for
            a few days.
          </p>
          <p>
            Another option might be to set some implementation requirements that
            allow dropping events or automatic pausing when the time between
            samples is protracted (such as the device going to sleep).
          </p>
        </div>
      </section>
      <section>
        <h3>Event dispatch during seeking</h3>
        <p>
          The previous description of event dispatch applies when the timing
          model is sampled during normal playback (whether forwards or
          backwards).
          However, when a seek is performed by setting the
          <code>currentTime</code> of a <a>TimedItem</a>,
          a different behavior is employed.
          In effect, event dispatch is supressed until the seek is completed.
          After the seek has completed, events are dispatched based on comparing
          the before and after state of each <a>TimedItem</a> affected by the
          seek.
          Iteration events are not dispatched.
        </p>
        <p class="annotation">
          Supressing events during seeking is necessary to provide performant
          seeking.
          It is also arguably the more intuitive behavior as, for example,
          when rewinding a cartoon one probably does not expect a bucketload of
          events to arrive as a result of traversing backwards over each
          <a>TimedItem</a>.
        </p>
        <p class="issue">
          Should iteration events be dispatched?
        </p>
        <p>
          The procedure is as follows:
        </p>
        <ol>
          <li>Prior to performing the seek on <var>item</var>,
              record whether it is <a>active</a> or not.</li>
          <li>If <var>item</var> is an <a>TimingGroup</a> record whether each
              descendent <a>TimedItem</a> is <a>active</a> or not.</li>
          <li>Perform the seek as described in <a href="#seeking-a-timed-item"
            class="sectionRef"></a>.</li>
          <li>For each <a>TimedItem</a> considered in steps 2 and 3, compare
              whether the item was <a>active</a> before the seek and
              whether it is <a>active</a> now and dispatch events as follows:
              <dl class="switch">
                <dt>If the item was previously <a>active</a> but, after seeking,
                    is no longer <a>active</a>,</dt>
                <dd>Dispatch a new <code>timingend</code> event with
                  <a>localTime</a> set to <code>endTime</code> and
                  <a>documentTime</a> set to the corresponding document
                  time.
                  <span class="todo">(Obviously this depends on being able
                    to convert from a local time to a document time as
                    discussed in the previous section.)
                </dd>
                <dt>If the item was previously not <a>active</a> but, after
                    seeking, is now <a>active</a>,</dt>
                <dd>Dispatch a new <code>timingstart</code> event with
                  <a>localTime</a> set to <code>startTime
                  + timing.startDelay + timeDrift</code> and
                  <a>documentTime</a> set to the corresponding document
                  time.
                </dd>
              </dl>
          </li>
        </ol>
        <p>
          The sequence of dispatched events is identical to that of events
          dispatched during regular sampling (see <a href="#sequence-of-events"
            class="sectionRef"></a>).
        </p>
      </section>
      <section>
        <h3>Sequence of events</h3>
        <p>
          <a>TimingEvent</a>s are categories as <a
          href="http://www.w3.org/TR/DOM-Level-3-Events/#sync-async">synchronous
          events</a> whose sequence is as follows:
        </p>
        <ol>
          <li>Events are ordered by <code>documentTime</code></li>
          <li>For events with the same <code>documentTime</code>,
              sort by event type from first to last as follows:
              <em>timingcancel</em>, <em>timingend</em>,
              <em>timingiteration</em>, <em>timingstart</em>.
              <p class="note">
                Note that sorting end events before start events is consistent
                with the end-point exclusive nature of timing in Web
                Animations (see <a href="#interval-timing"
                class="sectionRef"></a>).
                When animation A ends at the same time as animation B begins,
                we can imagine that animation A ends an incredibly short amount
                of time before animation B begins such that there is no overlap.
              </p>
          </li>
          <li>
            For events with the same <code>documentTime</code> and type,
            if the target <a>TimedItem</a>s participate in a tree made up of
            <a>TimingGroup</a>s then the events are dispatched as if the tree
            was sampled breadth-first such that events attached to ancestor
            <a>TimedItem</a>s are dispatched first.
          </li>
        </ol>
        <p class="issue">
          What if the order is still unresolved, is it okay to leave it
          undefined?
          Can we use document order or script order here?
          It's tempting to use the same order as we use for compositing but
          remember that not everything that is timed is composited (e.g.
          groups).
        </p>
      </section>
      <section>
        <h3><a>TimedItem</a> events interface members</h3>
        <dl title="partial interface TimedItem" class="idl">
          <dt>// Event callbacks</dt><dd></dd>
          <dt>attribute EventHandler onstart</dt>
          <dd>
            The event handler for the <em>timingstart</em> event
            (see <a href="#timing-events" class="sectionRef"></a>).
          </dd>
          <dt>attribute EventHandler oniteration</dt>
          <dd>
            The event handler for the <em>timingiteration</em> event
            (see <a href="#timing-events" class="sectionRef"></a>).
          </dd>
          <dt>attribute EventHandler onend</dt>
          <dd>
            The event handler for the <em>timingend</em> event
            (see <a href="#timing-events" class="sectionRef"></a>).
          </dd>
          <dt>attribute EventHandler oncancel</dt>
          <dd>
            The event handler for the <em>timingcancel</em> event
            (see <a href="#timing-events" class="sectionRef"></a>).
          </dd>
        </dl>
        <p class="note">
          Note that the <a
          href="http://www.w3.org/TR/html5/webappapis.html#eventhandler">EventHandler</a>
          callback interface type is defined in [[!HTML5]].
        </p>
        <div class="idl" title="TimedItem implements EventTarget">
          <a>TimedItem</a> also implements the <a class="externalDFN"
          href="http://www.w3.org/TR/dom/#eventtarget">EventTarget</a>
          interface defined in [[!DOM4]].
        </div>
      </section>
    </section>

    <section>
      <h2>Querying current animations</h2>
      <p>
        It is often useful to be able to access the animations currently in play
        or scheduled to play, that is <a>current</a> animations, including those
        which may have been defined declaratively rather than by using the API.
        To that end the following extensions are defined for
        the <a class="externalDFN"
        href="http://www.w3.org/TR/dom/#interface-document">Document</a>
        and <a class="externalDFN"
        href="http://www.w3.org/TR/dom/#interface-element">Element</a>
        interfaces defined in [[!DOM4]].
      </p>
      <p class="note">
        Note that animations for which the current time falls <em>after</em> the
        <a>active interval</a> but which are still <a>in effect</a> due to
        a <a>fill mode</a> are <em>not</em> returned by this method.
        This is because in order to return such animations, user agents would be
        required to maintain all animations with a forwards fill indefinitely.
        As a result the resources consumed by an animated document would
        steadily accumulate over time.
      </p>
      <dl class="idl" title="partial interface Document">
        <dt>sequence&lt;Animation&gt; getCurrentAnimations()</dt>
        <dd>
          <p>
            Returns all <a>Animation</a> objects that meet <em>both</em> of the
            following conditions:
          </p>
          <ol>
            <li>
              has a <code>target</code> attribute that is an Element whose
              <code>ownerDocument</code> is the Document on which this method
              was called, <em>or</em> has a <code>target</code> attribute that
              is a <a>PseudoElement</a> whose <code>element.ownerDocument</code>
              is the Document on which this method was called, and
            </li>
            <li>
              is <a>current</a>.
            </li>
          </ol>
          <p>
            The returned sequence is a snapshot (i.e. not live) representing the
            state of animations that corresponds at the time when the method was
            called.
          </p>
          <div class="issue">
            <p>
              There are at least three ways to define which elements this
              covers in terms of their association with the Document object on
              which the method is called, <var>document</var>:
            </p>
            <ol>
              <li>All <a>Animation</a>s created using
              <a><var>document</var>.createAnimation</a>&mdash;means even
              Animations that don't target an element (e.g. they do some audio,
              or target a scrollbar) get included. Not sure if this is good or
              bad.</li>
              <li>All <a>Animation</a>s which, if you trace their chain of time
              sources you eventually arrive at
              <code><var>document</var>.timeline</code>&mdash;means if you
              associate an Animation with a custom time source like a scrollbar
              (in a future version) it wouldn't be included. Again, not sure if
              this is good or bad.</li>
              <li>All <a>Animation</a>s whose <code>target</code> or
              <code>target.element</code> (for <a>PseudoElement</a>s) has an
              <code>ownerDocument</code> which is
              <var>document</var>&mdash;means only stuff which is affecting this
              document's DOM in the usual way is included (but including, if
              it's even possible, animations from another document).</li>
            </ol>
            <p>
              I suspect option 2 is the best approach but I've specified 3 for
              now simply because it was easiest.
            </p>
            <p>
              I'll probably specify 2 once we've cleared up some of the issues
              surrounding time sources.
            </p>
          </div>
        </dd>
      </dl>
      <dl class="idl" title="partial interface Element">
        <dt>sequence&lt;Animation&gt; getCurrentAnimations()</dt>
        <dd>
          <p>
            Returns all <a>Animation</a> objects whose <code>target</code>
            attribute is the Element on which this method was called and which
            are <a>current</a>.
            Note that this does <em>not</em> include <a>PseudoElement</a>s whose
            <code>element</code> attribute refers to this Element.
          </p>
          <p>
            The returned sequence is a snapshot (i.e. not live) representing the
            state of animations that corresponds at the time when the method was
            called.
          </p>
        </dd>
      </dl>
    </section>

    <section>
      <h2>Interaction with script</h2>
      <p>
        The Web Animations model may be modified using the API defined in this
        specification.
        This iteraction between script execution and the regular operation of
        the model is defined as follows:
      </p>
      <ul>
        <li>
          <p>
            Changes made to the timing model are reflected immediately in the
            values returned by timing model interfaces.
            <span
            class="todo">(Need to be more specific here. Once the section
            numbers have stabilized we could put section numbers here.)</span>
            Similarly, timing model methods that operate on the current state
            of the model such as pausing or reversing are applied to
            a fully-updated timing model, that is, after all previous
            modifications have been incorporated.
          </p>
          <div class="informative">
            <p>
              For example, if an <a>Animation</a>'s <code>startTime</code> is
              changed via the API, the value returned when querying the
              animation's <code>endTime</code> will reflect updated state of the
              timing model immediately.
            </p>
            <pre class="example sh_javascript">
              // Initially startTime is 3 and endTime is 5
              anim.startTime = 4;
              alert(anim.endTime); // Displays '6'
            </pre>
            <p>
              The same concept applies to more complex modifications of the
              timing model such as adding and removing children from
              a <a>TimingGroup</a>.
            </p>
          </div>
        </li>
        <li>
          <p>
            Changes to the timing model other than <a
            href="#seeking-a-timed-item">seek operations</a> do not cause
            <a href="#timing-events">timing events</a> to be dispatched
            immediately.
            Instead, such events are dispatched upon the next sample as defined
            in <a href="#event-dispatch" class="sectionRef"></a>.
          </p>
          <p>
            The behavior of events with relation to seek operations is defined
            in <a href="#event-dispatch-during-seeking" class="sectionRef"></a>.
          </p>
          <div class="informative">
            <p>
              For example, if a series of modifications to the timing model in
              a single script block causes a <a>TimedItem</a>'s <a>item time</a>
              to jump from being outside the active interval, to inside the
              interval, and then outside again no events are fired as in the
              following example.
            </p>
            <pre class="example sh_javascript">
              // document.timeline.currentTime is 3
              var anim = new Animation(null, null, 2);
              anim.onstart = function() { alert("started"); };
              anim.play(); // startTime = 3
              anim.startTime = Infinity;
              // No alert is shown
            </pre>
          </div>
        </li>
        <li>
          <p>
            Modifications to any part of the API (whether the timing model or
            animation model) are not reflected in the target element and nor is
            any <a>CustomAnimationEffect</a> called until the next sample has
            been performed at some time after the current script block completes
            execution.
          </p>
          <div class="informative">
            <p>
              For example, if a series of modifications to the timing model in
              a single script block causes a <a>TimedItem</a>'s <a>item time</a>
              to jump from being outside the active interval, to inside the
              interval, and then outside again no events are fired as in the
              following example.
            </p>
            <pre class="example sh_javascript">
              // Set opacity to 0 immediately
              var anim = new Animation(elem, { "opacity": 0 });
              anim.play();
              alert(window.getComputedStyle(elem).opacity);
              // Displays '1'
            </pre>
          </div>
          <p class="issue">
            I'm unsure if this is the desired behavior.
            Gecko, for example, forces a synchronous sample when a seek is
            performed.
            This certainly makes testing simpler but I'm not sure if this is
            a good idea or not.
          </p>
          <p class="issue">
            Do we need to put some minimum requirement on when samples are
            performed?
            By the time the next script block executes can I assume the model is
            up to date?
          </p>
        </li>
        <li>
          <p>
            The value returned by
            <code><a>DocumentTimeSource</a>.currentTime</code> will not change
            within a script block unless explicitly set through the API.
          </p>
          <div class="informative">
            <p>
              For example, if a series of modifications to the timing model in
              a single script block causes a <a>TimedItem</a>'s <a>item time</a>
              to jump from being outside the active interval, to inside the
              interval, and then outside again no events are fired as in the
              following example.
            </p>
            <pre class="example sh_javascript">
              var a = document.timeline.currentTime;
              // ... many lines of code ...
              var b = document.timeline.currentTime;
              alert(b - a); // Displays 0
            </pre>
          </div>
          <p class="issue">
            What about when <code>play</code> is called and the
            <a>DocumentTimeSource</a> is not already playing?
            We said elsewhere that <code>currentTime</code> <em>immediately</em>
            becomes zero.
            If we want that to be true we should probably force a synchronous
            sample at that point.
          </p>
        </li>
      </ul>
    </section>

    <section>
      <h2>Integration with Media Fragments</h2>
      <p>
        The Media Fragments specification [[!MEDIA-FRAGMENTS]] defines a means
        for addressing a temporal range of a media resource.
        The application of media fragments depends on the MIME type of the
        resource on which they are specified.
        For resources with the <a
        href="http://www.w3.org/TR/SVG/intro.html#MIMEType">SVG MIME type</a>
        [[!SVG11]], the application of temporal parameters is defined in the <a
        href="svg-integration.html">Web Animations and SVG Integration</a>
        specification.
      </p>
      <p class="note">
        Note that media fragments are defined to operate on resources based on
        their MIME type.
        As a result, temporal addressing may not be supported in all situations
        where Web Animations content is used.
      </p>
    </section>

    <section>
      <h2>Interaction with page display</h2>
      <p class="todo">
        What should be the behavior here? Should we pause on unload/pagehide?
        What does video do?
      </p>
    </section>

    <section>
      <h2>Making animation accessible</h2>
      <p class="todo">
        TBD. If we have triggers represented in the API, need a way to make
        these available to accessibility agents.
      </p>
      <p class="todo">
        TBD. Need a way to expose speed control etc.?
      </p>
      <p class="todo">
        TBD. Describe how to integrate with the <a
          href="http://www.whatwg.org/specs/web-apps/current-work/#timed-text-tracks">Timed
          Text API</a> and give examples of how to author content so it is
        accessible.
      </p>
    </section>

    <section>
      <h2>Implementation requirements</h2>
      <section>
        <h3>Discarding past animations</h3>
        <p>
          If implementations are required to preserve all state associated with
          animations then the resources required by an animation could continue
          to increase without limit over time. For long-running animations, and
          particularly those where animations are added dynamically, this could
          lead to degraded performance and eventual failure.
        </p>
        <div class="issue">
          <p>
            I'm not sure how to define this. We could say all animations with
            <code><var>end time converted to document time</var> &lt;
            <var>current document time</var> - 5min</code> can be discarded.
          </p>
          <p>
            That's fine, but what about crazy documents that put 1 million
            animations in a 5min span? Just leave that up to the browser.
            Also, what about mobile clients, is 5 min too long? Is this too
            prescriptive?
          </p>
          <p>
            Maybe, just make some suggestions (e.g. 1 min for mobile clients,
            5 min for desktop?) and then define an exception to throw if there
            is a seek to some time outside that window.
          </p>
          <p>
            Also, note that defining this in terms of past intervals is
            direction-specific but that's probably ok since most long-running
            animations will run forwards.
          </p>
        </div>
      </section>
      <section>
        <h3>Conformance criteria</h3>
        <p class="todo">
          Basically, for non-scripted user agents, there are none,
          For scripted user agents, do the API.
        </p>
      </section>
    </section>

    <section class='appendix' id="webidl-ref">
      <h2>Interface summary</h2>
    </section>

    <section class='appendix'>
      <h2>Acknowledgements</h2>
      <p>
        Thank you to Michiel &ldquo;Pomax&rdquo; Kamermans for help with the
        equations for a proposed smooth timing function although this feature
        has been deferred to a subsequent specification.
      </p>
    </section>
  </body>
</html>
